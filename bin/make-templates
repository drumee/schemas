#!/bin/bash
script_dir="$(dirname "$(readlink -f "$0")")"
base="$(dirname $script_dir)"
if [ -x /usr/bin/mariadb-dump ]; then
  DUMPER=/usr/bin/mariadb-dump
elif [ -x /usr/bin/mysqldump ]; then
  DUMPER=/usr/bin/mysqldump
else
  echo DUMPER not found
  exit 1
fi
echo Using $DUMPER
#-----------------------

db_name() {
  mariadb -e "SELECT db_name FROM entity WHERE type='$1' AND status='active' AND dom_id=1 LIMIT 1" --database=yp | grep -v db_name
}

clean_tables() {
  db_name=$1
  skip="^.+_(csv|view|ssv)$"
  for table in $(mariadb -e "show tables" $db_name); do
    if [[ $table =~ $skip ]]; then
      echo "Dropping view $db_name.$table"
      mariadb -e "DROP view IF EXISTS $db_name.$table"
    fi
  done

  skip="^_|^cleanup|_tmp$|_tmp_|_bak$|^community|_temp$|_backup|^tmp_$"
  for table in $(mariadb -e "show tables" $db_name); do
    if [[ $table =~ $skip ]]; then
      echo "Dropping table $db_name.$table"
      mariadb -e "DROP table IF EXISTS $db_name.$table"
    fi
  done
}

clean_tmp_yp_tables() {
  for table in cookie dmz_token dmz_user dmz_userx \
    token otp cities city countries country alias vhost sys_conf \
    disk_usage non_drumate languages validation_code \
    entity hub drumate authn mfs_changelog organisation privilege services_log;
  do 
    echo "Wiping table ${table}"
    mariadb -e "DELETE FROM ${table}" tmp_yp
  done

  for table in files_formats frozen_language locale locale2 intl;
  do
    echo "Droping table ${table}"
    mariadb -e "DROP TABLE IF EXISTS ${table}" tmp_yp
  done
}
if [ -d "$1" ]; then
  factory_dir=$1
else
  factory_dir=factory
fi

cd $base/templates
mkdir -p $factory_dir/seed
mkdir -p tmp

opt="--routines --quick --no-data --single-transaction --skip-comments"

for type in "hub" "drumate"; do
  db_name=$(db_name $type)
  echo "Dumping seed $type from $db_name to $factory_dir/$type.sql"
  clean_tables $db_name
  $DUMPER $opt $db_name > "$factory_dir/$type.sql"
  sed -i -E "s/DEFINER=(.+) (PROCEDURE|FUNCTION)/\2/" "$factory_dir/$type.sql"
  sed -i -E "s/AUTO_INCREMENT=([0-9]+) /AUTO_INCREMENT=0 /" "$factory_dir/$type.sql"
  # sed -i -E "s/\/\*\!.+\*\/$//" "$factory_dir/$type.sql"
done

opt="--routines --quick --single-transaction --skip-comments"
for db_name in "yp" "utils" "mailserver" "template" "trash"; do
  echo "Dumping seed of $db_name"
  $DUMPER $opt $db_name > "$factory_dir/seed/$db_name.sql"
  sed -i -E "s/DEFINER=(.+) (PROCEDURE|FUNCTION)/\2/" "$factory_dir/seed/$db_name.sql"
  sed -i -E "s/AUTO_INCREMENT=([0-9]+) /AUTO_INCREMENT=0 /" "$factory_dir/seed/$db_name.sql"
  # sed -i -E "s/\/\*\!.+\*\/$//" "$factory_dir/seed/$db_name.sql"
done

#mv $factory_dir/seed/yp.sql tmp/yp.sql
mariadb -e "DROP DATABASE IF EXISTS tmp_yp"
mariadb -e "CREATE DATABASE tmp_yp"
mariadb tmp_yp <$factory_dir/seed/yp.sql
mariadb tmp_yp <firebase/yp.sql

clean_tables tmp_yp
clean_tmp_yp_tables

opt="--routines --quick --single-transaction --skip-comments"
db_name=tmp_yp
echo "Dumping seed from $db_name"
$DUMPER $opt $db_name > "$factory_dir/seed/$db_name.sql"
sed -i -E "s/DEFINER=(.+) (PROCEDURE|FUNCTION)/\2/" "$factory_dir/seed/$db_name.sql"
sed -i -E "s/AUTO_INCREMENT=([0-9]+) /AUTO_INCREMENT=0 /" "$factory_dir/seed/$db_name.sql"
# sed -i -E "s/\/\*\!.+\*\/$//" "$factory_dir/seed/$db_name.sql"

mv $factory_dir/seed/tmp_yp.sql $factory_dir/seed/yp.sql
