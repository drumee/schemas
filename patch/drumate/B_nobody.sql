-- MariaDB dump 10.17  Distrib 10.4.8-MariaDB, for debian-linux-gnu (x86_64)
--
-- Host: localhost    Database: B_nobody
-- ------------------------------------------------------
-- Server version	10.4.8-MariaDB-1:10.4.8+maria~buster-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `__tmp__3`
--

DROP TABLE IF EXISTS `__tmp__3`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `__tmp__3` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) DEFAULT NULL,
  `origin_id` varchar(16) DEFAULT NULL,
  `owner_id` varchar(16) NOT NULL,
  `host_id` varchar(16) NOT NULL,
  `file_path` varchar(512) DEFAULT NULL,
  `user_filename` varchar(80) DEFAULT NULL,
  `parent_id` varchar(16) NOT NULL DEFAULT '',
  `parent_path` varchar(1024) NOT NULL,
  `extension` varchar(100) NOT NULL DEFAULT '',
  `mimetype` varchar(100) NOT NULL,
  `category` enum('hub','folder','link','video','image','audio','document','stylesheet','script','vector','other') NOT NULL DEFAULT 'other',
  `isalink` tinyint(2) unsigned NOT NULL DEFAULT 0,
  `filesize` int(20) unsigned NOT NULL DEFAULT 0,
  `geometry` varchar(200) NOT NULL DEFAULT '0x0',
  `publish_time` int(11) unsigned NOT NULL DEFAULT 0,
  `upload_time` int(11) unsigned NOT NULL DEFAULT 0,
  `last_download` int(11) unsigned NOT NULL DEFAULT 0,
  `download_count` mediumint(8) unsigned NOT NULL DEFAULT 0,
  `metadata` varchar(1024) DEFAULT NULL,
  `caption` varchar(1024) DEFAULT NULL,
  `status` varchar(20) NOT NULL DEFAULT 'active',
  `approval` enum('submitted','verified','validated') NOT NULL,
  `rank` tinyint(4) NOT NULL DEFAULT 0,
  `location` varchar(12) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  KEY `approval` (`approval`),
  KEY `geometry` (`geometry`),
  KEY `parent_id` (`parent_id`),
  KEY `origin_id` (`origin_id`),
  KEY `file_path` (`file_path`),
  KEY `user_filename` (`user_filename`),
  KEY `category` (`category`),
  KEY `location` (`location`),
  FULLTEXT KEY `content` (`caption`,`user_filename`,`file_path`,`metadata`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `__tmp__3`
--

LOCK TABLES `__tmp__3` WRITE;
/*!40000 ALTER TABLE `__tmp__3` DISABLE KEYS */;
INSERT INTO `__tmp__3` VALUES (1,'525adb21abcad26b','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Photos','Photos','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0,'/1970/01/01/'),(2,'525adb21ad02cba4','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Musics','Musics','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0,'/1970/01/01/'),(3,'525adb21ad5f3f43','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Videos','Videos','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0,'/1970/01/01/'),(4,'525adb21ad841f7b','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Documents','Documents','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0,'/1970/01/01/'),(5,'525adb2c861acd4d','','ffffffffffffffff','ffffffffffffffff','/','nobody','0','/','folder','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0,'/1970/01/01/'),(6,'b3f03d47b3f03d4c','df0db400a22011e0','b3f03d47b3f03d4c','b3f03d47b3f03d4c','/','odise-3.drumee.net','525adb2c861acd4d','/','public','text/plain','hub',0,232652,'0x0',1533230579,1533230579,0,0,NULL,'odise-3.drumee.com','active','submitted',0,'/2018/08/02/');
/*!40000 ALTER TABLE `__tmp__3` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `acl`
--

DROP TABLE IF EXISTS `acl`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `acl` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `pkey` varbinary(32) NOT NULL,
  `resource_id` varbinary(16) NOT NULL,
  `resource_type` enum('media','comment','link','layout','all','*') NOT NULL DEFAULT '*',
  `entity_id` varbinary(16) NOT NULL,
  `permission` tinyint(4) unsigned NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `pkey` (`pkey`),
  KEY `resource_id` (`resource_id`),
  KEY `resource_type` (`resource_type`),
  KEY `entity_id` (`entity_id`),
  KEY `permission` (`permission`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `acl`
--

LOCK TABLES `acl` WRITE;
/*!40000 ALTER TABLE `acl` DISABLE KEYS */;
/*!40000 ALTER TABLE `acl` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `action_log`
--

DROP TABLE IF EXISTS `action_log`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `action_log` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `uid` varchar(16) NOT NULL,
  `action` enum('added','deleted','changed','left','removed','backup','connection') DEFAULT NULL,
  `category` enum('media','permission','member','admin','title') NOT NULL,
  `notify_to` enum('all','member','admin') NOT NULL,
  `entity_id` varchar(16) DEFAULT NULL,
  `log` varchar(1000) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `action_log`
--

LOCK TABLES `action_log` WRITE;
/*!40000 ALTER TABLE `action_log` DISABLE KEYS */;
/*!40000 ALTER TABLE `action_log` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `agenda`
--

DROP TABLE IF EXISTS `agenda`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `agenda` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `agenda_id` varchar(16) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  `place` varchar(255) DEFAULT NULL,
  `owner_id` varchar(16) NOT NULL,
  `category` enum('own','other') NOT NULL,
  `stime` int(11) NOT NULL,
  `etime` int(11) DEFAULT NULL,
  `calendar_id` varchar(16) DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `agenda_id` (`agenda_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `agenda`
--

LOCK TABLES `agenda` WRITE;
/*!40000 ALTER TABLE `agenda` DISABLE KEYS */;
/*!40000 ALTER TABLE `agenda` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `archive_entity`
--

DROP TABLE IF EXISTS `archive_entity`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `archive_entity` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `entity_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `pkey` (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `archive_entity`
--

LOCK TABLES `archive_entity` WRITE;
/*!40000 ALTER TABLE `archive_entity` DISABLE KEYS */;
/*!40000 ALTER TABLE `archive_entity` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `areas`
--

DROP TABLE IF EXISTS `areas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `areas` (
  `id` varchar(16) NOT NULL,
  `name` varchar(30) NOT NULL,
  `order` tinyint(4) NOT NULL DEFAULT 1,
  `level` enum('public','restricted','private') NOT NULL DEFAULT 'private',
  PRIMARY KEY (`id`),
  UNIQUE KEY `level` (`level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `areas`
--

LOCK TABLES `areas` WRITE;
/*!40000 ALTER TABLE `areas` DISABLE KEYS */;
INSERT INTO `areas` VALUES ('56b8e88bc007664b','',1,'public'),('56b8f83e88bc07c4','',3,'private'),('56c10b8e88bc04cc','',2,'restricted');
/*!40000 ALTER TABLE `areas` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `attachments`
--

DROP TABLE IF EXISTS `attachments`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `attachments` (
  `thread_id` varbinary(16) NOT NULL,
  `drum_id` varbinary(16) NOT NULL,
  `media_id` varbinary(16) NOT NULL,
  `media_pid` varbinary(16) NOT NULL,
  `owner_id` varbinary(16) NOT NULL,
  `extension` varchar(8) NOT NULL,
  `filename` varchar(255) DEFAULT NULL,
  `filetype` varchar(16) DEFAULT NULL,
  `status` enum('active','idle','locked','deleted') NOT NULL DEFAULT 'active'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `attachments`
--

LOCK TABLES `attachments` WRITE;
/*!40000 ALTER TABLE `attachments` DISABLE KEYS */;
/*!40000 ALTER TABLE `attachments` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `blacklist`
--

DROP TABLE IF EXISTS `blacklist`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `blacklist` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `email` varchar(255) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `blacklist`
--

LOCK TABLES `blacklist` WRITE;
/*!40000 ALTER TABLE `blacklist` DISABLE KEYS */;
/*!40000 ALTER TABLE `blacklist` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `block`
--

DROP TABLE IF EXISTS `block`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `block` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varbinary(16) NOT NULL,
  `serial` int(11) DEFAULT 0,
  `active` int(11) DEFAULT NULL,
  `author_id` varbinary(16) NOT NULL,
  `hashtag` varchar(500) CHARACTER SET ascii NOT NULL,
  `type` enum('page','block','menu','header','footer') NOT NULL DEFAULT 'block',
  `editor` enum('creator','designer') CHARACTER SET ascii NOT NULL DEFAULT 'creator',
  `status` enum('online','offline','locked','readonly') CHARACTER SET ascii NOT NULL DEFAULT 'online',
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  `version` varchar(10) NOT NULL DEFAULT '1.0.0',
  `owner_id` varchar(16) DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  UNIQUE KEY `hashtag` (`hashtag`) USING BTREE,
  KEY `ctime` (`ctime`),
  KEY `mtime` (`mtime`),
  KEY `version` (`version`),
  KEY `author_id` (`author_id`),
  KEY `editor` (`editor`)
) ENGINE=InnoDB AUTO_INCREMENT=265 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `block`
--

LOCK TABLES `block` WRITE;
/*!40000 ALTER TABLE `block` DISABLE KEYS */;
INSERT INTO `block` VALUES (125,'008aea81008aea91',1,1,'df0db400a22011e0','008aea81008aea91','page','designer','offline',1464731133,1464731133,'1.2.0',NULL),(126,'00e3b2dd00e3b2f4',1,1,'df0db400a22011e0','00e3b2dd00e3b2f4','page','designer','offline',1464765923,1464765923,'1.2.0',NULL),(127,'016fd317016fd327',1,1,'df0db400a22011e0','016fd317016fd327','page','designer','offline',1464794700,1464794700,'1.2.0',NULL),(128,'058286bf058286cd',1,1,'df0db400a22011e0','058286bf058286cd','page','designer','offline',1464730712,1464730712,'1.2.0',NULL),(129,'0685849c068584ab',1,1,'df0db400a22011e0','0685849c068584ab','page','designer','offline',1464731143,1464731143,'1.2.0',NULL),(130,'06da589d06da58af',1,1,'df0db400a22011e0','06da589d06da58af','page','designer','offline',1464765933,1464765933,'1.2.0',NULL),(131,'07ff869707ff86a7',1,1,'df0db400a22011e0','07ff869707ff86a7','page','designer','offline',1464794711,1464794711,'1.2.0',NULL),(132,'0b7ed62e0b7ed63d',1,1,'df0db400a22011e0','0b7ed62e0b7ed63d','page','designer','offline',1464730722,1464730722,'1.2.0',NULL),(133,'0c823b640c823b72',1,1,'df0db400a22011e0','0c823b640c823b72','page','designer','offline',1464731153,1464731153,'1.2.0',NULL),(134,'0d1be88a0d1be89b',1,1,'df0db400a22011e0','0d1be88a0d1be89b','page','designer','offline',1464765943,1464765943,'1.2.0',NULL),(135,'0e8bd22f0e8bd240',1,1,'df0db400a22011e0','0e8bd22f0e8bd240','page','designer','offline',1464794722,1464794722,'1.2.0',NULL),(136,'117a1314117a1325',1,1,'df0db400a22011e0','117a1314117a1325','page','designer','offline',1464730732,1464730732,'1.2.0',NULL),(137,'127b643c127b644c',1,1,'df0db400a22011e0','127b643c127b644c','page','designer','offline',1464731163,1464731163,'1.2.0',NULL),(138,'135fd856135fd86d',1,1,'df0db400a22011e0','135fd856135fd86d','page','designer','offline',1464765954,1464765954,'1.2.0',NULL),(139,'148aa2ce148aa2e4',1,1,'df0db400a22011e0','148aa2ce148aa2e4','page','designer','offline',1464794732,1464794732,'1.2.0',NULL),(140,'177554d7177554e8',1,1,'df0db400a22011e0','177554d7177554e8','page','designer','offline',1464730742,1464730742,'1.2.0',NULL),(141,'1873484818734857',1,1,'df0db400a22011e0','1873484818734857','page','designer','offline',1464731173,1464731173,'1.2.0',NULL),(142,'1b0fed8c1b0fed9d',1,1,'df0db400a22011e0','1b0fed8c1b0fed9d','page','designer','offline',1464794743,1464794743,'1.2.0',NULL),(143,'1d16418d1d1641a6',1,1,'df0db400a22011e0','1d16418d1d1641a6','page','designer','offline',1464765970,1464765970,'1.2.0',NULL),(144,'1d6f93541d6f9365',1,1,'df0db400a22011e0','1d6f93541d6f9365','page','designer','offline',1464730752,1464730752,'1.2.0',NULL),(145,'1e6f15651e6f1571',1,1,'df0db400a22011e0','1e6f15651e6f1571','page','designer','offline',1464731183,1464731183,'1.2.0',NULL),(146,'1f0bfc061f0bfc17',1,1,'df0db400a22011e0','1f0bfc061f0bfc17','page','designer','offline',1464765973,1464765973,'1.2.0',NULL),(147,'21a006e321a006f4',1,1,'df0db400a22011e0','21a006e321a006f4','page','designer','offline',1464794754,1464794754,'1.2.0',NULL),(148,'236a534b236a535d',1,1,'df0db400a22011e0','236a534b236a535d','page','designer','offline',1464730762,1464730762,'1.2.0',NULL),(149,'2463ed582463ed60',1,1,'df0db400a22011e0','2463ed582463ed60','page','designer','offline',1464731193,1464731193,'1.2.0',NULL),(150,'2505fd0a2505fd21',1,1,'df0db400a22011e0','2505fd0a2505fd21','page','designer','offline',1464765983,1464765983,'1.2.0',NULL),(151,'282f7d1a282f7d2c',1,1,'df0db400a22011e0','282f7d1a282f7d2c','page','designer','offline',1464794765,1464794765,'1.2.0',NULL),(152,'2966441e2966442e',1,1,'df0db400a22011e0','2966441e2966442e','page','designer','offline',1464730772,1464730772,'1.2.0',NULL),(153,'2a66dc562a66dc6f',1,1,'df0db400a22011e0','2a66dc562a66dc6f','page','designer','offline',1464731203,1464731203,'1.2.0',NULL),(154,'2e4142ff2e414312',1,1,'df0db400a22011e0','2e4142ff2e414312','page','designer','offline',1464765999,1464765999,'1.2.0',NULL),(155,'2ebdc39f2ebdc3b0',1,1,'df0db400a22011e0','2ebdc39f2ebdc3b0','page','designer','offline',1464794776,1464794776,'1.2.0',NULL),(156,'2f600d7f2f600d90',1,1,'df0db400a22011e0','2f600d7f2f600d90','page','designer','offline',1464730782,1464730782,'1.2.0',NULL),(157,'305e0efe305e0f0e',1,1,'df0db400a22011e0','305e0efe305e0f0e','page','designer','offline',1464731213,1464731213,'1.2.0',NULL),(158,'314c543b314c544d',1,1,'df0db400a22011e0','314c543b314c544d','page','designer','offline',1464766004,1464766004,'1.2.0',NULL),(159,'354c8d42354c8d51',1,1,'df0db400a22011e0','354c8d42354c8d51','page','designer','offline',1464794787,1464794787,'1.2.0',NULL),(160,'355b7a93355b7aaa',1,1,'df0db400a22011e0','355b7a93355b7aaa','page','designer','offline',1464730792,1464730792,'1.2.0',NULL),(161,'3659291336592923',1,1,'df0db400a22011e0','3659291336592923','page','designer','offline',1464731223,1464731223,'1.2.0',NULL),(162,'370ccbef370ccc05',1,1,'df0db400a22011e0','370ccbef370ccc05','page','designer','offline',1464766014,1464766014,'1.2.0',NULL),(163,'3b5571403b55714d',1,1,'df0db400a22011e0','3b5571403b55714d','page','designer','offline',1464730802,1464730802,'1.2.0',NULL),(164,'3bd86fb63bd86fc7',1,1,'df0db400a22011e0','3bd86fb63bd86fc7','page','designer','offline',1464794798,1464794798,'1.2.0',NULL),(165,'3c523ae13c523af8',1,1,'df0db400a22011e0','3c523ae13c523af8','page','designer','offline',1464731233,1464731233,'1.2.0',NULL),(166,'3d5df3c83d5df3d9',1,1,'df0db400a22011e0','3d5df3c83d5df3d9','page','designer','offline',1464766024,1464766024,'1.2.0',NULL),(167,'4150f9084150f917',1,1,'df0db400a22011e0','4150f9084150f917','page','designer','offline',1464730812,1464730812,'1.2.0',NULL),(168,'42679aef42679aff',1,1,'df0db400a22011e0','42679aef42679aff','page','designer','offline',1464794809,1464794809,'1.2.0',NULL),(169,'474a239a474a23ab',1,1,'df0db400a22011e0','474a239a474a23ab','page','designer','offline',1464730822,1464730822,'1.2.0',NULL),(170,'48cb0d8b48cb0da1',1,1,'df0db400a22011e0','48cb0d8b48cb0da1','page','designer','offline',1464766043,1464766043,'1.2.0',NULL),(171,'48f4703348f47043',1,1,'df0db400a22011e0','48f4703348f47043','page','designer','offline',1464794820,1464794820,'1.2.0',NULL),(172,'4cbe73a64cbe73bb',1,1,'df0db400a22011e0','4cbe73a64cbe73bb','page','designer','offline',1464766050,1464766050,'1.2.0',NULL),(173,'4d44f8a34d44f8b3',1,1,'df0db400a22011e0','4d44f8a34d44f8b3','page','designer','offline',1464730832,1464730832,'1.2.0',NULL),(174,'4ec227c74ec227d7',1,1,'df0db400a22011e0','4ec227c74ec227d7','page','designer','offline',1464766053,1464766053,'1.2.0',NULL),(175,'4f51cea14f51cea6',1,1,'ffffffffffffffff','default','page','designer','offline',1406321249,1406321249,'1.0.0',NULL),(176,'4f83a6014f83a60f',1,1,'df0db400a22011e0','4f83a6014f83a60f','page','designer','offline',1464794831,1464794831,'1.2.0',NULL),(177,'533f4f53533f4f63',1,1,'df0db400a22011e0','533f4f53533f4f63','page','designer','offline',1464730842,1464730842,'1.2.0',NULL),(178,'54bf5ab354bf5ac7',1,1,'df0db400a22011e0','54bf5ab354bf5ac7','page','designer','offline',1464766064,1464766064,'1.2.0',NULL),(179,'5614095656140967',1,1,'df0db400a22011e0','5614095656140967','page','designer','offline',1464794842,1464794842,'1.2.0',NULL),(180,'593b620a593b621b',1,1,'df0db400a22011e0','593b620a593b621b','page','designer','offline',1464730852,1464730852,'1.2.0',NULL),(181,'5ca1365a5ca1366a',1,1,'df0db400a22011e0','5ca1365a5ca1366a','page','designer','offline',1464794853,1464794853,'1.2.0',NULL),(182,'5e7498255e749835',1,1,'df0db400a22011e0','5e7498255e749835','page','designer','offline',1464766080,1464766080,'1.2.0',NULL),(183,'5f3507385f350749',1,1,'df0db400a22011e0','5f3507385f350749','page','designer','offline',1464730862,1464730862,'1.2.0',NULL),(184,'609b5438609b5450',1,1,'df0db400a22011e0','609b5438609b5450','page','designer','offline',1464766083,1464766083,'1.2.0',NULL),(185,'652ff7c8652ff7d9',1,1,'df0db400a22011e0','652ff7c8652ff7d9','page','designer','offline',1464730872,1464730872,'1.2.0',NULL),(186,'6b28ed206b28ed2d',1,1,'df0db400a22011e0','6b28ed206b28ed2d','page','designer','offline',1464730882,1464730882,'1.2.0',NULL),(187,'6b6568056b656816',1,1,'df0db400a22011e0','6b6568056b656816','page','designer','offline',1464794878,1464794878,'1.2.0',NULL),(188,'6bb6ca8f6bb6caa0',1,1,'df0db400a22011e0','6bb6ca8f6bb6caa0','page','designer','offline',1464794449,1464794449,'1.2.0',NULL),(189,'71259bd171259be0',1,1,'df0db400a22011e0','71259bd171259be0','page','designer','offline',1464730892,1464730892,'1.2.0',NULL),(190,'715df4ed715df4ff',1,1,'df0db400a22011e0','715df4ed715df4ff','page','designer','offline',1464794888,1464794888,'1.2.0',NULL),(191,'71b1cd3871b1cd4e',1,1,'df0db400a22011e0','71b1cd3871b1cd4e','page','designer','offline',1464794459,1464794459,'1.2.0',NULL),(192,'7720f62b7720f63c',1,1,'df0db400a22011e0','7720f62b7720f63c','page','designer','offline',1464730902,1464730902,'1.2.0',NULL),(193,'775597d6775597e6',1,1,'df0db400a22011e0','775597d6775597e6','page','designer','offline',1464794898,1464794898,'1.2.0',NULL),(194,'77ac630677ac6318',1,1,'df0db400a22011e0','77ac630677ac6318','page','designer','offline',1464794469,1464794469,'1.2.0',NULL),(195,'7d1aab157d1aab24',1,1,'df0db400a22011e0','7d1aab157d1aab24','page','designer','offline',1464730912,1464730912,'1.2.0',NULL),(196,'7d4ce7617d4ce771',1,1,'df0db400a22011e0','7d4ce7617d4ce771','page','designer','offline',1464794908,1464794908,'1.2.0',NULL),(197,'7da6ed547da6ed67',1,1,'df0db400a22011e0','7da6ed547da6ed67','page','designer','offline',1464794479,1464794479,'1.2.0',NULL),(198,'8316ed958316eda1',1,1,'df0db400a22011e0','8316ed958316eda1','page','designer','offline',1464730923,1464730923,'1.2.0',NULL),(199,'834650e2834650f5',1,1,'df0db400a22011e0','834650e2834650f5','page','designer','offline',1464794918,1464794918,'1.2.0',NULL),(200,'83a1131f83a11335',1,1,'df0db400a22011e0','83a1131f83a11335','page','designer','offline',1464794489,1464794489,'1.2.0',NULL),(201,'890f56de890f56ee',1,1,'df0db400a22011e0','890f56de890f56ee','page','designer','offline',1464730933,1464730933,'1.2.0',NULL),(202,'893d4064893d4073',1,1,'df0db400a22011e0','893d4064893d4073','page','designer','offline',1464794928,1464794928,'1.2.0',NULL),(203,'899bcb4b899bcb5b',1,1,'df0db400a22011e0','899bcb4b899bcb5b','page','designer','offline',1464794499,1464794499,'1.2.0',NULL),(204,'8f0a5df78f0a5e07',1,1,'df0db400a22011e0','8f0a5df78f0a5e07','page','designer','offline',1464730943,1464730943,'1.2.0',NULL),(205,'8f387d788f387d8c',1,1,'df0db400a22011e0','8f387d788f387d8c','page','designer','offline',1464794938,1464794938,'1.2.0',NULL),(206,'8f96ca628f96ca73',1,1,'df0db400a22011e0','8f96ca628f96ca73','page','designer','offline',1464794509,1464794509,'1.2.0',NULL),(207,'9506561095065620',1,1,'df0db400a22011e0','9506561095065620','page','designer','offline',1464730953,1464730953,'1.2.0',NULL),(208,'9532b09b9532b0aa',1,1,'df0db400a22011e0','9532b09b9532b0aa','page','designer','offline',1464794948,1464794948,'1.2.0',NULL),(209,'9591019d959101b3',1,1,'df0db400a22011e0','9591019d959101b3','page','designer','offline',1464794519,1464794519,'1.2.0',NULL),(210,'9b01f70d9b01f71c',1,1,'df0db400a22011e0','9b01f70d9b01f71c','page','designer','offline',1464730963,1464730963,'1.2.0',NULL),(211,'9b2ae2a39b2ae2b4',1,1,'df0db400a22011e0','9b2ae2a39b2ae2b4','page','designer','offline',1464794958,1464794958,'1.2.0',NULL),(212,'9b8b06549b8b0665',1,1,'df0db400a22011e0','9b8b06549b8b0665','page','designer','offline',1464794529,1464794529,'1.2.0',NULL),(213,'a0fc6ab4a0fc6ac3',1,1,'df0db400a22011e0','a0fc6ab4a0fc6ac3','page','designer','offline',1464730973,1464730973,'1.2.0',NULL),(214,'a123713ca1237153',1,1,'df0db400a22011e0','a123713ca1237153','page','designer','offline',1464794968,1464794968,'1.2.0',NULL),(215,'a1850280a1850292',1,1,'df0db400a22011e0','a1850280a1850292','page','designer','offline',1464794539,1464794539,'1.2.0',NULL),(216,'a6f523d8a6f523ea',1,1,'df0db400a22011e0','a6f523d8a6f523ea','page','designer','offline',1464730983,1464730983,'1.2.0',NULL),(217,'a71c7926a71c7936',1,1,'df0db400a22011e0','a71c7926a71c7936','page','designer','offline',1464794978,1464794978,'1.2.0',NULL),(218,'a77f69b6a77f69cd',1,1,'df0db400a22011e0','a77f69b6a77f69cd','page','designer','offline',1464794549,1464794549,'1.2.0',NULL),(219,'aced743baced744d',1,1,'df0db400a22011e0','aced743baced744d','page','designer','offline',1464730993,1464730993,'1.2.0',NULL),(220,'ad14cabcad14caca',1,1,'df0db400a22011e0','ad14cabcad14caca','page','designer','offline',1464794988,1464794988,'1.2.0',NULL),(221,'ad7b3a3cad7b3a4b',1,1,'df0db400a22011e0','ad7b3a3cad7b3a4b','page','designer','offline',1464794559,1464794559,'1.2.0',NULL),(222,'b2e5d98db2e5d997',1,1,'df0db400a22011e0','b2e5d98db2e5d997','page','designer','offline',1464731003,1464731003,'1.2.0',NULL),(223,'b30e3d15b30e3d2d',1,1,'df0db400a22011e0','b30e3d15b30e3d2d','page','designer','offline',1464794998,1464794998,'1.2.0',NULL),(224,'b375bafab375bb09',1,1,'df0db400a22011e0','b375bafab375bb09','page','designer','offline',1464794569,1464794569,'1.2.0',NULL),(225,'b5cd9708b5cd971f',1,1,'df0db400a22011e0','b5cd9708b5cd971f','page','designer','offline',1464730149,1464730149,'1.2.0',NULL),(226,'b8deb955b8deb965',1,1,'df0db400a22011e0','b8deb955b8deb965','page','designer','offline',1464731013,1464731013,'1.2.0',NULL),(227,'b908d6c7b908d6d7',1,1,'df0db400a22011e0','b908d6c7b908d6d7','page','designer','offline',1464795008,1464795008,'1.2.0',NULL),(228,'b9ea67e4b9ea67f4',1,1,'df0db400a22011e0','b9ea67e4b9ea67f4','page','designer','offline',1464794580,1464794580,'1.2.0',NULL),(229,'bed70b23bed70b32',1,1,'df0db400a22011e0','bed70b23bed70b32','page','designer','offline',1464731023,1464731023,'1.2.0',NULL),(230,'beff3b2ebeff3b3f',1,1,'df0db400a22011e0','beff3b2ebeff3b3f','page','designer','offline',1464795018,1464795018,'1.2.0',NULL),(231,'c076f635c076f645',1,1,'df0db400a22011e0','c076f635c076f645','page','designer','offline',1464794591,1464794591,'1.2.0',NULL),(232,'c4ce9bb5c4ce9bc9',1,1,'df0db400a22011e0','c4ce9bb5c4ce9bc9','page','designer','offline',1464731033,1464731033,'1.2.0',NULL),(233,'c4f8ff16c4f8ff2b',1,1,'df0db400a22011e0','c4f8ff16c4f8ff2b','page','designer','offline',1464795028,1464795028,'1.2.0',NULL),(234,'c7054d98c7054dae',1,1,'df0db400a22011e0','c7054d98c7054dae','page','designer','offline',1464794602,1464794602,'1.2.0',NULL),(235,'c9bb4249c9bb4261',1,1,'df0db400a22011e0','c9bb4249c9bb4261','page','designer','offline',1464730612,1464730612,'1.2.0',NULL),(236,'cac952e9cac952fa',1,1,'df0db400a22011e0','cac952e9cac952fa','page','designer','offline',1464731043,1464731043,'1.2.0',NULL),(237,'caf2d1bdcaf2d1cf',1,1,'df0db400a22011e0','caf2d1bdcaf2d1cf','page','designer','offline',1464795038,1464795038,'1.2.0',NULL),(238,'cd938c0bcd938c1a',1,1,'df0db400a22011e0','cd938c0bcd938c1a','page','designer','offline',1464794613,1464794613,'1.2.0',NULL),(239,'cfb1de5ecfb1de74',1,1,'df0db400a22011e0','cfb1de5ecfb1de74','page','designer','offline',1464730622,1464730622,'1.2.0',NULL),(240,'d0c26ec6d0c26ed6',1,1,'df0db400a22011e0','d0c26ec6d0c26ed6','page','designer','offline',1464731053,1464731053,'1.2.0',NULL),(241,'d0ead4c9d0ead4d9',1,1,'df0db400a22011e0','d0ead4c9d0ead4d9','page','designer','offline',1464795048,1464795048,'1.2.0',NULL),(242,'d4280204d428021c',1,1,'df0db400a22011e0','d4280204d428021c','page','designer','offline',1464794624,1464794624,'1.2.0',NULL),(243,'d5aadd67d5aadd75',1,1,'df0db400a22011e0','d5aadd67d5aadd75','page','designer','offline',1464730632,1464730632,'1.2.0',NULL),(244,'d6ba5f4bd6ba5f5b',1,1,'df0db400a22011e0','d6ba5f4bd6ba5f5b','page','designer','offline',1464731063,1464731063,'1.2.0',NULL),(245,'daaf3977daaf398c',1,1,'df0db400a22011e0','daaf3977daaf398c','page','designer','offline',1464794635,1464794635,'1.2.0',NULL),(246,'dba6f1b4dba6f1c5',1,1,'df0db400a22011e0','dba6f1b4dba6f1c5','page','designer','offline',1464730642,1464730642,'1.2.0',NULL),(247,'dcb1bc7edcb1bc95',1,1,'df0db400a22011e0','dcb1bc7edcb1bc95','page','designer','offline',1464731073,1464731073,'1.2.0',NULL),(248,'e13ee94fe13ee964',1,1,'df0db400a22011e0','e13ee94fe13ee964','page','designer','offline',1464794646,1464794646,'1.2.0',NULL),(249,'e19f4791e19f479d',1,1,'df0db400a22011e0','e19f4791e19f479d','page','designer','offline',1464730652,1464730652,'1.2.0',NULL),(250,'e2ab161be2ab1629',1,1,'df0db400a22011e0','e2ab161be2ab1629','page','designer','offline',1464731083,1464731083,'1.2.0',NULL),(251,'e79d29fce79d2a12',1,1,'df0db400a22011e0','e79d29fce79d2a12','page','designer','offline',1464730662,1464730662,'1.2.0',NULL),(252,'e7ce7b1ae7ce7b29',1,1,'df0db400a22011e0','e7ce7b1ae7ce7b29','page','designer','offline',1464794657,1464794657,'1.2.0',NULL),(253,'e8a71a87e8a71a98',1,1,'df0db400a22011e0','e8a71a87e8a71a98','page','designer','offline',1464731093,1464731093,'1.2.0',NULL),(254,'ed96f3e9ed96f3fb',1,1,'df0db400a22011e0','ed96f3e9ed96f3fb','page','designer','offline',1464730672,1464730672,'1.2.0',NULL),(255,'ee5b7c92ee5b7ca3',1,1,'df0db400a22011e0','ee5b7c92ee5b7ca3','page','designer','offline',1464794668,1464794668,'1.2.0',NULL),(256,'ee9f861bee9f862e',1,1,'df0db400a22011e0','ee9f861bee9f862e','page','designer','offline',1464731103,1464731103,'1.2.0',NULL),(257,'f3926ea5f3926eb5',1,1,'df0db400a22011e0','f3926ea5f3926eb5','page','designer','offline',1464730682,1464730682,'1.2.0',NULL),(258,'f4579bd3f4579be3',1,1,'df0db400a22011e0','f4579bd3f4579be3','page','designer','offline',1464794678,1464794678,'1.2.0',NULL),(259,'f49991ecf49991fb',1,1,'df0db400a22011e0','f49991ecf49991fb','page','designer','offline',1464731113,1464731113,'1.2.0',NULL),(260,'f98e931df98e9333',1,1,'df0db400a22011e0','f98e931df98e9333','page','designer','offline',1464730692,1464730692,'1.2.0',NULL),(261,'fa90c3b0fa90c3c4',1,1,'df0db400a22011e0','fa90c3b0fa90c3c4','page','designer','offline',1464731123,1464731123,'1.2.0',NULL),(262,'fae01beefae01c05',1,1,'df0db400a22011e0','fae01beefae01c05','page','designer','offline',1464794689,1464794689,'1.2.0',NULL),(263,'faebf90cfaebf921',1,1,'df0db400a22011e0','faebf90cfaebf921','page','designer','offline',1464765913,1464765913,'1.2.0',NULL),(264,'ff87606fff87607d',1,1,'df0db400a22011e0','ff87606fff87607d','page','designer','offline',1464730702,1464730702,'1.2.0',NULL);
/*!40000 ALTER TABLE `block` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `block_history`
--

DROP TABLE IF EXISTS `block_history`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `block_history` (
  `serial` int(11) NOT NULL DEFAULT 0,
  `author_id` varbinary(16) NOT NULL,
  `master_id` varbinary(16) NOT NULL,
  `lang` varchar(10) CHARACTER SET ascii NOT NULL DEFAULT 'en',
  `device` enum('desktop','tablet','mobile') CHARACTER SET ascii NOT NULL DEFAULT 'desktop',
  `status` enum('draft','history') NOT NULL DEFAULT 'history',
  `isonline` int(4) DEFAULT 0,
  `meta` mediumtext NOT NULL,
  `ctime` int(11) unsigned NOT NULL,
  PRIMARY KEY (`serial`),
  KEY `lang` (`lang`),
  KEY `device` (`device`),
  FULLTEXT KEY `meta` (`meta`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `block_history`
--

LOCK TABLES `block_history` WRITE;
/*!40000 ALTER TABLE `block_history` DISABLE KEYS */;
/*!40000 ALTER TABLE `block_history` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `calendar`
--

DROP TABLE IF EXISTS `calendar`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `calendar` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `calendar_id` varchar(16) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  `color` varchar(10) CHARACTER SET ascii DEFAULT NULL,
  `category` enum('own','other') NOT NULL,
  `owner_id` varchar(16) NOT NULL,
  `is_selected` tinyint(1) DEFAULT 0,
  `is_default` tinyint(1) DEFAULT 0,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `calendar_id` (`calendar_id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `calendar`
--

LOCK TABLES `calendar` WRITE;
/*!40000 ALTER TABLE `calendar` DISABLE KEYS */;
/*!40000 ALTER TABLE `calendar` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `channel`
--

DROP TABLE IF EXISTS `channel`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `channel` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `message_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `author_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `entity_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `message` mediumtext DEFAULT NULL,
  `thread_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `attachment` longtext DEFAULT NULL CHECK (json_valid(`attachment`)),
  `status` enum('draft','active','trashed') NOT NULL DEFAULT 'active',
  `is_forward` tinyint(1) DEFAULT 0,
  `ctime` int(11) NOT NULL,
  `metadata` mediumtext DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `message_id` (`message_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `channel`
--

LOCK TABLES `channel` WRITE;
/*!40000 ALTER TABLE `channel` DISABLE KEYS */;
/*!40000 ALTER TABLE `channel` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `chat`
--

DROP TABLE IF EXISTS `chat`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `chat` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `chat_id` varchar(16) NOT NULL,
  `parent_chat_id` varchar(16) DEFAULT NULL,
  `bound` enum('out','in') NOT NULL DEFAULT 'out',
  `status` enum('draft','active','trashed') NOT NULL DEFAULT 'active',
  `is_read` tinyint(1) DEFAULT 0,
  `entity_id` varchar(16) NOT NULL,
  `uid` varchar(16) NOT NULL,
  `category` enum('group','contact') NOT NULL,
  `message` mediumtext DEFAULT NULL,
  `attachment` longtext DEFAULT NULL CHECK (json_valid(`attachment`)),
  `is_forward` tinyint(1) DEFAULT 0,
  `ctime` int(11) NOT NULL,
  `metadata` longtext DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `chat_id` (`chat_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `chat`
--

LOCK TABLES `chat` WRITE;
/*!40000 ALTER TABLE `chat` DISABLE KEYS */;
/*!40000 ALTER TABLE `chat` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `communities`
--

DROP TABLE IF EXISTS `communities`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `communities` (
  `id` varbinary(16) NOT NULL,
  `importance` tinyint(1) NOT NULL,
  `a_order` tinyint(4) NOT NULL DEFAULT 1,
  `c_order` tinyint(4) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `communities`
--

LOCK TABLES `communities` WRITE;
/*!40000 ALTER TABLE `communities` DISABLE KEYS */;
/*!40000 ALTER TABLE `communities` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `connection`
--

DROP TABLE IF EXISTS `connection`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `connection` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `session_id` varchar(64) DEFAULT NULL,
  `login_time` int(11) NOT NULL DEFAULT 0,
  `logout_time` int(11) NOT NULL DEFAULT 0,
  `ip` varchar(64) NOT NULL DEFAULT '',
  `ua` varchar(512) NOT NULL DEFAULT '',
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `session_id` (`session_id`),
  KEY `ip` (`ip`),
  KEY `ua` (`ua`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `connection`
--

LOCK TABLES `connection` WRITE;
/*!40000 ALTER TABLE `connection` DISABLE KEYS */;
/*!40000 ALTER TABLE `connection` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact`
--

DROP TABLE IF EXISTS `contact`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `surname` varchar(255) DEFAULT NULL,
  `firstname` varchar(255) DEFAULT NULL,
  `lastname` varchar(255) DEFAULT NULL,
  `comment` text DEFAULT NULL,
  `message` text DEFAULT NULL,
  `entity` varchar(255) CHARACTER SET ascii DEFAULT NULL,
  `uid` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `category` enum('drumate','independant','social') NOT NULL,
  `status` enum('memory','sent','received','invitation','informed','accept','active') DEFAULT NULL,
  `invitetime` int(11) DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  `metadata` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`metadata`)),
  `source` varchar(128) GENERATED ALWAYS AS (json_value(`metadata`,'$.source')) VIRTUAL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `entity` (`entity`),
  UNIQUE KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact`
--

LOCK TABLES `contact` WRITE;
/*!40000 ALTER TABLE `contact` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_address`
--

DROP TABLE IF EXISTS `contact_address`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_address` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) NOT NULL,
  `address` text DEFAULT NULL,
  `category` enum('prof','priv') NOT NULL DEFAULT 'priv',
  `contact_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_address`
--

LOCK TABLES `contact_address` WRITE;
/*!40000 ALTER TABLE `contact_address` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact_address` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_email`
--

DROP TABLE IF EXISTS `contact_email`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_email` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) NOT NULL,
  `email` varchar(255) DEFAULT NULL,
  `category` enum('prof','priv') NOT NULL DEFAULT 'priv',
  `is_default` tinyint(4) NOT NULL DEFAULT 0,
  `contact_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `email` (`email`,`id`),
  UNIQUE KEY `email_contact_id` (`email`,`contact_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_email`
--

LOCK TABLES `contact_email` WRITE;
/*!40000 ALTER TABLE `contact_email` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact_email` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_group`
--

DROP TABLE IF EXISTS `contact_group`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_group` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) NOT NULL,
  `owner_id` varchar(16) NOT NULL,
  `name` varchar(255) NOT NULL,
  `category` enum('origin','shadow') NOT NULL DEFAULT 'origin',
  `avatar` varchar(16) DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `owner_id_name` (`owner_id`,`category`,`name`),
  KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_group`
--

LOCK TABLES `contact_group` WRITE;
/*!40000 ALTER TABLE `contact_group` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact_group` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_group_detail`
--

DROP TABLE IF EXISTS `contact_group_detail`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_group_detail` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `group_id` varchar(16) NOT NULL,
  `contact_id` varchar(16) DEFAULT NULL,
  `uid` varchar(16) DEFAULT NULL,
  `status` enum('active','exit') DEFAULT 'active',
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `group_id_uid` (`group_id`,`uid`),
  KEY `id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_group_detail`
--

LOCK TABLES `contact_group_detail` WRITE;
/*!40000 ALTER TABLE `contact_group_detail` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact_group_detail` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_invitation`
--

DROP TABLE IF EXISTS `contact_invitation`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_invitation` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `uid` varchar(16) NOT NULL,
  `bound` enum('out','in') NOT NULL DEFAULT 'out',
  `status` enum('refuse','accept','pending','delete','inform') NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `uid_bound` (`uid`,`bound`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_invitation`
--

LOCK TABLES `contact_invitation` WRITE;
/*!40000 ALTER TABLE `contact_invitation` DISABLE KEYS */;
INSERT INTO `contact_invitation` VALUES (1,'1eb357c41eb357ca','in','pending',1571653500);
/*!40000 ALTER TABLE `contact_invitation` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contact_phone`
--

DROP TABLE IF EXISTS `contact_phone`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contact_phone` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) NOT NULL,
  `areacode` varchar(255) DEFAULT '',
  `phone` varchar(255) DEFAULT NULL,
  `category` enum('prof','priv') NOT NULL DEFAULT 'priv',
  `contact_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contact_phone`
--

LOCK TABLES `contact_phone` WRITE;
/*!40000 ALTER TABLE `contact_phone` DISABLE KEYS */;
/*!40000 ALTER TABLE `contact_phone` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `contacts`
--

DROP TABLE IF EXISTS `contacts`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `contacts` (
  `id` varbinary(40) NOT NULL,
  `firstname` varchar(60) DEFAULT NULL,
  `lastname` varchar(60) DEFAULT NULL,
  `nickname` varchar(60) DEFAULT NULL,
  `org` varchar(60) DEFAULT NULL,
  `categories` varchar(50) DEFAULT NULL,
  `title` varchar(60) DEFAULT NULL,
  `photo` varchar(150) DEFAULT NULL,
  `tel_work` varchar(30) DEFAULT NULL,
  `tel_home` varchar(30) DEFAULT NULL,
  `tel_cell` varchar(30) DEFAULT NULL,
  `adr_work` varchar(160) DEFAULT NULL,
  `label_work` varchar(160) DEFAULT NULL,
  `adr_home` varchar(160) DEFAULT NULL,
  `label_home` varchar(160) DEFAULT NULL,
  `email` varchar(250) DEFAULT NULL,
  `web_site` varchar(250) DEFAULT NULL,
  `fingerprin` varchar(250) DEFAULT NULL,
  `email_work` varchar(250) DEFAULT NULL,
  `email_home` varchar(250) DEFAULT NULL,
  `x-created` int(11) NOT NULL,
  `x-modified` int(11) NOT NULL,
  `x-primary-phone` varchar(30) DEFAULT NULL,
  `note` varchar(250) DEFAULT NULL,
  `tag` varchar(250) DEFAULT NULL,
  `vcard` varchar(250) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `tag` (`tag`),
  FULLTEXT KEY `firstname` (`firstname`),
  FULLTEXT KEY `lastname` (`lastname`),
  FULLTEXT KEY `nickname` (`nickname`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `contacts`
--

LOCK TABLES `contacts` WRITE;
/*!40000 ALTER TABLE `contacts` DISABLE KEYS */;
/*!40000 ALTER TABLE `contacts` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `content_tag`
--

DROP TABLE IF EXISTS `content_tag`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `content_tag` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) CHARACTER SET ascii NOT NULL,
  `language` varchar(50) NOT NULL,
  `type` enum('block','folder','link','video','image','audio','document','stylesheet','other') NOT NULL,
  `status` enum('online','offline') DEFAULT NULL,
  `name` varchar(500) NOT NULL,
  `description` varchar(1024) NOT NULL,
  `ctime` int(11) NOT NULL,
  `rank` int(8) NOT NULL,
  `group_rank` int(8) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`,`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `content_tag`
--

LOCK TABLES `content_tag` WRITE;
/*!40000 ALTER TABLE `content_tag` DISABLE KEYS */;
/*!40000 ALTER TABLE `content_tag` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `crop`
--

DROP TABLE IF EXISTS `crop`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `crop` (
  `id` int(4) NOT NULL AUTO_INCREMENT,
  `image_id` varbinary(16) NOT NULL,
  `attributes` text COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`id`),
  KEY `image_id` (`image_id`),
  FULLTEXT KEY `attributes` (`attributes`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `crop`
--

LOCK TABLES `crop` WRITE;
/*!40000 ALTER TABLE `crop` DISABLE KEYS */;
/*!40000 ALTER TABLE `crop` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `dmails`
--

DROP TABLE IF EXISTS `dmails`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `dmails` (
  `id` varbinary(16) NOT NULL,
  `dest_id` varbinary(16) NOT NULL,
  `dest_firstname` text NOT NULL,
  `dest_lastname` text NOT NULL,
  `dest_email` varchar(255) NOT NULL,
  `sender_id` varbinary(16) NOT NULL,
  `sender_firstname` text NOT NULL,
  `sender_lastname` text NOT NULL,
  `sender_email` varchar(255) NOT NULL,
  `thread_id` varbinary(40) NOT NULL,
  `source` enum('dmail','email') NOT NULL,
  `subject` text NOT NULL,
  `summary` text NOT NULL,
  `content` mediumtext NOT NULL,
  `data` longtext NOT NULL,
  `to` varchar(255) NOT NULL,
  `cc` varchar(255) NOT NULL,
  `bcc` varchar(255) NOT NULL,
  `email_header` longtext NOT NULL,
  `folder` text NOT NULL,
  `folder_id` varbinary(40) NOT NULL,
  `folder_tag` varchar(300) NOT NULL,
  `imap_folder` text NOT NULL,
  `publish_time` int(11) unsigned NOT NULL DEFAULT 0,
  `thread_rank` tinyint(4) NOT NULL DEFAULT 0,
  `msg_status` enum('new','seen','archived','deleted','draft','sent','important') NOT NULL DEFAULT 'new',
  `status` enum('draft','sent','deleted') NOT NULL DEFAULT 'draft',
  `read` enum('New','Seen','Archived','Deleted','Important') NOT NULL,
  `seen` tinyint(2) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `sender_id` (`sender_id`),
  KEY `dest_id` (`dest_id`),
  KEY `folder_id` (`folder_id`),
  KEY `thread_id` (`thread_id`),
  KEY `publish_time` (`publish_time`),
  KEY `read` (`read`),
  KEY `msg_status` (`msg_status`),
  KEY `folder_tag` (`folder_tag`(191)),
  KEY `enveloppe` (`dest_email`),
  FULLTEXT KEY `folder` (`folder`),
  FULLTEXT KEY `subject` (`subject`),
  FULLTEXT KEY `contacts` (`dest_lastname`,`dest_firstname`,`sender_lastname`,`sender_firstname`),
  FULLTEXT KEY `message` (`subject`,`content`),
  FULLTEXT KEY `every_text` (`subject`,`content`,`folder`,`dest_firstname`,`dest_lastname`,`sender_firstname`,`sender_lastname`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `dmails`
--

LOCK TABLES `dmails` WRITE;
/*!40000 ALTER TABLE `dmails` DISABLE KEYS */;
/*!40000 ALTER TABLE `dmails` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `font`
--

DROP TABLE IF EXISTS `font`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `font` (
  `sys_id` int(11) NOT NULL AUTO_INCREMENT,
  `family` varchar(256) DEFAULT NULL,
  `name` varchar(128) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `variant` varchar(128) DEFAULT NULL,
  `url` varchar(1024) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `status` enum('active','frozen') CHARACTER SET ascii NOT NULL DEFAULT 'active',
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `family` (`family`),
  KEY `url` (`url`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `font`
--

LOCK TABLES `font` WRITE;
/*!40000 ALTER TABLE `font` DISABLE KEYS */;
/*!40000 ALTER TABLE `font` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `font_face`
--

DROP TABLE IF EXISTS `font_face`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `font_face` (
  `sys_id` int(6) NOT NULL AUTO_INCREMENT,
  `family` varchar(80) NOT NULL,
  `style` varchar(30) NOT NULL,
  `weight` int(2) NOT NULL DEFAULT 400,
  `local1` varchar(80) NOT NULL,
  `local2` varchar(80) NOT NULL,
  `url` varchar(1024) NOT NULL,
  `format` varchar(16) CHARACTER SET ascii NOT NULL,
  `unicode_range` varchar(20) CHARACTER SET ascii NOT NULL,
  `comment` varchar(160) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `family` (`family`),
  KEY `format` (`format`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `font_face`
--

LOCK TABLES `font_face` WRITE;
/*!40000 ALTER TABLE `font_face` DISABLE KEYS */;
/*!40000 ALTER TABLE `font_face` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `font_link`
--

DROP TABLE IF EXISTS `font_link`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `font_link` (
  `sys_id` int(11) NOT NULL AUTO_INCREMENT,
  `family` varchar(256) DEFAULT NULL,
  `name` varchar(128) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `variant` varchar(128) DEFAULT NULL,
  `url` varchar(1024) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `status` enum('active','frozen') CHARACTER SET ascii NOT NULL DEFAULT 'active',
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `family` (`family`),
  KEY `url` (`url`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `font_link`
--

LOCK TABLES `font_link` WRITE;
/*!40000 ALTER TABLE `font_link` DISABLE KEYS */;
/*!40000 ALTER TABLE `font_link` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `group`
--

DROP TABLE IF EXISTS `group`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `group` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `email` varchar(255) NOT NULL,
  `name` varchar(255) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `name` (`name`,`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `group`
--

LOCK TABLES `group` WRITE;
/*!40000 ALTER TABLE `group` DISABLE KEYS */;
/*!40000 ALTER TABLE `group` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `groups_view`
--

DROP TABLE IF EXISTS `groups_view`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `groups_view` (
  `permission` tinyint(4) NOT NULL,
  `vhost` tinyint(4) NOT NULL,
  `username` tinyint(4) NOT NULL,
  `cid` tinyint(4) NOT NULL,
  `fullname` tinyint(4) NOT NULL,
  `name` tinyint(4) NOT NULL,
  `type` tinyint(4) NOT NULL,
  `owner_id` tinyint(4) NOT NULL,
  `cname` tinyint(4) NOT NULL,
  `area` tinyint(4) NOT NULL,
  `aid` tinyint(4) NOT NULL,
  `photo` tinyint(4) NOT NULL,
  `on_banner` tinyint(4) NOT NULL,
  `on_directory` tinyint(4) NOT NULL,
  `on_profile` tinyint(4) NOT NULL,
  `autojoin` tinyint(4) NOT NULL,
  `description` tinyint(4) NOT NULL,
  `keywords` tinyint(4) NOT NULL,
  `headline` tinyint(4) NOT NULL,
  `importance` tinyint(4) NOT NULL,
  `a_order` tinyint(4) NOT NULL,
  `c_order` tinyint(4) NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `groups_view`
--

LOCK TABLES `groups_view` WRITE;
/*!40000 ALTER TABLE `groups_view` DISABLE KEYS */;
/*!40000 ALTER TABLE `groups_view` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `hashtag`
--

DROP TABLE IF EXISTS `hashtag`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `hashtag` (
  `label` varchar(100) NOT NULL,
  `hash_id` varbinary(16) NOT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  KEY `label` (`label`,`hash_id`),
  KEY `ctime` (`ctime`,`mtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `hashtag`
--

LOCK TABLES `hashtag` WRITE;
/*!40000 ALTER TABLE `hashtag` DISABLE KEYS */;
/*!40000 ALTER TABLE `hashtag` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `huber`
--

DROP TABLE IF EXISTS `huber`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `huber` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varbinary(16) NOT NULL,
  `privilege` tinyint(2) NOT NULL DEFAULT 0,
  `expiry_time` int(11) NOT NULL DEFAULT 0,
  `ctime` int(11) NOT NULL,
  `utime` int(11) DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  KEY `ctime` (`ctime`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `huber`
--

LOCK TABLES `huber` WRITE;
/*!40000 ALTER TABLE `huber` DISABLE KEYS */;
INSERT INTO `huber` VALUES (1,'fffffffffffffffe',63,0,1486631522,NULL);
/*!40000 ALTER TABLE `huber` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `hubs`
--

DROP TABLE IF EXISTS `hubs`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `hubs` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varbinary(16) NOT NULL,
  `rank` tinyint(4) NOT NULL DEFAULT 1,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  KEY `rank` (`rank`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `hubs`
--

LOCK TABLES `hubs` WRITE;
/*!40000 ALTER TABLE `hubs` DISABLE KEYS */;
/*!40000 ALTER TABLE `hubs` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `language`
--

DROP TABLE IF EXISTS `language`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `language` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `base` varchar(10) NOT NULL,
  `name` varchar(100) NOT NULL,
  `locale` varchar(100) NOT NULL,
  `state` enum('deleted','active','frozen','replaced') NOT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `locale` (`locale`),
  KEY `base` (`base`),
  KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `language`
--

LOCK TABLES `language` WRITE;
/*!40000 ALTER TABLE `language` DISABLE KEYS */;
/*!40000 ALTER TABLE `language` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `layout`
--

DROP TABLE IF EXISTS `layout`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `layout` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varbinary(16) NOT NULL,
  `author_id` varbinary(16) NOT NULL,
  `hashtag` varchar(500) NOT NULL,
  `type` enum('page','block','menu','header','footer','slider','gallery') NOT NULL DEFAULT 'block',
  `context` enum('page','slider','slideshow','menu','creator','designer') NOT NULL DEFAULT 'creator',
  `editor` enum('designer','creator') CHARACTER SET ascii NOT NULL DEFAULT 'creator',
  `tag` varchar(400) NOT NULL,
  `hash` varchar(500) DEFAULT NULL,
  `device` varchar(2000) DEFAULT NULL,
  `lang` varchar(2000) DEFAULT NULL,
  `author` varchar(80) DEFAULT NULL,
  `comment` varchar(1024) DEFAULT NULL,
  `content` mediumtext DEFAULT NULL,
  `footnote` mediumtext DEFAULT NULL,
  `backup` mediumtext DEFAULT NULL,
  `newbie` mediumtext DEFAULT NULL,
  `expert` mediumtext DEFAULT NULL,
  `tablet` mediumtext NOT NULL,
  `mobile` mediumtext NOT NULL,
  `status` enum('active','deleted','locked','backup','readonly','draft','exported') DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  `version` varchar(10) NOT NULL DEFAULT '1.0.0',
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  UNIQUE KEY `id_2` (`id`),
  UNIQUE KEY `hashtag` (`hashtag`),
  UNIQUE KEY `hash` (`hash`) USING BTREE,
  KEY `author` (`author`),
  KEY `ctime` (`ctime`),
  KEY `mtime` (`mtime`),
  KEY `version` (`version`),
  KEY `ltype` (`context`),
  KEY `tag` (`tag`),
  KEY `author_id` (`author_id`),
  KEY `editor` (`editor`),
  FULLTEXT KEY `content` (`content`)
) ENGINE=InnoDB AUTO_INCREMENT=141 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `layout`
--

LOCK TABLES `layout` WRITE;
/*!40000 ALTER TABLE `layout` DISABLE KEYS */;
INSERT INTO `layout` VALUES (1,'008aea81008aea91','df0db400a22011e0','008aea81008aea91','block','page','designer','008aea81008aea91','008aea81008aea91!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731133,1464731133,'1.2.0'),(2,'00e3b2dd00e3b2f4','df0db400a22011e0','00e3b2dd00e3b2f4','block','page','designer','00e3b2dd00e3b2f4','00e3b2dd00e3b2f4!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765923,1464765923,'1.2.0'),(3,'016fd317016fd327','df0db400a22011e0','016fd317016fd327','block','page','designer','016fd317016fd327','016fd317016fd327!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794700,1464794700,'1.2.0'),(4,'058286bf058286cd','df0db400a22011e0','058286bf058286cd','block','page','designer','058286bf058286cd','058286bf058286cd!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730712,1464730712,'1.2.0'),(5,'0685849c068584ab','df0db400a22011e0','0685849c068584ab','block','page','designer','0685849c068584ab','0685849c068584ab!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731143,1464731143,'1.2.0'),(6,'06da589d06da58af','df0db400a22011e0','06da589d06da58af','block','page','designer','06da589d06da58af','06da589d06da58af!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765933,1464765933,'1.2.0'),(7,'07ff869707ff86a7','df0db400a22011e0','07ff869707ff86a7','block','page','designer','07ff869707ff86a7','07ff869707ff86a7!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794711,1464794711,'1.2.0'),(8,'0b7ed62e0b7ed63d','df0db400a22011e0','0b7ed62e0b7ed63d','block','page','designer','0b7ed62e0b7ed63d','0b7ed62e0b7ed63d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730722,1464730722,'1.2.0'),(9,'0c823b640c823b72','df0db400a22011e0','0c823b640c823b72','block','page','designer','0c823b640c823b72','0c823b640c823b72!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731153,1464731153,'1.2.0'),(10,'0d1be88a0d1be89b','df0db400a22011e0','0d1be88a0d1be89b','block','page','designer','0d1be88a0d1be89b','0d1be88a0d1be89b!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765943,1464765943,'1.2.0'),(11,'0e8bd22f0e8bd240','df0db400a22011e0','0e8bd22f0e8bd240','block','page','designer','0e8bd22f0e8bd240','0e8bd22f0e8bd240!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794722,1464794722,'1.2.0'),(12,'117a1314117a1325','df0db400a22011e0','117a1314117a1325','block','page','designer','117a1314117a1325','117a1314117a1325!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730732,1464730732,'1.2.0'),(13,'127b643c127b644c','df0db400a22011e0','127b643c127b644c','block','page','designer','127b643c127b644c','127b643c127b644c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731163,1464731163,'1.2.0'),(14,'135fd856135fd86d','df0db400a22011e0','135fd856135fd86d','block','page','designer','135fd856135fd86d','135fd856135fd86d!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765954,1464765954,'1.2.0'),(15,'148aa2ce148aa2e4','df0db400a22011e0','148aa2ce148aa2e4','block','page','designer','148aa2ce148aa2e4','148aa2ce148aa2e4!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794732,1464794732,'1.2.0'),(16,'177554d7177554e8','df0db400a22011e0','177554d7177554e8','block','page','designer','177554d7177554e8','177554d7177554e8!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730742,1464730742,'1.2.0'),(17,'1873484818734857','df0db400a22011e0','1873484818734857','block','page','designer','1873484818734857','1873484818734857!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731173,1464731173,'1.2.0'),(18,'1b0fed8c1b0fed9d','df0db400a22011e0','1b0fed8c1b0fed9d','block','page','designer','1b0fed8c1b0fed9d','1b0fed8c1b0fed9d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794743,1464794743,'1.2.0'),(19,'1d16418d1d1641a6','df0db400a22011e0','1d16418d1d1641a6','block','page','designer','1d16418d1d1641a6','1d16418d1d1641a6!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765970,1464765970,'1.2.0'),(20,'1d6f93541d6f9365','df0db400a22011e0','1d6f93541d6f9365','block','page','designer','1d6f93541d6f9365','1d6f93541d6f9365!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730752,1464730752,'1.2.0'),(21,'1e6f15651e6f1571','df0db400a22011e0','1e6f15651e6f1571','block','page','designer','1e6f15651e6f1571','1e6f15651e6f1571!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731183,1464731183,'1.2.0'),(22,'1f0bfc061f0bfc17','df0db400a22011e0','1f0bfc061f0bfc17','block','page','designer','1f0bfc061f0bfc17','1f0bfc061f0bfc17!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765973,1464765973,'1.2.0'),(23,'21a006e321a006f4','df0db400a22011e0','21a006e321a006f4','block','page','designer','21a006e321a006f4','21a006e321a006f4!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794754,1464794754,'1.2.0'),(24,'236a534b236a535d','df0db400a22011e0','236a534b236a535d','block','page','designer','236a534b236a535d','236a534b236a535d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730762,1464730762,'1.2.0'),(25,'2463ed582463ed60','df0db400a22011e0','2463ed582463ed60','block','page','designer','2463ed582463ed60','2463ed582463ed60!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731193,1464731193,'1.2.0'),(26,'2505fd0a2505fd21','df0db400a22011e0','2505fd0a2505fd21','block','page','designer','2505fd0a2505fd21','2505fd0a2505fd21!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765983,1464765983,'1.2.0'),(27,'282f7d1a282f7d2c','df0db400a22011e0','282f7d1a282f7d2c','block','page','designer','282f7d1a282f7d2c','282f7d1a282f7d2c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794765,1464794765,'1.2.0'),(28,'2966441e2966442e','df0db400a22011e0','2966441e2966442e','block','page','designer','2966441e2966442e','2966441e2966442e!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730772,1464730772,'1.2.0'),(29,'2a66dc562a66dc6f','df0db400a22011e0','2a66dc562a66dc6f','block','page','designer','2a66dc562a66dc6f','2a66dc562a66dc6f!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731203,1464731203,'1.2.0'),(30,'2e4142ff2e414312','df0db400a22011e0','2e4142ff2e414312','block','page','designer','2e4142ff2e414312','2e4142ff2e414312!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"}]}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"}]}]}','','','','','',1464765999,1464765999,'1.2.0'),(31,'2ebdc39f2ebdc3b0','df0db400a22011e0','2ebdc39f2ebdc3b0','block','page','designer','2ebdc39f2ebdc3b0','2ebdc39f2ebdc3b0!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794776,1464794776,'1.2.0'),(32,'2f600d7f2f600d90','df0db400a22011e0','2f600d7f2f600d90','block','page','designer','2f600d7f2f600d90','2f600d7f2f600d90!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730782,1464730782,'1.2.0'),(33,'305e0efe305e0f0e','df0db400a22011e0','305e0efe305e0f0e','block','page','designer','305e0efe305e0f0e','305e0efe305e0f0e!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731213,1464731213,'1.2.0'),(34,'314c543b314c544d','df0db400a22011e0','314c543b314c544d','block','page','designer','314c543b314c544d','314c543b314c544d!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"}]}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\"}]}]}','','','','','',1464766004,1464766004,'1.2.0'),(35,'354c8d42354c8d51','df0db400a22011e0','354c8d42354c8d51','block','page','designer','354c8d42354c8d51','354c8d42354c8d51!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794787,1464794787,'1.2.0'),(36,'355b7a93355b7aaa','df0db400a22011e0','355b7a93355b7aaa','block','page','designer','355b7a93355b7aaa','355b7a93355b7aaa!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730792,1464730792,'1.2.0'),(37,'3659291336592923','df0db400a22011e0','3659291336592923','block','page','designer','3659291336592923','3659291336592923!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731223,1464731223,'1.2.0'),(38,'370ccbef370ccc05','df0db400a22011e0','370ccbef370ccc05','block','page','designer','370ccbef370ccc05','370ccbef370ccc05!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":1,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":1,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]}]}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"cvType\":\"menu\",\"flow\":\"horizontal\",\"listClass\":\"\",\"justify\":\"center\",\"kids\":[{\"flow\":\"widget\",\"cvType\":\"button:anchor\",\"className\":\"auto relative\",\"label\":\"Accueil\",\"picto\":\"fa fa-home fa-fw\",\"styleOpt\":{\"width\":\"130px\"},\"url\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 2\",\"styleOpt\":{\"width\":\"130px\"},\"open\":1,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 1\",\"styleOpt\":{\"width\":\"130px\"},\"open\":1,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 2\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"},{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 3\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]},{\"flow\":\"vertical\",\"cvType\":\"button:nested\",\"className\":\"auto relative\",\"label\":\"Menu 3\",\"styleOpt\":{\"width\":\"130px\"},\"open\":0,\"justify\":\"center\",\"picto\":\"\",\"listClass\":\"\",\"listFlow\":\"vertical\",\"slide\":\"vertical\",\"kids\":[{\"flow\":\"vertical\",\"cvType\":\"button:anchor\",\"label\":\"Sous-menu 1\",\"className\":\"xia-menu-item\",\"labelClass\":\"margin-auto\",\"url\":\"\",\"picto\":\"\",\"href\":\"\"}]}]}]}','','','','','',1464766014,1464766014,'1.2.0'),(39,'3b5571403b55714d','df0db400a22011e0','3b5571403b55714d','block','page','designer','3b5571403b55714d','3b5571403b55714d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730802,1464730802,'1.2.0'),(40,'3bd86fb63bd86fc7','df0db400a22011e0','3bd86fb63bd86fc7','block','page','designer','3bd86fb63bd86fc7','3bd86fb63bd86fc7!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794798,1464794798,'1.2.0'),(41,'3c523ae13c523af8','df0db400a22011e0','3c523ae13c523af8','block','page','designer','3c523ae13c523af8','3c523ae13c523af8!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731233,1464731233,'1.2.0'),(42,'3d5df3c83d5df3d9','df0db400a22011e0','3d5df3c83d5df3d9','block','page','designer','3d5df3c83d5df3d9','3d5df3c83d5df3d9!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766024,1464766024,'1.2.0'),(43,'4150f9084150f917','df0db400a22011e0','4150f9084150f917','block','page','designer','4150f9084150f917','4150f9084150f917!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730812,1464730812,'1.2.0'),(44,'42679aef42679aff','df0db400a22011e0','42679aef42679aff','block','page','designer','42679aef42679aff','42679aef42679aff!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794809,1464794809,'1.2.0'),(45,'474a239a474a23ab','df0db400a22011e0','474a239a474a23ab','block','page','designer','474a239a474a23ab','474a239a474a23ab!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730822,1464730822,'1.2.0'),(46,'48cb0d8b48cb0da1','df0db400a22011e0','48cb0d8b48cb0da1','block','page','designer','48cb0d8b48cb0da1','48cb0d8b48cb0da1!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766043,1464766043,'1.2.0'),(47,'48f4703348f47043','df0db400a22011e0','48f4703348f47043','block','page','designer','48f4703348f47043','48f4703348f47043!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794820,1464794820,'1.2.0'),(48,'4cbe73a64cbe73bb','df0db400a22011e0','4cbe73a64cbe73bb','block','page','designer','4cbe73a64cbe73bb','4cbe73a64cbe73bb!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766050,1464766050,'1.2.0'),(49,'4d44f8a34d44f8b3','df0db400a22011e0','4d44f8a34d44f8b3','block','page','designer','4d44f8a34d44f8b3','4d44f8a34d44f8b3!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730832,1464730832,'1.2.0'),(50,'4ec227c74ec227d7','df0db400a22011e0','4ec227c74ec227d7','block','page','designer','4ec227c74ec227d7','4ec227c74ec227d7!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766053,1464766053,'1.2.0'),(51,'4f51cea14f51cea6','ffffffffffffffff','default','block','','designer','default','default!fr!desktop','desktop','{\"fr\": 1}','nobody','','[{\"branch\":[{\"branch\":[{\"branch\":[{\"branch\":null,\"cvType\":\"container:vertical\",\"className\":\"container flow-vertical\",\"parentType\":\"container:horizontal\",\"opt\":{\"css\":{\"width\":\"143px\",\"height\":\"176px\",\"background\":\"rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box\",\"border\":\"1px dashed rgb(240, 128, 128)\"},\"nodeClass\":\"outerLayout\",\"modelOpt\":{\"flag\":\"idle\",\"status\":\"idle\",\"serial\":\"425\"}}}],\"cvType\":\"container:horizontal\",\"className\":\"container flow-horizontal\",\"parentType\":\"container:vertical\",\"opt\":{\"css\":{\"width\":\"274px\",\"height\":\"178px\",\"background\":\"rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box\",\"border\":\"1px dashed rgb(240, 128, 128)\"},\"nodeClass\":\"outerLayout\",\"modelOpt\":{\"flag\":\"idle\",\"status\":\"idle\",\"serial\":\"318\"}}}],\"cvType\":\"container:vertical\",\"className\":\"container flow-vertical\",\"parentType\":\"container:horizontal\",\"opt\":{\"css\":{\"width\":\"276px\",\"height\":\"288px\",\"background\":\"rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box\",\"border\":\"1px dashed rgb(240, 128, 128)\"},\"nodeClass\":\"outerLayout\",\"modelOpt\":{\"flag\":\"idle\",\"status\":\"idle\",\"serial\":\"282\"}}}],\"cvType\":\"container:horizontal\",\"className\":\"container flow-horizontal\",\"parentType\":\"container:root\",\"opt\":{\"css\":{\"width\":\"960px\",\"height\":\"290px\",\"background\":\"rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box\",\"border\":\"2px solid rgb(240, 128, 128)\"},\"nodeClass\":\"outerLayout\",\"modelOpt\":{\"flag\":\"idle\",\"status\":\"idle\",\"serial\":\"273\"}}}]','','','','','','','active',1406321249,1406321249,'1.0.0'),(52,'4f83a6014f83a60f','df0db400a22011e0','4f83a6014f83a60f','block','page','designer','4f83a6014f83a60f','4f83a6014f83a60f!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794831,1464794831,'1.2.0'),(53,'533f4f53533f4f63','df0db400a22011e0','533f4f53533f4f63','block','page','designer','533f4f53533f4f63','533f4f53533f4f63!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730842,1464730842,'1.2.0'),(54,'54bf5ab354bf5ac7','df0db400a22011e0','54bf5ab354bf5ac7','block','page','designer','54bf5ab354bf5ac7','54bf5ab354bf5ac7!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766064,1464766064,'1.2.0'),(55,'5614095656140967','df0db400a22011e0','5614095656140967','block','page','designer','5614095656140967','5614095656140967!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794842,1464794842,'1.2.0'),(56,'593b620a593b621b','df0db400a22011e0','593b620a593b621b','block','page','designer','593b620a593b621b','593b620a593b621b!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730852,1464730852,'1.2.0'),(57,'5ca1365a5ca1366a','df0db400a22011e0','5ca1365a5ca1366a','block','page','designer','5ca1365a5ca1366a','5ca1365a5ca1366a!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794853,1464794853,'1.2.0'),(58,'5e7498255e749835','df0db400a22011e0','5e7498255e749835','block','page','designer','5e7498255e749835','5e7498255e749835!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766080,1464766080,'1.2.0'),(59,'5f3507385f350749','df0db400a22011e0','5f3507385f350749','block','page','designer','5f3507385f350749','5f3507385f350749!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730862,1464730862,'1.2.0'),(60,'609b5438609b5450','df0db400a22011e0','609b5438609b5450','block','page','designer','609b5438609b5450','609b5438609b5450!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[]}','','','','','',1464766083,1464766083,'1.2.0'),(61,'652ff7c8652ff7d9','df0db400a22011e0','652ff7c8652ff7d9','block','page','designer','652ff7c8652ff7d9','652ff7c8652ff7d9!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730872,1464730872,'1.2.0'),(62,'6b28ed206b28ed2d','df0db400a22011e0','6b28ed206b28ed2d','block','page','designer','6b28ed206b28ed2d','6b28ed206b28ed2d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730882,1464730882,'1.2.0'),(63,'6b6568056b656816','df0db400a22011e0','6b6568056b656816','block','page','designer','6b6568056b656816','6b6568056b656816!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794878,1464794878,'1.2.0'),(64,'6bb6ca8f6bb6caa0','df0db400a22011e0','6bb6ca8f6bb6caa0','block','page','designer','6bb6ca8f6bb6caa0','6bb6ca8f6bb6caa0!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794449,1464794449,'1.2.0'),(65,'71259bd171259be0','df0db400a22011e0','71259bd171259be0','block','page','designer','71259bd171259be0','71259bd171259be0!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730892,1464730892,'1.2.0'),(66,'715df4ed715df4ff','df0db400a22011e0','715df4ed715df4ff','block','page','designer','715df4ed715df4ff','715df4ed715df4ff!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794888,1464794888,'1.2.0'),(67,'71b1cd3871b1cd4e','df0db400a22011e0','71b1cd3871b1cd4e','block','page','designer','71b1cd3871b1cd4e','71b1cd3871b1cd4e!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794459,1464794459,'1.2.0'),(68,'7720f62b7720f63c','df0db400a22011e0','7720f62b7720f63c','block','page','designer','7720f62b7720f63c','7720f62b7720f63c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730902,1464730902,'1.2.0'),(69,'775597d6775597e6','df0db400a22011e0','775597d6775597e6','block','page','designer','775597d6775597e6','775597d6775597e6!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794898,1464794898,'1.2.0'),(70,'77ac630677ac6318','df0db400a22011e0','77ac630677ac6318','block','page','designer','77ac630677ac6318','77ac630677ac6318!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794469,1464794469,'1.2.0'),(71,'7d1aab157d1aab24','df0db400a22011e0','7d1aab157d1aab24','block','page','designer','7d1aab157d1aab24','7d1aab157d1aab24!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730912,1464730912,'1.2.0'),(72,'7d4ce7617d4ce771','df0db400a22011e0','7d4ce7617d4ce771','block','page','designer','7d4ce7617d4ce771','7d4ce7617d4ce771!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794908,1464794908,'1.2.0'),(73,'7da6ed547da6ed67','df0db400a22011e0','7da6ed547da6ed67','block','page','designer','7da6ed547da6ed67','7da6ed547da6ed67!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794479,1464794479,'1.2.0'),(74,'8316ed958316eda1','df0db400a22011e0','8316ed958316eda1','block','page','designer','8316ed958316eda1','8316ed958316eda1!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730923,1464730923,'1.2.0'),(75,'834650e2834650f5','df0db400a22011e0','834650e2834650f5','block','page','designer','834650e2834650f5','834650e2834650f5!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794918,1464794918,'1.2.0'),(76,'83a1131f83a11335','df0db400a22011e0','83a1131f83a11335','block','page','designer','83a1131f83a11335','83a1131f83a11335!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794489,1464794489,'1.2.0'),(77,'890f56de890f56ee','df0db400a22011e0','890f56de890f56ee','block','page','designer','890f56de890f56ee','890f56de890f56ee!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730933,1464730933,'1.2.0'),(78,'893d4064893d4073','df0db400a22011e0','893d4064893d4073','block','page','designer','893d4064893d4073','893d4064893d4073!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794928,1464794928,'1.2.0'),(79,'899bcb4b899bcb5b','df0db400a22011e0','899bcb4b899bcb5b','block','page','designer','899bcb4b899bcb5b','899bcb4b899bcb5b!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794499,1464794499,'1.2.0'),(80,'8f0a5df78f0a5e07','df0db400a22011e0','8f0a5df78f0a5e07','block','page','designer','8f0a5df78f0a5e07','8f0a5df78f0a5e07!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730943,1464730943,'1.2.0'),(81,'8f387d788f387d8c','df0db400a22011e0','8f387d788f387d8c','block','page','designer','8f387d788f387d8c','8f387d788f387d8c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794938,1464794938,'1.2.0'),(82,'8f96ca628f96ca73','df0db400a22011e0','8f96ca628f96ca73','block','page','designer','8f96ca628f96ca73','8f96ca628f96ca73!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794509,1464794509,'1.2.0'),(83,'9506561095065620','df0db400a22011e0','9506561095065620','block','page','designer','9506561095065620','9506561095065620!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730953,1464730953,'1.2.0'),(84,'9532b09b9532b0aa','df0db400a22011e0','9532b09b9532b0aa','block','page','designer','9532b09b9532b0aa','9532b09b9532b0aa!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794948,1464794948,'1.2.0'),(85,'9591019d959101b3','df0db400a22011e0','9591019d959101b3','block','page','designer','9591019d959101b3','9591019d959101b3!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794519,1464794519,'1.2.0'),(86,'9b01f70d9b01f71c','df0db400a22011e0','9b01f70d9b01f71c','block','page','designer','9b01f70d9b01f71c','9b01f70d9b01f71c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730963,1464730963,'1.2.0'),(87,'9b2ae2a39b2ae2b4','df0db400a22011e0','9b2ae2a39b2ae2b4','block','page','designer','9b2ae2a39b2ae2b4','9b2ae2a39b2ae2b4!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794958,1464794958,'1.2.0'),(88,'9b8b06549b8b0665','df0db400a22011e0','9b8b06549b8b0665','block','page','designer','9b8b06549b8b0665','9b8b06549b8b0665!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794529,1464794529,'1.2.0'),(89,'a0fc6ab4a0fc6ac3','df0db400a22011e0','a0fc6ab4a0fc6ac3','block','page','designer','a0fc6ab4a0fc6ac3','a0fc6ab4a0fc6ac3!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730973,1464730973,'1.2.0'),(90,'a123713ca1237153','df0db400a22011e0','a123713ca1237153','block','page','designer','a123713ca1237153','a123713ca1237153!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794968,1464794968,'1.2.0'),(91,'a1850280a1850292','df0db400a22011e0','a1850280a1850292','block','page','designer','a1850280a1850292','a1850280a1850292!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794539,1464794539,'1.2.0'),(92,'a6f523d8a6f523ea','df0db400a22011e0','a6f523d8a6f523ea','block','page','designer','a6f523d8a6f523ea','a6f523d8a6f523ea!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730983,1464730983,'1.2.0'),(93,'a71c7926a71c7936','df0db400a22011e0','a71c7926a71c7936','block','page','designer','a71c7926a71c7936','a71c7926a71c7936!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794978,1464794978,'1.2.0'),(94,'a77f69b6a77f69cd','df0db400a22011e0','a77f69b6a77f69cd','block','page','designer','a77f69b6a77f69cd','a77f69b6a77f69cd!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794549,1464794549,'1.2.0'),(95,'aced743baced744d','df0db400a22011e0','aced743baced744d','block','page','designer','aced743baced744d','aced743baced744d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730993,1464730993,'1.2.0'),(96,'ad14cabcad14caca','df0db400a22011e0','ad14cabcad14caca','block','page','designer','ad14cabcad14caca','ad14cabcad14caca!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794988,1464794988,'1.2.0'),(97,'ad7b3a3cad7b3a4b','df0db400a22011e0','ad7b3a3cad7b3a4b','block','page','designer','ad7b3a3cad7b3a4b','ad7b3a3cad7b3a4b!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794559,1464794559,'1.2.0'),(98,'b2e5d98db2e5d997','df0db400a22011e0','b2e5d98db2e5d997','block','page','designer','b2e5d98db2e5d997','b2e5d98db2e5d997!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731003,1464731003,'1.2.0'),(99,'b30e3d15b30e3d2d','df0db400a22011e0','b30e3d15b30e3d2d','block','page','designer','b30e3d15b30e3d2d','b30e3d15b30e3d2d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794998,1464794998,'1.2.0'),(100,'b375bafab375bb09','df0db400a22011e0','b375bafab375bb09','block','page','designer','b375bafab375bb09','b375bafab375bb09!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794569,1464794569,'1.2.0'),(101,'b5cd9708b5cd971f','df0db400a22011e0','b5cd9708b5cd971f','block','page','designer','b5cd9708b5cd971f','!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730149,1464730149,'1.2.0'),(102,'b8deb955b8deb965','df0db400a22011e0','b8deb955b8deb965','block','page','designer','b8deb955b8deb965','b8deb955b8deb965!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731013,1464731013,'1.2.0'),(103,'b908d6c7b908d6d7','df0db400a22011e0','b908d6c7b908d6d7','block','page','designer','b908d6c7b908d6d7','b908d6c7b908d6d7!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464795008,1464795008,'1.2.0'),(104,'b9ea67e4b9ea67f4','df0db400a22011e0','b9ea67e4b9ea67f4','block','page','designer','b9ea67e4b9ea67f4','b9ea67e4b9ea67f4!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794580,1464794580,'1.2.0'),(105,'bed70b23bed70b32','df0db400a22011e0','bed70b23bed70b32','block','page','designer','bed70b23bed70b32','bed70b23bed70b32!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731023,1464731023,'1.2.0'),(106,'beff3b2ebeff3b3f','df0db400a22011e0','beff3b2ebeff3b3f','block','page','designer','beff3b2ebeff3b3f','beff3b2ebeff3b3f!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464795018,1464795018,'1.2.0'),(107,'c076f635c076f645','df0db400a22011e0','c076f635c076f645','block','page','designer','c076f635c076f645','c076f635c076f645!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794591,1464794591,'1.2.0'),(108,'c4ce9bb5c4ce9bc9','df0db400a22011e0','c4ce9bb5c4ce9bc9','block','page','designer','c4ce9bb5c4ce9bc9','c4ce9bb5c4ce9bc9!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731033,1464731033,'1.2.0'),(109,'c4f8ff16c4f8ff2b','df0db400a22011e0','c4f8ff16c4f8ff2b','block','page','designer','c4f8ff16c4f8ff2b','c4f8ff16c4f8ff2b!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464795028,1464795028,'1.2.0'),(110,'c7054d98c7054dae','df0db400a22011e0','c7054d98c7054dae','block','page','designer','c7054d98c7054dae','c7054d98c7054dae!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794602,1464794602,'1.2.0'),(111,'c9bb4249c9bb4261','df0db400a22011e0','c9bb4249c9bb4261','block','page','designer','c9bb4249c9bb4261','c9bb4249c9bb4261!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730612,1464730612,'1.2.0'),(112,'cac952e9cac952fa','df0db400a22011e0','cac952e9cac952fa','block','page','designer','cac952e9cac952fa','cac952e9cac952fa!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731043,1464731043,'1.2.0'),(113,'caf2d1bdcaf2d1cf','df0db400a22011e0','caf2d1bdcaf2d1cf','block','page','designer','caf2d1bdcaf2d1cf','caf2d1bdcaf2d1cf!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464795038,1464795038,'1.2.0'),(114,'cd938c0bcd938c1a','df0db400a22011e0','cd938c0bcd938c1a','block','page','designer','cd938c0bcd938c1a','cd938c0bcd938c1a!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794613,1464794613,'1.2.0'),(115,'cfb1de5ecfb1de74','df0db400a22011e0','cfb1de5ecfb1de74','block','page','designer','cfb1de5ecfb1de74','cfb1de5ecfb1de74!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730622,1464730622,'1.2.0'),(116,'d0c26ec6d0c26ed6','df0db400a22011e0','d0c26ec6d0c26ed6','block','page','designer','d0c26ec6d0c26ed6','d0c26ec6d0c26ed6!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731053,1464731053,'1.2.0'),(117,'d0ead4c9d0ead4d9','df0db400a22011e0','d0ead4c9d0ead4d9','block','page','designer','d0ead4c9d0ead4d9','d0ead4c9d0ead4d9!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464795048,1464795048,'1.2.0'),(118,'d4280204d428021c','df0db400a22011e0','d4280204d428021c','block','page','designer','d4280204d428021c','d4280204d428021c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794624,1464794624,'1.2.0'),(119,'d5aadd67d5aadd75','df0db400a22011e0','d5aadd67d5aadd75','block','page','designer','d5aadd67d5aadd75','d5aadd67d5aadd75!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730632,1464730632,'1.2.0'),(120,'d6ba5f4bd6ba5f5b','df0db400a22011e0','d6ba5f4bd6ba5f5b','block','page','designer','d6ba5f4bd6ba5f5b','d6ba5f4bd6ba5f5b!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731063,1464731063,'1.2.0'),(121,'daaf3977daaf398c','df0db400a22011e0','daaf3977daaf398c','block','page','designer','daaf3977daaf398c','daaf3977daaf398c!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794635,1464794635,'1.2.0'),(122,'dba6f1b4dba6f1c5','df0db400a22011e0','dba6f1b4dba6f1c5','block','page','designer','dba6f1b4dba6f1c5','dba6f1b4dba6f1c5!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730642,1464730642,'1.2.0'),(123,'dcb1bc7edcb1bc95','df0db400a22011e0','dcb1bc7edcb1bc95','block','page','designer','dcb1bc7edcb1bc95','dcb1bc7edcb1bc95!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731073,1464731073,'1.2.0'),(124,'e13ee94fe13ee964','df0db400a22011e0','e13ee94fe13ee964','block','page','designer','e13ee94fe13ee964','e13ee94fe13ee964!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794646,1464794646,'1.2.0'),(125,'e19f4791e19f479d','df0db400a22011e0','e19f4791e19f479d','block','page','designer','e19f4791e19f479d','e19f4791e19f479d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730652,1464730652,'1.2.0'),(126,'e2ab161be2ab1629','df0db400a22011e0','e2ab161be2ab1629','block','page','designer','e2ab161be2ab1629','e2ab161be2ab1629!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731083,1464731083,'1.2.0'),(127,'e79d29fce79d2a12','df0db400a22011e0','e79d29fce79d2a12','block','page','designer','e79d29fce79d2a12','e79d29fce79d2a12!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730662,1464730662,'1.2.0'),(128,'e7ce7b1ae7ce7b29','df0db400a22011e0','e7ce7b1ae7ce7b29','block','page','designer','e7ce7b1ae7ce7b29','e7ce7b1ae7ce7b29!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794657,1464794657,'1.2.0'),(129,'e8a71a87e8a71a98','df0db400a22011e0','e8a71a87e8a71a98','block','page','designer','e8a71a87e8a71a98','e8a71a87e8a71a98!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731093,1464731093,'1.2.0'),(130,'ed96f3e9ed96f3fb','df0db400a22011e0','ed96f3e9ed96f3fb','block','page','designer','ed96f3e9ed96f3fb','ed96f3e9ed96f3fb!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730672,1464730672,'1.2.0'),(131,'ee5b7c92ee5b7ca3','df0db400a22011e0','ee5b7c92ee5b7ca3','block','page','designer','ee5b7c92ee5b7ca3','ee5b7c92ee5b7ca3!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794668,1464794668,'1.2.0'),(132,'ee9f861bee9f862e','df0db400a22011e0','ee9f861bee9f862e','block','page','designer','ee9f861bee9f862e','ee9f861bee9f862e!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731103,1464731103,'1.2.0'),(133,'f3926ea5f3926eb5','df0db400a22011e0','f3926ea5f3926eb5','block','page','designer','f3926ea5f3926eb5','f3926ea5f3926eb5!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730682,1464730682,'1.2.0'),(134,'f4579bd3f4579be3','df0db400a22011e0','f4579bd3f4579be3','block','page','designer','f4579bd3f4579be3','f4579bd3f4579be3!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794678,1464794678,'1.2.0'),(135,'f49991ecf49991fb','df0db400a22011e0','f49991ecf49991fb','block','page','designer','f49991ecf49991fb','f49991ecf49991fb!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731113,1464731113,'1.2.0'),(136,'f98e931df98e9333','df0db400a22011e0','f98e931df98e9333','block','page','designer','f98e931df98e9333','f98e931df98e9333!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730692,1464730692,'1.2.0'),(137,'fa90c3b0fa90c3c4','df0db400a22011e0','fa90c3b0fa90c3c4','block','page','designer','fa90c3b0fa90c3c4','fa90c3b0fa90c3c4!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464731123,1464731123,'1.2.0'),(138,'fae01beefae01c05','df0db400a22011e0','fae01beefae01c05','block','page','designer','fae01beefae01c05','fae01beefae01c05!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":979},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464794689,1464794689,'1.2.0'),(139,'faebf90cfaebf921','df0db400a22011e0','faebf90cfaebf921','block','page','designer','faebf90cfaebf921','faebf90cfaebf921!fr!desktop','desktop','{\"fr\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":1099},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"},{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\",\"background-color\":\"rgba(196, 43, 43, 1)\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464765913,1464765913,'1.2.0'),(140,'ff87606fff87607d','df0db400a22011e0','ff87606fff87607d','block','page','designer','ff87606fff87607d','ff87606fff87607d!en!desktop','desktop','{\"en\": 1}','somanos','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','{\"cvType\":\"container:reader\",\"flow\":\"page\",\"context\":\"page\",\"className\":\"full\",\"styleOpt\":{\"width\":\"100%\",\"height\":\"auto\",\"min-height\":668},\"listClass\":\"\",\"kids\":[{\"styleOpt\":{\"width\":\"100%\",\"height\":\"140px\"},\"flow\":\"horizontal\",\"cvType\":\"container:reader\",\"listClass\":\"\"}]}','','','','','',1464730702,1464730702,'1.2.0');
/*!40000 ALTER TABLE `layout` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `login_log`
--

DROP TABLE IF EXISTS `login_log`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `login_log` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `cookie_id` varchar(64) NOT NULL,
  `metadata` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`metadata`)),
  `intime` int(11) DEFAULT NULL,
  `outtime` int(11) DEFAULT NULL,
  PRIMARY KEY (`sys_id`)
) ENGINE=InnoDB AUTO_INCREMENT=264 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `login_log`
--

LOCK TABLES `login_log` WRITE;
/*!40000 ALTER TABLE `login_log` DISABLE KEYS */;
INSERT INTO `login_log` VALUES (1,'7de320057de320117de321027de3210a7de321ab7de321b07de322467de3224c','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599321120,NULL),(2,'7de320057de320117de321027de3210a7de321ab7de321b07de322467de3224c','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599321478,NULL),(3,'ce400882ce40091ece400b34ce400b45ce400ca6ce400cb3ce400df0ce400dfe','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599322878,NULL),(4,'decd013bdecd0148decd0252decd0259decd0304decd030adecd03a7decd03ad','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599322906,NULL),(5,'534e6c0b534e6c18534e6d15534e6d1d534e6dc9534e6dcf534e6e6d534e6e72','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599324954,NULL),(6,'cd174750cd17475ccd174855cd17485ccd17490acd174910cd1749accd1749b3','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599325127,NULL),(7,'58cff5d158cff5dd58cff6d158cff6d858cff78158cff78758cff81d58cff823','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599325771,NULL),(8,'6ebae9916ebae9ac6ebaebac6ebaebbc6ebaed186ebaed266ebaee6e6ebaee7b','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599453721,NULL),(9,'91006af891006b1491006d1991006d2b91006e8d91006e9b91006fde91006fec','{\"range\":[995686400,995687423],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":1,\"ip\":\"59.88.249.152\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599462379,NULL),(10,'f9658315f9658330f96584fdf965850df965864ef965865af9658783f965878f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599463397,NULL),(11,'07a3126a07a3128507a3148707a3149607a315f607a3160307a3174207a3174f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599463429,NULL),(12,'6ebae9916ebae9ac6ebaebac6ebaebbc6ebaed186ebaed266ebaee6e6ebaee7b','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599465932,NULL),(13,'6ebae9916ebae9ac6ebaebac6ebaebbc6ebaed186ebaed266ebaee6e6ebaee7b','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599465957,NULL),(14,'1a801c6f1a801c7a1a801db41a801dbf1a801ee31a801eea1a801f921a801f99','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599467466,NULL),(15,'86694ebd86694ed3866950618669506d866951de866951e9866953718669537d','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599467513,NULL),(16,'5dbe87ab5dbe87ba5dbe88bf5dbe88c65dbe89725dbe89795dbe8a135dbe8a1a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599467559,NULL),(17,'3362da763362da8b3362dc1d3362dc2a3362dde63362ddf33362deff3362df0a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599467855,NULL),(18,'aa67c55aaa67c56baa67c6a0aa67c6aaaa67c77aaa67c782aa67c83caa67c843','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.52\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599469282,NULL),(19,'12436db412436dcc12436fd012436fe01243713f1243714c12437295124372a1','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599470317,NULL),(20,'65a29d8765a29da365a29f9865a29fa865a2a10a65a2a11765a2a25865a2a265','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599476038,NULL),(21,'77aa926777aa928377aa947877aa948777aa95e077aa95ee77aa972677aa9734','{\"range\":[995686400,995687423],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":1,\"ip\":\"59.88.249.152\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599485516,NULL),(22,'f83b7cc9f83b7cd8f83b7e14f83b7e1df83b7ee6f83b7eeff83b7faaf83b7fb1','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599543366,NULL),(23,'dc732bf8dc732c14dc732e1cdc732e2cdc732f9adc732fa8dc7330fcdc733109','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599543660,NULL),(24,'2ea3873b2ea387522ea3890e2ea3891b2ea38a522ea38a5e2ea38b802ea38b8c','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599543797,NULL),(25,'bbc77280bbc7729dbbc77498bbc774a8bbc77613bbc7761fbbc77767bbc77775','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599544818,NULL),(26,'dedef745dedef75cdedef8dadedef8e5dedef9eddedef9f7dedefae3dedefaec','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599545419,NULL),(27,'18df8a1e18df8a3918df8c2e18df8c3e18df8d9f18df8dad18df8ee818df8ef5','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599545581,NULL),(28,'2c4c642a2c4c64372c4c653b2c4c65452c4c66122c4c66182c4c66a72c4c66ad','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599551096,NULL),(29,'a65e4e63a65e4e7fa65e5072a65e5083a65e527ca65e528aa65e53dba65e53e8','{\"range\":\"\",\"country\":\"FR\",\"region\":\"\",\"city\":\"\",\"ll\":[46,2],\"metro\":0,\"area\":100,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb09:e017:aeb:84f5:2940:9f2:a88e\",\"ua\":\"Mozilla/5.0 (Linux; Android 10; CPH1941) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.81 Mobile Safari/537.36\"}',1599558081,NULL),(30,'e7954a80e7954a8ee7954b6ee7954b74e7954c09e7954c0ee7954c97e7954c9c','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599558340,NULL),(31,'d88768c0d88768dbd8876accd8876adcd8876c36d8876c43d8876d80d8876d8d','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599560859,NULL),(32,'b69f9586b69f95a3b69f979ab69f97acb69f98fcb69f990bb69f9a4cb69f9a5a','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599562066,NULL),(33,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2872158208,2872158719],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Ernakulam\",\"ll\":[9.9671,76.2904],\"metro\":0,\"area\":200,\"ip\":\"171.49.168.161\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599562156,NULL),(34,'92a6337f92a6339a92a6359392a635a392a6370592a6371292a6385592a63862','{\"range\":[995686400,995687423],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":1,\"ip\":\"59.88.249.152\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599566744,NULL),(35,'21f2bc0d21f2bc2921f2be4121f2be5121f2bfbf21f2bfcd21f2c11721f2c124','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599573840,NULL),(36,'299675e429967601299677f229967802299679592996796629967aa429967ab1','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599576000,NULL),(37,'374eab68374eab78374eac6c374eac74374ead17374ead1d374eadb2374eadb7','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599576037,NULL),(38,'6978d8b86978d8ce6978daa26978daae6978dc0f6978dc1b6978dd646978dd71','{\"range\":[995686400,995687423],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":1,\"ip\":\"59.88.249.152\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599630660,NULL),(39,'304960233049602f304961353049613c304961ed304961f4304962963049629c','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599636601,NULL),(40,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599644900,NULL),(41,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599644922,NULL),(42,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599644984,NULL),(43,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599645020,NULL),(44,'ed5cad5fed5cad7bed5caf6ded5caf7ded5cb0daed5cb0e8ed5cb22aed5cb237','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599645115,NULL),(45,'d3c9ef06d3c9ef14d3c9f030d3c9f039d3c9f0f3d3c9f0fad3c9f19fd3c9f1a5','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599645865,NULL),(46,'9ed054b89ed054d29ed056d09ed056df9ed0583f9ed0584b9ed0598a9ed05996','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599648353,NULL),(47,'b1fd99e8b1fd9a00b1fd9be8b1fd9bf8b1fd9d54b1fd9d62b1fd9ea1b1fd9eaf','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599648393,NULL),(48,'df0be594df0be5a3df0be6afdf0be6b6df0be762df0be768df0be7fedf0be804','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599648460,NULL),(49,'b7c9c789b7c9c7a4b7c9c998b7c9c9a9b7c9cb07b7c9cb14b7c9cc4cb7c9cc59','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599648937,NULL),(50,'5d7406295d74063c5d7407765d7407805d74084b5d7408525d7409055d74090c','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649102,NULL),(51,'729823157298233172982520729825307298268872982695729827c9729827d6','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649143,NULL),(52,'93177f9193177fac931781a4931781b5931783129317831e9317845a93178467','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649337,NULL),(53,'fea2293afea22955fea22b52fea22b62fea22cc0fea22cccfea22e0efea22e1b','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649375,NULL),(54,'22974a9022974aac22974cb222974cc122974e1b22974e2722974f5d22974f69','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649447,NULL),(55,'482a054c482a0567482a075a482a0769482a08c0482a08ce482a0a0c482a0a19','{\"range\":[2057622528,2057623551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":500,\"ip\":\"122.164.213.199\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599649498,NULL),(56,'fc86a4e2fc86a4fbfc86a707fc86a717fc86a878fc86a885fc86a9c7fc86a9d4','{\"range\":[1048645184,1048645247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"ip\":\"62.129.14.113\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599657109,NULL),(57,'e487b5c0e487b5dae487b7dbe487b7eae487b94be487b958e487ba9ee487baab','{\"range\":[631898112,632029183],\"country\":\"FR\",\"region\":\"\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"\",\"ll\":[48.8582,2.3387],\"metro\":0,\"area\":500,\"ip\":\"37.171.41.251\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36\"}',1599658811,NULL),(58,'4bd7c8f04bd7c9024bd7ca354bd7ca3d4bd7cb024bd7cb0a4bd7cbbb4bd7cbc1','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599661295,NULL),(59,'41f6942c41f6944741f6963441f6964441f6979741f697a341f698dc41f698e8','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.54\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599661906,NULL),(60,'c572c4adc572c4c6c572c631c572c63bc572c728c572c731c572c80ac572c813','{\"range\":[1048645184,1048645247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"ip\":\"62.129.14.113\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36 Edg/84.0.522.52\"}',1599663044,NULL),(61,'fb1cad09fb1cad19fb1cae62fb1cae6cfb1caf42fb1caf49fb1cb00cfb1cb013','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599663110,NULL),(62,'e715a2e2e715a2fce715a4ece715a4fde715a64fe715a65ee715a794e715a7a2','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36 Edg/85.0.564.44\"}',1599663512,NULL),(63,'773dded1773ddefb773ddfe5773ddfec773de084773de089773de116773de11b','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599728095,NULL),(64,'4fa912824fa9129e4fa9149c4fa914ac4fa917704fa917814fa918e14fa918ef','{\"range\":[3577208064,3577208319],\"country\":\"CH\",\"region\":\"BE\",\"eu\":\"0\",\"timezone\":\"Europe/Zurich\",\"city\":\"Zollikofen\",\"ll\":[46.999,7.4581],\"metro\":0,\"area\":100,\"ip\":\"213.55.221.146\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36\"}',1599728991,NULL),(65,'1d07bb201d07bb2e1d07bc311d07bc391d07bcdf1d07bce61d07bd811d07bd86','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.55\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1599735899,NULL),(66,'22023dfa22023e1422023fc022023fcc220240ef220240fb2202420522024210','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599742238,NULL),(67,'159ddf9f159ddfb9159de19f159de1ae159de2f4159de301159de42a159de436','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599809212,NULL),(68,'5c9d2b585c9d2b695c9d2c775c9d2c7f5c9d2d2f5c9d2d365c9d2dd45c9d2dda','{\"range\":[1975819264,1975820287],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Aluva\",\"ll\":[10.1065,76.3548],\"metro\":0,\"area\":20,\"ip\":\"117.196.159.110\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599816215,NULL),(69,'74c4bb8574c4bb9574c4bcad74c4bcb474c4bd6e74c4bd7474c4be1774c4be1d','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599816264,NULL),(70,'727dcb04727dcb1f727dcd0f727dcd1e727dce76727dce83727dcfc1727dcfcd','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599821806,NULL),(71,'82682fbb82682fcc826831238268312d8268321a82683222826832f882683300','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599821848,NULL),(72,'e92e08c1e92e08dbe92e0b77e92e0b89e92e0cf4e92e0d02e92e0e35e92e0e42','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599824532,NULL),(73,'227823712278238f22782596227825a82278270a227827192278285622782864','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599824670,NULL),(74,'d2db1b40d2db1b5bd2db1d1dd2db1d2bd2db1e6dd2db1e79d2db1f9dd2db1fa9','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599825832,NULL),(75,'c7f617c0c7f617dcc7f619d2c7f619e0c7f61b49c7f61b56c7f61c9fc7f61cab','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599828050,NULL),(76,'c550e586c550e59bc550e6f0c550e6f9c550e7ddc550e7e5c550e8b5c550e8bd','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599830237,NULL),(77,'5c3bba895c3bbaa75c3bbc9c5c3bbcac5c3bbe055c3bbe145c3bbf535c3bbf60','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599830351,NULL),(78,'881d20fe881d2113881d221c881d2223881d22cb881d22d1881d236b881d2372','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599830460,NULL),(79,'b7769181b7769193b77692d5b77692deb77693b8b77693c1b7769488b7769491','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599830525,NULL),(80,'701794cb701794dd701795dd701795e47017968a701796907017972a7017972f','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599834776,NULL),(81,'c0422748c0422760c0422939c0422949c0422a8cc0422a99c0422bc3c0422bcf','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599836640,NULL),(82,'d5c7e6fed5c7e70dd5c7e851d5c7e85cd5c7e93cd5c7e945d5c7ea0fd5c7ea18','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599836759,NULL),(83,'e373723ae373724be3737383e373738ce373745ce3737463e3737520e3737527','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599837040,NULL),(84,'0f2f831e0f2f833b0f2f85080f2f85180f2f865c0f2f866b0f2f879c0f2f87aa','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599839669,NULL),(85,'4c33cefa4c33cf164c33d10e4c33d11f4c33d2884c33d2944c33d3da4c33d3e6','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599846660,NULL),(86,'a66c23dca66c23efa66c254ba66c2556a66c2643a66c264ba66c2720a66c2729','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599847678,NULL),(87,'9475e5579475e5639475e6389475e63f9475e6cb9475e6d19475e7549475e75a','{\"range\":[1975819264,1975820287],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Aluva\",\"ll\":[10.1065,76.3548],\"metro\":0,\"area\":20,\"ip\":\"117.196.159.110\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599848989,NULL),(88,'621682de621682f5621684af621684bc6216861c62168627621687cb621687d8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599851403,NULL),(89,'f11fb02bf11fb049f11fb240f11fb250f11fb3b0f11fb3c0f11fb505f11fb512','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.101 YaBrowser/20.7.0.1230 Yowser/2.5 Yptp/1.23 Safari/537.36\"}',1599899242,NULL),(90,'f777961df777962cf777973af7779741f77797e8f77797eef7779888f777988d','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599993390,NULL),(91,'92b2712a92b2713792b2720b92b2721192b2729e92b272a392b2732292b27327','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1599997516,NULL),(92,'08b1436108b1437c08b1457308b1458208b146e708b146f408b1483608b14842','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.39\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600048434,NULL),(93,'987b4b57987b4b64987b4c56987b4c5c987b4cfe987b4d04987b4d98987b4d9e','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.39\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600048638,NULL),(94,'7511cd357511cd4e7511cf217511cf2f7511d06c7511d0787511d19f7511d1ab','{\"range\":[996286464,996290559],\"country\":\"IN\",\"region\":\"\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"\",\"ll\":[20,77],\"metro\":0,\"area\":1000,\"ip\":\"59.98.35.66\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600061562,NULL),(95,'4c8a264d4c8a26684c8a284c4c8a285e4c8a29b94c8a29c64c8a2b034c8a2b10','{\"range\":[996286464,996290559],\"country\":\"IN\",\"region\":\"\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"\",\"ll\":[20,77],\"metro\":0,\"area\":1000,\"ip\":\"59.98.35.66\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600062799,NULL),(96,'b38053abb38053c7b38055d1b38055e0b3805749b3805756b380589fb38058ab','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600069729,NULL),(97,'bf391798bf3917b1bf391976bf391985bf391ababf391ac6bf391be0bf391beb','{\"range\":[2962575360,2962579455],\"country\":\"FR\",\"region\":\"\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"\",\"ll\":[48.8582,2.3387],\"metro\":0,\"area\":500,\"ip\":\"176.149.86.1\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.101 YaBrowser/20.7.0.1230 Yowser/2.5 Yptp/1.23 Safari/537.36\"}',1600070186,NULL),(98,'0aa2fab50aa2fac90aa2fc3b0aa2fc470aa2fd560aa2fd610aa2fe5b0aa2fe65','{\"range\":[1555589120,1555590143],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":200,\"ip\":\"92.184.106.105\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36 Edg/84.0.522.52\"}',1600075032,NULL),(99,'240679e824067a0724067c3424067c4524067da024067dac24067ee024067eec','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600077749,NULL),(100,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143185,NULL),(101,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143193,NULL),(102,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143248,NULL),(103,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143276,NULL),(104,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143301,NULL),(105,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143337,NULL),(106,'bd97d0a8bd97d0bfbd97d22cbd97d236bd97d32cbd97d334bd97d40bbd97d413','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.11\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143745,NULL),(107,'4c9430824c94309b4c9432914c94329f4c9433ee4c9433fa4c94352c4c943538','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600143854,NULL),(108,'baa13dd1baa13de3baa13f04baa13f0bbaa13fc4baa13fcbbaa1406ebaa14073','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600144039,NULL),(109,'4f5a0f0c4f5a0f274f5a11474f5a11574f5a12d04f5a12dc4f5a14354f5a1442','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600144289,NULL),(110,'05f1eee005f1eefc05f1f0ef05f1f10005f1f26205f1f26f05f1f3b005f1f3bc','{\"range\":[1975819264,1975820287],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Aluva\",\"ll\":[10.1065,76.3548],\"metro\":0,\"area\":20,\"ip\":\"117.196.159.110\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600150261,NULL),(111,'770bceab770bcec5770bd0be770bd0cd770bd22b770bd239770bd376770bd383','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600151251,NULL),(112,'c48d9f37c48d9f4fc48da0e6c48da0f3c48da204c48da20fc48da30ac48da314','{\"range\":[1975819264,1975820287],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Aluva\",\"ll\":[10.1065,76.3548],\"metro\":0,\"area\":20,\"ip\":\"117.196.159.110\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600156111,NULL),(113,'0acdd4810acdd4920acdd5be0acdd5c80acdd68b0acdd6930acdd7410acdd749','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600159241,NULL),(114,'6df4a4856df4a4a06df4a68e6df4a69d6df4a7f86df4a8046df4a9416df4a94d','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600163006,NULL),(115,'90e3adbf90e3add590e3af4390e3af4d90e3b04590e3b04e90e3b12b90e3b134','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600167178,NULL),(116,'a4965b32a4965b4ca4965dbca4965dd3a4966042a4966050a49661b5a49661c2','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.11\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600167301,NULL),(117,'efb7294aefb72964efb72b4cefb72b5befb72d93efb72da1efb72f52efb72f58','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600172865,NULL),(118,'f2255157f2255173f225535cf225536df22554cdf22554dcf225561ff225562c','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600175485,NULL),(119,'440ded64440ded78440deede440deee9440defda440defe4440df0bf440df0c9','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600176065,NULL),(120,'566be9a6566be9c1566bebca566bebdb566bed3c566bed49566bee87566bee93','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.1\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600176999,NULL),(121,'89ca233189ca234d89ca25a989ca25bc89ca272489ca273389ca287889ca2885','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.1\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600177037,NULL),(122,'bc987a4dbc987a6cbc987c6fbc987c80bc987de2bc987defbc987f30bc987f3c','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600177321,NULL),(123,'4330ae274330ae424330b1114330b1244330b2884330b2964330b3cf4330b3db','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600177340,NULL),(124,'4cc18a2e4cc18a4b4cc18c564cc18c674cc18dca4cc18dd64cc18f154cc18f21','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600177378,NULL),(125,'6f6243076f6243236f62452f6f62453f6f6246ab6f6246b96f6248056f624811','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600177442,NULL),(126,'61427419614274336142761e6142762c6142778e6142779c614278e4614278f0','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.10\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600178800,NULL),(127,'e00e3caae00e3cc8e00e3efce00e3f0ae00e4070e00e4081e00e4285e00e4299','{\"range\":[1405747200,1405749247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":1,\"ip\":\"83.202.6.142\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600179367,NULL),(128,'2db03b3c2db03b4b2db03c622db03c6b2db03d212db03d272db03dd02db03dd5','{\"range\":[1405747200,1405749247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":1,\"ip\":\"83.202.6.142\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600179455,NULL),(129,'fb4e09fdfb4e0a11fb4e0b97fb4e0ba5fb4e0cbafb4e0cc5fb4e0dc2fb4e0dcc','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:3146:4b57:2e6d:91d8\",\"ua\":\"Mozilla/5.0 (Linux; Android 10; CPH1941) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.101 Mobile Safari/537.36\"}',1600179523,NULL),(130,'291d6829291d6838291d6933291d693b291d69e6291d69ec291d6a81291d6a87','{\"range\":[1405747200,1405749247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":1,\"ip\":\"83.202.6.142\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600179885,NULL),(131,'cef8864fcef8866bcef88865cef88875cef889dbcef889e8cef88b31cef88b3d','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600225677,NULL),(132,'4b6550f04b65510b4b6552f04b6553004b6554604b65546d4b6555ad4b6555bb','{\"range\":[1975819264,1975820287],\"country\":\"IN\",\"region\":\"KL\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Aluva\",\"ll\":[10.1065,76.3548],\"metro\":0,\"area\":20,\"ip\":\"117.196.159.110\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600238546,NULL),(133,'70ebd94d70ebd95c70ebda7470ebda7e70ebdb3a70ebdb4070ebdbeb70ebdbf1','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600242588,NULL),(134,'70ebd94d70ebd95c70ebda7470ebda7e70ebdb3a70ebdb4070ebdbeb70ebdbf1','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600244864,NULL),(135,'70ebd94d70ebd95c70ebda7470ebda7e70ebdb3a70ebdb4070ebdbeb70ebdbf1','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600244916,NULL),(136,'70ebd94d70ebd95c70ebda7470ebda7e70ebdb3a70ebdb4070ebdbeb70ebdbf1','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600245803,NULL),(137,'70ebd94d70ebd95c70ebda7470ebda7e70ebdb3a70ebdb4070ebdbeb70ebdbf1','{\"range\":[1733207040,1733207551],\"country\":\"IN\",\"region\":\"TN\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Chennai\",\"ll\":[13.087,80.2456],\"metro\":0,\"area\":100,\"ip\":\"103.78.165.12\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600245816,NULL),(138,'9fe205fe9fe2060d9fe2072f9fe207379fe207f89fe208009fe208af9fe208b6','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600263397,NULL),(139,'5e4453985e4453b45e4455cf5e4455e05e4457505e44575e5e4458ad5e4458ba','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600265006,NULL),(140,'7a85b16b7a85b17d7a85b2ec7a85b2f77a85b4197a85b4247a85b5337a85b53d','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600265060,NULL),(141,'aea3bdf5aea3be0eaea3bfe3aea3bff2aea3c13eaea3c14baea3c27faea3c28c','{\"range\":[1048645184,1048645247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"ip\":\"62.129.14.113\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600269435,NULL),(142,'170dd872170dd88d170dda8a170dda9a170ddbfc170ddc0a170ddd53170ddd60','{\"range\":[1048645184,1048645247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"ip\":\"62.129.14.113\",\"ua\":\"Mozilla/5.0 (Linux; Android 10; CPH1941) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.101 Mobile Safari/537.36\"}',1600269684,NULL),(143,'d5f39f40d5f39f5dd5f3a17ad5f3a18bd5f3a2f7d5f3a306d5f3a44bd5f3a459','{\"range\":[1048645184,1048645247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"ip\":\"62.129.14.113\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600270358,NULL),(144,'048ac5f8048ac60f048ac7c6048ac7d5048ac90a048ac917048aca36048aca42','{\"range\":[1414258688,1414260735],\"country\":\"CH\",\"region\":\"VD\",\"eu\":\"0\",\"timezone\":\"Europe/Zurich\",\"city\":\"Renens\",\"ll\":[46.5399,6.5881],\"metro\":0,\"area\":1,\"ip\":\"84.75.226.146\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600328420,NULL),(145,'8508bfa68508bfb78508c1148508c11e8508c20a8508c2138508c2e38508c2eb','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600331102,NULL),(146,'c5b8f664c5b8f672c5b8f773c5b8f77ac5b8f819c5b8f81fc5b8f8adc5b8f8b3','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600333035,NULL),(147,'aa817ab6aa817ac5aa817bdeaa817be7aa817c96aa817c9daa817d3baa817d41','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600333861,NULL),(148,'acd05a60acd05a79acd05c5aacd05c6aacd05dc2acd05dcfacd05f14acd05f21','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600336859,NULL),(149,'b71ce3f9b71ce40ab71ce550b71ce55ab71ce63bb71ce644b71ce717b71ce71f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600336888,NULL),(150,'9aebc5749aebc5909aebc78c9aebc79b9aebc8f59aebc9029aebca429aebca4d','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600336950,NULL),(151,'ce0e9c28ce0e9c35ce0e9d5bce0e9d64ce0e9e2cce0e9e34ce0e9eeece0e9ef5','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600336956,NULL),(152,'efc4b8feefc4b90fefc4b9f9efc4ba00efc4baa2efc4baa7efc4bb3aefc4bb3f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600336971,NULL),(153,'fad5e186fad5e19bfad5e2eafad5e2f3fad5e39afad5e3a0fad5e433fad5e438','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600337000,NULL),(154,'67f338ba67f338ca67f339f067f339f867f33abd67f33ac467f33b7767f33b7e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb00:d9:1200:29e0:c11d:8e14:f195\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36\"}',1600340623,NULL),(155,'6d6dd5346d6dd54f6d6dd7466d6dd7556d6dd8bd6d6dd8cb6d6dda136d6dda20','{\"range\":[3577208832,3577210879],\"country\":\"CH\",\"region\":\"ZH\",\"eu\":\"0\",\"timezone\":\"Europe/Zurich\",\"city\":\"Zurich\",\"ll\":[47.3664,8.5546],\"metro\":0,\"area\":50,\"ip\":\"213.55.224.153\",\"ua\":\"Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1\"}',1600341484,NULL),(156,'b8d4938ab8d493b4b8d496cfb8d496e2b8d49864b8d49873b8d499b6b8d499c3','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb00:d9:1200:29e0:c11d:8e14:f195\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600341620,NULL),(157,'47b2314647b2316347b2335947b2336947b234c747b234d347b2361047b2361d','{\"range\":[1405747200,1405749247],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":1,\"ip\":\"83.202.6.142\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600357327,NULL),(158,'eef4d315eef4d331eef4d527eef4d537eef4d695eef4d6a2eef4d7e3eef4d7f0','{\"range\":[631898112,632029183],\"country\":\"FR\",\"region\":\"\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"\",\"ll\":[48.8582,2.3387],\"metro\":0,\"area\":500,\"ip\":\"37.170.47.155\",\"ua\":\"Mozilla/5.0 (Linux; Android 10; SNE-LX1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.101 Mobile Safari/537.36\"}',1600361524,NULL),(159,'ab8c0cbbab8c0cd8ab8c0ec8ab8c0ed8ab8c1032ab8c103eab8c117fab8c118c','{\"range\":[1977143296,1977145343],\"country\":\"IN\",\"region\":\"AP\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Medarametla\",\"ll\":[15.7247,80.0197],\"metro\":0,\"area\":50,\"ip\":\"117.216.212.81\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600408249,NULL),(160,'c422d57ac422d595c422d79fc422d7afc422d90ec422d91bc422da62c422da6f','{\"range\":[1977143296,1977145343],\"country\":\"IN\",\"region\":\"AP\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Medarametla\",\"ll\":[15.7247,80.0197],\"metro\":0,\"area\":50,\"ip\":\"117.216.212.81\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600408437,NULL),(161,'40d1efc440d1efe040d1f1fc40d1f20e40d1f37540d1f38240d1f4c840d1f4d4','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600411850,NULL),(162,'84261aaa84261ac484261cbb84261ccb84261e2d84261e3b84261f8284261f8f','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600412050,NULL),(163,'c7c05499c7c054b2c7c0568fc7c0569fc7c057f7c7c05805c7c05947c7c05954','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600412779,NULL),(164,'7b2671807b26719b7b2673ae7b2673be7b2675247b2675317b26767b7b267688','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600413861,NULL),(165,'4b5dffc24b5dffdd4b5e01d64b5e01e74b5e035a4b5e03674b5e04ba4b5e04c6','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600416298,NULL),(166,'d30554dbd30554f7d30556f7d3055706d305586cd3055879d30559bfd30559cb','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600416556,NULL),(167,'590402fd5904031b5904051e5904052e59040693590406a0590407e8590407f4','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600416623,NULL),(168,'cd03b392cd03b3a6cd03b4facd03b504cd03b5ebcd03b5f3cd03b6c3cd03b6cb','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600416819,NULL),(169,'d333d96bd333d983d333db42d333db50d333dc8ed333dc99d333ddbad333ddc5','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600417758,NULL),(170,'345e2819345e2832345e2a41345e2a53345e2bc0345e2bcd345e2d19345e2d26','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600418593,NULL),(171,'044919a2044919bf04491bc904491bd904491d3e04491d4c04491e8f04491e9c','{\"range\":[2732100864,2732101119],\"country\":\"IN\",\"region\":\"PY\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Puducherry\",\"ll\":[11.9338,79.8298],\"metro\":0,\"area\":500,\"ip\":\"162.216.141.33\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600419184,NULL),(172,'5506a2405506a2545506a3b45506a3c05506a4b55506a4be5506a59d5506a5a6','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600421753,NULL),(173,'20a5065920a5067520a5087220a5088320a50a8220a50a9220a50c2620a50c35','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15\"}',1600425550,NULL),(174,'7b3d87ab7b3d87c87b3d899d7b3d89ad7b3d8af57b3d8b027b3d8c3b7b3d8c47','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600425713,NULL),(175,'8b0aead38b0aeaee8b0aece68b0aecf68b0aee598b0aee678b0aefae8b0aefbb','{\"range\":[1977124864,1977126911],\"country\":\"IN\",\"region\":\"JK\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"Srinagar\",\"ll\":[34.0857,74.8056],\"metro\":0,\"area\":200,\"ip\":\"117.216.142.140\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600434737,NULL),(176,'9cdac0e09cdac0f59cdac2a79cdac2b59cdac3ec9cdac3f89cdac5139cdac51d','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1600443348,NULL),(177,'53f0f42d53f0f44a53f0f64753f0f65753f0f7b453f0f7c353f0f90453f0f913','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:942e:625c:d65a:aedc\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36 Edg/84.0.522.52\"}',1600451406,NULL),(178,'c3e4a604c3e4a619c3e4a73ac3e4a743c3e4a7fdc3e4a803c3e4a8acc3e4a8b2','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36\"}',1600623381,NULL),(179,'7076d5817076d59d7076d7977076d7a77076d9017076d90f7076da4e7076da5b','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1600674342,NULL),(180,'f3cb467cf3cb4697f3cb488af3cb489bf3cb49fcf3cb4a09f3cb4b4cf3cb4b59','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600675174,NULL),(181,'2a886de12a886dee2a886f172a886f1f2a886fcd2a886fd32a8870a32a8870aa','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600675841,NULL),(182,'75ba00ac75ba00c875ba02b975ba02c975ba042075ba042d75ba056875ba0574','{\"range\":[996286464,996290559],\"country\":\"IN\",\"region\":\"\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"\",\"ll\":[20,77],\"metro\":0,\"area\":1000,\"ip\":\"59.98.33.27\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600676071,NULL),(183,'facf596efacf598afacf5b89facf5b97facf5cfefacf5d0bfacf5e57facf5e64','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600676323,NULL),(184,'d7ca464ed7ca4665d7ca47eed7ca47fbd7ca490ed7ca4919d7ca4a12d7ca4a1d','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb00:d9:1200:b5a6:401a:21b3:d594\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600677950,NULL),(185,'32b23af032b23b0432b23c7832b23c8232b23d7d32b23d8732b23e6e32b23e77','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600680149,NULL),(186,'0070d3fa0070d4060070d5150070d51c0070d5d40070d5da0070d6860070d68b','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600680195,NULL),(187,'f34538cef34538e9f3453ae6f3453af6f3453c58f3453c66f3453da8f3453db5','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:559c:6b14:b416:efa\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36 Edg/84.0.522.52\"}',1600683154,NULL),(188,'d6b49c9ed6b49cafd6b49dc0d6b49dc7d6b49e74d6b49e7ad6b49f17d6b49f1d','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:559c:6b14:b416:efa\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600683273,NULL),(189,'10d1df8210d1dfa110d1e19f10d1e1af10d1e31a10d1e32810d1e47210d1e47f','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:ec93:3496:570c:7c85\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600686640,NULL),(190,'521bbb39521bbb55521bbd49521bbd5a521bbeaf521bbebd521bbff4521bc002','{\"range\":[996286464,996290559],\"country\":\"IN\",\"region\":\"\",\"eu\":\"0\",\"timezone\":\"Asia/Kolkata\",\"city\":\"\",\"ll\":[20,77],\"metro\":0,\"area\":1000,\"ip\":\"59.98.33.27\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600687330,NULL),(191,'a6cf0900a6cf091ba6cf0b13a6cf0b23a6cf0c86a6cf0c93a6cf0ddba6cf0de6','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:ec93:3496:570c:7c85\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600689196,NULL),(192,'dc6f20addc6f20badc6f21a5dc6f21acdc6f224ddc6f2252dc6f22e5dc6f22eb','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1600691273,NULL),(193,'c65e2508c65e2525c65e271fc65e272fc65e2883c65e288fc65e29cbc65e29d7','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36\"}',1600693824,NULL),(194,'4a77fa204a77fa3b4a77fc3b4a77fc4d4a77fe474a77fe574a77ffc94a77ffd7','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":10,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb00:d9:1200:d41d:7880:d918:f065\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600764046,NULL),(195,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:d828:7e57:8e35:6fa2\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600767209,NULL),(196,'43cdb1a443cdb1be43cdb39b43cdb3aa43cdb51b43cdb52843cdb65943cdb664','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600771831,NULL),(197,'7ee667787ee667847ee668837ee6688a7ee6693a7ee6693f7ee669df7ee669e5','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600771867,NULL),(198,'38c9e23838c9e25238c9e45538c9e46538c9e5d338c9e5df38c9e72f38c9e73b','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600771907,NULL),(199,'02510f0102510f1c0251113702511148025112b1025112c10251140402511411','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600772950,NULL),(200,'e8a74495e8a744aee8a74676e8a74686e8a747cae8a747d6e8a74902e8a7490d','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600773456,NULL),(201,'3e78bfea3e78bffd3e78c1823e78c1903e78c2a53e78c2af3e78c3b03e78c3ba','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600773552,NULL),(202,'7b8a18d27b8a18e07b8a19ea7b8a19f17b8a1a9e7b8a1aa37b8a1b407b8a1b45','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600779368,NULL),(203,'0ac3824c0ac3825c0ac383a20ac383ac0ac3848e0ac384970ac385670ac3856f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600779427,NULL),(204,'ead6b895ead6b8a2ead6b99fead6b9a7ead6ba59ead6ba5fead6bb02ead6bb07','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600780206,NULL),(205,'a91ffabda91ffac8a91ffbbaa91ffbc2a91ffc6da91ffc74a91ffd0da91ffd13','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600780524,NULL),(206,'fc77a5b7fc77a5c2fc77a6c1fc77a6c9fc77a77ffc77a786fc77a82bfc77a831','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600780665,NULL),(207,'31fd6b0e31fd6b2731fd6d2631fd6d3631fd6ea031fd6eae31fd6ff531fd7002','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1600785047,NULL),(208,'26255297262552b5262555322625554626255779262557882625598226255990','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600785460,NULL),(209,'552330835523309d552332b0552332bf5523341c5523342b5523356755233574','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600785540,NULL),(210,'3dee803c3dee80573dee82763dee82873dee83e43dee83f23dee85393dee8546','{\"range\":\"\",\"country\":\"FR\",\"region\":\"PDL\",\"city\":\"La Chapelle-Basse-Mer\",\"ll\":[47.2775,-1.2852],\"metro\":0,\"area\":200,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb01:306f:f02d:9967:3921:f85:2681\",\"ua\":\"Mozilla/5.0 (Linux; Android 10; CPH1941) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.101 Mobile Safari/537.36\"}',1600786365,NULL),(211,'2b0c7d2f2b0c7d3b2b0c7e412b0c7e492b0c7ef72b0c7efd2b0c7f9b2b0c7fa1','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600786760,NULL),(212,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600797305,NULL),(213,'ed78af03ed78af1eed78b12ded78b13ded78b29ded78b2aaed78b3eced78b3f9','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600797981,NULL),(214,'851a0a6c851a0a7e851a0b96851a0ba0851a0c60851a0c67851a0d1b851a0d21','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600845936,NULL),(215,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846264,NULL),(216,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846270,NULL),(217,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846300,NULL),(218,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846306,NULL),(219,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846329,NULL),(220,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846340,NULL),(221,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846390,NULL),(222,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846396,NULL),(223,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846405,NULL),(224,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846405,NULL),(225,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846451,NULL),(226,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846456,NULL),(227,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846460,NULL),(228,'a550a54ea550a56aa550a772a550a784a550a9a3a550a9b2a550ab11a550ab1e','{\"range\":\"\",\"country\":\"FR\",\"region\":\"IDF\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":5,\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"ip\":\"2a01:cb04:a2e:c100:1984:4c83:d6d0:d34d\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1600846463,NULL),(229,'bc69134fbc69136dbc6915a1bc6915b1bc69173cbc69174bbc6918bbbc6918c8','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846479,NULL),(230,'3d07f5263d07f5403d07f7353d07f7443d07f89f3d07f8ac3d07f9e33d07f9ef','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846486,NULL),(231,'48e4f23e48e4f24948e4f31c48e4f32248e4f3b748e4f3bc48e4f44348e4f449','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600846514,NULL),(232,'5ad25f295ad25f385ad2605d5ad260655ad261905ad261985ad262655ad2626a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600846534,NULL),(233,'a9174b63a9174b7ba9174d2ea9174d3ba9174e6fa9174e79a9174f90a9174f9b','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600846667,NULL),(234,'5989f1975989f1b35989f3ac5989f3bc5989f5165989f5235989f6685989f676','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600848701,NULL),(235,'0d48668a0d4866980d48678e0d4867950d4868370d48683c0d4868d00d4868d5','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600854154,NULL),(236,'ac8c0305ac8c0320ac8c0537ac8c0548ac8c06aaac8c06b8ac8c07feac8c080b','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600867288,NULL),(237,'3b58f2b83b58f2cd3b58f42e3b58f43b3b58f5373b58f5413b58f62e3b58f638','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600867528,NULL),(238,'4a7e27194a7e272c4a7e28654a7e286e4a7e29484a7e29504a7e2a184a7e2a20','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600867561,NULL),(239,'653ec053653ec069653ec1f9653ec206653ec32c653ec336653ec441653ec44c','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600867625,NULL),(240,'86d4553f86d4555886d4573186d4573e86d4587a86d4588586d459a186d459ac','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600867664,NULL),(241,'be86024fbe86026cbe860469be860479be8605debe8605ecbe860731be86073e','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600872969,NULL),(242,'fde816f1fde8170afde818d6fde818e4fde81a1cfde81a27fde81b49fde81b53','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600873150,NULL),(243,'1c6361431c6361581c6362ef1c6362fc1c63641e1c6364291c6365301c63653a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600873191,NULL),(244,'6263ef3b6263ef4e6263f0ae6263f0b86263f1a86263f1b16263f28b6263f294','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36\"}',1600874899,NULL),(245,'f5a585f7f5a58604f5a586ddf5a586e4f5a58776f5a5877cf5a58800f5a58805','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600877320,NULL),(246,'65c04e0665c04e1665c04f5265c04f5b65c0502d65c0503465c050f065c050f7','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 Edg/85.0.564.51\"}',1600934176,NULL),(247,'0d07e5820d07e5a10d07e7930d07e7a40d07e9000d07e90e0d07ea530d07ea5f','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\"}',1600952617,NULL),(248,'66cb4a8d66cb4aa366cb4c1c66cb4c2866cb4d2566cb4d3066cb4e1966cb4e22','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1601051451,NULL),(249,'8431de888431dec88431dfc58431dfcc8431e0758431e07b8431e1168431e11c','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1601051494,NULL),(250,'dee3728cdee372a1dee3742cdee37439dee37552dee3755cdee3765ddee37667','{\"range\":[2961568512,2961568767],\"country\":\"FR\",\"region\":\"PAC\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Avignon\",\"ll\":[43.9483,4.8089],\"metro\":0,\"area\":20,\"ip\":\"176.133.243.95\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1601051657,NULL),(251,'584cb58b584cb59b584cb6f5584cb700584cb7ec584cb7f4584cb8cb584cb8d2','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601051841,NULL),(252,'dfbba1e9dfbba200dfbba3b4dfbba3c2dfbba4e9dfbba4f4dfbba605dfbba610','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601054219,NULL),(253,'031b3e72031b3e7e031b3f7f031b3f86031b4034031b403b031b40d9031b40df','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601055948,NULL),(254,'aeb00938aeb00953aeb00bdeaeb00bf1aeb00e11aeb00e23aeb01017aeb01027','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601057847,NULL),(255,'b88b117eb88b119ab88b13a6b88b13b7b88b1525b88b1534b88b167cb88b168a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601278783,NULL),(256,'bda5333bbda53346bda5343dbda53444bda534edbda534f3bda5358cbda53592','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601279294,NULL),(257,'3987deda3987dee63987dfd83987dfdf3987e0873987e08d3987e1243987e12a','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601279620,NULL),(258,'ea6d8d24ea6d8d3fea6d8f4cea6d8f5dea6d90bfea6d90cdea6d921cea6d922a','{\"range\":[1356320768,1356321791],\"country\":\"FR\",\"region\":\"\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"\",\"ll\":[48.8582,2.3387],\"metro\":0,\"area\":200,\"ip\":\"80.215.210.51\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1601299467,NULL),(259,'f28f3698f28f36aff28f3884f28f3894f28f39ddf28f39eaf28f3b18f28f3b25','{\"range\":[1356312576,1356314623],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Paris\",\"ll\":[48.8543,2.3527],\"metro\":0,\"area\":200,\"ip\":\"80.215.178.221\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.86 YaBrowser/20.8.0.893 Yowser/2.5 Safari/537.36\"}',1601455824,NULL),(260,'6d33998a6d3399966d339a536d339a5a6d339b126d339b186d339b926d339b97','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601458666,NULL),(261,'9f36ed3a9f36ed529f36ef299f36ef389f36f07d9f36f0899f36f1ae9f36f1ba','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601462481,NULL),(262,'7923d77d7923d7957923d9567923d9667923daa67923dab37923dbdc7923dbe9','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601471003,NULL),(263,'59c4b64859c4b66359c4b86b59c4b87c59c4b9d459c4b9e259c4bb1b59c4bb29','{\"range\":[1537580544,1537581055],\"country\":\"FR\",\"region\":\"IDF\",\"eu\":\"1\",\"timezone\":\"Europe/Paris\",\"city\":\"Athis-Mons\",\"ll\":[48.7052,2.3915],\"metro\":0,\"area\":100,\"ip\":\"91.165.159.40\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36\"}',1601471773,NULL);
/*!40000 ALTER TABLE `login_log` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `map_agenda`
--

DROP TABLE IF EXISTS `map_agenda`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `map_agenda` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `agenda_id` varchar(16) NOT NULL,
  `contact_id` varchar(16) NOT NULL,
  `uid` varchar(16) DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `agenda_contact` (`agenda_id`,`contact_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `map_agenda`
--

LOCK TABLES `map_agenda` WRITE;
/*!40000 ALTER TABLE `map_agenda` DISABLE KEYS */;
/*!40000 ALTER TABLE `map_agenda` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `map_chat`
--

DROP TABLE IF EXISTS `map_chat`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `map_chat` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `chat_id` varchar(16) NOT NULL,
  `drumate_id` varchar(16) NOT NULL,
  `is_read` tinyint(1) DEFAULT 0,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `chat_id` (`chat_id`,`drumate_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `map_chat`
--

LOCK TABLES `map_chat` WRITE;
/*!40000 ALTER TABLE `map_chat` DISABLE KEYS */;
/*!40000 ALTER TABLE `map_chat` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `map_tag`
--

DROP TABLE IF EXISTS `map_tag`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `map_tag` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `tag_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `category` enum('group','contact') NOT NULL,
  `mode` enum('chat','mail') NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`,`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `map_tag`
--

LOCK TABLES `map_tag` WRITE;
/*!40000 ALTER TABLE `map_tag` DISABLE KEYS */;
/*!40000 ALTER TABLE `map_tag` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `mark`
--

DROP TABLE IF EXISTS `mark`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `mark` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `author_id` varchar(16) NOT NULL,
  `message_id` varchar(16) NOT NULL,
  `thread_id` varchar(16) DEFAULT NULL,
  `status` enum('new','seen','deleted') NOT NULL DEFAULT 'new',
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `message_id` (`message_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `mark`
--

LOCK TABLES `mark` WRITE;
/*!40000 ALTER TABLE `mark` DISABLE KEYS */;
/*!40000 ALTER TABLE `mark` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `media`
--

DROP TABLE IF EXISTS `media`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `media` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `origin_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `owner_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `host_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `file_path` varchar(1000) DEFAULT NULL,
  `user_filename` varchar(80) DEFAULT NULL,
  `parent_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `parent_path` varchar(1024) NOT NULL,
  `extension` varchar(100) CHARACTER SET ascii DEFAULT NULL,
  `mimetype` varchar(100) NOT NULL,
  `category` varchar(16) NOT NULL DEFAULT 'other',
  `isalink` tinyint(2) unsigned NOT NULL DEFAULT 0,
  `filesize` int(20) unsigned NOT NULL DEFAULT 0,
  `geometry` varchar(200) NOT NULL DEFAULT '0x0',
  `publish_time` int(11) unsigned NOT NULL DEFAULT 0,
  `upload_time` int(11) unsigned NOT NULL DEFAULT 0,
  `last_download` int(11) unsigned NOT NULL DEFAULT 0,
  `download_count` mediumint(8) unsigned NOT NULL DEFAULT 0,
  `metadata` mediumtext DEFAULT NULL,
  `caption` varchar(1024) DEFAULT NULL,
  `status` varchar(20) NOT NULL DEFAULT 'active',
  `approval` enum('submitted','verified','validated','draft','online','offline') DEFAULT 'draft',
  `rank` int(11) NOT NULL DEFAULT 0,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`),
  UNIQUE KEY `filepath` (`file_path`),
  KEY `approval` (`approval`),
  KEY `geometry` (`geometry`),
  KEY `parent_id` (`parent_id`),
  KEY `origin_id` (`origin_id`),
  KEY `file_path` (`file_path`),
  KEY `user_filename` (`user_filename`),
  KEY `category` (`category`),
  FULLTEXT KEY `content` (`caption`,`user_filename`,`file_path`,`metadata`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `media`
--

LOCK TABLES `media` WRITE;
/*!40000 ALTER TABLE `media` DISABLE KEYS */;
INSERT INTO `media` VALUES (1,'525adb21abcad26b','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Photos.special','Photos','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0),(2,'525adb21ad02cba4','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Musics.special','Musics','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0),(3,'525adb21ad5f3f43','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Videos.special','Videos','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0),(4,'525adb21ad841f7b','ffffffffffffffff','ffffffffffffffff','ffffffffffffffff','/Documents.special','Documents','525adb2c861acd4d','/','special','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0),(5,'525adb2c861acd4d','','','ffffffffffffffff','/.folder','','0','/','folder','folder','folder',0,4096,'',0,0,0,0,'0','submitted','active','',0),(6,'b3f03d47b3f03d4c','df0db400a22011e0','df0db400a22011e0','b3f03d47b3f03d4c','/odise-3.drumee.net.public','odise-3.drumee.net','525adb2c861acd4d','/','public','text/plain','hub',0,232652,'0x0',1533230579,1533230579,0,0,NULL,'odise-3.drumee.com','active','submitted',0),(7,'323398cf323398d3','ffffffffffffffff','ffffffffffffffff','','/__trash__.folder','__trash__','525adb2c861acd4d','','folder','folder','folder',0,4096,'0x0',1559824369,1559824369,0,0,NULL,NULL,'hidden','submitted',0),(8,'67570c9867570c9d','ffffffffffffffff','ffffffffffffffff','','/__chat__.folder','__chat__','525adb2c861acd4d','','folder','folder','folder',0,4096,'0x0',1567081665,1567081665,0,0,NULL,NULL,'hidden','submitted',0),(9,'675859fb675859fe','ffffffffffffffff','ffffffffffffffff','','/__chat__/__send__.folder','__send__','67570c9867570c9d','/__chat__','folder','folder','folder',0,4096,'0x0',1567081665,1567081665,0,0,NULL,NULL,'hidden','submitted',0),(10,'6758d36e6758d372','ffffffffffffffff','ffffffffffffffff','','/__chat__/__receive__.folder','__receive__','67570c9867570c9d','/__chat__','folder','folder','folder',0,4096,'0x0',1567081665,1567081665,0,0,NULL,NULL,'hidden','submitted',0),(11,'53f82c2e53f82c3c','ffffffffffffffff','','','/__chat__/__upload__.folder','__upload__','67570c9867570c9d','/__chat__','folder','folder','folder',0,4096,'0x0',1593434263,1593434263,0,0,NULL,NULL,'hidden','submitted',0),(13,'de4ca848de4ca860','ffffffffffffffff','','','/wicket','wicket','525adb2c861acd4d','/','dmz','hub','hub',1,0,'0x0',1618331142,1618331142,0,0,'{\"seen\": \"ffffffffffffffff\"}',NULL,'hidden','draft',7);
/*!40000 ALTER TABLE `media` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `media_stats`
--

DROP TABLE IF EXISTS `media_stats`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `media_stats` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) DEFAULT NULL,
  `uid` varchar(16) DEFAULT NULL,
  `sid` varchar(64) DEFAULT NULL,
  `ctime` int(11) unsigned NOT NULL,
  PRIMARY KEY (`sys_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `media_stats`
--

LOCK TABLES `media_stats` WRITE;
/*!40000 ALTER TABLE `media_stats` DISABLE KEYS */;
/*!40000 ALTER TABLE `media_stats` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `member`
--

DROP TABLE IF EXISTS `member`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `member` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `id` varchar(16) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `member`
--

LOCK TABLES `member` WRITE;
/*!40000 ALTER TABLE `member` DISABLE KEYS */;
INSERT INTO `member` VALUES (11,'fffffffffffffffe');
/*!40000 ALTER TABLE `member` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `message`
--

DROP TABLE IF EXISTS `message`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `message` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `pkey` varchar(32) DEFAULT NULL,
  `resource_id` varchar(16) NOT NULL,
  `resource_type` enum('media','comment','link','page','all','*') NOT NULL DEFAULT '*',
  `entity_id` varchar(16) NOT NULL,
  `content` text DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `message_pkey` (`pkey`),
  KEY `resource_id` (`resource_id`),
  KEY `resource_type` (`resource_type`),
  KEY `entity_id` (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `message`
--

LOCK TABLES `message` WRITE;
/*!40000 ALTER TABLE `message` DISABLE KEYS */;
/*!40000 ALTER TABLE `message` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `notice`
--

DROP TABLE IF EXISTS `notice`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `notice` (
  `id` varbinary(64) NOT NULL,
  `dest_email` varchar(255) NOT NULL DEFAULT '',
  `category` enum('invitation','request','rendezvous','event','security','other') NOT NULL DEFAULT 'invitation',
  `sender_id` varbinary(16) NOT NULL,
  `dest_id` varbinary(16) NOT NULL,
  `link_id` varbinary(16) NOT NULL,
  `link_type` enum('community','event','poll') NOT NULL DEFAULT 'community',
  `status` enum('sent','received','open','declined','accepted') NOT NULL DEFAULT 'sent',
  `message` text NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `category` (`category`),
  KEY `status` (`status`),
  KEY `subject_id` (`link_id`),
  KEY `subject_type` (`link_type`),
  FULLTEXT KEY `message` (`message`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `notice`
--

LOCK TABLES `notice` WRITE;
/*!40000 ALTER TABLE `notice` DISABLE KEYS */;
/*!40000 ALTER TABLE `notice` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `notification`
--

DROP TABLE IF EXISTS `notification`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `notification` (
  `sys_id` int(11) NOT NULL AUTO_INCREMENT,
  `id` varbinary(16) NOT NULL,
  `type` enum('chat','message','invitation','event') CHARACTER SET ascii NOT NULL DEFAULT 'message',
  `text` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `notification`
--

LOCK TABLES `notification` WRITE;
/*!40000 ALTER TABLE `notification` DISABLE KEYS */;
/*!40000 ALTER TABLE `notification` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `params`
--

DROP TABLE IF EXISTS `params`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `params` (
  `topic` enum('general','privacy','security','mobile','template') NOT NULL,
  `category` varchar(127) NOT NULL,
  `field` varchar(127) NOT NULL,
  `type` varchar(16) NOT NULL DEFAULT 'any',
  `value` text NOT NULL,
  `pkey` varchar(30) NOT NULL,
  `rank` int(8) NOT NULL DEFAULT 0,
  `share` int(4) NOT NULL DEFAULT 1,
  PRIMARY KEY (`pkey`),
  KEY `share` (`share`),
  KEY `field` (`field`),
  KEY `category` (`category`),
  KEY `type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `params`
--

LOCK TABLES `params` WRITE;
/*!40000 ALTER TABLE `params` DISABLE KEYS */;
INSERT INTO `params` VALUES ('general','identity','birthdate','any','','identity-birthdate',2,1),('general','identity','gender','any','','identity-gender',1,1),('general','identity','residence_city','any','','identity-residence_city',3,1),('general','lang','en','any','off','lang-en',1,1),('general','lang','fr','any','on','lang-fr',0,1),('privacy','myprofile','open','any','off','myprofile-open',3,1),('privacy','myprofile','prudent','any','on','myprofile-prudent',0,1),('privacy','myprofile','standard','any','off','myprofile-standard',1,1),('mobile','other','nop','any','Des ides ???','other-nop',0,1),('security','password','master','any','e10753627bb46af63cbabd3b5969cadadbcd6b91','password-master',0,1),('mobile','phone','phonenumber','any','','phone-phonenumber',0,1),('privacy','communities','communities','any','','privacy-communities',0,1),('privacy','private','admin','any','off','private-admin',0,1),('privacy','private','alter','any','off','private-alter',2,1),('privacy','private','delete','any','off','private-delete',1,1),('privacy','private','invite','any','off','private-invite',3,1),('privacy','private','profile','any','on','private-profile',100,1),('privacy','private','read','any','on','private-read',5,1),('privacy','private','write','any','on','private-write',4,1),('privacy','profile','normal','any','off','profile-normal',1,1),('privacy','profile','open','any','off','profile-open',2,1),('privacy','profile','prudent','any','on','profile-prudent',0,1),('privacy','public','admin','any','off','public-admin',0,1),('privacy','public','alter','any','off','public-alter',2,1),('privacy','public','autojoin','any','off','public-autojoin',104,1),('privacy','public','banner','any','off','public-banner',102,1),('privacy','public','delete','any','off','public-delete',1,1),('privacy','public','directory','any','on','public-directory',101,1),('privacy','public','invite','any','off','public-invite',3,1),('privacy','public','profile','any','on','public-profile',100,1),('privacy','public','read','any','on','public-read',5,1),('privacy','public','write','any','on','public-write',4,1),('security','removal','delegate','any','off','removal-delegate',3,1),('security','removal','freeze','any','off','removal-freeze',0,1),('security','removal','remove','any','off','removal-remove',1,1),('privacy','restricted','admin','any','off','restricted-admin',0,1),('privacy','restricted','alter','any','off','restricted-alter',3,1),('privacy','restricted','delete','any','off','restricted-delete',2,1),('privacy','restricted','directory','any','on','restricted-directory',101,1),('privacy','restricted','invite','any','off','restricted-invite',4,1),('privacy','restricted','profile','any','on','restricted-profile',100,1),('privacy','restricted','read','any','on','restricted-read',6,1),('privacy','restricted','write','any','on','restricted-write',5,1),('security','retrieval','email','any','on','retrieval-email',0,1),('security','retrieval','questions','any','off','retrieval-questions',2,1),('security','retrieval','sms','any','off','retrieval-sms',1,1),('security','session','signle','any','off','session-single',100,1),('security','session','timeout','any','24','session-timeout',0,1),('mobile','sync','agenda','any','off','sync-agenda',1,1),('mobile','sync','directory','any','off','sync-directory',0,1),('mobile','auth','isecure','any','off','sync-isecure',0,1),('general','theme','background','any','','theme-background',100,1),('general','theme','customized','any','','theme-customized',2,1),('general','theme','photo','any','','theme-photo',3,1),('general','theme','standard','any','on','theme-standard',0,1),('general','usage','both','any','on','usage-both',2,1),('general','usage','most_pro','any','off','usage-most_pro',1,1),('general','usage','most_prv','any','off','usage-most_prv',0,1),('general','usage','only_pro','any','off','usage-only_pro',4,1),('general','usage','only_prv','any','off','usage-only_prv',3,1),('general','vibes','dmail','any','on','vibes-dmail',1,1),('general','vibes','notice','any','on','vibes-notice',0,1),('general','vibes','private','any','on','vibes-private',2,1),('general','vibes','public','any','on','vibes-public',4,1),('general','vibes','restricted','any','on','vibes-restricted',3,1);
/*!40000 ALTER TABLE `params` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `permission`
--

DROP TABLE IF EXISTS `permission`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `permission` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `resource_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `entity_id` varchar(512) CHARACTER SET ascii DEFAULT NULL,
  `message` mediumtext DEFAULT NULL,
  `expiry_time` int(11) NOT NULL DEFAULT 0,
  `ctime` int(11) DEFAULT NULL,
  `utime` int(11) DEFAULT NULL,
  `permission` tinyint(4) unsigned NOT NULL,
  `assign_via` enum('system','link','share','no_traversal') DEFAULT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `pkey` (`resource_id`,`entity_id`),
  KEY `entity_id` (`entity_id`),
  KEY `permission` (`permission`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `permission`
--

LOCK TABLES `permission` WRITE;
/*!40000 ALTER TABLE `permission` DISABLE KEYS */;
INSERT INTO `permission` VALUES (1,'*','fffffffffffffffe','',0,1486631522,1545089261,1,'system'),(2,'*','ffffffffffffffff','',0,1545089261,1545089261,1,'system'),(3,'b3f03d47b3f03d4c','ffffffffffffffff','',0,1545392673,1545392673,15,'system'),(4,'default','ffffffffffffffff','Avatar',0,1546714670,1546721869,1,'system'),(5,'525adb2c861acd4d','*','no traversal',0,1601890048,1601890048,1,'no_traversal');
/*!40000 ALTER TABLE `permission` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `position_chat`
--

DROP TABLE IF EXISTS `position_chat`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `position_chat` (
  `entity_id` varchar(16) NOT NULL,
  `chat_sys_id` int(11) unsigned NOT NULL,
  PRIMARY KEY (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `position_chat`
--

LOCK TABLES `position_chat` WRITE;
/*!40000 ALTER TABLE `position_chat` DISABLE KEYS */;
/*!40000 ALTER TABLE `position_chat` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `preferences`
--

DROP TABLE IF EXISTS `preferences`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `preferences` (
  `name` varchar(40) NOT NULL DEFAULT '',
  `user_id` varbinary(16) NOT NULL,
  `last_tab` varchar(255) NOT NULL DEFAULT 'home',
  `home_tab` varchar(255) NOT NULL DEFAULT 'home',
  `general` longtext NOT NULL,
  `privacy` longtext NOT NULL,
  `security` longtext NOT NULL,
  `mobile` longtext NOT NULL,
  `jason` longtext NOT NULL,
  FULLTEXT KEY `general` (`general`,`privacy`,`security`,`mobile`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `preferences`
--

LOCK TABLES `preferences` WRITE;
/*!40000 ALTER TABLE `preferences` DISABLE KEYS */;
/*!40000 ALTER TABLE `preferences` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `profile`
--

DROP TABLE IF EXISTS `profile`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `profile` (
  `user_id` varbinary(16) NOT NULL,
  `username` varchar(40) NOT NULL DEFAULT '',
  `password` varchar(40) NOT NULL DEFAULT '',
  `pseudo` varchar(80) NOT NULL DEFAULT '',
  `firstname` varchar(80) NOT NULL DEFAULT '',
  `secondname` varchar(80) NOT NULL DEFAULT '',
  `nickname` varchar(80) NOT NULL DEFAULT '',
  `first_use` tinyint(1) NOT NULL,
  `lastname` varchar(40) NOT NULL DEFAULT '',
  `email` varchar(120) NOT NULL DEFAULT '',
  `photo_pub` varchar(255) NOT NULL,
  `photo_res` varchar(255) NOT NULL,
  `photo_prv` varchar(255) NOT NULL,
  `alt_email` varchar(120) NOT NULL DEFAULT '',
  `gender` enum('M','F') DEFAULT NULL,
  `birthdate` varchar(255) NOT NULL DEFAULT '',
  `residence_city` varchar(40) NOT NULL DEFAULT '',
  `postcode` tinyint(4) unsigned NOT NULL DEFAULT 0,
  `personal_data` longtext NOT NULL,
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `email` (`email`),
  KEY `postcode` (`postcode`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `profile`
--

LOCK TABLES `profile` WRITE;
/*!40000 ALTER TABLE `profile` DISABLE KEYS */;
/*!40000 ALTER TABLE `profile` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `read_channel`
--

DROP TABLE IF EXISTS `read_channel`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `read_channel` (
  `entity_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `uid` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `ref_sys_id` int(11) unsigned NOT NULL,
  `ctime` int(11) NOT NULL,
  UNIQUE KEY `id` (`entity_id`,`uid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `read_channel`
--

LOCK TABLES `read_channel` WRITE;
/*!40000 ALTER TABLE `read_channel` DISABLE KEYS */;
/*!40000 ALTER TABLE `read_channel` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `read_chat`
--

DROP TABLE IF EXISTS `read_chat`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `read_chat` (
  `entity_id` varchar(16) NOT NULL,
  `uid` varchar(16) DEFAULT NULL,
  `chat_sys_id` int(11) unsigned NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`entity_id`),
  UNIQUE KEY `id` (`entity_id`,`uid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `read_chat`
--

LOCK TABLES `read_chat` WRITE;
/*!40000 ALTER TABLE `read_chat` DISABLE KEYS */;
/*!40000 ALTER TABLE `read_chat` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `seo`
--

DROP TABLE IF EXISTS `seo`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `seo` (
  `sys_id` int(11) NOT NULL AUTO_INCREMENT,
  `key` varchar(25) CHARACTER SET ascii NOT NULL,
  `hashtag` varchar(256) CHARACTER SET ascii NOT NULL,
  `lang` varchar(6) NOT NULL,
  `content` mediumtext NOT NULL,
  `link_data` mediumtext NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `key` (`key`),
  KEY `lang` (`lang`),
  FULLTEXT KEY `content` (`content`),
  FULLTEXT KEY `hashtag` (`hashtag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `seo`
--

LOCK TABLES `seo` WRITE;
/*!40000 ALTER TABLE `seo` DISABLE KEYS */;
/*!40000 ALTER TABLE `seo` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `sites`
--

DROP TABLE IF EXISTS `sites`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `sites` (
  `id` varbinary(16) NOT NULL,
  `rank` tinyint(4) NOT NULL DEFAULT 1,
  PRIMARY KEY (`id`),
  KEY `rank` (`rank`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `sites`
--

LOCK TABLES `sites` WRITE;
/*!40000 ALTER TABLE `sites` DISABLE KEYS */;
/*!40000 ALTER TABLE `sites` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `style`
--

DROP TABLE IF EXISTS `style`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `style` (
  `id` int(8) NOT NULL AUTO_INCREMENT,
  `name` varchar(80) NOT NULL DEFAULT 'My Style',
  `class_name` varchar(100) DEFAULT NULL,
  `selector` varchar(255) NOT NULL,
  `declaration` varchar(12000) CHARACTER SET ascii DEFAULT NULL,
  `comment` varchar(255) NOT NULL DEFAULT 'xxx',
  `status` enum('active','frozen') CHARACTER SET ascii NOT NULL DEFAULT 'active',
  PRIMARY KEY (`id`),
  KEY `className` (`selector`),
  KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `style`
--

LOCK TABLES `style` WRITE;
/*!40000 ALTER TABLE `style` DISABLE KEYS */;
/*!40000 ALTER TABLE `style` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tag`
--

DROP TABLE IF EXISTS `tag`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tag` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `tag_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
  `parent_tag_id` varchar(16) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `position` int(11) unsigned DEFAULT 0,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `name` (`name`),
  UNIQUE KEY `tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tag`
--

LOCK TABLES `tag` WRITE;
/*!40000 ALTER TABLE `tag` DISABLE KEYS */;
/*!40000 ALTER TABLE `tag` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `thread`
--

DROP TABLE IF EXISTS `thread`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `thread` (
  `sys_id` int(11) NOT NULL AUTO_INCREMENT,
  `master_id` varbinary(16) NOT NULL,
  `type` enum('block','media','comment') CHARACTER SET ascii NOT NULL,
  `name` varchar(256) NOT NULL,
  `device` enum('desktop','tablet','mobile') CHARACTER SET ascii NOT NULL DEFAULT 'desktop',
  `lang` varchar(10) CHARACTER SET armscii8 NOT NULL,
  `author_id` varbinary(16) NOT NULL,
  `comment` varchar(256) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  KEY `type` (`type`),
  KEY `master_id` (`master_id`),
  KEY `comment` (`comment`),
  KEY `author_id` (`author_id`),
  KEY `ctime` (`ctime`),
  KEY `device` (`device`),
  KEY `lang` (`lang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `thread`
--

LOCK TABLES `thread` WRITE;
/*!40000 ALTER TABLE `thread` DISABLE KEYS */;
/*!40000 ALTER TABLE `thread` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `time_channel`
--

DROP TABLE IF EXISTS `time_channel`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `time_channel` (
  `entity_id` varchar(16) CHARACTER SET ascii NOT NULL,
  `ref_sys_id` int(11) unsigned NOT NULL,
  `message` mediumtext DEFAULT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `time_channel`
--

LOCK TABLES `time_channel` WRITE;
/*!40000 ALTER TABLE `time_channel` DISABLE KEYS */;
/*!40000 ALTER TABLE `time_channel` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `time_chat`
--

DROP TABLE IF EXISTS `time_chat`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `time_chat` (
  `entity_id` varchar(16) NOT NULL,
  `chat_id` varchar(16) DEFAULT NULL,
  `category` enum('group','contact') NOT NULL,
  `owner_id` varchar(16) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `message` text DEFAULT NULL,
  `status` enum('active','remove','exit') DEFAULT 'active',
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `time_chat`
--

LOCK TABLES `time_chat` WRITE;
/*!40000 ALTER TABLE `time_chat` DISABLE KEYS */;
/*!40000 ALTER TABLE `time_chat` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `trashbin`
--

DROP TABLE IF EXISTS `trashbin`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `trashbin` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `resource_id` varchar(16) NOT NULL,
  `owner_id` varchar(16) NOT NULL,
  `hub_id` varchar(16) NOT NULL,
  `holder_id` varchar(16) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`),
  UNIQUE KEY `id` (`hub_id`,`resource_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `trashbin`
--

LOCK TABLES `trashbin` WRITE;
/*!40000 ALTER TABLE `trashbin` DISABLE KEYS */;
/*!40000 ALTER TABLE `trashbin` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `used_colors`
--

DROP TABLE IF EXISTS `used_colors`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `used_colors` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `rgba` varchar(50) NOT NULL,
  `hexacode` varchar(20) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`)
) ENGINE=InnoDB AUTO_INCREMENT=168 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `used_colors`
--

LOCK TABLES `used_colors` WRITE;
/*!40000 ALTER TABLE `used_colors` DISABLE KEYS */;
INSERT INTO `used_colors` VALUES (1,'rgba(88, 250, 255, 1)','#58FAFF',1527659806),(2,'rgba(148, 255, 70, 1)','#94FF46',1527659808),(3,'rgba(254, 203, 94, 1)','#FECB5E',1527659811),(4,'rgba(223, 255, 98, 1)','#DFFF62',1527659842),(5,'rgba(50, 107, 255, 1)','#326BFF',1527659846),(6,'rgba(254, 68, 57, 1)','#FE4439',1527659850),(7,'rgba(228, 249, 159, 1)','#E4F99F',1527659853),(8,'rgba(24, 70, 253, 1)','#1846FD',1527665630),(9,'rgba(254, 100, 93, 1)','#FE645D',1527674762),(10,'rgba(148, 255, 70, 1)','#94FF46',1527674766),(11,'rgba(148, 255, 70, 1)','#94FF46',1527742804),(12,'rgba(234, 249, 149, 1)','#EAF995',1527744144),(13,'rgba(77, 255, 147, 1)','#4DFF93',1527745640),(14,'rgba(55, 255, 134, 0.84)','#37FF86',1527746287),(15,'rgba(90, 252, 217, 1)','#5AFCD9',1527746349),(16,'rgba(138, 61, 240, 1)','#8A3DF0',1527746356),(17,'rgba(223, 19, 225, 1)','#DF13E1',1527746403),(18,'rgba(255, 61, 38, 1)','#FF3D26',1527746409),(19,'rgba(205, 212, 247, 1)','#CDD4F7',1527746416),(20,'rgba(255, 61, 38, 1)','#FF3D26',1527746424),(21,'rgba(107, 128, 252, 1)','#6B80FC',1527746436),(22,'rgba(206, 248, 232, 1)','#CEF8E8',1527746448),(23,'rgba(175, 255, 128, 1)','#AFFF80',1527746459),(24,'#6B80FC','#6B80FC',1527746495),(25,'rgba(191, 225, 250, 1)','#BFE1FA',1527767432),(26,'rgba(168, 247, 236, 1)','#A8F7EC',1527768177),(27,'rgba(90, 252, 217, 1)','#5AFCD9',1527770226),(28,'rgba(51, 238, 125, 1)','#33EE7D',1527772138),(29,'rgba(168, 111, 244, 1)','#A86FF4',1527772156),(30,'rgba(240, 230, 253, 1)','#F0E6FD',1527836583),(31,'rgba(223, 255, 48, 1)','#DFFF30',1527856291),(32,'rgba(255, 61, 38, 1)','#FF3D26',1528087634),(33,'rgba(88, 250, 255, 1)','#58FAFF',1528087671),(34,'rgba(255, 56, 180, 1)','#FF38B4',1528087684),(35,'rgba(244, 201, 242, 1)','#F4C9F2',1528087690),(36,'rgba(24, 70, 253, 1)','#1846FD',1528087713),(37,'rgba(198, 132, 244, 1)','#C684F4',1528087985),(38,'rgba(255, 61, 38, 1)','#FF3D26',1528088093),(39,'rgba(255, 61, 38, 1)','#FF3D26',1528088097),(40,'#F4C9F2','#F4C9F2',1528088109),(41,'rgba(220, 255, 29, 1)','#DCFF1D',1528088115),(42,'rgba(223, 255, 48, 1)','#DFFF30',1528088119),(43,'rgba(0, 255, 101, 0.78)','#00FF65',1528088139),(44,'rgba(235, 255, 128, 1)','#EBFF80',1528089738),(45,'rgba(146, 253, 253, 1)','#92FDFD',1528089757),(46,'rgba(255, 122, 111, 1)','#FF7A6F',1528090232),(47,'rgba(168, 111, 244, 1)','#A86FF4',1528090568),(48,'rgb(168, 111, 244)','#A86FF4',1528090661),(49,'rgba(127, 252, 252, 1)','#7FFCFC',1528090811),(50,'rgba(189, 144, 246, 1)','#BD90F6',1528090843),(51,'rgba(158, 255, 68, 0.99)','#9EFF44',1528091490),(52,'rgba(158, 255, 68, 0.99)','#9EFF44',1528091520),(53,'rgba(251, 255, 93, 0.99)','#FBFF5D',1528092149),(54,'rgba(251, 255, 93, 0.99)','#FBFF5D',1528092156),(55,'rgba(61, 104, 253, 0.99)','#3D68FD',1528092180),(56,'rgba(206, 84, 235, 0.99)','#CE54EB',1528093274),(57,'rgba(241, 255, 175, 0.99)','#F1FFAF',1528093293),(58,'rgba(255, 65, 114, 0.99)','#FF4172',1528093308),(59,'rgba(188, 255, 124, 0.99)','#BCFF7C',1528093314),(60,'rgba(250, 255, 50, 0.99)','#FAFF32',1528093322),(61,'rgba(250, 255, 50, 0.99)','#FAFF32',1528093327),(62,'rgba(250, 255, 50, 0.25)','#FAFF32',1528093337),(63,'rgba(250, 255, 50, 0.08)','#FAFF32',1528093357),(64,'rgba(250, 255, 50, 0.62)','#FAFF32',1528093367),(65,'rgba(255, 9, 64, 0.62)','#FF0940',1528093382),(66,'rgba(255, 9, 64, 0.21)','#FF0940',1528093389),(67,'rgba(29, 244, 255, 1)','#1DF4FF',1528093462),(68,'rgba(255, 82, 74, 1)','#FF524A',1528093478),(69,'rgba(255, 82, 74, 1)','#FF524A',1528093485),(70,'rgba(255, 88, 175, 0.36)','#FF58AF',1528093498),(71,'rgba(255, 82, 74, 0.51)','#FF524A',1528093528),(72,'rgba(0, 0, 0, 0.66)','#000000',1528093605),(73,'rgba(168, 111, 244, 0.47)','#A86FF4',1528093632),(74,'rgba(168, 111, 244, 0.66)','#A86FF4',1528093810),(75,'rgba(255, 13, 51, 0.99)','#FF0D33',1528093844),(76,'rgba(59, 114, 255, 0.52)','#3B72FF',1528093942),(77,'rgba(255, 8, 149, 0.99)','#FF0895',1528093990),(78,'rgba(7, 115, 255, 0.99)','#0773FF',1528094113),(79,'rgba(7, 115, 255, 0.99)','#0773FF',1528094498),(80,'rgba(7, 115, 255, 0.99)','#0773FF',1528094502),(81,'rgba(255, 90, 121, 1)','#FF5A79',1528101655),(82,'rgba(81, 117, 253, 1)','#5175FD',1528102386),(83,'rgba(221, 255, 88, 1)','#DDFF58',1528102525),(84,'rgba(77, 239, 141, 1)','#4DEF8D',1528102989),(85,'rgba(239, 150, 242, 1)','#EF96F2',1528103085),(86,'rgb(168, 247, 249)','#A8F7F9',1528104543),(87,'rgba(255, 152, 143, 1)','#FF988F',1528104870),(88,'rgba(174, 129, 245, 1)','#AE81F5',1528107157),(89,'rgba(14, 250, 184, 1)','#0EFAB8',1528107300),(90,'rgba(210, 179, 249, 1)','#D2B3F9',1528111179),(91,'rgba(255, 90, 121, 1)','#FF5A79',1528111255),(92,'rgba(253, 166, 243, 1)','#FDA6F3',1528113427),(93,'rgba(55, 255, 134, 1)','#37FF86',1528113496),(94,'rgba(240, 117, 236, 1)','#F075EC',1528113878),(95,'rgba(230, 63, 224, 1)','#E63FE0',1528115527),(96,'rgba(250, 97, 227, 1)','#FA61E3',1528115612),(97,'rgba(116, 254, 75, 1)','#74FE4B',1528116473),(98,'rgba(150, 204, 250, 1)','#96CCFA',1528116679),(99,'rgba(163, 255, 86, 1)','#A3FF56',1528174642),(100,'rgba(255, 61, 38, 1)','#FF3D26',1528174649),(101,'rgba(147, 207, 255, 1)','#93CFFF',1528174654),(102,'rgba(253, 182, 20, 1)','#FDB614',1528174731),(103,'rgba(50, 107, 255, 1)','#326BFF',1528174988),(104,'rgba(239, 33, 225, 1)','#EF21E1',1528175168),(105,'rgba(255, 135, 127, 1)','#FF877F',1528175258),(106,'rgba(243, 239, 169, 1)','#F3EFA9',1528175288),(107,'rgba(24, 70, 253, 1)','#1846FD',1528175310),(108,'rgba(212, 249, 243, 1)','#D4F9F3',1528175710),(109,'rgba(242, 113, 231, 1)','#F271E7',1528175966),(110,'rgba(0, 254, 143, 1)','#00FE8F',1528176152),(111,'rgba(161, 250, 250, 1)','#A1FAFA',1528176203),(112,'rgba(255, 61, 38, 1)','#FF3D26',1528176555),(113,'rgba(255, 61, 38, 1)','#FF3D26',1528176561),(114,'rgba(89, 179, 255, 1)','#59B3FF',1528176575),(115,'rgba(76, 158, 255, 1)','#4C9EFF',1528176620),(116,'rgba(90, 252, 217, 1)','#5AFCD9',1528176749),(117,'rgba(255, 107, 137, 1)','#FF6B89',1528177435),(118,'rgba(116, 254, 75, 1)','#74FE4B',1528177449),(119,'rgba(242, 44, 219, 1)','#F22CDB',1528177584),(120,'rgba(134, 254, 84, 1)','#86FE54',1528177591),(121,'rgba(0, 79, 246, 1)','#004FF6',1528177610),(122,'rgba(255, 0, 67, 1)','#FF0043',1528177624),(123,'rgba(255, 168, 239, 1)','#FFA8EF',1528177764),(124,'rgba(131, 54, 229, 1)','#8336E5',1528177977),(125,'rgba(255, 88, 171, 1)','#FF58AB',1528180780),(126,'rgba(168, 255, 208, 1)','#A8FFD0',1528181312),(127,'rgb(255, 29, 173)','#FF1DAD',1528181963),(128,'rgba(253, 182, 20, 1)','#FDB614',1528181971),(129,'rgb(253, 182, 20)','#FDB614',1528181977),(130,'rgb(253, 182, 20)','#FDB614',1528181983),(131,'rgb(253, 182, 20)','#FDB614',1528181986),(132,'rgb(253, 182, 20)','#FDB614',1528181989),(133,'rgb(253, 182, 20)','#FDB614',1528181992),(134,'rgb(253, 182, 20)','#FDB614',1528181994),(135,'rgb(253, 182, 20)','#FDB614',1528181997),(136,'rgba(56, 255, 154, 1)','#38FF9A',1528182067),(137,'rgba(55, 147, 255, 1)','#3793FF',1528183909),(138,'rgba(55, 111, 255, 1)','#376FFF',1528189196),(139,'rgba(201, 255, 76, 1)','#C9FF4C',1528196608),(140,'rgba(91, 87, 248, 1)','#5B57F8',1528196623),(141,'rgba(106, 238, 255, 1)','#6AEEFF',1528196650),(142,'rgb(201, 255, 76)','#C9FF4C',1528196796),(143,'rgba(98, 156, 255, 1)','#629CFF',1528197283),(144,'rgba(255, 87, 209, 1)','#FF57D1',1528197498),(145,'rgba(157, 145, 250, 1)','#9D91FA',1528197629),(146,'rgba(157, 145, 250, 1)','#9D91FA',1528197698),(147,'rgba(255, 57, 70, 1)','#FF3946',1528197784),(148,'rgb(255, 57, 70)','#FF3946',1528197855),(149,'rgb(254, 97, 99)','#FE6163',1528198249),(150,'rgba(73, 172, 255, 1)','#49ACFF',1528199083),(151,'rgb(80, 149, 255)','#5095FF',1528200262),(152,'rgba(255, 73, 67, 1)','#FF4943',1528202569),(153,'rgba(254, 146, 63, 1)','#FE923F',1528202943),(154,'rgba(255, 132, 78, 1)','#FF844E',1528203079),(155,'rgba(103, 114, 250, 1)','#6772FA',1528203123),(156,'rgba(255, 136, 231, 1)','#FF88E7',1528203199),(157,'rgba(55, 133, 255, 1)','#3785FF',1528203229),(158,'rgba(173, 255, 121, 1)','#ADFF79',1528203409),(159,'rgba(170, 255, 55, 1)','#AAFF37',1528204516),(160,'rgba(82, 94, 250, 1)','#525EFA',1528204959),(161,'rgba(112, 194, 255, 1)','#70C2FF',1528204985),(162,'rgb(0, 121, 214)','#0079D6',1528205000),(163,'rgba(164, 255, 41, 1)','#A4FF29',1528205015),(164,'rgba(254, 71, 55, 1)','#FE4737',1528205041),(165,'rgba(254, 191, 95, 0.43)','#FEBF5F',1528259194),(166,'rgba(255, 127, 198, 1)','#FF7FC6',1528262245),(167,'rgba(175, 255, 128, 1)','#AFFF80',1528287954);
/*!40000 ALTER TABLE `used_colors` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `used_fonts`
--

DROP TABLE IF EXISTS `used_fonts`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `used_fonts` (
  `sys_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(200) NOT NULL,
  `ctime` int(11) NOT NULL,
  PRIMARY KEY (`sys_id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `used_fonts`
--

LOCK TABLES `used_fonts` WRITE;
/*!40000 ALTER TABLE `used_fonts` DISABLE KEYS */;
INSERT INTO `used_fonts` VALUES (1,'zzz',1528110341),(2,'IstokWeb-Bold',1528111261),(3,'Lora-BoldItalic',1528115897),(4,'Arimo-Bold',1528208910),(5,'CormorantInfant-Italic',1528208921),(6,'Arimo-BoldItalic',1528214177),(7,'Arimo-Bold',1528214185),(8,'Arimo-Italic',1528214208),(9,'AnonymousPro-BoldItalic',1528214528),(10,'AnonymousPro-Bold',1528235829),(11,'Cormorant-Italic',1528236006),(12,'Cuprum-BoldItalic',1528236256),(13,'Lora-Regular',1528259271),(14,'Pacifico',1528259377),(15,'IstokWeb-Italic',1528277802);
/*!40000 ALTER TABLE `used_fonts` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `vcore`
--

DROP TABLE IF EXISTS `vcore`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `vcore` (
  `id` varbinary(16) NOT NULL,
  `prodid` varchar(255) NOT NULL,
  `dtstart` varchar(16) NOT NULL,
  `dtend` varchar(16) NOT NULL,
  `summary` varchar(255) NOT NULL,
  `child_id` varbinary(16) NOT NULL,
  `child_type` enum('event','todo','freebusy','journal','pollin') NOT NULL,
  PRIMARY KEY (`id`),
  KEY `dtstart` (`dtstart`,`dtend`,`child_id`,`child_type`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `vcore`
--

LOCK TABLES `vcore` WRITE;
/*!40000 ALTER TABLE `vcore` DISABLE KEYS */;
/*!40000 ALTER TABLE `vcore` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `vjournal`
--

DROP TABLE IF EXISTS `vjournal`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `vjournal` (
  `id` varbinary(16) NOT NULL,
  `prodid` varchar(255) NOT NULL,
  `dtstamp` varchar(16) NOT NULL,
  `uid` varchar(255) NOT NULL,
  `organizer` varchar(255) NOT NULL,
  `status` varchar(16) NOT NULL,
  `class` varchar(16) NOT NULL,
  `categories` varchar(255) NOT NULL,
  `description` mediumtext NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `organizer` (`organizer`),
  KEY `prodid` (`prodid`,`dtstamp`,`uid`,`status`,`class`,`categories`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `vjournal`
--

LOCK TABLES `vjournal` WRITE;
/*!40000 ALTER TABLE `vjournal` DISABLE KEYS */;
/*!40000 ALTER TABLE `vjournal` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Dumping routines for database 'B_nobody'
--
/*!50003 DROP FUNCTION IF EXISTS `clean_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `clean_path`(_path VARCHAR(1024)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);

  SELECT _path INTO @path ;
  WHILE @path regexp '\/\/' DO 
    SELECT REPLACE(@path, '//', '/') INTO @path;
  END WHILE;

  SELECT @path INTO _r;
  RETURN _r;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `copy_notices` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `copy_notices`(in_email VARCHAR(255)
) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
   INSERT INTO notices SELECT * FROM yp.notice WHERE email=in_email;
   DELETE FROM directory.notice WHERE email=in_email;
   RETURN TRUE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `count_unread` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `count_unread`(_cid VARBINARY(16)
) RETURNS int(11)
    DETERMINISTIC
BEGIN
  DECLARE _count INT;

  IF _cid IS NOT NULL THEN
    SELECT COUNT(*) FROM mark WHERE msg_status='new' AND cid=_cid INTO _count;
  ELSE
    SELECT COUNT(*) FROM mark WHERE msg_status='new' INTO _count;
  END IF;

  RETURN _count;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `domain_name` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `domain_name`() RETURNS varchar(512) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  RETURN "drumee.com";
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `filepath` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `filepath`(_id VARCHAR(1024)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _pid VARCHAR(16);
  DECLARE _ext VARCHAR(16);
  DECLARE _fname VARCHAR(1024);

  SELECT parent_id, extension, user_filename FROM media WHERE id=_id 
    INTO _pid, _ext, _fname;
  IF _pid IS NULL THEN 
    SELECT id FROM media m WHERE m.parent_id='0' INTO  _pid;
  END IF;

  SELECT CONCAT(
    parent_path(_pid), 
    '/', 
    (SELECT TRIM('/' FROM user_filename) FROM media WHERE id=_pid), 
    '/', 
    REPLACE(_fname, CONCAT('.', _ext), ''),
    '.', 
    _ext
  ) INTO _r;

  RETURN clean_path(_r);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_area_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `get_area_id`() RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _id VARCHAR(120);
  SELECT area_id FROM yp.entity WHERE db_name=database() INTO _id;
  RETURN _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_finger_print` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `get_finger_print`() RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _fp VARCHAR(120);
  SELECT `value` FROM params WHERE pkey='password-master' INTO _fp;
  RETURN _fp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_home_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `get_home_id`() RETURNS varchar(16) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _id VARCHAR(16);
  SELECT  id FROM media WHERE parent_id='0' INTO _id;
  RETURN _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `get_id`() RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _id VARCHAR(120);
  SELECT id FROM yp.entity WHERE db_name=database() INTO _id;
  RETURN _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_ident` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `get_ident`() RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _ident VARCHAR(120);
  SELECT ident FROM yp.entity WHERE db_name=database() INTO _ident;
  RETURN _ident;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_json_array` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `get_json_array`(_json json,
  _index int(8) unsigned
) RETURNS text CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _res text;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_json, CONCAT("$[", _index, "]"))) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_json_object` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `get_json_object`(_json json,
  _name text
) RETURNS text CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _res text;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_json, CONCAT("$.", _name))) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `get_privilege` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `get_privilege`(_uid VARBINARY(16),
  _area VARCHAR(12)
) RETURNS tinyint(2)
    DETERMINISTIC
BEGIN
  DECLARE _id VARBINARY(16);
  DECLARE _res TINYINT(2);
  DECLARE _priv TINYINT(2);

  SELECT privilege FROM huber WHERE id=_uid INTO _priv;
  IF _priv IS NULL OR _priv='' THEN
    IF _area = 'public' THEN
      SET _res=1;
    ELSE
      SET _res=0;
    END IF;
  ELSE
    SET _res=_priv;
  END IF;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `init_env` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `init_env`(_lc_time VARCHAR(512),
  _rows_per_page tinyint(4)
) RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  SET lc_time_names = _lc_time;
  SET @rows_per_page = _rows_per_page;
  RETURN  @rows_per_page;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `is_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `is_new`(_metadata JSON,
  _oid VARCHAR(16),
  _uid VARCHAR(16)
) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
  RETURN IF(
      NOT json_valid(_metadata) OR 
      _metadata IS NULL OR _metadata IN('{}', '') OR _oid = _uid OR
      JSON_EXTRACT(_metadata, "$._seen_") IS NULL OR 
      JSON_UNQUOTE(JSON_EXTRACT(_metadata, CONCAT("$._seen_.", _uid))) IS NOT NULL, 
      0, 1
    );
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `is_parent_of` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `is_parent_of`(_parent_id VARCHAR(16),
  _node_id VARCHAR(16)
) RETURNS tinyint(2)
    DETERMINISTIC
BEGIN

  DECLARE _pid VARCHAR(16);
  DECLARE _res VARCHAR(16);
  DECLARE _depth SMALLINT DEFAULT 0;

  IF _node_id IS NULL OR _parent_id IS NULL THEN 
    RETURN 0;
  END IF;

  IF _node_id NOT IN ('', 0, '0', "*") AND _parent_id = _node_id THEN
    RETURN 1;
  END IF; 
  SELECT IF(parent_id=_parent_id, 1, 0), parent_id 
    FROM media WHERE id=_node_id INTO _res, _pid;
  WHILE _depth  < 120 AND _pid != '0' AND _res = 0 DO
    SELECT IF(parent_id=_parent_id, 1, 0), parent_id 
      FROM media WHERE id=_pid INTO _res, _pid;
    SELECT _depth + 1 INTO _depth;
  END WHILE;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `layoutMatching` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `layoutMatching`(_hashtag VARCHAR(512),
   _key VARCHAR(512),
   _screen  VARCHAR(16),
   _lang  VARCHAR(16)
) RETURNS int(8)
    DETERMINISTIC
BEGIN
  DECLARE res INT(8) DEFAULT 0;
  SELECT IF(_hashtag=concat(_key, '.', _lang, '.', _screen), 6, 0)
     + IF(_hashtag=concat(_key, '.', _screen, '.', _lang), 6, 0)
     + IF(_hashtag=concat(_key, '.', _lang), 4, 0)
     + IF(_hashtag=concat(_key, '.', _screen), 5, 0)
     + IF(_hashtag=_key , 1, 0) INTO res;
  RETURN res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `layout_ident` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `layout_ident`(_tag VARCHAR(512),
   _lang  VARCHAR(16),
   _device  VARCHAR(16)
) RETURNS varchar(512) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  RETURN concat(_tag, '!', _lang, '!', _device);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `layout_score` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `layout_score`(_hash VARCHAR(512),
   _tag VARCHAR(512),
   _lang  VARCHAR(16),
   _device  VARCHAR(16)
) RETURNS int(8)
    DETERMINISTIC
BEGIN
  DECLARE res INT(8) DEFAULT 0;
  SELECT IF(_hash=layout_ident(_tag, _lang, _device), 6, 0)
     + IF(_hash LIKE concat(_tag, '!', _lang, '!%'), 5, 0)
     + IF(_hash LIKE concat(_tag, '!%', _lang), 3, 0) INTO res;
  RETURN res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `logical_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `logical_path`(_id VARCHAR(16)
) RETURNS longtext CHARSET utf8mb4 COLLATE utf8mb4_bin
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _pid VARCHAR(16);
  DECLARE _home_id VARCHAR(16);
  DECLARE _max INTEGER DEFAULT 0;
  DECLARE _res JSON;

  IF _pid IN('0', NULL) THEN 
    SELECT JSON_ARRAY(id) FROM media WHERE parent_id='0' INTO _res;
    RETURN _res;
  END IF;

  SELECT parent_id, JSON_ARRAY(id) FROM media WHERE id=_id INTO _pid, _res;
  WHILE _pid != '0' AND _max < 100 DO 
    SELECT _max + 1 INTO _max;
    SELECT parent_id, JSON_MERGE(JSON_ARRAY(_pid), _res) FROM media WHERE id = _pid INTO _pid, _res;
  END WHILE;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `media_notified` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `media_notified`(_metadata JSON,
  _uid VARCHAR(16)
) RETURNS int(11)
    DETERMINISTIC
BEGIN
  DECLARE _res INTEGER DEFAULT 0;
  SELECT 
    JSON_QUERY(_metadata, "$.acknowledge") IS NOT NULL AND 
    IF(JSON_SEARCH(JSON_QUERY(_metadata,"$.acknowledge"), "one", _uid) IS NULL, 1, 0) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `media_ttl` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `media_ttl`(_uid VARCHAR(16),
  _rid VARCHAR(16)
) RETURNS int(11)
    DETERMINISTIC
BEGIN
  DECLARE _expiry INT(11);
  DECLARE _db_name VARCHAR(60);
  DECLARE _category VARCHAR(60);
  DECLARE _file_path VARCHAR(1024);
  
  SET _expiry = NULL;
  SELECT category FROM media WHERE id=_rid INTO _category;

  SELECT expiry_time FROM media LEFT JOIN permission ON 
      resource_id=media.id WHERE entity_id=_uid AND media.id=_rid INTO _expiry;

  IF _expiry IS NULL THEN 
      SELECT expiry_time FROM permission WHERE (entity_id=_uid AND resource_id='*') INTO _expiry;
  END IF;
  IF _expiry IS NULL THEN 
      SELECT file_path FROM media WHERE id=_rid INTO _file_path;
      SELECT IFNULL(expiry_time, 0) FROM media LEFT JOIN permission ON 
        resource_id=media.id AND entity_id= _uid WHERE  REPLACE(_file_path  , '(',')')  REGEXP  REPLACE(user_filename , '(',')')  AND permission 
        IS NOT NULL
        ORDER BY (LENGTH(parent_path)-LENGTH(REPLACE(parent_path, '/', '')))  DESC LIMIT 1 
        INTO _expiry;
  END IF;
  
  SELECT IFNULL(_expiry, 0) INTO _expiry;
  SELECT IF(_expiry=0, 0, _expiry - UNIX_TIMESTAMP()) INTO _expiry;
  RETURN _expiry;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `media_unseen` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `media_unseen`(_metadata JSON,
  _uid VARCHAR(16)
) RETURNS int(11)
    DETERMINISTIC
BEGIN
  DECLARE _res INTEGER DEFAULT 0;
  SELECT 
    IF(JSON_EXISTS(_metadata, "$._seen_") AND NOT JSON_EXISTS(_metadata, CONCAT("$._seen_.", _uid)), 1, 0) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `node_id_from_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `node_id_from_path`(_path VARCHAR(1024)
) RETURNS varchar(16) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(16);
  DECLARE _node_id VARCHAR(16);
  IF _path regexp  '^\/.+' THEN 
    SELECT id FROM media 
      WHERE REPLACE(file_path, '/', '') = 
      REPLACE(IF(category='folder' OR category ='hub', CONCAT(_path, '.', extension), _path), '/','')
      INTO _node_id;
  ELSE 
    SELECT _key INTO _node_id;
  END IF;
  SELECT id FROM media WHERE id = _node_id INTO _r;
  RETURN _r;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `normalize_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `normalize_path`(_id VARCHAR(16)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);

  SELECT CONCAT('/', parent_path) FROM media WHERE id=_id  INTO @path ;
  WHILE @path regexp '\/\/' DO 
    SELECT REPLACE(@path, '//', '/') INTO @path;
  END WHILE;
  UPDATE media SET parent_path=TRIM(TRAILING '/' FROM @path) WHERE id=_id;

  SELECT file_path FROM media WHERE id=_id INTO @path ;
  WHILE @path regexp '\/\/' DO 
    SELECT REPLACE(@path, '//', '/') INTO @path;
  END WHILE;

  UPDATE media SET file_path=TRIM(TRAILING '/' FROM @path) WHERE id=_id;

  UPDATE media SET user_filename=TRIM('/' FROM user_filename) WHERE id=_id;

  SELECT CONCAT(parent_path, '/', TRIM('/' FROM user_filename)) 
    FROM media WHERE id=_id INTO _r;
  RETURN _r;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `parent_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `parent_path`(_id VARCHAR(16)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _pid VARCHAR(16);
  DECLARE _max INTEGER DEFAULT 0;

  SET @path='';
  SET @rr='';

  SELECT  parent_id, TRIM('/' FROM user_filename) FROM media WHERE id=_id 
    INTO _pid, @fname;

  IF _pid IN('0') THEN 
    RETURN '/';
  END IF;
  
  SELECT id FROM media WHERE parent_id ='0' OR parent_id ='' OR parent_id IS NULL 
    INTO @root_id;

  IF @fname IS NULL OR @fname='' OR _pid IS NULL OR _pid='' THEN 
    SELECT '0' INTO _pid;
  END IF;
 
  

  WHILE _pid != '0' AND _max < 100 DO 
    SELECT _max + 1 INTO _max;
    SET @prev = _pid;
    SELECT parent_id, TRIM('/' FROM user_filename) FROM media WHERE id = _pid 
      INTO _pid, @fname;

    
    IF @prev = _pid THEN 
      SELECT '0'INTO _pid;
      SELECT CONCAT('/', @fname, '/') INTO @path;
    ELSE
      SELECT CONCAT(@fname, '/', @path) INTO @path;
    END IF;

    IF @fname IS NULL OR @fname='' OR _pid IS NULL OR _pid='' THEN 
      SELECT '0' INTO _pid;
    END IF;

  END WHILE;

  IF @path IS NULL OR @path='' THEN 
    SET @path = '/';
  END IF;

  SELECT @path INTO _r;
  RETURN _r;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `parent_permission` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `parent_permission`(_uid VARCHAR(16) CHARACTER SET ascii,
  _node_id VARCHAR(16) CHARACTER SET ascii
) RETURNS tinyint(2)
    DETERMINISTIC
BEGIN
  DECLARE _perm TINYINT(4) DEFAULT 0;

    WITH RECURSIVE parent_media AS 
      (
        SELECT m.id,m.parent_id ,IFNULL(p.permission,0) permission 
        FROM media m 
        LEFT JOIN permission p ON 
          p.resource_id=m.parent_id AND p.entity_id IN(_uid, '*') AND p.assign_via != 'no_traversal'
        WHERE m.id = _node_id  
          UNION ALL
        SELECT  m.id, m.parent_id,IFNULL(p.permission,0) permission 
        FROM media m
        LEFT JOIN permission p ON 
          p.resource_id=m.parent_id AND  p.entity_id IN(_uid, '*') AND p.assign_via != 'no_traversal'
        INNER JOIN parent_media AS t ON 
          m.id = t.parent_id  AND m.parent_id <> '0'  AND t.permission = 0
      )
      SELECT permission FROM parent_media WHERE permission <> 0  INTO  _perm ;

      RETURN _perm;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `parent_permission_old` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `parent_permission_old`(_uid VARCHAR(16),
  _node_id VARCHAR(16)
) RETURNS tinyint(2)
    DETERMINISTIC
BEGIN

  DECLARE _pid VARCHAR(16);
  DECLARE _perm TINYINT(4) DEFAULT 0;
  DECLARE _res VARCHAR(16);
  DECLARE _depth SMALLINT DEFAULT 0;
  SELECT m.parent_id, IFNULL(p.permission,0) FROM media m LEFT JOIN permission p ON 
    p.resource_id=m.parent_id AND  p.entity_id IN(_uid, '*') WHERE m.id=_node_id  LIMIT 1
    INTO _pid, _perm;
  WHILE _depth  < 120 AND (_pid != '0' OR _pid IS NULL) AND _perm = 0 DO
    SELECT m.parent_id, IFNULL(p.permission,0) FROM media m LEFT JOIN permission p ON 
      p.resource_id=m.parent_id AND  p.entity_id IN(_uid, '*') AND p.assign_via != 'no_traversal'  WHERE  m.id=_pid 
      LIMIT 1
      INTO _pid, _perm;
      SELECT _depth + 1 INTO _depth;
  END WHILE;
  RETURN _perm;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `permission_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `permission_tree`(_id VARCHAR(16)
) RETURNS varchar(16) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(16) DEFAULT '*';
  DECLARE _pid VARCHAR(16);
  DECLARE _count INTEGER;
  DECLARE _max INTEGER DEFAULT 0;

  SELECT COUNT(*) FROM permission WHERE resource_id = _id INTO _count;
  IF  _count > 0 THEN
    SELECT _id INTO _r;
    SELECT 'O'  INTO _pid;
  ELSE
    SELECT parent_id FROM media WHERE id = _id INTO _pid;
  END IF;

  WHILE _pid != '0' AND _count = 0 AND _max < 100 DO 
    SELECT _max + 1 INTO _max;
    SET @prev = _pid;
    SELECT parent_id FROM media WHERE id = _pid INTO _pid;
    SELECT count(*) FROM permission WHERE resource_id = _pid INTO _count;
    IF _count > 0 THEN
      SELECT _pid INTO _r;
    END IF;
  END WHILE;
  RETURN _r;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `read_json_array` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `read_json_array`(_json json,
  _index int(8) unsigned
) RETURNS text CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _res text;
  SELECT TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(_json, CONCAT("$[", _index, "]"))), '')) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `read_json_object` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `read_json_object`(_json json,
  _name text
) RETURNS text CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _res text;
  SELECT TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(_json, CONCAT("$.", _name))), '')) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `set_env` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `set_env`(_home_root VARCHAR(512),
  _date_format VARCHAR(512),
  _lc_time VARCHAR(512),
  _rows_per_page tinyint(4)
) RETURNS varchar(80) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  SET @home_root = _home_root;
  SET @dformat = _date_format;
  SET lc_time_names = _lc_time;
  SET @rows_per_page = _rows_per_page;
  
  SELECT area, area_id from yp.entity where db_name=database() INTO @area, @area_id;
  RETURN @home_root;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `strToBits` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `strToBits`(_str VARCHAR(8)

) RETURNS bit(8)
    DETERMINISTIC
BEGIN
  DECLARE _bits BIT(8) DEFAULT NULL;
  SELECT CAST(_str AS UNSIGNED) INTO _bits;
  RETURN _bits;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `uniqueId` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `uniqueId`() RETURNS varchar(16) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _res VARCHAR(16);
  SELECT CONCAT(
    SUBSTRING_INDEX(UUID(), '-', 1),
    SUBSTRING_INDEX(UUID(), '-', 1)
  ) INTO _res;
  RETURN _res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `unique_filename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `unique_filename`(_pid VARCHAR(16),
  _file_name VARCHAR(200),
  _ext VARCHAR(20)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _fname VARCHAR(1024);
  DECLARE _path VARCHAR(1024);
  DECLARE _count INT(8) DEFAULT 0;
  DECLARE _depth TINYINT(4) DEFAULT 0;

  SELECT TRIM('/' FROM  REPLACE(_file_name, '/', ' - ')) INTO _fname;
  SELECT clean_path(
    CONCAT(parent_path(id), '/', user_filename, '/', _file_name, '.', _ext)
  )FROM media WHERE id = _pid INTO _path;

  SELECT count(*) FROM media WHERE 
    file_path=_path OR (
      parent_id=_pid AND 
      (TRIM('/' FROM user_filename) = _fname) AND 
      extension=_ext
    ) INTO _count;
  IF _count = 0 THEN 
    SELECT _fname INTO _r;
  ELSEIF _fname regexp '\\\([0-9]+\\\)$' THEN 
    WHILE _depth  < 1000 AND _count > 0 DO 
      SELECT _depth + 1 INTO _depth;
      
      
      SELECT SUBSTRING_INDEX(_fname, '(', 1) INTO @base;
      SELECT SUBSTRING_INDEX(_fname, ')', -1) INTO @ext;
      SELECT CONCAT(@base, "(", _depth, ")", @ext) INTO _r;
      SELECT count(*) FROM media WHERE 
        parent_id=_pid AND TRIM('/' FROM user_filename) = _r
        INTO _count;
    END WHILE;
  ELSE 
    SELECT CONCAT(_fname, "(1)") INTO _r;
    SELECT count(*) FROM media WHERE 
      parent_id=_pid AND TRIM('/' FROM user_filename) = _r
      INTO _count;
    WHILE _depth  < 1000 AND _count > 0 DO 
      SELECT _depth + 1 INTO _depth;
      
      
      SELECT SUBSTRING_INDEX(_r, '(', 1) INTO @base;
      SELECT SUBSTRING_INDEX(_r, ')', -1) INTO @ext;
      SELECT CONCAT(@base, "(", _depth, ")", @ext) INTO _r;
      SELECT count(*) FROM media WHERE 
        parent_id=_pid AND TRIM('/' FROM user_filename) = _r
        INTO _count;
    END WHILE;
  END IF;
  SELECT SUBSTRING_INDEX(_r, '/', -1) INTO _r;
  RETURN _r;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `unique_filename_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` FUNCTION `unique_filename_next`(_pid VARCHAR(16),
  _file_name VARCHAR(200),
  _ext VARCHAR(20)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _fname VARCHAR(1024);
  DECLARE _count INT(8) DEFAULT 0;
  DECLARE _depth TINYINT(4) DEFAULT 0;

  SELECT TRIM('/' FROM _file_name) INTO _fname;
  
  SELECT count(*) FROM media WHERE 
    parent_id=_pid AND (TRIM('/' FROM user_filename) = _fname) AND 
    extension=_ext INTO _count;
  IF _count = 0 THEN 
    SELECT _fname INTO _r;
  ELSEIF _fname regexp '\\\([0-9]+\\\)$' THEN 
    WHILE _depth  < 1000 AND _count > 0 DO 
      SELECT _depth + 1 INTO _depth;
      
      
      SELECT SUBSTRING_INDEX(_fname, '(', 1) INTO @base;
      SELECT SUBSTRING_INDEX(_fname, ')', -1) INTO @ext;
      SELECT CONCAT(@base, "(", _depth, ")", @ext) INTO _r;
      SELECT count(*) FROM media WHERE 
        parent_id=_pid AND TRIM('/' FROM user_filename) = _r
        INTO _count;
    END WHILE;
  ELSE 
    SELECT CONCAT(_fname, "(1)") INTO _r;
    SELECT count(*) FROM media WHERE 
      parent_id=_pid AND TRIM('/' FROM user_filename) = _r
      INTO _count;
    WHILE _depth  < 1000 AND _count > 0 DO 
      SELECT _depth + 1 INTO _depth;
      
      
      SELECT SUBSTRING_INDEX(_r, '(', 1) INTO @base;
      SELECT SUBSTRING_INDEX(_r, ')', -1) INTO @ext;
      SELECT CONCAT(@base, "(", _depth, ")", @ext) INTO _r;
      SELECT count(*) FROM media WHERE 
        parent_id=_pid AND TRIM('/' FROM user_filename) = _r
        INTO _count;
    END WHILE;
  END IF;
  SELECT SUBSTRING_INDEX(_r, '/', -1) INTO _r;
  RETURN _r;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `unique_tagname` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `unique_tagname`(_tag_name VARCHAR(255),
  _chk_tag_id VARCHAR(50)
) RETURNS varchar(1024) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _r VARCHAR(1024);
  DECLARE _count INT(8) DEFAULT 0;
  DECLARE _depth INT(4) DEFAULT 0;

  IF _chk_tag_id IN ('',  '0') THEN 
   SELECT NULL INTO  _chk_tag_id;
  END IF;

  SELECT count(*) FROM tag WHERE name = _tag_name   AND tag_id <> IFNULL(_chk_tag_id,'xxxxxx')
  INTO _count;
 
  IF _count = 0 THEN 
    SELECT _tag_name INTO _r;
  ELSE 
      WHILE _depth  < 1000 AND _count > 0 DO 
            SELECT _depth + 1 INTO _depth;
            SELECT CONCAT(_tag_name, " (", _depth, ")") INTO _r;
            SELECT count(*) FROM tag WHERE name = _r  AND tag_id <> IFNULL(_chk_tag_id,'xxxxxx')
            INTO _count;

      END WHILE;  
  END IF;   
  RETURN _r;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `user_expiry` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `user_expiry`(_uid VARCHAR(16) CHARACTER SET ascii,
  _rid VARCHAR(16) CHARACTER SET ascii
) RETURNS int(11)
    DETERMINISTIC
BEGIN
  DECLARE _expiry INT(11);
  DECLARE _db_name VARCHAR(60);
  DECLARE _category VARCHAR(60);
  DECLARE _file_path VARCHAR(1024);
  
  SET _expiry = NULL;
  SELECT category FROM media WHERE id=_rid INTO _category;

  SELECT expiry_time FROM media LEFT JOIN permission ON 
      resource_id=media.id WHERE entity_id=_uid AND media.id=_rid INTO _expiry;

  IF _expiry IS NULL THEN 
      SELECT expiry_time FROM permission WHERE (entity_id=_uid AND resource_id='*') INTO _expiry;
  END IF;
  IF _expiry IS NULL THEN 
      SELECT file_path FROM media WHERE id=_rid INTO _file_path;
      SELECT IFNULL(expiry_time, 0) FROM media LEFT JOIN permission ON 
        resource_id=media.id AND entity_id= _uid WHERE  REPLACE(_file_path, '(',')')  REGEXP  REPLACE(user_filename, '(',')')  AND permission 
        IS NOT NULL
        ORDER BY (LENGTH(parent_path)-LENGTH(REPLACE(parent_path, '/', '')))  DESC LIMIT 1 
        INTO _expiry;
  END IF;
  
  SELECT IFNULL(_expiry, 0) INTO _expiry;
  RETURN _expiry;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `user_permission` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `user_permission`(_uid VARCHAR(512) CHARACTER SET ascii,
  _rid VARCHAR(16)  CHARACTER SET ascii
  
) RETURNS tinyint(2)
    DETERMINISTIC
BEGIN
  DECLARE _perm TINYINT(2) DEFAULT 0;
  DECLARE _db_name VARCHAR(60);
  DECLARE _category VARCHAR(60);
  DECLARE _file_path VARCHAR(1024);
  DECLARE _token VARCHAR(1024);
  
  DECLARE _parent_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _parent_perm TINYINT(4);

  
  
  
  
  
  
  
  
  
  

  SELECT category FROM media WHERE id=_rid INTO _category;
  SELECT IF(_uid IN ('nobody', 'ffffffffffffffff', '*'), '*', _uid) INTO _uid;

  IF _category = "hub" THEN
    SELECT permission FROM permission 
      WHERE resource_id=_rid AND entity_id=_uid INTO _perm;
  ELSE
    SELECT IFNULL(permission, 0) FROM permission WHERE
      entity_id=_uid AND resource_id=_rid INTO _perm;

    IF NOT _perm THEN 
      SELECT IFNULL(permission, 0) FROM permission WHERE 
        (entity_id=_uid AND _uid != '*' AND resource_id='*') INTO _perm;
    END IF;

    IF NOT _perm THEN 
      SELECT IFNULL(parent_permission(_uid, _rid), 0) INTO _perm;
    END IF;

    IF NOT _perm THEN 
      SELECT IFNULL(permission, 0) FROM permission WHERE 
        (entity_id= '*' AND resource_id=_rid) INTO _perm;
    END IF;


    
    
    

    IF NOT _perm THEN 
      SELECT MAX(permission) FROM permission WHERE 
        (entity_id IN ('nobody', 'ffffffffffffffff', '*') AND 
        (resource_id='*' OR resource_id=_rid) ) LIMIT 1 INTO _perm;
    END IF;
    
  END IF;
  SELECT IFNULL(_perm, 0) INTO _perm;
  RETURN _perm;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `user_perm_msg` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` FUNCTION `user_perm_msg`(_uid VARCHAR(16),
  _rid VARCHAR(16)
) RETURNS text CHARSET utf8mb4
    DETERMINISTIC
BEGIN
  DECLARE _msg MEDIUMTEXT;
  DECLARE _db_name VARCHAR(60);
  DECLARE _category VARCHAR(60);
  DECLARE _file_path VARCHAR(1024);
  
  SET _msg = NULL;
  SELECT category FROM media WHERE id=_rid INTO _category;

  SELECT IFNULL(message, '') FROM media LEFT JOIN permission ON 
      resource_id=media.id WHERE entity_id=_uid AND media.id=_rid INTO _msg;

  IF _msg IS NULL THEN 
      SELECT message FROM permission WHERE (entity_id=_uid AND resource_id='*') INTO _msg;
  END IF;
  IF _msg IS NULL THEN 
    SELECT file_path FROM media WHERE id=_rid INTO _file_path;
    SELECT IFNULL(message, '') FROM media LEFT JOIN permission ON 
      resource_id=media.id AND entity_id= _uid WHERE  REPLACE(_file_path  , '(',')')  REGEXP  REPLACE(user_filename  , '(',')')  AND permission 
      IS NOT NULL 
      ORDER BY (LENGTH(parent_path)-LENGTH(REPLACE(parent_path, '/', '')))  DESC LIMIT 1 
      INTO _msg;
  END IF;
  
  SELECT IFNULL(_msg, '') INTO _msg;
  RETURN _msg;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acknowledge_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `acknowledge_message`(
IN _in JSON
)
BEGIN

  DECLARE _entity_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _author_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _message_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _uid VARCHAR(16) CHARACTER SET ascii;
  DECLARE _ref_sys_id int(11) unsigned default 0 ;
  DECLARE _old_ref_sys_id int(11) unsigned default 0 ;
  DECLARE _entity_db VARCHAR(255); 
 

  

  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.message_id")) INTO _message_id;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.uid")) INTO _uid;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.entity_id")) INTO _entity_id;
  
  
  SELECT sys_id FROM channel c WHERE message_id = _message_id INTO _ref_sys_id ;


  SELECT ref_sys_id FROM read_channel WHERE entity_id = _entity_id AND uid = _uid INTO _old_ref_sys_id;


  SELECT CASE WHEN _ref_sys_id < _old_ref_sys_id THEN _old_ref_sys_id ELSE _ref_sys_id END INTO _ref_sys_id;


  

  
  
  
  
  INSERT INTO read_channel(entity_id,uid,ref_sys_id,ctime) SELECT _entity_id,_uid,_ref_sys_id,UNIX_TIMESTAMP() 
  ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id , ctime =UNIX_TIMESTAMP() ;


  SELECT NULL INTO _old_ref_sys_id;
  SELECT ref_sys_id FROM read_channel WHERE entity_id = _entity_id AND uid = _entity_id INTO _old_ref_sys_id;

  INSERT INTO read_channel(entity_id,uid,ref_sys_id,ctime) SELECT _entity_id,_entity_id,0,UNIX_TIMESTAMP() 
  WHERE _old_ref_sys_id IS NULL;


  SELECT db_name FROM yp.entity WHERE id=_entity_id AND status <> 'deleted' INTO _entity_db;
  IF _entity_db  IS  NOT NULL THEN 
      SET @st = CONCAT('CALL ', _entity_db ,'.post_acknowledge_message(?)');
      PREPARE stamt FROM @st;
      EXECUTE stamt USING JSON_MERGE( JSON_OBJECT('message_id',_message_id ) , JSON_OBJECT('entity_id', _entity_id  ) ,JSON_OBJECT('uid',_uid )) ;
      DEALLOCATE PREPARE stamt; 
 END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_array_check` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `acl_array_check`(
  IN _key VARCHAR(16),
  IN _permission TINYINT(4),
  IN _nodes JSON
)
BEGIN

  DECLARE _uid VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _area VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _mfs_root VARCHAR(512);

  DECLARE _rid VARCHAR(16);
  DECLARE _i INT(8) DEFAULT 0;
  DECLARE _j INT(8) DEFAULT 0;

  SELECT id FROM yp.entity WHERE id=_key or ident=_key INTO _uid;

  DROP TABLE IF EXISTS __tmp_ids;
  CREATE TEMPORARY TABLE __tmp_ids(
    `id` varchar(16) DEFAULT NULL,
    db_name varchar(90) DEFAULT NULL,
    expiry tinyint(4) unsigned,
    asked  tinyint(4) unsigned,
    privilege int(11) 
  ); 

  WHILE _i < JSON_LENGTH(_nodes) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _i, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.nid")) INTO @_nids;
    SELECT 0 INTO  _j;
    WHILE _j < JSON_LENGTH(@_nids) DO 
      SELECT JSON_UNQUOTE(JSON_EXTRACT(@_nids,CONCAT("$[", _j, "]"))) INTO _rid;
      SELECT db_name, area, owner_id, concat(home_dir, "__storage__/")
        FROM yp.entity LEFT JOIN yp.hub USING(id) WHERE 
        id = yp.hub_id(JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.hub_id")))
        INTO _src_db_name, _area, _owner_id, _mfs_root; 
      
      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_permission (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resperm");
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt; 

      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_expiry (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resexpiry");
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      SELECT IF(_area='public', GREATEST(7, @resperm), @resperm) INTO @resperm;
      
      
      
      
      
      INSERT INTO __tmp_ids SELECT 
        _rid, _src_db_name, @resexpiry, _permission, CAST(@resperm AS UNSIGNED); 
        
      SELECT _j + 1 INTO _j;
    END WHILE;
    SELECT _i + 1 INTO _i;
  END WHILE;
  
  SELECT * FROM  __tmp_ids WHERE 
    (expiry = 0 OR expiry > UNIX_TIMESTAMP());

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_array_check_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `acl_array_check_next`(
  IN _key VARCHAR(16),
  IN _permission TINYINT(4),
  IN _nodes JSON
)
BEGIN

  DECLARE _uid VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _mfs_root VARCHAR(512);

  DECLARE _rid VARCHAR(16);
  DECLARE _i INT(8) DEFAULT 0;
  DECLARE _j INT(8) DEFAULT 0;

  SELECT id FROM yp.entity WHERE id=_key INTO _uid;

  DROP TABLE IF EXISTS __tmp_ids;
  CREATE TEMPORARY TABLE __tmp_ids(
    `id` varchar(16) DEFAULT NULL,
    `hub_id` varchar(16) DEFAULT NULL,
    db_name varchar(90) DEFAULT NULL,
    expiry tinyint(4) unsigned,
    asked  tinyint(4) unsigned DEFAULT 1,
    privilege int(11) 
  ); 

  IF _permission IS NULL OR _permission=0 THEN 
    SET _permission = 1;
  END IF;

  WHILE _i < JSON_LENGTH(_nodes) DO 
    
    SELECT get_json_array(_nodes, _i) INTO @_node;
    
    SELECT get_json_object(@_node, "nid") INTO @_nids;

    SELECT 0 INTO  _j;
    WHILE _j < JSON_LENGTH(@_nids) DO 
      
      SELECT get_json_array(@_nids, _j) INTO _rid;
      SELECT id, db_name, area, owner_id, concat(home_dir, "__storage__/")
        FROM yp.entity LEFT JOIN yp.hub USING(id) WHERE 
        
        id = yp.hub_id(get_json_object(@_node, "hub_id"))
        INTO _hub_id, _src_db_name, _area, _owner_id, _mfs_root; 
      

      IF _src_db_name IS NOT NULL THEN 
        SET @s = CONCAT(
          "SELECT " ,_src_db_name,".user_permission (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resperm");
        PREPARE stmt FROM @s;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt; 

        SET @s = CONCAT(
          "SELECT " ,_src_db_name,".user_expiry (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resexpiry");
        PREPARE stmt FROM @s;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        SELECT IF(_area='public', GREATEST(7, @resperm), GREATEST(1, @resperm)) INTO @resperm;
        INSERT INTO __tmp_ids SELECT 
          _rid, _hub_id, _src_db_name, @resexpiry, _permission, CAST(@resperm AS UNSIGNED); 
      END IF;          
      SELECT _j + 1 INTO _j;
    END WHILE;
    SELECT _i + 1 INTO _i;
  END WHILE;
  
  SELECT * FROM  __tmp_ids WHERE 
    (expiry = 0 OR expiry > UNIX_TIMESTAMP());

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_check` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `acl_check`(
  IN _uid VARCHAR(255) CHARACTER SET ascii,
  IN _permission TINYINT(4),
  IN _nodes JSON
)
BEGIN

  
  DECLARE _hub_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _area VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _mfs_root VARCHAR(512);
  

  DECLARE _rid VARCHAR(16) CHARACTER SET ascii;
  DECLARE _i INT(4) DEFAULT 0;

  
  

  DROP TABLE IF EXISTS __tmp_ids;
  CREATE TEMPORARY TABLE __tmp_ids(
    `id` varchar(16) CHARACTER SET ascii DEFAULT NULL ,
    `hub_id` varchar(16) CHARACTER SET ascii DEFAULT NULL,
    db_name varchar(90) DEFAULT NULL,
    expiry int(11) ,
    asked  tinyint(4) unsigned DEFAULT 0,
    privilege int(11) 
  ); 

  IF _permission IS NULL OR _permission='' THEN 
    SET _permission = 0;
  END IF;

  WHILE _i < JSON_LENGTH(_nodes) DO 
    SELECT get_json_array(_nodes, _i) INTO @_node;
    SELECT JSON_VALUE(@_node, "$.nid") INTO _rid;
    
    
    SELECT id, db_name, area, concat(home_dir, "__storage__/")
      FROM yp.entity WHERE 
      
      id = JSON_VALUE(@_node, "$.hub_id")
      INTO _hub_id, _src_db_name, _area, _mfs_root; 
    
    
    
    

    IF _src_db_name IS NOT NULL THEN 
      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_permission (?, ?) INTO @resperm");
      PREPARE stmt FROM @s;
      EXECUTE stmt USING _uid, _rid;
      DEALLOCATE PREPARE stmt; 

      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_expiry (?, ?) INTO @resexpiry");
      PREPARE stmt FROM @s;
      EXECUTE stmt USING _uid, _rid;
      DEALLOCATE PREPARE stmt;
      SELECT IF(_area='public', GREATEST(3, @resperm), IFNULL(@resperm, 1)) INTO @resperm;

      INSERT INTO __tmp_ids SELECT 
        _rid, _hub_id, _src_db_name, @resexpiry, _permission, CAST(@resperm AS UNSIGNED); 
    END IF;

    SELECT _i + 1 INTO _i;
  END WHILE;
  
  SELECT * FROM  __tmp_ids WHERE 
    (expiry = 0 OR expiry > UNIX_TIMESTAMP());

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_check_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `acl_check_next`(
  IN _key VARCHAR(16),
  IN _permission TINYINT(4),
  IN _nodes JSON
)
BEGIN

  DECLARE _uid VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _area VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _mfs_root VARCHAR(512);

  DECLARE _rid VARCHAR(16);
  DECLARE _i INT(4) DEFAULT 0;

  SELECT id FROM yp.entity WHERE id=_key or ident=_key INTO _uid;

  DROP TABLE IF EXISTS __tmp_ids;
  CREATE TEMPORARY TABLE __tmp_ids(
    `id` varchar(16) DEFAULT NULL,
    db_name varchar(90) DEFAULT NULL,
    expiry tinyint(4) unsigned,
    asked  tinyint(4) unsigned,
    privilege int(11) 
  ); 

  WHILE _i < JSON_LENGTH(_nodes) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _i, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.nid")) INTO _rid;
    SELECT db_name, area, owner_id, concat(home_dir, "__storage__/")
      FROM yp.entity LEFT JOIN yp.hub USING(id) WHERE 
      
      id = yp.hub_id(JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.hub_id")))
      INTO _src_db_name, _area, _owner_id, _mfs_root; 
    
    IF _src_db_name IS NOT NULL THEN 
      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_permission (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resperm");
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt; 

      SET @s = CONCAT(
        "SELECT " ,_src_db_name,".user_expiry (", QUOTE(_uid),",",QUOTE(_rid), ") INTO @resexpiry");
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      SELECT IF(_area='public', GREATEST(7, @resperm), @resperm) INTO @resperm;
      INSERT INTO __tmp_ids SELECT 
        _rid, _src_db_name, @resexpiry, _permission, CAST(@resperm AS UNSIGNED); 
    END IF;

    SELECT _i + 1 INTO _i;
  END WHILE;
  
  SELECT * FROM  __tmp_ids WHERE 
    (expiry = 0 OR expiry > UNIX_TIMESTAMP());

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_revoke` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `acl_revoke`(
  IN _rid VARCHAR(16),
  IN _eid VARCHAR(16)
)
BEGIN

  IF _eid != '' THEN
    DELETE FROM acl WHERE resource_id=_rid AND entity_id=_eid;
  ELSE
    DELETE FROM acl WHERE resource_id=_rid;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `acl_show_users` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `acl_show_users`(
  IN _resouce_id VARCHAR(16)
)
BEGIN
  DECLARE _node_permission VARCHAR(16);
  DECLARE _level VARCHAR(16);

  SELECT permission_tree(_resouce_id) INTO _node_permission;
  SELECT 
    CASE 
      WHEN _node_permission = '*' THEN 'hub'
      WHEN _node_permission = _resouce_id THEN 'node'
      ELSE 'parent'
    END
  INTO _level;

  SELECT 
    entity_id AS uid, 
    firstname,
    lastname,
    _level AS level,
    IF(expiry_time > 0, expiry_time - UNIX_TIMESTAMP(), 0) AS ttl,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.avatar')), 'default')) AS avatar,
    permission AS privilege
  FROM permission INNER JOIN (yp.drumate) ON drumate.id=entity_id 
  WHERE resource_id = _node_permission

  UNION

  SELECT 
    entity_id AS uid, 
    firstname,
    lastname,
    'hub' AS level,
    IF(expiry_time > 0, expiry_time - UNIX_TIMESTAMP(), 0) AS ttl,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.avatar')), 'default')) AS avatar,
    permission AS privilege
  FROM permission INNER JOIN (yp.drumate) ON drumate.id=entity_id 
  WHERE resource_id = '*';

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `add_agenda`(
    _name VARCHAR(255),
    _place VARCHAR(255),
    _contact_ids MEDIUMTEXT,
    _stime int(11) ,
    _etime int(11) ,  
    _owner_id  VARCHAR(16),
    _calendar_id VARCHAR(16)   
    
)
BEGIN
    DECLARE _agenda_id VARCHAR(16); 

    DECLARE _category  VARCHAR(16);
    DECLARE _i INTEGER DEFAULT 0;
    
    DECLARE _contact_id VARCHAR(16);
    DECLARE _drumate_id VARCHAR(16);

    DECLARE _drumate_db VARCHAR(255); 
    DECLARE _time int(11) unsigned;

    IF _name = '' THEN 
        SELECT NULL INTO _name;
    END IF; 

    IF _place = '' THEN 
        SELECT NULL INTO _place;
    END IF;
    
    IF _etime = '' or _etime = 0 THEN 
        SELECT NULL INTO _etime;
    END IF;

    IF _calendar_id = '' THEN
        SELECT NULL INTO _calendar_id;
    END IF;


    SELECT  yp.uniqueId() INTO _agenda_id; 
    SELECT UNIX_TIMESTAMP() INTO _time; 
    SELECT id FROM yp.entity WHERE db_name=database() INTO _drumate_id;
    SELECT CASE WHEN _owner_id = _drumate_id THEN 'own' ELSE 'other' END INTO _category; 


    CALL insert_agenda(_agenda_id,_name,_place,_category,_owner_id,_calendar_id,_stime,_etime);

    UPDATE calendar SET is_selected=1  WHERE calendar_id=_calendar_id;
     
    
    WHILE _i < JSON_LENGTH(_contact_ids) DO 
        SELECT NULL,NULL , NULL INTO _drumate_id ,_drumate_db, _contact_id;
        
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_contact_ids, CONCAT("$[", _i, "]")))  INTO _contact_id ;
        
        
        SELECT  (SELECT id FROM contact WHERE id = _contact_id) INTO _contact_id; 
        SELECT db_name FROM yp.entity WHERE id=_contact_id INTO _drumate_db;
        SELECT *  FROM (SELECT _contact_id ) a WHERE  _drumate_db IS NOT NULL INTO _drumate_id ;     

      

        IF _contact_id IS NOT NULL THEN
            CALL add_map_agenda (_agenda_id,_contact_id, _drumate_id);
        END IF;

        IF _drumate_id IS NOT NULL THEN


            SET @st = CONCAT(
             'CALL ', _drumate_db ,'.add_map_agenda (', QUOTE(_agenda_id) ,',', QUOTE(_owner_id),',', QUOTE(_owner_id),')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.add_calendar(', QUOTE(_owner_id) ,',null,',  QUOTE(_owner_id),',0,0 )' );
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 


           
            SET @st = CONCAT(
            'CALL  ', _drumate_db ,'.insert_agenda(', QUOTE(_agenda_id) ,',', QUOTE(_name),',',
            IFNULL(QUOTE(_place),"NULL"),',"other",',QUOTE(_owner_id),',',QUOTE(_owner_id),',',_stime,',',
            IFNULL(_etime,"NULL"),')');
            
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

     END IF;
        
        
        SELECT _i + 1 INTO _i;
    END WHILE;
        
    CALL show_detail_agenda(_agenda_id);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `add_calendar`(
    _name VARCHAR(255),
    _color VARCHAR(10),
    _owner_id  VARCHAR(16),
    _is_default  BOOLEAN,
    _is_show_result   BOOLEAN
)
BEGIN
    DECLARE _calendar_id VARCHAR(16); 
    DECLARE _drumate_id  VARCHAR(16);
    DECLARE _category  VARCHAR(16);

  
    SELECT id FROM yp.entity WHERE db_name=database() INTO _drumate_id;
    SELECT CASE WHEN _owner_id = _drumate_id THEN 'own' ELSE 'other' END INTO _category; 
    SELECT  yp.uniqueId() INTO _calendar_id; 
    
    IF _category = 'other' THEN
      
      SELECT  _owner_id INTO _calendar_id; 
    
    END IF ;


    IF IFNULL(_is_default,0) = 1 THEN 
    
        UPDATE calendar SET  is_default = 0 WHERE is_default = 1 ;
    
    END IF; 

  
        INSERT INTO calendar (calendar_id,name,color,category,owner_id,is_selected,is_default,ctime)
        SELECT _calendar_id,_name,_color,_category,_owner_id,0,_is_default,UNIX_TIMESTAMP()  ON DUPLICATE KEY UPDATE ctime = UNIX_TIMESTAMP(),is_default=_is_default ;
  
    IF _is_show_result = 1 THEN    
        CALL show_calendar(_calendar_id);
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_huber` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `add_huber`(
  IN _uid  VARCHAR(16),
  IN _privilege INT(8),
  IN _expiry_time INT(11)
)
BEGIN
  DECLARE _ts INT(11) DEFAULT 0;
  SELECT UNIX_TIMESTAMP() INTO _ts;
  INSERT into huber values(null, _uid, _privilege, IF(IFNULL(_expiry_time, 0) = 0, 0,
      UNIX_TIMESTAMP(TIMESTAMPADD(HOUR,_expiry_time, FROM_UNIXTIME(_ts)))), _ts, NULL)
      ON DUPLICATE KEY UPDATE privilege=_privilege,
      expiry_time = IF(IFNULL(_expiry_time, 0) = 0, 0,
      UNIX_TIMESTAMP(TIMESTAMPADD(HOUR,_expiry_time, FROM_UNIXTIME(_ts)))),
      utime = _ts;
  SELECT
    entity.id,
    entity.ident,
    entity.area,
    entity.vhost,
    drumate.dmail,
    drumate.email,
    drumate.firstname,
    drumate.lastname,
    drumate.remit,
    CONCAT(firstname, ' ', lastname) as `fullname`,
    privilege
  FROM yp.entity INNER JOIN (yp.drumate, huber) ON (drumate.id=entity.id AND huber.id=entity.id)
    WHERE drumate.id=_uid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_intial_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `add_intial_calendar`()
BEGIN
        DECLARE _check_any INT(1);
        DECLARE _owner_id VARCHAR(16);

        SET _check_any = 0;
        SELECT 1 FROM calendar WHERE category = 'own' LIMIT 1 INTO _check_any;

    IF _check_any =0 THEN
            SELECT id FROM yp.entity WHERE db_name=database() INTO _owner_id;
            CALL add_calendar('My calendar',null,_owner_id,1,0);
    END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_map_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `add_map_agenda`(
    _agenda_id VARCHAR(16),
    _contact_id VARCHAR(16), 
    _drumate_id VARCHAR(16)
)
BEGIN

    INSERT INTO map_agenda (agenda_id,contact_id,uid,ctime)   
    SELECT _agenda_id,_contact_id, _drumate_id ,UNIX_TIMESTAMP() ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_member` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `add_member`(
  IN _member_id  VARCHAR(512),
  IN _privilege TINYINT(2),
  IN _expiry_time INT(11)
)
BEGIN
  DECLARE _member_db VARCHAR(30);
  DECLARE _hub_db VARCHAR(30);
  DECLARE _area VARCHAR(30);
  DECLARE _hid VARCHAR(16);
  DECLARE _uid VARCHAR(16);
  DECLARE _guest_id VARCHAR(16);
  DECLARE _ts INT(11) DEFAULT 0;
  DECLARE _tx INT(11) DEFAULT 0;

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT IF(IFNULL(_expiry_time, 0) = 0, 0,
    UNIX_TIMESTAMP(TIMESTAMPADD(HOUR,_expiry_time, FROM_UNIXTIME(_ts)))) INTO _tx;

  SELECT id, db_name FROM yp.entity WHERE id = _member_id OR ident = _member_id 
    INTO _uid, _member_db;

  SELECT id, area FROM yp.entity WHERE db_name = database() INTO _hid, _area;
  SELECT id FROM yp.guest WHERE id = _member_id OR email = _member_id INTO _guest_id;
  
  IF _member_db IS NOT NULL THEN 
    REPLACE INTO permission 
      VALUES(null, '*', _uid, '', _tx, _ts, _ts, _privilege, 'share');

    SET @s = CONCAT("CALL `", _member_db, "`.join_hub(", quote(_hid), ");");
    

    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    SET @s = CONCAT("REPLACE INTO  `", _member_db, "`.permission VALUES(null, ", 
      "'"  , _hid         , "'," ,
      "'"  , _uid         , "'," ,
      "'"  , "---"        , "'," ,
      "'"  , _expiry_time , "'," ,
      "'"  , _ts          , "'," ,
      "'"  , _ts          , "'," ,
      "'"  , _privilege   , "'," ,
      "'"  , 'share'      , "')" 
    );
      
    
    
    

    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    SELECT
      entity.id,
      entity.ident,
      entity.area_id,
      entity.area,
      entity.db_name,
      entity.vhost,
      drumate.dmail,
      drumate.email,
      drumate.firstname,
      drumate.lastname,
      drumate.gender,
      drumate.remit,
      CONCAT(firstname, ' ', lastname) as `fullname`,
      permission AS permission
    FROM yp.entity INNER JOIN (yp.drumate, permission) ON (drumate.id=entity.id AND 
    permission.entity_id=entity.id)
    WHERE entity.id=_uid;
  ELSEIF _area = 'restricted' AND _guest_id IS NOT NULL THEN
    REPLACE INTO permission 
      VALUES(null, '*', _guest_id, '', _tx, _ts, _ts, _privilege, 'share');
    SELECT
      guest.id,
      guest.email,
      guest.firstname,
      guest.lastname,
      CONCAT(firstname, ' ', lastname) as `fullname`,
      permission AS permission
    FROM yp.guest INNER JOIN (permission) ON guest.id=entity.id WHERE guest.id=_guest_id;
  ELSE
    SELECT _member_db AS db_name, _area AS area, 0 AS permission ;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `all_read_count` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `all_read_count`()
BEGIN

  DECLARE _db_name VARCHAR(500);
  DECLARE _temp_result JSON;
  DECLARE _uid VARCHAR(16) CHARACTER SET ascii;
  DECLARE _nid VARCHAR(16) CHARACTER SET ascii;
  DECLARE _read_cnt INT ;
  DECLARE _is_archive INT ;  
  DECLARE _contact_chat_cnt INT DEFAULT 0;  
  DECLARE _share_chat_cnt INT DEFAULT 0 ;  
  DECLARE _archive_chat_cnt INT DEFAULT 0 ; 
  DECLARE _support_chat_cnt INT DEFAULT 0 ; 
  DECLARE _head_chat_cnt INT DEFAULT 0 ; 
  DECLARE _archive_head_chat_cnt INT DEFAULT 0 ; 

  DECLARE _domain_id INT;
  DECLARE _is_support INT DEFAULT 0 ;

  SELECT 
    COUNT(1) , COUNT( DISTINCT ch.entity_id )
  FROM 
  channel ch 
  INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
  INNER JOIN  contact c ON c.uid = ch.entity_id
  WHERE
    ch.entity_id = ch.author_id AND 
    rc.entity_id <> rc.uid  AND 
    ch.sys_id > rc.ref_sys_id INTO _contact_chat_cnt,_head_chat_cnt; 


  SELECT 
    COUNT(1) , COUNT( DISTINCT ch.entity_id )
  FROM 
  channel ch 
  INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
  INNER JOIN  contact c ON c.uid = ch.entity_id
  INNER JOIN  archive_entity ae ON c.id = ae.entity_id
  WHERE
    ch.entity_id = ch.author_id AND 
    rc.entity_id <> rc.uid  AND 
    ch.sys_id > rc.ref_sys_id INTO _archive_chat_cnt,_archive_head_chat_cnt ; 

  SELECT _contact_chat_cnt -  _archive_chat_cnt INTO _contact_chat_cnt;
  SELECT _head_chat_cnt -  _archive_head_chat_cnt INTO _head_chat_cnt;

  DROP TABLE IF EXISTS _show_node;
  CREATE TEMPORARY TABLE _show_node  AS  
    SELECT 
      m.id, db_name,  CASE WHEN ae.entity_id = m.id THEN 1 ELSE 0 END is_archive
    FROM 
    media m
    INNER JOIN yp.hub h on  h.id = m.id 
    INNER  JOIN yp.entity he ON m.id = he.id
    LEFT JOIN  archive_entity ae ON m.id = ae.entity_id
    WHERE category = 'hub' ;

  ALTER TABLE _show_node ADD `is_checked` boolean default 0 ;

  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _uid;
  SELECT id, db_name, is_archive FROM _show_node WHERE is_checked =0  LIMIT 1 
    INTO _nid, _db_name,_is_archive; 

  WHILE _nid IS NOT NULL DO

    SET @st = CONCAT('CALL ', _db_name ,'.room_detail(?,?)');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING  JSON_OBJECT('uid',_uid ), _temp_result ;
    DEALLOCATE PREPARE stamt; 
      
    SELECT JSON_VALUE(_temp_result, "$.read_cnt") INTO _read_cnt;  

    IF _is_archive = 0 THEN  
      SELECT IFNULL(_read_cnt, 0) +  _share_chat_cnt INTO _share_chat_cnt; 
      SELECT _head_chat_cnt + 1 INTO _head_chat_cnt  WHERE IFNULL(_read_cnt, 0) > 0; 
                 
    ELSE
      SELECT IFNULL(_read_cnt, 0) +  _archive_chat_cnt INTO _archive_chat_cnt; 
    END IF ; 

    UPDATE _show_node SET is_checked = 1 WHERE id = _nid ;
    SELECT 0, NULL INTO _read_cnt, _nid;
    SELECT id, db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
  END WHILE;


    SELECT domain_id FROM yp.privilege WHERE uid = _uid INTO _domain_id;
    SELECT 1  FROM yp.sys_conf WHERE  conf_key = 'support_domain' AND conf_value =_domain_id INTO _is_support;

  IF _is_support = 1 THEN
      SELECT 
        COUNT(1)
      FROM 
      yp.ticket t 
      LEFT JOIN yp.read_ticket_channel rtc on rtc.ticket_id = t.ticket_id AND rtc.uid = _uid
      WHERE 
        t.last_sys_id > IFNULL(rtc.ref_sys_id,0)  
      INTO _support_chat_cnt;
  ELSE 
      SELECT 
        COUNT(1)
      FROM 
      yp.ticket t 
      INNER JOIN yp.read_ticket_channel rtc on rtc.ticket_id = t.ticket_id AND rtc.uid = _uid
      WHERE 
        t.last_sys_id > rtc.ref_sys_id AND t.uid = _uid
      INTO _support_chat_cnt;
  END  IF; 
  
    SELECT _share_chat_cnt  share_chat_cnt , _contact_chat_cnt  contact_chat_cnt, _archive_chat_cnt archive_chat_cnt, _support_chat_cnt support_cnt,
          _head_chat_cnt head_chat_cnt, (_share_chat_cnt + _contact_chat_cnt + _archive_chat_cnt +_support_chat_cnt ) total_cnt; 


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `archive_entity` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `archive_entity`(
 _entity_id VARCHAR(16)
)
BEGIN
  REPLACE INTO archive_entity(entity_id) SELECT _entity_id;
  SELECT * FROM archive_entity WHERE entity_id = _entity_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `archive_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `archive_get`(
 _entity_id VARCHAR(16)
)
BEGIN
  SELECT * FROM archive_entity WHERE entity_id = _en;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `archive_getall` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `archive_getall`()
BEGIN
  SELECT * FROM archive_entity ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `blacklist_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `blacklist_add`(
  IN _emails    MEDIUMTEXT
)
BEGIN
  DECLARE _i INTEGER DEFAULT 0;
  WHILE _i < JSON_LENGTH(_emails) DO 
    INSERT IGNORE INTO blacklist VALUES(
      null, 
      JSON_UNQUOTE(JSON_EXTRACT(_emails, CONCAT("$[", _i, "]"))), 
      UNIX_TIMESTAMP()
    );
    SELECT _i + 1 INTO _i;
  END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `blacklist_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `blacklist_delete`(
  IN _emails    MEDIUMTEXT
)
BEGIN
  DECLARE _i INTEGER DEFAULT 0;
  WHILE _i < JSON_LENGTH(_emails) DO 
    DELETE FROM blacklist 
      WHERE email = JSON_UNQUOTE(JSON_EXTRACT(_emails, CONCAT("$[", _i, "]")));
    SELECT _i + 1 INTO _i;
  END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `blacklist_show` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `blacklist_show`(
  _page INT(6)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT d.id AS id, d.email AS email,
  JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.firstname')) AS firstname,
  JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.lastname'))  AS lastname,
  JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.mobile'))  AS mobile,
  _page AS page
  FROM yp.drumate d JOIN blacklist b ON d.email = b.email
  ORDER BY CONCAT(firstname, ' ', lastname) ASC, email ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_add_history` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_add_history`(
   IN _id        VARCHAR(512),
   IN _hashtag   VARCHAR(512),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _status    VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16)
)
BEGIN
    DECLARE _ts   INT(11) DEFAULT 0;
    SELECT UNIX_TIMESTAMP() INTO _ts;
    INSERT INTO block_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `status`, `isonline`, `ctime`)
      VALUES(_author_id, _id, _lang, _device, _hashtag, _status, _isonline, _ts);
    SELECT LAST_INSERT_ID() as history_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_copy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_copy`(
   IN _key    VARCHAR(16),
   IN _author  VARCHAR(160)
)
BEGIN
   DECLARE _id VARBINARY(16) DEFAULT '';
   DECLARE _hashtag VARCHAR(512);
   DECLARE _version TINYINT(4);
   DECLARE _tag VARCHAR(512);
   DECLARE _ident VARCHAR(512);

   SELECT id, hashtag FROM block WHERE (id=_key OR hashtag=_key) INTO _id, _hashtag;
   SELECT COUNT(*) FROM block WHERE hashtag LIKE concat(_hashtag, '-v%') INTO _version;
   SET _hashtag = CONCAT(_hashtag, '-v', _version);
   SELECT COUNT(*) FROM block WHERE hashtag = _hashtag INTO _version;
   WHILE _version > 0 DO
      SET _version = _version + 1;
      SET _hashtag = CONCAT(_hashtag, '-v', _version);
      SELECT COUNT(*) FROM block WHERE hashtag = _hashtag INTO _version;
   END WHILE;
   INSERT INTO block
      SELECT null, uniqueId(), serial, active, _author, _hashtag, `type`, editor, status, ctime, mtime, version
      FROM block WHERE id=_id;
   SELECT *, @vhost AS vhost, _id as src_id FROM block WHERE hashtag=_hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_copy_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_copy_new`(
   IN _history_id     VARCHAR(16),
   IN _author         VARCHAR(160),
   IN _to_lang        VARCHAR(20),
   IN _hashtag        VARCHAR(512),
   IN _new_page       VARCHAR(10)
)
BEGIN
   DECLARE _id VARBINARY(16) DEFAULT '';
   DECLARE _new_id VARBINARY(16) DEFAULT '';
   DECLARE _version TINYINT(4);
   DECLARE _tag VARCHAR(512);
   DECLARE _ident VARCHAR(512);
   DECLARE _lang varchar(10);
   DECLARE _device varchar(100);
   DECLARE _ts INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;
   DECLARE _block_exist INT(4) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   START TRANSACTION;
   SELECT master_id, lang, device FROM block_history WHERE serial = _history_id INTO _id, _lang, _device;
   
   SELECT EXISTS (SELECT serial FROM block_history WHERE master_id = _id AND lang = _to_lang AND device = _device) INTO _block_exist;
   IF _lang <> _to_lang AND _block_exist = 1 AND _new_page = "0" THEN
      SELECT 1 AS confirm_copy;
   ELSE
      IF _lang = _to_lang OR (_block_exist = 1 AND _lang <> _to_lang AND _new_page = "1") THEN
        SELECT UNIQUEID() INTO _new_id;
        IF IFNULL(_hashtag, '') = "" THEN
          SELECT hashtag FROM block WHERE id = _id INTO _hashtag;
          
          
          
          
          
          
          
          
          SELECT IFNULL(MAX(SUBSTRING_INDEX(hashtag, '-v', -1)),-1) as d FROM block
            WHERE hashtag REGEXP CONCAT(_hashtag, '-v[0-9]*$') INTO _version;
          SET _hashtag = CONCAT(_hashtag, '-v', _version + 1);

        END IF;
      ELSE
          SELECT _id INTO _new_id;
      END IF;

      UPDATE block_history SET status = 'history' WHERE master_id = _new_id AND lang = _to_lang AND device = _device;
      INSERT INTO block_history (`author_id`, `master_id`, `lang`, `device`, `status`, `isonline`, `meta`, `ctime`)
          VALUES(_author, _new_id, _to_lang, _device, 'draft', 0, _hashtag, _ts);
      SELECT LAST_INSERT_ID() INTO _last;

      IF _lang = _to_lang OR (_block_exist = 1 AND _lang <> _to_lang AND _new_page = "1") THEN
          INSERT INTO block (sys_id, id, serial, active, author_id, hashtag, `type`, editor, status, ctime, mtime, version)
              SELECT null, _new_id, _last, _last, _author, _hashtag, `type`, editor, status, _ts, _ts, version
              FROM block WHERE id=_id;
      END IF;
      COMMIT;
      SELECT *, _hashtag AS hashtag, @vhost AS vhost, _id as src_id, 0 AS confirm_copy FROM block_history WHERE serial=_last;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_delete_by_id_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_delete_by_id_lang`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
  
  DECLARE _eid VARCHAR (16);

  DELETE FROM block_history WHERE master_id = _id AND lang = _locale AND device = _device;
  DELETE block FROM block WHERE id = _id AND id NOT IN (SELECT master_id
    FROM block_history WHERE master_id = _id);
  
  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_delete_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_delete_by_lang`(
   IN _locale       VARCHAR(100)
)
BEGIN
  DELETE FROM block_history WHERE lang=_locale;
  DELETE block FROM block WHERE id NOT IN (SELECT master_id FROM block_history);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_exists` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_exists`(
  IN _hashtag        VARCHAR(512)
)
BEGIN
  SELECT id FROM block WHERE hashtag = _hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get`(
   IN _tag VARCHAR(512),
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16)
)
BEGIN
   DECLARE _existence INT(4);
   SELECT EXISTS (
    SELECT master_id FROM block LEFT JOIN block_history 
      ON master_id = block.id 
      WHERE block.id=_tag OR hashtag=_tag
      AND lang = _lang AND device = _device
   ) INTO _existence;
          
  IF _existence THEN
   SELECT 
    block.id, 
    active, 
    hashtag, 
    `type`, 
    editor, 
    block.status, 
    firstname, 
    lastname,
    ctime, 
    mtime, 
    version
      FROM block LEFT JOIN yp.drumate ON block.author_id=drumate.id
      WHERE (block.id=_tag OR hashtag=_tag);
      
      
      
      
  ELSE
    SELECT id, status FROM block WHERE id=_tag OR hashtag=_tag;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_base_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_base_by_lang`(
   IN _base_lang       VARCHAR(100)
)
BEGIN
  SELECT serial AS history_id, master_id AS block_id, lang, device, status, isonline, meta
    FROM block_history WHERE (lang = _base_lang AND isonline=1)
    OR (lang = _base_lang AND status='draft' AND isonline=0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_by_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_by_id`(
   IN _key VARCHAR(512)
)
BEGIN
  SELECT block.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
    FROM block LEFT JOIN yp.drumate ON author_id=drumate.id WHERE block.id = _key OR hashtag= _key;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_by_type` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_by_type`(
   IN _tag VARCHAR(512),
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16),
   IN _type  VARCHAR(16)

)
BEGIN
   SELECT block.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
         FROM block LEFT JOIN yp.drumate ON author_id=drumate.id WHERE `type`=_type;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_draft_publish` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_draft_publish`(
   IN _locale       VARCHAR(100),
   IN _published    INT(4),
   IN _hashtag      VARCHAR(500),
   IN _sort_by      VARCHAR(100),
   IN _sort         VARCHAR(100),
   IN _page         INT(11)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT bh.serial AS history_id, id AS block_id, lang, device, bh.status,
    isonline, hashtag  FROM block b INNER JOIN block_history bh ON b.id = bh.master_id
    WHERE lang = _locale AND hashtag LIKE CONCAT('%', TRIM(IFNULL(_hashtag,'')), '%')
    AND CASE WHEN _published = 1 OR _published = 2 THEN 
      CASE WHEN _published = 2 THEN (bh.status = 'draft' OR isonline=1)
      ELSE isonline = 1 END
    ELSE bh.status = 'draft' END
    ORDER BY
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_sort) = 'asc' THEN b.mtime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_sort) = 'desc' THEN b.mtime END DESC,
    CASE WHEN LCASE(_sort) = 'desc' THEN hashtag END DESC,
    CASE WHEN LCASE(_sort) <> 'desc' THEN hashtag END ASC
    LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_thread` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_thread`(
  IN _key VARCHAR(500),
  IN _criteria VARCHAR(16),
  IN _page TINYINT(4)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _head int(6);
  DECLARE _hashtag VARCHAR(500);
  DECLARE _id VARBINARY(16);
  DECLARE _status VARCHAR(16);

  CALL pageToLimits(_page, _offset, _range);

  SELECT id, status, active, hashtag FROM block WHERE id=_key OR hashtag=_key
     INTO _id, _status, _head, _hashtag;

  IF _criteria LIKE "D%" THEN
    SELECT serial, author_id, master_id, lang, device, _hashtag as hashtag,
          master_id as id, firstname, lastname, ctime, _head as head
    FROM block_history LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE master_id=_id ORDER BY ctime DESC LIMIT _offset, _range;
  ELSE
    SELECT serial, author_id, master_id, lang, device, _hashtag as hashtag,
          master_id as id, firstname, lastname, ctime, _head as head
    FROM block_history LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE master_id=_id ORDER BY ctime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_get_used_languages` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_get_used_languages`(
  IN _hashtag  varchar(256)
)
BEGIN
  SELECT lang FROM block LEFT JOIN block_history ON block.id=master_id 
  WHERE hashtag=_hashtag or master_id=_hashtag GROUP BY lang;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_history_check_published` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_history_check_published`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
  SELECT EXISTS (SELECT serial FROM block_history WHERE master_id = _id AND isonline = 1
    AND lang = _locale AND device = _device) AS IS_PUBLISHED;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_history_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_history_log`(
  IN _tag VARCHAR(400),
  IN _device VARCHAR(16),
  IN _lang VARCHAR(16),
  IN _page TINYINT(4),
  IN _month INT(4),
  IN _year INT(4),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _active int(8);
  DECLARE _id   VARBINARY(16) DEFAULT '';
  DECLARE _hashtag   varchar(400);

  SELECT id, hashtag, active FROM block WHERE id=_tag OR hashtag=_tag INTO _id, _hashtag, _active;
  CALL pageToLimits(_page, _offset, _range);

  IF _criteria LIKE "D%" THEN
    SELECT _hashtag AS hashtag, author_id, _id AS id,
       serial, ctime, firstname, lastname,lang, device, IF(serial=_active, 1, 0) AS active,
       FROM_UNIXTIME(ctime) AS created_date, status, isonline
       FROM block_history LEFT JOIN (yp.drumate)
       ON author_id=drumate.id
       WHERE master_id=_id AND lang=_lang AND device=_device
       AND CASE WHEN IFNULL(_month,0) <> 0 AND IFNULL(_year,0) <> 0 THEN
       MONTH(FROM_UNIXTIME(ctime)) = _month ELSE true END
       AND CASE WHEN IFNULL(_year,0) <> 0 THEN
       YEAR(FROM_UNIXTIME(ctime)) = _year ELSE true END
       ORDER BY ctime DESC LIMIT _offset, _range;
  ELSE
    SELECT _hashtag AS hashtag, author_id, _id AS id,
       serial, ctime, firstname, lastname,lang, device, IF(serial=_active, 1, 0) AS active,
       FROM_UNIXTIME(ctime) AS created_date, status, isonline
       FROM block_history LEFT JOIN (yp.drumate)
       ON author_id=drumate.id
       WHERE master_id=_id AND lang=_lang AND device=_device
       AND CASE WHEN IFNULL(_month,0) <> 0 AND IFNULL(_year,0) <> 0 THEN
       MONTH(FROM_UNIXTIME(ctime)) = _month ELSE true END
       AND CASE WHEN IFNULL(_year,0) <> 0 THEN
       YEAR(FROM_UNIXTIME(ctime)) = _year ELSE true END
       ORDER BY ctime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_home` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_home`(
)
BEGIN
  DECLARE _languages VARCHAR(512);
  SELECT
    area, concat(TRIM(TRAILING '/' FROM home_dir), '/Block/'), id from yp.entity where db_name=database()
  INTO @area, @root, @entity_id;
  SELECT GROUP_CONCAT(DISTINCT `base` SEPARATOR ':' ) FROM `language` WHERE `state`='active'
    INTO _languages;

  SELECT 
    @area as area, 
    @entity_id as eid, 
    @root AS block_root,
   _languages AS languages;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_id_get_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_id_get_by_lang`(
   IN _locale       VARCHAR(100)
)
BEGIN
  SELECT master_id as block_id FROM block_history WHERE lang=_locale GROUP BY master_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_index` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_index`(
   IN _hashtag  varchar(256),
   IN _lang  VARCHAR(6),
   IN _content  MEDIUMTEXT
)
BEGIN
   DECLARE _key  VARCHAR(25);
   SELECT CONCAT(id, '-', _lang) FROM block WHERE hashtag=_hashtag INTO _key;
   REPLACE INTO seo
     (`key`, `hashtag`, `lang`, `content`)
     VALUES(_key, _hashtag, _lang, _content);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_info` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_info`(
  IN _hashtag      VARCHAR(500)
)
BEGIN
  SELECT * FROM block WHERE hashtag=_hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_list`(
  IN _page TINYINT(4),
  IN _editor VARCHAR(10),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);

  IF _criteria LIKE "D%" THEN
    SELECT
      block.id, serial, active, hashtag, `type`, `status`, `ctime`, `mtime`, `version`,
      remit, firstname, lastname
    FROM block LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE editor=_editor AND (`type`='page' OR `type`= 'block')
      ORDER BY mtime DESC LIMIT _offset, _range;
  ELSE
    SELECT
      block.id, serial, active, hashtag, `type`, `status`, `ctime`, `mtime`, `version`,
      remit, firstname, lastname
    FROM block LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE editor=_editor AND (`type`='page' OR `type`= 'block')
      ORDER BY mtime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_purge` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_purge`(
   IN _tag      varchar(400)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _hashtag   varchar(400);

   SELECT id, hashtag FROM block WHERE id=_tag OR hashtag=_tag INTO _id, _hashtag;

   DELETE FROM block_history WHERE master_id=_id;
   DELETE FROM block WHERE id=_id;
   SELECT _id as id, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_remove_item` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_remove_item`(
   IN _id      VARBINARY(16)
)
BEGIN
   DELETE FROM block WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_remove_thread` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_remove_thread`(
   IN _id      VARBINARY(16)
)
BEGIN
   DELETE FROM block WHERE id=_id;
   DELETE FROM thread WHERE mester_id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_rename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_rename`(
   IN _key     VARCHAR(512),
   IN _hashtag VARCHAR(512)
)
BEGIN

   UPDATE block SET hashtag=_hashtag WHERE (id=_key OR hashtag=_key);
   SELECT
     *,
     @vhost AS vhost
   FROM block WHERE hashtag=_hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_rename_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_rename_new`(
   IN _id             VARCHAR(16),
   IN _hashtag        VARCHAR(512)
)
BEGIN
   DECLARE _hash_exist INT(4) DEFAULT 0;
   DECLARE _eid VARCHAR (16);

   SELECT EXISTS (SELECT id FROM block WHERE id <> _id AND hashtag = _hashtag) INTO _hash_exist;

   IF _hash_exist = 0 THEN
    UPDATE block SET hashtag=_hashtag WHERE id=_id;
    UPDATE block_history SET meta=_hashtag WHERE master_id=_id;
   END IF;
  
  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
  


   SELECT
      *,
      @vhost AS vhost, _hash_exist AS hash_exist
   FROM block WHERE id=_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_save` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_save`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   START TRANSACTION;

   INSERT INTO block_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
         VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
   SELECT LAST_INSERT_ID() INTO _last;

   INSERT INTO block
     (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
     VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion)
     ON DUPLICATE KEY UPDATE serial=_last, active=_last, mtime=_ts;

   COMMIT;

   SELECT _id as id, _last as active, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_save_int` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_save_int`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;
   DECLARE _hash_exist INT(4) DEFAULT 0;
   DECLARE _eid VARCHAR (16);

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   SELECT EXISTS (SELECT id FROM block WHERE id <> _id AND hashtag = _hashtag) INTO _hash_exist;
   SELECT IFNULL(max(serial) + 1,1) FROM block_history INTO _last;
   IF _hash_exist = 0 THEN
    START TRANSACTION;

    INSERT INTO block_history (`serial`, `author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
        VALUES(_last, _author_id, _id, _lang, _device, _hashtag, _ts);
    

    UPDATE block_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
    UPDATE block_history SET status = 'draft' WHERE master_id=_id AND lang = _lang AND serial=_last;

    IF _isonline = 1 THEN
        UPDATE block_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
        UPDATE block_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_last;
    END IF;
    INSERT INTO block
      (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
      VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion)
      ON DUPLICATE KEY UPDATE serial=_last, active=_last, mtime=_ts;
    
    SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
    CALL yp.set_default_homepage(_eid);
   
    
    COMMIT;

    SELECT _id as id, _last as active, _hashtag as hashtag, _hash_exist AS hash_exist;
   ELSE
    SELECT _id as id, _hashtag as hashtag, _hash_exist AS hash_exist;
   END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_save_int_default_page` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_save_int_default_page`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
  DECLARE _id   VARCHAR(16) DEFAULT '';
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _last INT(11) DEFAULT 0;
  DECLARE _hash_exist INT(4) DEFAULT 0;
  DECLARE _src_path VARCHAR(512);

  SELECT UNIX_TIMESTAMP() INTO _ts;

  CALL yp.default_page(_hashtag, _lang, _src_path);

  IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
    SELECT yp.uniqueId() INTO _id;
  ELSE
    SELECT _inId INTO _id;
  END IF;

  
  
  
  

  SELECT active FROM `block` LEFT JOIN block_history ON block_history.`serial` = `block`.`serial`  
  WHERE `hashtag` = _hashtag AND block_history.lang = _lang INTO _last;


  
  IF _last IS NULL THEN
    START TRANSACTION;

    INSERT INTO block_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
        VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
    

    
    SELECT MAX(`serial`)+1 FROM block_history INTO _last;
    UPDATE block_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
    UPDATE block_history SET status = 'draft' 
      WHERE master_id=_id AND lang = _lang AND serial=_last;

    IF _isonline = 1 THEN
      UPDATE block_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
      UPDATE block_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_last;
    END IF;
    
    
    
    

    REPLACE INTO block
      (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, 
      `active`, `status`, `ctime`, `mtime`, `version`)
      VALUES(_id, _hashtag, _author_id, _editor, _type, _last, 
      _last, 'offline', _ts, _ts, _vesrion);

    COMMIT;

    SELECT _id as id, _lang AS lang, _last as active, 
      _hashtag as hashtag, _hash_exist AS hash_exist, _src_path AS src_path;
  ELSE
    SELECT _id as id, _lang AS lang, _hashtag as hashtag, _last AS active,
      _hash_exist AS hash_exist, _src_path AS src_path;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_save_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_save_menu`(
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16)
)
BEGIN
   SELECT block.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
         FROM block LEFT JOIN yp.drumate ON author_id=drumate.id WHERE `type`=_type;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_search`(
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    content as text,
    @vhost AS vhost,
    SUBSTRING(`key`, 1, 16) as id,
    hashtag,
    hashtag as `name`,
    MATCH(content) against(_pattern IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION) as s1,
    MATCH(hashtag) against(concat('*', _pattern, '*') IN BOOLEAN MODE) as s2
  FROM seo HAVING s1 > 0 or s2 > 0 ORDER BY s2 DESC, s1 DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_status` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_status`(
   IN _id      VARBINARY(16),
   IN _status  VARCHAR(16)
)
BEGIN
   UPDATE block SET status=_status WHERE id=_id;
   SELECT *, tag as hashtag FROM block WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_store` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_store`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' OR _inId='' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   START TRANSACTION;

   INSERT INTO block_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
         VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
   SELECT LAST_INSERT_ID() INTO _last;

   REPLACE INTO block
     (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
     VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion);
     

   COMMIT;

   SELECT _id as id, _last as active, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_unpublish` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_unpublish`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
   DECLARE _history_id   INT(11) DEFAULT 0;
   DECLARE _ts INT(11) DEFAULT 0;
   SELECT serial INTO _history_id FROM block_history WHERE master_id = _id AND isonline = 1 AND lang = _locale AND device = _device;
   SELECT UNIX_TIMESTAMP() INTO _ts;
   UPDATE block_history SET status = 'history', isonline = 0 WHERE master_id=_id AND lang = _locale AND device = _device;
   UPDATE block_history SET status = 'draft' WHERE serial=_history_id;
   UPDATE block SET serial=_history_id, active=_history_id,mtime=_ts WHERE id=_id;
   SELECT id, active, hashtag, _history_id AS history_id FROM block WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_update` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_update`(
   IN _id      VARCHAR(16),
   IN _tag     VARCHAR(512),
   IN _author  VARCHAR(160),
   IN _lang    VARCHAR(20),
   IN _device  VARCHAR(20),
   IN _comment TEXT
)
BEGIN
   DECLARE _mtime INT(11) DEFAULT 0;
   DECLARE _url_key   VARCHAR(1000) DEFAULT '';
   SELECT UNIX_TIMESTAMP() INTO _mtime;
   UPDATE block SET hash=block_ident(_tag, _lang, _device),  tag=_tag,
     author=_author, comment=_comment, mtime=_mtime WHERE id=_id;
   SELECT
     *,
     @vhost AS vhost,
     tag as hashtag
   FROM block WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `block_update_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `block_update_new`(
   IN _id           VARCHAR(512),
   IN _history_id   INT(11),
   IN _lang         VARCHAR(20),
   IN _isonline     INT(4)
)
BEGIN
   DECLARE _ts INT(11) DEFAULT 0;
   SELECT UNIX_TIMESTAMP() INTO _ts;
   UPDATE block_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
   UPDATE block_history SET status = 'draft' WHERE master_id=_id AND lang = _lang AND serial=_history_id;

   IF _isonline = 1 THEN
      UPDATE block_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
      UPDATE block_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_history_id;
   END IF;
   
   UPDATE block SET serial=_history_id, active=_history_id,mtime=_ts WHERE id=_id;
   SELECT id, active, hashtag FROM block WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `change_history` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `change_history`(
  IN _drumate_id  VARBINARY(16),
  IN _key         VARBINARY(80),
  IN _from        INT(11) UNSIGNED,
  IN _to          INT(11) UNSIGNED,
  IN _page        TINYINT(8)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  set @type = '';
  set @num  = 1;
  SELECT bh.serial AS history_id, master_id AS item_id, drumate.email, lang, device, bh.status,
    isonline, meta AS hashtag, bh.ctime, 'block' AS `type`, remit, firstname, lastname,
    "saved" AS modification, bh.author_id AS `user_id`, CONCAT('v',bh2.version) AS `version`
    FROM block_history bh JOIN block b ON b.id = bh.master_id
    JOIN (SELECT serial, @num := if(@type = master_id, @num + 1, 1) as `version`,
    @type := master_id as page FROM block_history ORDER BY master_id) AS bh2
    ON bh.serial = bh2.serial
    JOIN yp.drumate ON bh.author_id=drumate.id AND drumate.email LIKE CONCAT(IFNULL(_key,""), "%")
    WHERE ((bh.author_id=drumate.id AND IFNULL(_drumate_id,"") = "")
    OR (bh.author_id = _drumate_id AND IFNULL(_drumate_id,"") <> ""))
    AND CASE WHEN _from > 0 THEN bh.ctime >= _from  ELSE true END
    AND CASE WHEN _to > 0 THEN bh.ctime <= _to  ELSE true END
  UNION ALL
  SELECT m.sys_id AS history_id, m.id AS item_id, drumate.email, '', '', '', 0, user_filename AS hashtag,
    upload_time AS ctime, m.category AS `type`, remit, firstname, lastname,
    "uploaded" AS modification, origin_id AS `user_id`, "v1" AS `version`
    FROM media m JOIN yp.drumate ON origin_id=drumate.id AND drumate.email LIKE CONCAT(IFNULL(_key,""), "%")
    WHERE ((origin_id=drumate.id AND IFNULL(_drumate_id,"") = "")
    OR (origin_id = _drumate_id AND IFNULL(_drumate_id,"") <> ""))
    AND CASE WHEN _from > 0 THEN upload_time >= _from  ELSE true END
    AND CASE WHEN _to > 0 THEN upload_time <= _to  ELSE true END
  ORDER BY ctime DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `change_owner` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `change_owner`(
  IN _uid VARCHAR(16)
)
BEGIN
  DECLARE _db_name VARCHAR(30);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _ts INT(11);
  DECLARE _finished INTEGER DEFAULT 0;

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _hub_id;

  DROP TABLE IF EXISTS  _mid_tmp;  
  CREATE TEMPORARY TABLE `_mid_tmp` (db_name   VARCHAR(50));
  INSERT INTO _mid_tmp SELECT db_name FROM permission 
    LEFT JOIN yp.entity e ON entity_id=e.id WHERE permission&32>0 AND resource_id='*';

  BEGIN 
    DECLARE dbcursor CURSOR FOR SELECT db_name FROM _mid_tmp;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
    WHILE NOT _finished DO 
      FETCH dbcursor INTO _db_name;
      SET @s = CONCAT(
        "UPDATE `" ,_db_name,"`.permission SET permission=31, ", 
        "utime = UNIX_TIMESTAMP() WHERE resource_id=", QUOTE(_hub_id));
      
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
    END WHILE;
  END;

  
  UPDATE permission SET permission=31, utime = UNIX_TIMESTAMP()
    WHERE permission&32>0 AND resource_id='*';

  
  REPLACE INTO permission VALUES(NULL, '*', _uid, '', 0, _ts, _ts, 63, 'share');

  SELECT db_name FROM yp.entity WHERE id=_uid INTO _db_name;
  SET @s = CONCAT(
    "UPDATE `" ,_db_name,"`.permission SET permission=63, ", 
    "utime = UNIX_TIMESTAMP() WHERE resource_id=", QUOTE(_hub_id));
  
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  
  UPDATE yp.hub SET owner_id=_uid WHERE id=_hub_id;

  SELECT 
    entity_id AS uid, 
    firstname,
    lastname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.avatar')), 'default')) AS avatar,
    permission AS privilege
  FROM permission INNER JOIN (yp.drumate) ON drumate.id=entity_id 
  WHERE entity_id = _uid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_delete`(
  IN _option VARCHAR(16),
  IN _messages JSON
)
BEGIN

  DECLARE _ref_sys_id int(11) unsigned default 0 ;
  DECLARE _sys_id int(11) unsigned default 0 ;
  DECLARE _message_id VARCHAR(16);
  DECLARE _idx_node INT(4) DEFAULT 0; 

  DECLARE _ctime INT(11) unsigned;
  DECLARE _entity_id VARCHAR(16);
  DECLARE _entity_db VARCHAR(255);
  SELECT UNIX_TIMESTAMP() INTO _ctime;
  
  DROP TABLE IF EXISTS _show_node;
  CREATE TEMPORARY TABLE _show_node AS SELECT * FROM channel WHERE 1=2;

  WHILE _idx_node < JSON_LENGTH(_messages) DO 
      
    SELECT get_json_array(_messages, _idx_node) INTO _message_id;
  
    INSERT INTO _show_node SELECT  * FROM channel WHERE message_id = _message_id;
 
    
    IF _option='all' THEN
      SELECT entity_id FROM channel WHERE message_id = _message_id INTO _entity_id; 
      SELECT db_name FROM yp.entity WHERE id = _entity_id INTO _entity_db; 

      SET @st = CONCAT('DELETE FROM ', _entity_db ,'.channel WHERE message_id= ?');
      PREPARE stamt FROM @st;
      EXECUTE stamt USING _message_id ;
      DEALLOCATE PREPARE stamt; 
    END IF; 
    
    DELETE FROM channel WHERE message_id = _message_id; 
    
    SELECT NULL, NULL, NULL INTO _message_id,_entity_id,_entity_db ;
    SELECT _idx_node + 1 INTO _idx_node;
  END WHILE;
 

  SELECT * FROM _show_node;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_delete_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_delete_next`(
  IN _uid VARCHAR(16),
  IN _option VARCHAR(16),
  IN _messages JSON
)
BEGIN
  DECLARE _message_id VARCHAR(16);
  DECLARE _hub_id  VARCHAR(16);
  DECLARE _drumate_hub_id  VARCHAR(16);
  DECLARE _drumate_id  VARCHAR(16);
  DECLARE _nid  VARCHAR(16);
  DECLARE _node json;
  DECLARE _attachment  JSON;
  DECLARE _cnt INT(6) DEFAULT 0;
  DECLARE _idx_node INT(4) DEFAULT 0; 
  DECLARE _idx_attachment INT(4) DEFAULT 0; 
  DECLARE _sbx_id VARCHAR(16);
  DECLARE _sbx_db_name VARCHAR(255);
  DECLARE _type VARCHAR(16);
  DECLARE _entity_id VARCHAR(16);
  DECLARE _entity_db VARCHAR(255);  
  DECLARE _delete_nid VARCHAR(16);
  DECLARE _delete_attachment  JSON;
  DECLARE _ref_sys_id INT;



    SELECT id, type FROM yp.entity WHERE db_name=DATABASE() INTO _hub_id,_type;

    DROP TABLE IF EXISTS _show_node;
    CREATE TEMPORARY TABLE _show_node AS SELECT * FROM channel WHERE 1=2;
    ALTER TABLE _show_node ADD `delete_attachment` JSON;

    DROP TABLE IF EXISTS _list_uid;
    CREATE TEMPORARY TABLE _list_uid (id VARCHAR(16), hub_id VARCHAR(16));
    ALTER TABLE _list_uid ADD `is_checked` boolean default 0 ;
    
    INSERT INTO _list_uid (id,hub_id) SELECT _uid,_hub_id;
    
    IF _type = 'hub' AND _option = 'all'  THEN
      INSERT INTO _list_uid (id, hub_id) SELECT  d.id, _hub_id FROM .permission p 
      INNER JOIN yp.drumate d on p.entity_id=d.id 
      WHERE p.resource_id='*' AND  d.id <> _uid;
    END IF;
    
    IF _type <> 'hub' AND _option = 'all'  THEN
      SELECT get_json_array(_messages, 0) INTO _message_id;
      SELECT entity_id FROM channel WHERE message_id = _message_id INTO _entity_id;
      SELECT db_name FROM yp.entity WHERE id = _entity_id INTO _entity_db; 
      INSERT INTO _list_uid (id,hub_id) SELECT _entity_id,_entity_id;
    END IF; 



    WHILE _idx_node < JSON_LENGTH(_messages) DO 
      SELECT get_json_array(_messages, _idx_node) INTO _message_id;
    
      INSERT INTO _show_node SELECT  *, NULL FROM channel WHERE message_id = _message_id;
      SELECT attachment,sys_id FROM channel WHERE message_id = _message_id INTO _attachment,_ref_sys_id;
      
      SELECT '[]' INTO _delete_attachment ;
      WHILE _idx_attachment < JSON_LENGTH(_attachment) DO 
     
        SELECT JSON_QUERY(_attachment, CONCAT("$[", _idx_attachment, "]") ) INTO _node;
        SELECT JSON_VALUE(_node, '$.hub_id') INTO _sbx_id;
        SELECT JSON_VALUE(_node, '$.nid') INTO _nid;
        SELECT db_name FROM yp.entity WHERE id=_sbx_id INTO _sbx_db_name;

        UPDATE _list_uid SET is_checked = 0;
        
        SELECT id , hub_id FROM _list_uid WHERE is_checked =0  LIMIT 1 INTO _drumate_id , _drumate_hub_id;
          WHILE _drumate_id IS NOT NULL DO
            
            SET @s = CONCAT("CALL ",_sbx_db_name , ".channel_sbx_attachment_delete(?,?,?,?,?)");
            PREPARE stmt FROM @s;
            EXECUTE stmt USING  _message_id, _drumate_hub_id,_drumate_id,_nid, _delete_nid ;
            DEALLOCATE PREPARE stmt;
   
            SELECT JSON_ARRAY_INSERT(_delete_attachment , '$[0]', _node) INTO _delete_attachment WHERE  _delete_nid IS NOT NULL; 
            
            UPDATE _list_uid SET is_checked = 1 WHERE id = _drumate_id ;
            SELECT NULL,NULL INTO _drumate_id,_drumate_hub_id;
             SELECT id , hub_id FROM _list_uid WHERE is_checked =0  LIMIT 1 INTO _drumate_id , _drumate_hub_id;
          END WHILE;

        SELECT _idx_attachment + 1 INTO _idx_attachment;
      END WHILE;
     
      UPDATE  _show_node SET delete_attachment= _delete_attachment 
      WHERE message_id =_message_id AND _delete_attachment <> '[]' ;
 
      IF _entity_db IS NOT NULL THEN

        SET @st = CONCAT('
        INSERT INTO ', _entity_db ,'.time_channel(entity_id, ref_sys_id,message,ctime)
        SELECT c.entity_id, c.sys_id,c.message, c.ctime FROM ', _entity_db ,'.channel c
        WHERE c.entity_id = ( SELECT  entity_id FROM ', _entity_db ,'.channel WHERE message_id = ?)  
        AND message_id <> ?
        ORDER BY c.sys_id DESC LIMIT 1
        ON DUPLICATE KEY UPDATE ref_sys_id= c.sys_id, ctime =c.ctime ,message=c.message');
        PREPARE stamt FROM @st;
        EXECUTE stamt USING _message_id,_message_id ;
        DEALLOCATE PREPARE stamt;


        SET @st = CONCAT('DELETE FROM ', _entity_db ,'.channel WHERE message_id= ?');
        PREPARE stamt FROM @st;
        EXECUTE stamt USING _message_id ;
        DEALLOCATE PREPARE stamt;
      END IF;

      IF _type <> 'hub' THEN
       
        INSERT INTO time_channel(entity_id, ref_sys_id,message,ctime)
        SELECT c.entity_id, c.sys_id,c.message, c.ctime FROM channel c
        WHERE c.entity_id = ( SELECT  entity_id FROM channel WHERE message_id = _message_id)  
        AND message_id <> _message_id
        ORDER BY c.sys_id DESC LIMIT 1
        ON DUPLICATE KEY UPDATE ref_sys_id= c.sys_id, ctime =c.ctime ,message=c.message;
        DELETE FROM channel WHERE message_id = _message_id;

      END IF;

      IF _type = 'hub' THEN
        INSERT INTO  delete_channel (uid,ref_sys_id,ctime)  
        SELECT id ,_ref_sys_id,UNIX_TIMESTAMP()  FROM _list_uid  ON DUPLICATE KEY UPDATE  ctime =UNIX_TIMESTAMP();
        SELECT 0 INTO _cnt;
        SELECT count(id)
        FROM permission p 
        INNER JOIN yp.drumate d ON  p.entity_id=d.id 
        WHERE p.resource_id='*'
        AND NOT EXISTS( SELECT 1 FROM delete_channel WHERE uid = d.id AND ref_sys_id = _ref_sys_id) INTO _cnt;

        DELETE FROM delete_channel WHERE ref_sys_id = _ref_sys_id AND  _cnt= 0 ; 
        DELETE FROM channel WHERE message_id = _message_id AND  _cnt= 0; 

      END IF;

      SELECT _idx_node + 1 INTO _idx_node;
    END WHILE;

   SELECT * FROM _show_node;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_get`(
  IN _message_id VARCHAR(16)  CHARACTER SET ascii
)
BEGIN
DECLARE _type VARCHAR(16);
 
 SELECT type FROM yp.entity WHERE db_name=DATABASE() INTO _type;
  IF _type = 'hub' THEN
    SELECT *, 
   CASE WHEN JSON_LENGTH(metadata , '$._seen_')  >=  JSON_LENGTH(metadata , '$._delivered_') 
   THEN  1 ELSE 0 END is_seen 
   FROM channel WHERE message_id = _message_id;
  ELSE 
    SELECT * , 1 is_seen  FROM channel ch
    WHERE message_id = _message_id;
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_list_messages` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `channel_list_messages`(
  IN _uid VARCHAR(16),
  IN _sort_by VARCHAR(20),
  IN _order   VARCHAR(20),
  IN _page    TINYINT(4)
)
BEGIN
  DECLARE _recipient_db VARCHAR(255); 
  DECLARE _msg_id VARCHAR(16);
  DECLARE _timestamp int(11) unsigned;
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);  


  SELECT 
    c.author_id,  
    c.message,   
    c.message_id, 
    c.thread_id,  
    c.attachment, 
    c.status,     
    c.ctime,      
    c.metadata,  
    firstname, lastname, CONCAT(firstname, ' ', lastname) fullname,
    CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _uid))= 1 THEN 1 ELSE 0 END is_readed,
    CASE WHEN JSON_LENGTH(metadata , '$._seen_')  =  JSON_LENGTH(metadata , '$._delivered_') 
    THEN  1 ELSE 0 END is_seen
  FROM channel c INNER JOIN(yp.drumate d)
  ON author_id=d.id
  ORDER BY 
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN ctime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN ctime END DESC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN firstname END ASC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN firstname END DESC
  LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_post_attachment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_post_attachment`(
  IN _message_id VARCHAR(16),
  IN _entity_id VARCHAR(16),
  IN _attachment json
)
BEGIN
  DECLARE _sbx_id VARCHAR(16); 

  DECLARE _nid VARCHAR(16); 
  DECLARE _sbx_db_name VARCHAR(255);
  DECLARE _idx_attachment INT(4) DEFAULT 0; 
  DECLARE _node JSON;
  DECLARE _type VARCHAR(16);
  DECLARE _hub_db_name VARCHAR(255);
  DECLARE _uid VARCHAR(255);

    DROP TABLE IF EXISTS _show_node;
    CREATE TEMPORARY TABLE _show_node (uid VARCHAR(16));
    ALTER TABLE _show_node ADD `is_checked` boolean default 0 ;

    SELECT type,db_name FROM yp.entity WHERE id= _entity_id INTO _type,_hub_db_name;

    IF _type = 'hub' THEN
      
      SET @s = CONCAT(" INSERT INTO _show_node (uid) SELECT  d.id FROM ",_hub_db_name , 
       ".permission p 
        INNER JOIN yp.drumate d on p.entity_id=d.id 
        WHERE 
        p.resource_id='*'");
      PREPARE stmt FROM @s;
      EXECUTE stmt ;
      DEALLOCATE PREPARE stmt;      
    ELSE  
       INSERT INTO _show_node (uid) SELECT _entity_id;
    END IF;

    WHILE _idx_attachment < JSON_LENGTH(_attachment) DO 
      SELECT JSON_QUERY(_attachment, CONCAT("$[", _idx_attachment, "]") ) INTO _node;
      SELECT JSON_VALUE(_node, '$.hub_id') INTO _sbx_id;
      SELECT JSON_VALUE(_node, '$.nid') INTO _nid;
      SELECT db_name FROM yp.entity WHERE id=_sbx_id INTO _sbx_db_name;


      UPDATE _show_node SET is_checked = 0;
      SELECT uid FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _uid;
      WHILE _uid IS NOT NULL DO

        SET @s = CONCAT(" CALL ",_sbx_db_name , ".permission_grant(?,?,?,?,?,?)");
        PREPARE stmt FROM @s;
        EXECUTE stmt USING _nid,_uid,0,15,'system','chatpermission';
        DEALLOCATE PREPARE stmt;


        SET @s = CONCAT(" INSERT INTO  ",_sbx_db_name , ".attachment (message_id,hub_id,rid,uid) select ?,?,?,?");
        PREPARE stmt FROM @s;
        EXECUTE stmt USING _message_id,_entity_id,_nid,_uid;
        DEALLOCATE PREPARE stmt;


        UPDATE _show_node SET is_checked = 1 WHERE uid = _uid ;
        SELECT NULL INTO _uid;
        SELECT uid FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _uid;
        
      END WHILE;

      SELECT _idx_attachment + 1 INTO _idx_attachment;
    END WHILE;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_post_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `channel_post_message`(
  _author_id VARCHAR(16),
  _message  TEXT,
  _thread_id VARCHAR(16),
  _attachment JSON
)
BEGIN
  DECLARE _recipient_db VARCHAR(255); 
  DECLARE _msg_id VARCHAR(16);
  DECLARE _timestamp int(11) unsigned;
  DECLARE _author_db VARCHAR(128);
  DECLARE _nid VARCHAR(16);  
  DECLARE _finished  INTEGER DEFAULT 0; 
  DECLARE _sys_id  INTEGER DEFAULT 0; 

  IF _thread_id IS NULL THEN 
    SELECT  yp.uniqueId() INTO _thread_id;
  END IF;
  SELECT db_name FROM yp.entity WHERE id=_author_id INTO _author_db;

  IF _attachment IS NULL THEN 
    SELECT JSON_ARRAY() INTO _attachment;
  END IF;

  SELECT UNIX_TIMESTAMP() INTO _timestamp; 

  SELECT  yp.uniqueId() INTO _msg_id ; 

    INSERT INTO channel 
    (`author_id`,`message`,`message_id`,`thread_id`,`attachment`,`status`,`ctime` ) 
    VALUES 
    (_author_id,_message,_msg_id,_thread_id,_attachment,'active',_timestamp );

   UPDATE channel SET metadata=JSON_MERGE(
      IFNULL(metadata, '{}'), 
      JSON_OBJECT('_seen_', JSON_OBJECT(_author_id, 1)) ,    
      JSON_OBJECT('_delivered_',   JSON_OBJECT(_author_id,_timestamp))
    )
   WHERE message_id=_msg_id;

  SELECT sys_id FROM channel WHERE message_id=_msg_id INTO _sys_id;


  UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._seen_.", _author_id), UNIX_TIMESTAMP())
  WHERE sys_id <= _sys_id  AND 
  JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 0;

  SET _finished = 0;
    BEGIN
      DECLARE db_cursor CURSOR FOR SELECT  d.id 
                                    FROM permission p 
                                    INNER JOIN yp.drumate d on p.entity_id=d.id 
                                    WHERE 
                                      p.resource_id='*' AND d.id <> _author_id ;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
      OPEN db_cursor;
        WHILE NOT _finished DO FETCH db_cursor INTO _nid;
        
          UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._delivered_.", _nid), UNIX_TIMESTAMP())
          WHERE message_id = _msg_id ;

        END WHILE;
      CLOSE db_cursor;
    END; 
 
  SELECT 
    sys_id,     
    author_id,  
    message,   
    message_id, 
    thread_id,  
    attachment, 
    status,     
    ctime,      
    metadata,  
    CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 1 THEN 1 ELSE 0 END is_readed,
    CASE WHEN JSON_LENGTH(metadata , '$._seen_')  =  JSON_LENGTH(metadata , '$._delivered_') 
    THEN  1 ELSE 0 END is_seen
   FROM channel WHERE message_id = _msg_id ;
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_post_message_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_post_message_next`(
  IN _in JSON ,
  IN _message text
)
BEGIN
 DECLARE _hub_id VARCHAR(16) CHARACTER SET ascii;  
 DECLARE _thread_id  VARCHAR(16) CHARACTER SET ascii;
 DECLARE _forward_message_id VARCHAR(16) CHARACTER SET ascii;
 DECLARE _attachment JSON;
 DECLARE _metadata JSON;
 DECLARE _author_id VARCHAR(16) CHARACTER SET ascii;
 DECLARE _entity_id VARCHAR(16) CHARACTER SET ascii;

 DECLARE _message_id VARCHAR(16) CHARACTER SET ascii;
 DECLARE _ctime int(11) unsigned;
 DECLARE _ref_sys_id int(11) unsigned;
 DECLARE _type VARCHAR(16);
 DECLARE _nid  VARCHAR(16) CHARACTER SET ascii;
 DECLARE _finished  INTEGER DEFAULT 0; 
 DECLARE _ticket_id  INTEGER DEFAULT NULL; 
  SELECT type FROM yp.entity WHERE db_name=DATABASE() INTO _type;
 
  SELECT JSON_VALUE(_in, "$.author_id") INTO _author_id;
  SELECT JSON_VALUE(_in, "$.entity_id") INTO _entity_id;
  SELECT JSON_VALUE(_in, "$.ticket_id") INTO _ticket_id; 

  SELECT JSON_VALUE(_in, "$.thread_id") INTO _thread_id; 
  SELECT JSON_VALUE(_in, "$.forward_message_id") INTO _forward_message_id; 
  SELECT JSON_QUERY(_in, "$.attachment") INTO _attachment; 
  SELECT JSON_VALUE(_in, "$.message_id") INTO _message_id;
  SELECT JSON_QUERY(_in, "$.metadata") INTO _metadata; 

  SELECT UNIX_TIMESTAMP() INTO _ctime; 
  IF _message = '' THEN 
    SELECT NULL INTO _message;
  END IF ;
  
  IF _type = 'hub' THEN
    INSERT INTO channel (message_id,author_id,message,thread_id,ctime,attachment, metadata)
    SELECT _message_id,_author_id,_message,_thread_id,_ctime,_attachment,_metadata;
  ELSE 
    INSERT INTO channel (message_id,author_id,entity_id,message,thread_id,ctime,attachment,metadata)
    SELECT _message_id,_author_id,_entity_id,_message,_thread_id,_ctime,_attachment,_metadata;
  END IF ;


  UPDATE channel SET metadata=JSON_MERGE(
      IFNULL(metadata, '{}'), 
      JSON_OBJECT('_seen_', JSON_OBJECT(_author_id, 1)) ,    
      JSON_OBJECT('_delivered_',   JSON_OBJECT(_author_id,_ctime))
    )
  WHERE message_id=_message_id;

  UPDATE channel SET 
  is_forward =1, 
  metadata=JSON_MERGE(
                        IFNULL(metadata, '{}'), 
                        JSON_OBJECT('forward_message_id',   _forward_message_id),
                        JSON_OBJECT('forward_hub_id',   JSON_UNQUOTE(JSON_EXTRACT(_in, "$.hub_id")))
                       )
  WHERE message_id=_message_id AND _forward_message_id is NOT NULL;


  IF _entity_id <> _author_id THEN 
    UPDATE channel SET metadata=JSON_MERGE(IFNULL(metadata, '{}'), JSON_OBJECT('_delivered_',   JSON_OBJECT(_entity_id,_ctime)))
    WHERE message_id=_message_id;
  END IF;

  SELECT sys_id FROM channel WHERE message_id = _message_id   INTO _ref_sys_id;
  
  IF _type = 'hub' THEN
  


    SET _finished = 0;
      BEGIN
        DECLARE db_cursor CURSOR FOR SELECT  d.id 
          FROM permission p 
          INNER JOIN yp.drumate d on p.entity_id=d.id 
          WHERE 
            p.resource_id='*' AND d.id <> _author_id ;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
        OPEN db_cursor;
          WHILE NOT _finished DO FETCH db_cursor INTO _nid;
          
            UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._delivered_.", _nid), _ctime)
            WHERE message_id = _message_id  AND _nid IS NOT NULL;

          END WHILE;
        CLOSE db_cursor;
      END; 
 
    INSERT INTO read_channel(uid,ref_sys_id,ctime) 
    SELECT _author_id,_ref_sys_id,_ctime
    ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id , ctime =_ctime;

    SELECT ticket_id FROM map_ticket WHERE message_id = _message_id INTO _ticket_id; 
    IF  _ticket_id IS NOT NULL THEN 

      UPDATE channel c INNER JOIN map_ticket mt ON mt.message_id = c.message_id
      SET  c.metadata = JSON_SET(metadata,CONCAT("$._seen_.", _author_id), UNIX_TIMESTAMP())
      WHERE c.sys_id <= _ref_sys_id   AND mt.ticket_id = _ticket_id AND
      JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 0;

      INSERT INTO yp.read_ticket_channel(uid,ticket_id , ref_sys_id,ctime) SELECT _author_id,_ticket_id,_ref_sys_id,UNIX_TIMESTAMP() 
      ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id , ctime =UNIX_TIMESTAMP() ;

      UPDATE yp.ticket SET last_sys_id =  _ref_sys_id WHERE  ticket_id =_ticket_id;
    ELSE 
      UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._seen_.", _author_id), _ctime)
      WHERE sys_id <= _ref_sys_id  AND 
      JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 0;  
    END IF;

    SELECT id FROM yp.entity WHERE db_name= DATABASE() INTO _hub_id; 
    SELECT 
      c.sys_id,     
      c.author_id,  
      c.message,   
      c.message_id, 
      c.thread_id,  
      c.is_forward,
      c.attachment, 
      c.status,     
      c.ctime,      
      c.metadata,  
      CASE WHEN JSON_EXISTS(c.metadata, CONCAT("$._seen_.", _author_id))= 1 THEN 1 ELSE 0 END is_readed,
      CASE WHEN JSON_LENGTH(c.metadata , '$._seen_')  >=  JSON_LENGTH(c.metadata , '$._delivered_') 
      THEN  1 ELSE 0 END is_seen,
      IFNULL(read_json_object(c.metadata, "message_type"),'chat')   message_type,
      CASE WHEN  t.message_id IS NOT NULL THEN 1 ELSE 0 END is_ticket,
      _hub_id hub_id,
      read_json_object(c.metadata, "call_status") call_status  
    FROM channel c 
    LEFT JOIN map_ticket mt ON mt.message_id= c.message_id
    LEFT JOIN yp.ticket t ON t.message_id= c.message_id
    WHERE c.message_id = _message_id ;

  ELSE 
    INSERT INTO time_channel(entity_id, ref_sys_id,message,ctime)
    SELECT _entity_id, _ref_sys_id,_message, _ctime ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id, ctime =_ctime ,message=_message;
  
    SELECT 
      sys_id,     
      author_id, 
      entity_id,  
      message,   
      message_id, 
      thread_id,  
      is_forward,
      attachment, 
      status,     
      ctime,      
      metadata,  
      CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 1 THEN 1 ELSE 0 END is_readed,
      CASE WHEN JSON_LENGTH(metadata , '$._seen_')  >=  JSON_LENGTH(metadata , '$._delivered_') 
      THEN  1 ELSE 0 END is_seen,
      IFNULL(read_json_object(metadata, "message_type"),'chat')   message_type, 
      0 is_ticket ,
      read_json_object(metadata, "call_status") call_status,
      read_json_object(metadata, "duration") call_duration  
      FROM channel WHERE message_id = _message_id;
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_post_message_next1` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `channel_post_message_next1`(
  IN _in JSON ,
  IN _message text
)
BEGIN

 DECLARE _thread_id  VARCHAR(16);
 DECLARE _forward_message_id VARCHAR(16);
 DECLARE _attachment JSON;
 DECLARE _author_id VARCHAR(16);
 DECLARE _entity_id VARCHAR(16);

 DECLARE _message_id VARCHAR(16);
 DECLARE _ctime int(11) unsigned;
 DECLARE _ref_sys_id int(11) unsigned;
 DECLARE _type VARCHAR(16);
 DECLARE _nid  VARCHAR(16);
 DECLARE _finished  INTEGER DEFAULT 0; 

  SELECT type FROM yp.entity WHERE db_name=DATABASE() INTO _type;
 
  SELECT JSON_VALUE(_in, "$.author_id") INTO _author_id;
  SELECT JSON_VALUE(_in, "$.entity_id") INTO _entity_id;
  

  SELECT JSON_VALUE(_in, "$.thread_id") INTO _thread_id; 
  SELECT JSON_VALUE(_in, "$.forward_message_id") INTO _forward_message_id; 
  SELECT JSON_QUERY(_in, "$.attachment") INTO _attachment; 
  SELECT JSON_VALUE(_in, "$.message_id") INTO _message_id;

  SELECT UNIX_TIMESTAMP() INTO _ctime; 
  
  IF _type = 'hub' THEN
    INSERT INTO channel (message_id,author_id,message,thread_id,ctime,attachment)
    SELECT _message_id,_author_id,_message,_thread_id,_ctime,_attachment;
  ELSE 
    INSERT INTO channel (message_id,author_id,entity_id,message,thread_id,ctime,attachment)
    SELECT _message_id,_author_id,_entity_id,_message,_thread_id,_ctime,_attachment;
  END IF ;

  UPDATE channel SET metadata=JSON_MERGE(
      IFNULL(metadata, '{}'), 
      JSON_OBJECT('_seen_', JSON_OBJECT(_author_id, 1)) ,    
      JSON_OBJECT('_delivered_',   JSON_OBJECT(_author_id,_ctime))
    )
  WHERE message_id=_message_id;

  UPDATE channel SET 
  is_forward =1, 
  metadata=JSON_MERGE(
                        IFNULL(metadata, '{}'), 
                        JSON_OBJECT('forward_message_id',   _forward_message_id),
                        JSON_OBJECT('forward_hub_id',   JSON_UNQUOTE(JSON_EXTRACT(_in, "$.hub_id")))
                       )
  WHERE message_id=_message_id AND _forward_message_id is NOT NULL;


  IF _entity_id <> _author_id THEN 
    UPDATE channel SET metadata=JSON_MERGE(IFNULL(metadata, '{}'), JSON_OBJECT('_delivered_',   JSON_OBJECT(_entity_id,_ctime)))
    WHERE message_id=_message_id;
  END IF;

  SELECT sys_id FROM channel WHERE message_id = _message_id   INTO _ref_sys_id;
  
  IF _type = 'hub' THEN
    UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._seen_.", _author_id), _ctime)
    WHERE sys_id <= _ref_sys_id  AND 
    JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 0;


    SET _finished = 0;
      BEGIN
        DECLARE db_cursor CURSOR FOR SELECT  d.id 
          FROM permission p 
          INNER JOIN yp.drumate d on p.entity_id=d.id 
          WHERE 
            p.resource_id='*' AND d.id <> _author_id ;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
        OPEN db_cursor;
          WHILE NOT _finished DO FETCH db_cursor INTO _nid;
          
            UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._delivered_.", _nid), _ctime)
            WHERE message_id = _message_id ;

          END WHILE;
        CLOSE db_cursor;
      END; 
 
    INSERT INTO read_channel(uid,ref_sys_id,ctime) 
    SELECT _author_id,_ref_sys_id,_ctime
    ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id , ctime =_ctime;


    SELECT 
      sys_id,     
      author_id,  
      message,   
      message_id, 
      thread_id,  
      is_forward,
      attachment, 
      status,     
      ctime,      
      metadata,  
      CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 1 THEN 1 ELSE 0 END is_readed,
      CASE WHEN JSON_LENGTH(metadata , '$._seen_')  >=  JSON_LENGTH(metadata , '$._delivered_') 
      THEN  1 ELSE 0 END is_seen
    FROM channel WHERE message_id = _message_id ;

  ELSE 
    INSERT INTO time_channel(entity_id, ref_sys_id,message,ctime)
    SELECT _entity_id, _ref_sys_id,_message, _ctime ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id, ctime =_ctime ,message=_message;
  
    SELECT 
      sys_id,     
      author_id, 
      entity_id,  
      message,   
      message_id, 
      thread_id,  
      is_forward,
      attachment, 
      status,     
      ctime,      
      metadata,  
      CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _author_id))= 1 THEN 1 ELSE 0 END is_readed,
      CASE WHEN JSON_LENGTH(metadata , '$._seen_')  >=  JSON_LENGTH(metadata , '$._delivered_') 
      THEN  1 ELSE 0 END is_seen
    FROM channel WHERE message_id = _message_id;
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `channel_read_messages` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `channel_read_messages`(
  IN _msg_id VARCHAR(16),
  IN _uid VARCHAR(16)
)
BEGIN
  
 DECLARE _sys_id  INTEGER DEFAULT 0; 
  
  SELECT sys_id FROM channel WHERE message_id=_msg_id INTO _sys_id;

  UPDATE channel SET  metadata = JSON_SET(metadata,CONCAT("$._seen_.", _uid), UNIX_TIMESTAMP())
  WHERE sys_id <= _sys_id   AND 
  JSON_EXISTS(metadata, CONCAT("$._seen_.", _uid))= 0;
 
  SELECT 
    sys_id,     
    author_id,  
    message,   
    message_id, 
    thread_id,  
    attachment, 
    status,     
    ctime,      
    metadata,  
    CASE WHEN JSON_EXISTS(metadata, CONCAT("$._seen_.", _uid))= 1 THEN 1 ELSE 0 END is_readed,
    CASE WHEN JSON_LENGTH(metadata , '$._seen_')  =  JSON_LENGTH(metadata , '$._delivered_') 
    THEN  1 ELSE 0 END is_seen
  FROM channel WHERE message_id = _msg_id ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `chat_rooms` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `chat_rooms`(
  IN _key VARCHAR(500), 
  IN _tag_id  VARCHAR(16), 
  IN _flag VARCHAR(500),
  IN _option VARCHAR(20),
  IN _page INT(6)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _lvl INT(4);
  DECLARE _this_hub_id VARCHAR(16);
  DECLARE _nid VARCHAR(16);
  DECLARE _db_name VARCHAR(500);
  DECLARE _temp_result JSON;
  DECLARE _read_cnt INT ;
  DECLARE _attachment  VARCHAR(6000) ;
  DECLARE _ctime INT(11) unsigned;
  DECLARE _message mediumtext;
  DECLARE _temp_nid VARCHAR(16);

  DECLARE _uid  VARCHAR(16);
  DECLARE _mail  VARCHAR(500);

   SELECT id,id FROM yp.entity WHERE db_name=DATABASE() INTO  _this_hub_id ,_uid ;
   SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;
    
    CALL pageToLimits(_page, _offset, _range); 
    IF _key IN ('', '0') THEN 
      SELECT NULL INTO  _key;
    END IF;
    IF _tag_id IN ('', '0') THEN 
      SELECT NULL INTO  _tag_id;
    END IF;

    IF _flag IN ('', '0') THEN 
      SELECT NULL INTO  _flag;
    END IF;

    DROP TABLE IF EXISTS _show_node;
    CREATE TEMPORARY TABLE _show_node (
      entity_id  VARCHAR(16) NOT NULL,  
      hub_id VARCHAR(16) NOT null,
      drumate_id  VARCHAR(16)  NULL,
      contact_id  VARCHAR(16)  NULL,
      firstname  VARCHAR(255)  NULL,
      lastname   VARCHAR(255)  NULL,
      display    VARCHAR(255)  NULL,
      is_online  INT DEFAULT 0,
      room_count INT DEFAULT 0,
      message    mediumtext  NULL,
      ctime INT(11) unsigned,
      flag VARCHAR(500),
      db_name   VARCHAR(500)  NULL,
      status   VARCHAR(255)  DEFAULT  'active',
      is_blocked INT DEFAULT 0,
      is_blocked_me INT DEFAULT 0,
      is_archived INT DEFAULT 0 ,    
      is_attachment   INT DEFAULT 0 ,  
      PRIMARY KEY `entity_id`(`entity_id`)
    ); 

    INSERT INTO _show_node
    SELECT
      c.uid  entity_id, 
      _this_hub_id   hub_id,  
      c.uid  drumate_id, 
      c.id contact_id,
      c.firstname,
      c.lastname,
      IFNULL(c.surname,  
        IF(coalesce(c.firstname, c.lastname) IS NULL, 
          IFNULL(ce.email,du.email) , 
            CONCAT( IFNULL(c.firstname, '') ,' ',  
              IFNULL(c.lastname, '')))
      ) as display,
      IF(s.uid IS NULL, 0, du.connected) online,
      IFNULL(( 
        SELECT 
          COUNT(1)
        FROM 
          channel ch 
        INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
        WHERE
          ch.entity_id = ch.author_id AND 
          rc.entity_id <> rc.uid  AND 
          ch.sys_id > rc.ref_sys_id AND 
          ch.entity_id = c.uid), 0),
       tc.message,
       tc.ctime , 
       'contact',null,'active',
       CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
       CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me, 
       CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END  is_archived , 
       IF(cha.attachment IS NOT NULL , 1, 0 )
    FROM
      contact c
    LEFT JOIN time_channel tc ON tc.entity_id = c.uid
    LEFT JOIN channel cha ON tc.ref_sys_id = cha.sys_id
    LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
    INNER JOIN yp.drumate du ON du.id = c.uid
    LEFT JOIN (SELECT DISTINCT uid FROM yp.socket) s ON s.uid = du.id 
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = c.uid) 
        AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    LEFT JOIN archive_entity ae ON ae.entity_id = c.id
    WHERE CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  c.id IN ( SELECT id FROM map_tag mt WHERE mt.tag_id = _tag_id) ELSE c.id =c.id END 
    AND c.uid IS NOT NULL
    AND _flag IN ('all','contact')
    AND CASE WHEN  ae.entity_id  IS NOT NULL THEN 'archived' ELSE 'active'  END = _option 
    AND (IFNULL(c.firstname,'') LIKE CONCAT(TRIM(IFNULL(_key,IFNULL(c.firstname,''))), '%') OR 
         IFNULL(c.lastname,'') LIKE CONCAT(TRIM(IFNULL(_key, IFNULL(c.lastname,''))), '%') OR 
         IFNULL(c.surname,'') LIKE CONCAT(TRIM(IFNULL(_key,IFNULL(c.surname,''))), '%') OR 
         IFNULL(c.source,'') LIKE CONCAT(TRIM(IFNULL(_key, IFNULL(c.source,''))), '%') );

    INSERT INTO _show_node(entity_id,hub_id,display,flag,message,ctime,status, is_archived ,is_attachment)
    SELECT tc.entity_id ,_this_hub_id,du.fullname,'contact',tc.message, tc.ctime,'nocontact',
    CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END,
    IF(cha.attachment IS NOT NULL , 1, 0 )   
    FROM 
    time_channel tc
    INNER JOIN channel cha ON tc.ref_sys_id = cha.sys_id
    INNER JOIN yp.drumate du ON du.id = tc.entity_id
    LEFT JOIN archive_entity ae ON ae.entity_id = tc.entity_id
    WHERE  _tag_id IS NULL AND  tc.entity_id NOT IN (SELECT IFNULL(uid,'1') FROM contact) 
     AND CASE WHEN  ae.entity_id  IS NOT NULL THEN 'archived' ELSE 'active'  END = _option 
    AND tc.entity_id  NOT IN (SELECT IFNULL(entity,'1') FROM contact)
    AND _flag IN ('all','contact');

    INSERT INTO _show_node(entity_id,hub_id,display,flag,message,ctime,status, is_archived,is_attachment)
    SELECT tc.entity_id ,_this_hub_id,du.fullname,'contact',tc.message, tc.ctime,'memory',
    CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END,
    IF(cha.attachment IS NOT NULL , 1, 0 )     
    FROM 
    time_channel tc
    INNER JOIN channel cha ON tc.ref_sys_id = cha.sys_id
    INNER JOIN yp.drumate du ON du.id = tc.entity_id
    LEFT JOIN archive_entity ae ON ae.entity_id = tc.entity_id
    WHERE  _tag_id IS NULL AND  tc.entity_id NOT IN (SELECT IFNULL(uid,'1') FROM contact)
    AND CASE WHEN  ae.entity_id  IS NOT NULL THEN 'archived' ELSE 'active'  END = _option 
    AND tc.entity_id IN (SELECT IFNULL(entity,'1') FROM contact)
    AND _flag IN ('all','contact');     


    INSERT INTO _show_node(entity_id,hub_id,display,flag,db_name,is_archived)
    SELECT 
      m.id ,  m.id ,  
      IFNULL(h.name, user_filename)  group_name, 
      'share',
      db_name,
      CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END        
    FROM 
    media m
    LEFT JOIN archive_entity ae ON ae.entity_id = m.id
    INNER JOIN yp.hub h on  h.id = m.id 
    INNER  JOIN yp.entity he ON m.id = he.id AND he.area <> 'share'
    WHERE category = 'hub'
    AND extension = 'private'
    AND CASE WHEN  ae.entity_id  IS NOT NULL THEN 'archived' ELSE 'active'  END = _option 
    AND CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  m.id IN ( SELECT id FROM map_tag mt WHERE mt.tag_id = _tag_id) ELSE m.id =m.id END
    AND _flag IN ('all','share')
    AND ( IFNULL(h.name, user_filename) LIKE CONCAT(TRIM(IFNULL(_key,IFNULL(h.name, user_filename) )), '%') ); 

    ALTER TABLE _show_node ADD `is_checked` boolean default 0 ;
    UPDATE   _show_node SET is_checked = 1 WHERE flag='contact';

    
    SELECT entity_id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
    WHILE _nid IS NOT NULL DO
 
        SET @st = CONCAT('CALL ', _db_name ,'.room_detail(?,?)');
        PREPARE stamt FROM @st;
        EXECUTE stamt USING  JSON_OBJECT('uid',_this_hub_id ) , _temp_result ;
        DEALLOCATE PREPARE stamt; 
      
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.read_cnt")) INTO _read_cnt;  
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.message")) INTO _message;  
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.ctime")) INTO _ctime;  
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.attachment")) INTO _attachment;  


        UPDATE _show_node SET  
          room_count =  _read_cnt,
          `message` =  _message,  
          ctime =  _ctime ,
          is_attachment = IF(_attachment IS NOT NULL , 1, 0 )
        WHERE entity_id = _nid ;

      UPDATE _show_node SET is_checked = 1 WHERE entity_id = _nid ; 
      
      SELECT NULL , NULL ,NULL,NULL INTO _read_cnt,_message,_ctime ,_nid;
      SELECT entity_id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
    END WHILE;


    SELECT  _page as `page`,
      entity_id,
      hub_id,
      drumate_id,
      contact_id,
      firstname,
      lastname,
      display,
      room_count,
      is_online as `online`,
      message,
      ctime,
      flag,
      status,
      is_blocked,
      is_blocked_me, 
      is_archived ,
      is_attachment
    FROM _show_node
    ORDER BY IFNULL(ctime,0) DESC, entity_id ASC 
    LIMIT _offset, _range;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `chat_room_info` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `chat_room_info`(
  IN _id VARCHAR(500)
)
BEGIN
  DECLARE _this_hub_id VARCHAR(16);
  DECLARE _uid  VARCHAR(16);
  DECLARE _mail  VARCHAR(500);

    DROP TABLE IF EXISTS _show_node;
    CREATE TEMPORARY TABLE _show_node (
      entity_id  VARCHAR(16) NOT NULL,  
      hub_id VARCHAR(16) NOT null,
      drumate_id  VARCHAR(16)  NULL,
      contact_id  VARCHAR(16)  NULL,
      firstname  VARCHAR(255)  NULL,
      lastname   VARCHAR(255)  NULL,
      display    VARCHAR(255)  NULL,
      is_online  INT DEFAULT 0,
      room_count INT DEFAULT 0,
      message    mediumtext  NULL,
      ctime INT(11) unsigned,
      flag VARCHAR(500),
      db_name   VARCHAR(500)  NULL,
      status   VARCHAR(255)  DEFAULT  'active',
      is_blocked INT DEFAULT 0,
      is_blocked_me INT DEFAULT 0,
      is_archived INT DEFAULT 0 ,      
      PRIMARY KEY `entity_id`(`entity_id`)
    ); 

    SELECT id,id FROM yp.entity WHERE db_name=DATABASE() INTO  _this_hub_id ,_uid ;
    SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;


    INSERT INTO _show_node
    SELECT
      c.uid  entity_id, 
      _this_hub_id   hub_id,  
      c.uid  drumate_id, 
      c.id contact_id,
      c.firstname,
      c.lastname,
      IFNULL(c.surname,  
        IF(coalesce(c.firstname, c.lastname) IS NULL, 
          IFNULL(ce.email,du.email) , 
            CONCAT( IFNULL(c.firstname, '') ,' ',  
              IFNULL(c.lastname, '')))
      ) as display,
      (SELECT IF(COUNT(*), 1, 0) FROM yp.socket soc WHERE soc.uid=du.id ) is_online,
      IFNULL(( 
        SELECT 
          COUNT(1)
        FROM 
          channel ch 
        INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
        WHERE
          ch.entity_id = ch.author_id AND 
          rc.entity_id <> rc.uid  AND 
          ch.sys_id > rc.ref_sys_id AND 
          ch.entity_id = c.uid), 0),
       tc.message,
       tc.ctime , 
       'contact',null,'active',
       CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
       CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me, 
       CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END  is_archived  
    FROM
      contact c
    LEFT JOIN time_channel tc ON tc.entity_id = c.uid
    LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
    INNER JOIN yp.drumate du ON du.id = c.uid
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = c.uid) 
        AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    LEFT JOIN archive_entity ae ON ae.entity_id = c.id
    WHERE c.uid IS NOT NULL
    AND (c.uid = _id OR c.id = _id);


    INSERT INTO _show_node(entity_id,hub_id,display,flag,message,ctime,status, is_archived)
    SELECT tc.entity_id ,_this_hub_id,du.fullname,'contact',tc.message, tc.ctime,'memory',
    CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END    
    FROM 
    time_channel tc
    INNER JOIN yp.drumate du ON du.id = tc.entity_id
    INNER JOIN contact c ON IFNULL(c.entity,'1') = tc.entity_id
    LEFT JOIN archive_entity ae ON ae.entity_id = tc.entity_id
    WHERE tc.entity_id NOT IN (SELECT IFNULL(uid,'1') FROM contact)
    AND tc.entity_id IN (SELECT IFNULL(entity,'1') FROM contact)
    AND (tc.entity_id  = _id OR c.id = _id);


    INSERT INTO _show_node(entity_id,hub_id,display,flag,message,ctime,status, is_archived)
    SELECT tc.entity_id ,_this_hub_id,du.fullname,'contact',tc.message, tc.ctime,'nocontact',
    CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END    
    FROM 
    time_channel tc
    INNER JOIN yp.drumate du ON du.id = tc.entity_id
    LEFT JOIN archive_entity ae ON ae.entity_id = tc.entity_id
    WHERE  tc.entity_id NOT IN (SELECT IFNULL(uid,'1') FROM contact) 
    AND tc.entity_id  NOT IN (SELECT IFNULL(entity,'1') FROM contact)
    AND tc.entity_id  = _id;



    SELECT 
      entity_id,
      hub_id,
      drumate_id,
      contact_id,
      firstname,
      lastname,
      display,
      room_count,
      is_online as `online`,
      message,
      ctime,
      flag,
      status,
      is_blocked,
      is_blocked_me, 
      is_archived 
    FROM _show_node;
   
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `check_huber` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `check_huber`(
  IN _uid  VARCHAR(16)
)
BEGIN

  SELECT
    entity.id,
    entity.ident,
    entity.area_id,
    entity.area,
    entity.vhost,
    drumate.dmail,
    drumate.email,
    drumate.firstname,
    drumate.lastname,
    drumate.gender,
    drumate.remit,
    CONCAT(firstname, ' ', lastname) as `fullname`,
    privilege
  FROM yp.entity INNER JOIN (yp.drumate, huber) ON (drumate.id=entity.id AND huber.id=entity.id) WHERE id=_uid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `check_hub_access` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `check_hub_access`( 
  IN _hub_id VARCHAR(16),
  IN _drumate_id VARCHAR(16)
)
BEGIN
  DECLARE _hub_db VARCHAR(255);
  DECLARE _script MEDIUMTEXT DEFAULT "";
  SELECT db_name from yp.entity where id = _hub_id INTO _hub_db;
  SET _script = CONCAT("SELECT id, privilege FROM `", _hub_db , "`.huber WHERE id = '", _drumate_id, "'");
  SET @s = _script;
  PREPARE stmt1 FROM @s;
  EXECUTE stmt1;
  DEALLOCATE PREPARE stmt1; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `chk_default_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `chk_default_calendar`(
    _is_default  BOOLEAN,
    _calendar_id  VARCHAR(16))
BEGIN


    SELECT calendar_id  FROM calendar  
    WHERE  is_default = 1  AND _is_default = 0  AND calendar_id = _calendar_id
    LIMIT 1; 
   

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `chk_name_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `chk_name_calendar`(
    _name VARCHAR(255),
    _calendar_id  VARCHAR(16))
BEGIN


    IF _calendar_id IS NOT NULL THEN      
        SELECT calendar_id   FROM calendar  WHERE  name = _name AND calendar_id != _calendar_id; 
    ELSE 
        SELECT calendar_id   FROM calendar  WHERE  name = _name; 
    END IF;
   

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `color_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `color_add`(
   IN _rgba         VARCHAR(50),
   IN _hexacode     VARCHAR(20)
)
BEGIN
  DECLARE _last INT(11) DEFAULT 0;
  INSERT INTO used_colors VALUES (NULL, _rgba, _hexacode, UNIX_TIMESTAMP());
  SELECT LAST_INSERT_ID() INTO _last;
  SELECT sys_id AS color_id, rgba, hexacode, ctime FROM used_colors WHERE sys_id = _last;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `color_last` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `color_last`()
BEGIN
  SELECT sys_id AS color_id, rgba, hexacode, ctime FROM used_colors
    WHERE sys_id IN (SELECT MAX(sys_id) FROM used_colors GROUP BY hexacode)
    ORDER BY sys_id DESC LIMIT 7;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_block_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_block_add`(
  _contact_id  VARCHAR(1024)
)
BEGIN
  DECLARE _owner_id VARCHAR(16);
  SELECT id from yp.entity WHERE db_name = DATABASE() INTO _owner_id ;
  INSERT INTO yp.contact_block (owner_id,contact_id,entity,uid)
  SELECT _owner_id , c.id , c.entity, c.uid FROM contact c WHERE id = _contact_id  ON DUPLICATE KEY UPDATE uid =c.uid  , entity = c.entity;
  SELECT * FROM yp.contact_block WHERE contact_id =_contact_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_block_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_block_delete`(
  _contact_id  VARCHAR(1024)
)
BEGIN
  DELETE FROM yp.contact_block WHERE contact_id = _contact_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_block_update` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_block_update`(
  _contact_id  VARCHAR(1024)
)
BEGIN
  DECLARE _owner_id VARCHAR(16);
  DECLARE _check_id VARCHAR(16);
  SELECT id from yp.entity WHERE db_name = DATABASE() INTO _owner_id ;

  SELECT contact_id FROM yp.contact_block WHERE contact_id = _contact_id INTO _check_id; 
  IF _check_id = _contact_id THEN 
    INSERT INTO yp.contact_block (owner_id,contact_id,entity,uid)
    SELECT _owner_id , id , entity, uid FROM contact c WHERE id = _contact_id  ON DUPLICATE KEY UPDATE uid =c.uid  , entity = c.entity;
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_chat_rooms` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_chat_rooms`(
  IN _key VARCHAR(500), 
  IN _tag_id  VARCHAR(16), 
  IN _page INT(6)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
    DECLARE _lvl INT(4);
    CALL pageToLimits(_page, _offset, _range); 

   IF _key IN ('', '0') THEN 
    SELECT NULL INTO  _key;
   END IF;

    DROP TABLE IF EXISTS _tag;
      CREATE TEMPORARY TABLE _tag(
        `tag_id` varchar(16) NOT NULL,
        `is_checked` boolean default 0
      );

    DROP TABLE IF EXISTS _map_tag;
      CREATE TEMPORARY TABLE _map_tag(
        `tag_id` varchar(16) NOT NULL,
        `id`     varchar(16) NOT NULL
      );

   
    IF _tag_id IS  NULL OR (ltrim(_tag_id) = '') THEN
        INSERT INTO _tag (tag_id) SELECT tag_id from  tag ; 
    ELSE 
      
      INSERT INTO _tag (tag_id) SELECT _tag_id;
      WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id;
        INSERT INTO _tag (tag_id) SELECT tag_id FROM tag WHERE  parent_tag_id = _tag_id;
        UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
      END WHILE; 
    END IF;


    INSERT INTO _map_tag (tag_id,id) SELECT tag_id ,id FROM  map_tag WHERE tag_id in (SELECT tag_id FROM _tag); 


    SELECT 
      _page as `page`, 
      c.id contact_id, 
      c.uid id,
      IFNULL(c.firstname, d.firstname) firstname,
      IFNULL(c.lastname, d.lastname) lastname,
      tc.message,
      tc.ctime, 
      IFNULL(c.surname, IFNULL(c.firstname, d.firstname)) surname,
      IF(socket.uid IS NULL, 0, 1) `online`,
      IFNULL(( 
        SELECT 
          COUNT(1)
        FROM 
          channel ch 
        INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
        WHERE
          ch.entity_id = ch.author_id AND 
          rc.entity_id <> rc.uid  AND 
          ch.sys_id > rc.ref_sys_id AND 
          ch.entity_id = c.uid), 0) room_count 
    FROM
      contact c
      INNER JOIN yp.entity e ON e.id = c.uid
      INNER JOIN yp.drumate d ON d.id = c.entity
      LEFT JOIN time_channel tc ON tc.entity_id = c.uid
      LEFT JOIN yp.socket ON socket.uid = c.uid
    WHERE 
     CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  c.id IN ( SELECT id FROM _map_tag) ELSE c.id =c.id END 
     AND c.status <> 'received' 
     AND 
        (c.firstname LIKE CONCAT(TRIM(IFNULL(_key,c.firstname)), '%') OR 
        c.lastname LIKE CONCAT(TRIM(IFNULL(_key, c.lastname)), '%') OR 
        c.surname LIKE CONCAT(TRIM(IFNULL(_key,c.surname)), '%') OR 
        c.entity LIKE CONCAT(TRIM(IFNULL(_key, c.entity)), '%') )
    ORDER BY 
      IFNULL(tc.ctime,0) DESC,  c.uid  ASC
      LIMIT _offset, _range;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_delete`(
  IN _key       VARCHAR(160)
)
BEGIN
  DELETE FROM contact WHERE email = _key;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_drumate_chk` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_drumate_chk`(
  IN _to_drumate_id  VARCHAR(16),
  IN _bound  VARCHAR(16)
)
BEGIN
    SELECT uid , status  FROM contact WHERE  uid=_to_drumate_id ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_export` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_export`(
)
BEGIN

  SELECT GROUP_CONCAT(p.phone , '---', IF(p.category = 'prof', 'WORK', 'HOME') SEPARATOR ':::') AS phone, c.id,
    e.email, is_default, 
    IFNULL(c.firstname, m.firstname) AS firstname, 
    IFNULL(c.lastname, c.lastname) AS lastname,
    c.surname, 
    CONCAT('https://', d.name, '/avatar/', m.id) AS avatar,
    CONCAT(IFNULL(IFNULL(c.firstname, m.firstname), ''), ' ', IFNULL(IFNULL(c.lastname, c.lastname), '')) as fullname,
    GROUP_CONCAT(a.address, '---', IF(a.category = 'prof', 'WORK', 'HOME') SEPARATOR ':::') AS address
  FROM contact c 
  LEFT JOIN contact_address a ON c.id=a.contact_id 
  LEFT JOIN contact_email e ON e.contact_id = c.id 
  LEFT JOIN contact_phone p ON c.id=p.contact_id 
  LEFT JOIN yp.drumate m ON (m.id = c.id OR m.email = e.email)
  LEFT JOIN yp.domain d ON d.id = m.domain_id WHERE e.email IS NOT NULL
  GROUP BY e.email;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_invite`(
  IN _entity     VARCHAR(255)
)
BEGIN
  DECLARE _invitee_db VARCHAR(255);
  DECLARE _inviter_id VARCHAR(16);
  DECLARE _invitee_status VARCHAR(16);  
  DECLARE _contact_id VARCHAR(16);
  DECLARE _message VARCHAR(2000); 

 
  SELECT id FROM yp.entity WHERE db_name=database() INTO _inviter_id;
  SELECT db_name FROM yp.entity WHERE id=_entity INTO _invitee_db;
  SELECT message FROM  contact  WHERE  entity = _entity INTO _message; 

  IF _invitee_db IS NOT NULL THEN
    SET @st = CONCAT("CALL  " , _invitee_db ,".contact_invite_post (?,?,?)");
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _inviter_id,_message,_invitee_status;
    DEALLOCATE PREPARE stamt;
  END IF;	  

  UPDATE contact SET invitetime = UNIX_TIMESTAMP()  WHERE  entity = _entity; 
  
  UPDATE contact SET status = 'informed', uid= _entity 
  WHERE  entity = _entity  AND _invitee_status = 'active' AND _invitee_db IS NOT  NULL  ;

  UPDATE contact SET status = 'active',uid= _entity  
  WHERE entity = _entity AND _invitee_status = 'informed'  AND _invitee_db IS NOT  NULL;
    
  UPDATE contact SET status = 'sent' 
  WHERE entity = _entity  AND _invitee_status in ('received' , 'invitation') AND _invitee_db IS NOT  NULL;

  UPDATE contact SET status = 'sent'   WHERE  entity = _entity  AND _invitee_db IS NULL ;

 SELECT id FROM contact WHERE ( entity= _entity) INTO  _contact_id;
 CALL  contact_block_update(_contact_id);


  SELECT status FROM contact WHERE entity=  _entity; 
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_accept` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_invite_accept`(
  IN _to_drumate_id     VARCHAR(16)
)
BEGIN

      
    DECLARE _to_drumate_db VARCHAR(255);
    DECLARE _frm_drumate_id VARCHAR(16);
    DECLARE _contact_id VARCHAR(16);
    DECLARE _firstname   VARCHAR(255);
    DECLARE _lastname   VARCHAR(255);
    
    SELECT db_name FROM yp.entity WHERE id=_to_drumate_id INTO _to_drumate_db;
    SELECT id FROM yp.entity WHERE db_name=database() INTO _frm_drumate_id;
   
    SELECT firstname,lastname FROM yp.drumate WHERE id=_frm_drumate_id INTO _firstname,_lastname;
    

    SELECT id FROM contact WHERE entity = _to_drumate_id AND status IN ( 'received', "invitation") INTO _contact_id;
    UPDATE contact set status = 'active' , uid = entity , category='drumate'  WHERE entity = _to_drumate_id AND status IN ( 'received', "invitation") ;
    CALL contact_block_update(_contact_id);


    SET @st = CONCAT('SELECT  id,firstname,lastname FROM ', _to_drumate_db ,'.contact WHERE entity = ? INTO @contact_id,@firstname,@lastname');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _frm_drumate_id ;
    DEALLOCATE PREPARE stamt;   
    
    IF rtrim(ltrim(@firstname)) IN ('',  '0') THEN 
      SELECT NULL INTO  @firstname;
    END IF;

    IF rtrim(ltrim(@lastname)) IN ('',  '0') THEN 
      SELECT NULL INTO  @lastname;
    END IF;

    SELECT IFNULL(@firstname,_firstname) INTO _firstname ;
    SELECT IFNULL(@lastname, _lastname)  INTO _lastname;

    SET @st = CONCAT('CALL ', _to_drumate_db ,'.contact_block_update(?)');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING  @contact_id ;
    DEALLOCATE PREPARE stamt; 


    SET @st = CONCAT('UPDATE  ', _to_drumate_db ,'.contact SET firstname=?,  lastname=? , status = "informed" ,  category="drumate" , uid= ? WHERE entity = ?');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _firstname , _lastname,_frm_drumate_id ,_frm_drumate_id ;
    DEALLOCATE PREPARE stamt; 
   
    SELECT _to_drumate_id drumate_id, status , id contact_id from contact WHERE entity = _to_drumate_id ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_chk` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_invite_chk`(
  IN _to_drumate_id  VARCHAR(16),
  IN _status VARCHAR(16) 
)
BEGIN

  SELECT entity , status  FROM contact  
  WHERE  
  status = IFNULL(_status,status) AND
  entity = _to_drumate_id ; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_drumate` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_invite_drumate`(
  IN _to_drumate_id     VARCHAR(16)
)
BEGIN
  DECLARE _to_drumate_db VARCHAR(255);
  DECLARE _frm_drumate_id VARCHAR(16);
  DECLARE _time int(11) unsigned; 

  SELECT UNIX_TIMESTAMP() INTO _time;  
  
  SELECT id FROM yp.entity WHERE db_name=database() INTO _frm_drumate_id;
  SELECT db_name FROM yp.entity WHERE id=_to_drumate_id INTO _to_drumate_db;

  
  
  
  
  
  
  
  
  
  

  


  UPDATE contact 
  SET status = 'sent' 
  WHERE temp_uid = _to_drumate_id AND status in ('memory','sent');

  SELECT NULL INTO @_status; 
  SELECT status FROM contact WHERE temp_uid = _to_drumate_id  INTO @_status;

  

  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_informed` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_invite_informed`(
  IN _to_drumate_id     VARCHAR(16)
)
BEGIN
  DECLARE _contact_id VARCHAR(16);
  DECLARE _firstname   VARCHAR(255);
  DECLARE _lastname   VARCHAR(255);
    SELECT firstname,lastname FROM yp.drumate WHERE id=_to_drumate_id INTO _firstname,_lastname;

    SELECT id FROM contact WHERE entity = _to_drumate_id AND status = 'informed' INTO _contact_id;    
    CALL contact_block_update(_contact_id);

    UPDATE contact set 
      status = 'active' , uid = entity , 
      category='drumate' ,
      firstname = CASE  WHEN json_value(`metadata`,'$.is_auto') =1  THEN _firstname ELSE firstname END, 
      lastname = CASE  WHEN json_value(`metadata`,'$.is_auto') =1  THEN _lastname ELSE lastname END , 
      metadata = JSON_SET(metadata, "$.is_auto", 0)
    WHERE entity = _to_drumate_id AND status = 'informed';
    SELECT _to_drumate_id drumate_id, status from contact WHERE entity = _to_drumate_id ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_post` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_invite_post`(
  IN _inviter_id     VARCHAR(16),
  IN  _message VARCHAR(2000),
  OUT _invitee_status VARCHAR(16)
)
BEGIN

   DECLARE _firstname   VARCHAR(255);
   DECLARE _lastname   VARCHAR(255);
   DECLARE _id VARCHAR(16);
   DECLARE _my_status VARCHAR(16); 
   DECLARE _email VARCHAR(500);
   DECLARE _contact_id VARCHAR(16);
   
  SELECT email FROM yp.drumate WHERE id = _inviter_id OR email = _inviter_id INTO _email;

  SELECT id FROM (SELECT  yp.uniqueId() id ) a  WHERE _id IS NULL INTO _id ; 
  SELECT status from contact WHERE entity = _inviter_id OR  entity = _email INTO _my_status;
  SELECT firstname,lastname 
  INTO _firstname,_lastname FROM yp.drumate d  WHERE d.id = _inviter_id; 

 
 INSERT INTO contact (id,firstname,lastname,category,status,entity,ctime,mtime) 
 SELECT _id , _firstname,_lastname,'drumate', 'received', _inviter_id, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()
 WHERE _my_status IS NULL ;

 
  
 UPDATE contact SET status ='invitation', category ='drumate'  WHERE ( entity= _inviter_id OR  entity = _email) and _my_status IN ('memory' ,'invitation' );
 UPDATE contact SET status ='received', category ='drumate'  WHERE ( entity= _inviter_id OR  entity = _email ) and _my_status = 'received';
 UPDATE contact SET status ='informed' , category ='drumate' WHERE ( entity= _inviter_id OR  entity = _email ) and _my_status in( 'informed','sent');
 SELECT id FROM contact WHERE ( entity= _inviter_id OR  entity = _email) INTO  _contact_id;
 CALL  contact_block_update(_contact_id);
 UPDATE contact SET message= _message  WHERE ( entity= _inviter_id OR  entity = _email );
 SELECT status FROM contact WHERE entity= _inviter_id INTO _invitee_status; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_refuse` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_invite_refuse`(
  IN _to_drumate_id     VARCHAR(16)
)
BEGIN

   SELECT 
    d.id drumate_id,
    d.email,
    IFNULL(ci.firstname, '') AS firstname,
    IFNULL(ci.lastname, '') AS lastname,
    CONCAT(IFNULL(ci.firstname, ''), ' ', IFNULL(ci.lastname, '')) as fullname,
    ci.comment message,
    'deleted' status
    FROM 
    contact ci 
    INNER JOIN yp.drumate d ON d.id = ci.entity
    WHERE ci.entity = _to_drumate_id AND status IN ( 'received', "invitation") ;

   DELETE FROM contact  WHERE entity = _to_drumate_id AND status = 'received';
   UPDATE contact  SET status = 'memory'  WHERE entity = _to_drumate_id AND status = 'invitation';
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_invite_to_notify` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_invite_to_notify`(
  IN _email     VARCHAR(500)
)
BEGIN
  DECLARE _lvl INT(4); 
  DECLARE _inviter_id  VARCHAR(16);

  DECLARE _firstname   VARCHAR(255);
  DECLARE _lastname   VARCHAR(255);
  DECLARE _id VARCHAR(16);
  DECLARE _my_status VARCHAR(16); 
  DECLARE _inviter_db VARCHAR(255);  

  
  DROP TABLE IF EXISTS _inviter;
  CREATE TEMPORARY TABLE _inviter(
              inviter_id varchar(16) NOT NULL,
              is_checked boolean default 0
      );
  INSERT INTO _inviter(inviter_id)    
  
  SELECT DISTINCT inviter_id FROM yp.token WHERE email = _email AND inviter_id  IS NOT NULL AND status = 'active' and method = 'signup';  

  WHILE (IFNULL((SELECT 1 FROM _inviter  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO

    SELECT inviter_id  FROM _inviter WHERE is_checked = 0 LIMIT 1  INTO _inviter_id;
    
    SELECT NULL,NULL,NULL INTO _my_status, _id,_inviter_db;
   
    
    SELECT db_name FROM yp.entity WHERE id=_inviter_id INTO _inviter_db;
    
    
    
    IF _inviter_db IS NOT NULL THEN
        SET @st = CONCAT("UPDATE " , _inviter_db ,".contact SET entity=?  WHERE entity = ? ");
          PREPARE stamt FROM @st;
          EXECUTE stamt USING _inviter_id,_email;
        DEALLOCATE PREPARE stamt;
        
        
        SELECT status FROM  contact WHERE entity = _inviter_id INTO _my_status;

        SELECT id FROM (SELECT  yp.uniqueId() id ) a  WHERE _id IS NULL INTO _id ; 
        SELECT firstname,lastname  INTO _firstname,_lastname FROM yp.drumate d  WHERE d.id = _inviter_id; 
        
        INSERT INTO contact (id,firstname,lastname,category,status,entity,ctime,mtime) 
        SELECT _id , _firstname,_lastname,'drumate', 'received', _inviter_id, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()
        WHERE _my_status IS NULL ;
    END IF ; 
    
    UPDATE yp.token SET status ='passive'  WHERE email = _email AND inviter_id  IS NOT NULL AND status = 'active' and method = 'signup';  
    UPDATE _inviter SET is_checked =  1 WHERE inviter_id =_inviter_id; 
    SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
  END WHILE; 


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_join` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_join`(
   IN _source_secret  varchar(255) 
)
BEGIN
 
  DECLARE _secret VARCHAR(255);
  DECLARE _source_id VARCHAR(16);
  DECLARE _email VARCHAR(1024);
  DECLARE _lvl INT(4); 
  DECLARE _inviter_id  VARCHAR(16);
  DECLARE _invitee_id  VARCHAR(16);


  DECLARE _firstname   VARCHAR(255);
  DECLARE _lastname   VARCHAR(255);
  DECLARE _id VARCHAR(16);
  DECLARE _my_status VARCHAR(16); 
  DECLARE _inviter_db VARCHAR(255);

  


  DROP TABLE IF EXISTS _inviter;
  CREATE TEMPORARY TABLE _inviter(
              inviter_id varchar(16) NOT NULL,
              secret  varchar(255) NOT NULL,
              is_checked boolean default 0
            
      );

  DROP TABLE IF EXISTS _show;
  CREATE TEMPORARY TABLE _show(
              inviter_id varchar(16) NOT NULL    
            
      );

  SELECT email,inviter_id FROM yp.token 
  WHERE secret = _source_secret AND inviter_id  IS NOT NULL AND status = 'active' and method = 'signup' INTO _email ,_source_id ;  

  SELECT id FROM yp.entity WHERE db_name=database() INTO _invitee_id;
  INSERT INTO _inviter(inviter_id,secret)    
  SELECT inviter_id ,secret  FROM yp.token WHERE email = _email AND inviter_id  IS NOT NULL AND status = 'active' and method = 'signup';  

     
  WHILE (IFNULL((SELECT 1 FROM _inviter  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO

    SELECT inviter_id ,secret  FROM _inviter WHERE is_checked = 0 LIMIT 1  INTO _inviter_id, _secret;
    SELECT NULL,NULL,NULL INTO _my_status, _id,_inviter_db;

    SELECT db_name FROM yp.entity WHERE id=_inviter_id INTO _inviter_db;


    IF _inviter_db IS NOT NULL THEN

      SELECT  NULL INTO @entity ; 
      SET @st = CONCAT('SELECT  entity  FROM ', _inviter_db ,'.contact WHERE   entity =? or entity =? INTO @entity');
      PREPARE stamt FROM @st;
      EXECUTE stamt USING _email,_invitee_id ;
      DEALLOCATE PREPARE stamt;

      IF @entity IS NOT NULL THEN 

        IF _secret = _source_secret THEN 
          SET @st = CONCAT('UPDATE ', _inviter_db ,'.contact SET category ="drumate", status="active", uid = ?, entity=? WHERE  entity =? or entity =?');
          PREPARE stamt FROM @st;
          EXECUTE stamt USING _invitee_id,_invitee_id,_email,_invitee_id;
          DEALLOCATE PREPARE stamt;

          DELETE FROM contact WHERE uid = _inviter_id;
          DELETE FROM contact WHERE entity = _inviter_id;
          INSERT INTO contact (id,firstname,lastname,category,entity,uid,status,metadata,ctime,mtime) 
          SELECT yp.uniqueId(), firstname,lastname,'drumate',id,id,'active',null, UNIX_TIMESTAMP(),UNIX_TIMESTAMP() FROM yp.drumate t
          WHERE id = _inviter_id;

          INSERT INTO _show SELECT  _source_id WHERE _secret = _source_secret ;

        ELSE 

          SET @st = CONCAT('UPDATE ', _inviter_db ,'.contact SET category ="drumate", entity=? WHERE  entity =? or entity =?');
          PREPARE stamt FROM @st;
          EXECUTE stamt USING _invitee_id,_email,_invitee_id;
          DEALLOCATE PREPARE stamt;

          DELETE FROM contact WHERE uid = _inviter_id;
          DELETE FROM contact WHERE entity = _inviter_id;
          INSERT INTO contact (id,firstname,lastname,category,entity,uid,status,metadata,ctime,mtime) 
          SELECT yp.uniqueId(), firstname,lastname,'drumate',id,null,'received',null, UNIX_TIMESTAMP(),UNIX_TIMESTAMP() FROM yp.drumate t
          WHERE id = _inviter_id;

        END IF;  
      
      END IF ;

    END IF ; 
    UPDATE _inviter SET is_checked =  1 WHERE inviter_id =_inviter_id; 
    SELECT IFNULL(_lvl,0) + 1 INTO _lvl;

  END WHILE; 
 

  DELETE FROM yp.token where secret IN (SELECT secret From _inviter WHERE secret <>  _source_secret ); 
  
  SELECT * from _show;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_notification_by_entity` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_notification_by_entity`(
  IN _entity     VARCHAR(500)
)
BEGIN
  SELECT 
    d.id drumate_id,
    d.email,
    ci.id contact_id,
    IFNULL(ci.firstname, '') AS firstname,
    IFNULL(ci.lastname, '') AS lastname,
    CONCAT(IFNULL(ci.firstname, ''), ' ', IFNULL(ci.lastname, '')) as fullname,
    ci.comment message,
    ci.status 
  FROM 
  contact ci 
  INNER JOIN yp.drumate d ON d.id = ci.entity
  WHERE ((ci.status="received") OR (ci.status="informed") OR (ci.status="invitation")) 
  AND (entity = _entity OR uid = _entity);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_notification_count` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_notification_count`()
BEGIN
  SELECT 
      count(ci.id) count
  FROM 
  contact ci 
  INNER JOIN yp.drumate d ON d.id = ci.entity
  WHERE (ci.status="received") OR (ci.status="informed") OR (ci.status="invitation");
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_notification_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_notification_get`()
BEGIN
  SELECT 
    d.id drumate_id,
    d.email,
    IFNULL(ci.firstname, '') AS firstname,
    IFNULL(ci.lastname, '') AS lastname,
   
    ci.message message,
    ci.status ,
    CASE WHEN json_value(`metadata`,'$.is_auto') =1 THEN d. fullname 
    ELSE RTRIM(LTRIM(CONCAT(IFNULL(ci.firstname, ''), ' ', IFNULL(ci.lastname, '')))) END  fullname
  FROM 
  contact ci 
  INNER JOIN yp.drumate d ON d.id = ci.entity
  WHERE (ci.status="received") OR (ci.status="informed") OR (ci.status="invitation");
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_search`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  DECLARE _uid VARCHAR(16);
  DECLARE _domain VARCHAR(512);

  
  SELECT u.id, `name` FROM yp.domain d INNER JOIN(yp.drumate u, yp.entity e) 
    ON u.domain_id=d.id AND e.id=u.id WHERE db_name=database() INTO _uid, _domain;

  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    1 as is_mycontact,
    IFNULL( e.id, c.entity) as id,
    c.entity email,
    IFNULL(c.surname, IFNULL(c.firstname, d.firstname)) surname,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname,
    CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,
    NULL ident,
    CASE WHEN d.id IS NULL THEN 1 ELSE 0 END is_need_email,
    c.status 
    FROM contact c
    LEFT JOIN yp.entity e ON e.id = c.uid
    LEFT JOIN yp.drumate d ON d.id = c.entity
    WHERE 
       (c.firstname LIKE CONCAT(TRIM(_key), '%') OR 
        c.lastname LIKE CONCAT(TRIM(_key), '%') OR 
        c.surname LIKE CONCAT(TRIM(_key), '%') OR 
        c.entity LIKE CONCAT(TRIM(_key), '%') ) AND c.status <> 'received'
    ORDER BY is_mycontact desc ,fullname ASC , c.id ASC  LIMIT _offset, _range;



  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_search_by_domain` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_search_by_domain`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  DECLARE _uid VARCHAR(16);
  DECLARE _domain VARCHAR(512);

  SELECT domain, id FROM yp.entity WHERE db_name=database() INTO _domain, _uid;

  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    1 as is_mycontact,
    'my_contact' as type,
    c.id as id,
    c.entity email,
    c.surname,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname,
    CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,
    NULL ident,
    CASE WHEN d.id IS NULL THEN 1 ELSE 0 END is_need_email,
    c.status 
    FROM contact c
    LEFT JOIN yp.entity e ON e.id = c.uid
    LEFT JOIN yp.drumate d ON d.id = c.entity
    WHERE 
       (c.firstname LIKE CONCAT(TRIM(_key), '%') OR 
        c.lastname LIKE CONCAT(TRIM(_key), '%') OR 
        c.surname LIKE CONCAT(TRIM(_key), '%') OR 
        c.entity LIKE CONCAT(TRIM(_key), '%') ) AND c.status <> 'received'
  UNION 
  SELECT 
    _page as `page`,
    0 as is_mycontact,
    'same_domain' as type,
    NULL AS id, 
    CASE WHEN d.email = TRIM(_key) THEN  d.email  ELSE NULL END AS email, 
    NULL AS surname,
    NULL AS firstname,
    NULL AS lastname,
    NULL as fullname,
    1   is_drumate , 
    CASE WHEN e.ident = TRIM(_key) THEN  e.ident  ELSE NULL END ,
    CASE WHEN d.id IS NULL THEN 1 ELSE 0 END is_need_email ,
    null status
    FROM yp.drumate d INNER JOIN yp.entity e using(id)
    WHERE
      d.id != _uid AND
      d.id  NOT IN (SELECT entity FROM contact WHERE status <> 'received') AND
      e.domain = _domain AND 
      ( e.ident =TRIM(_key) OR d.email = TRIM(_key)) 
    
  ORDER BY is_mycontact desc ,fullname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_search_by_domain_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_search_by_domain_next`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  DECLARE _uid VARCHAR(16);
  DECLARE _domain VARCHAR(512);
  DECLARE _mail  VARCHAR(500);

  SELECT domain, id FROM yp.entity WHERE db_name=database() INTO _domain, _uid;
  SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;

  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    1 as is_mycontact,
    'my_contact' as type,
    c.id as id,
    IF(coalesce(c.firstname, c.lastname ) IS NULL,IFNULL(ce.email,de.email) , NULL) email,
    IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
    c.surname given_surname,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname,
    CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,
    NULL ident, null username,
    CASE WHEN du.id IS NULL THEN 1 ELSE 0 END is_need_email,
    c.status ,
    CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
    CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me 
    FROM contact c
    LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
    LEFT JOIN yp.entity e ON e.id = c.uid
    LEFT JOIN yp.drumate de on de.id=c.entity
    LEFT JOIN yp.drumate du ON du.id = c.uid 
    
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.drumate dm ON dm.email = ce.email
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = dm.id) 
            AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    WHERE 
       (c.firstname LIKE CONCAT(TRIM(_key), '%') OR 
        c.lastname LIKE CONCAT(TRIM(_key), '%') OR 
        c.surname LIKE CONCAT(TRIM(_key), '%') OR 
        COALESCE(c.firstname, c.lastname, c.source) LIKE CONCAT(TRIM(_key), '%') ) AND c.status <> 'received'
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  
  
  
  
  
  
  
  
    
  ORDER BY is_mycontact desc ,fullname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_search_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `contact_search_next`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  DECLARE _uid VARCHAR(16);
  DECLARE _domain VARCHAR(512);
  DECLARE _mail  VARCHAR(500);

  SELECT id FROM yp.entity WHERE db_name=database() INTO  _uid;
  SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;


  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    1 as is_mycontact,
    coalesce( du.id,de.id, c.entity) as id,
    coalesce (du.email,de.email,ce.email) email,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname,
    IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
    CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,
    NULL ident,
    CASE WHEN du.id IS NULL THEN 1 ELSE 0 END is_need_email,
    c.status,
    CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
    CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me 
    FROM contact c
    LEFT JOIN contact_email ce on ce.contact_id = c.id AND ce.is_default = 1
    LEFT JOIN yp.drumate de ON de.id = c.entity
    LEFT JOIN yp.drumate du ON du.id = c.uid
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.drumate dm ON dm.email = ce.email
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = dm.id) 
            AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    WHERE 
      (c.firstname LIKE CONCAT(TRIM(_key), '%') OR 
        c.lastname LIKE CONCAT(TRIM(_key), '%') OR 
        c.surname LIKE CONCAT(TRIM(_key), '%') OR 
        c.source LIKE CONCAT(TRIM(_key), '%') ) AND c.status <> 'received'
    ORDER BY surname ASC, c.id ASC  LIMIT _offset, _range;



  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `contact_status_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `contact_status_get`(
  IN _entity     VARCHAR(500)
)
BEGIN
DECLARE _email VARCHAR(500);
SELECT email FROM yp.drumate WHERE id = _entity OR email = _entity INTO _email;
SELECT * FROM contact WHERE  entity= _entity OR uid = _entity OR entity= _email OR uid =  _email;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `copy_media` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `copy_media`(
  IN _src_id VARCHAR(16),
  IN _dest_pid VARCHAR(16),
  IN _des_entity_id VARCHAR(16),
  IN _option  SMALLINT   
  )
BEGIN
  DECLARE _id varchar(16);
  DECLARE _temp_filename varchar(1024);
  DECLARE _lvl int;
  DECLARE _des_db   VARCHAR(255);
  
  DECLARE _area VARCHAR(25);
  DECLARE _vhost VARCHAR(255);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _origin_sb_db VARCHAR(255);
  DECLARE src_home_dir VARCHAR(500);

  DECLARE _is_src_folder boolean; 
  SELECT 0 INTO _is_src_folder;
  SELECT 1 FROM media m WHERE category ='folder' AND  m.id =_src_id INTO  _is_src_folder;  
  
  
  SELECT utils.vhost(ident), home_dir, id,db_name FROM yp.entity WHERE id=_des_entity_id
  INTO _vhost, _home_dir, _hub_id,_des_db;
  
  
  
    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
    `id` varchar(16) DEFAULT NULL,
    `origin_id` varchar(16) DEFAULT NULL,
    `owner_id` varchar(16) NOT NULL,
    `host_id` varchar(16) NOT NULL,
    `file_path` varchar(512) DEFAULT NULL,
    `user_filename` varchar(128) DEFAULT NULL,
    `parent_id` varchar(16)  NULL DEFAULT '',
    `parent_path` varchar(1024) NOT NULL,
    `extension` varchar(100) NOT NULL DEFAULT '',
    `mimetype` varchar(100) NOT NULL,
    `category`  varchar(16) NOT NULL,
    `isalink` tinyint(2) unsigned NOT NULL DEFAULT '0',
    `filesize` int(20) unsigned NOT NULL DEFAULT '0',
    `geometry` varchar(200) NOT NULL DEFAULT '0x0',
    `publish_time` int(11) unsigned NOT NULL DEFAULT '0',
    `upload_time` int(11) unsigned NOT NULL DEFAULT '0',
    `last_download` int(11) unsigned NOT NULL DEFAULT '0',
    `download_count` mediumint(8) unsigned NOT NULL DEFAULT '0',
    `metadata` varchar(1024) DEFAULT NULL,
    `caption` varchar(1024) DEFAULT NULL,
    `status` varchar(20) NOT NULL DEFAULT 'active',
    `approval` enum('submitted','verified','validated') NOT NULL,
    `rank` tinyint(4) NOT NULL DEFAULT '0',
     
    `relative_path` varchar(1024) NOT NULL,
	  `lvl` int default 0,
    `is_checked` boolean default 0,
    `is_matched` boolean default 0,
    `is_delete` boolean default 0,
    `is_update` boolean default 0,
    `update_file_path`   varchar(1024)  NULL,
    `update_parent_path`   varchar(1024)  NULL,
    `new_id` varchar(16) DEFAULT NULL,
    `new_parent_id` varchar(16) DEFAULT NULL,
    `new_file_path`   varchar(1024)  NULL
    );

    DROP TABLE IF EXISTS  _des_media;
    CREATE TEMPORARY TABLE _des_media as select * from _src_media where 1=2;
    
    DROP TABLE IF EXISTS  _final_media;
    CREATE TEMPORARY TABLE _final_media as select * from _src_media where 1=2;
    
    ALTER table _src_media ADD `flg` char(1) DEFAULT 'S';
    ALTER table _des_media ADD `flg` char(1) DEFAULT 'D';
    ALTER table _final_media ADD `flg` char(1);

    SELECT db_name FROM yp.entity WHERE id =( 
        SELECT host_id FROM media WHERE id=_src_id AND file_path LIKE CONCAT("/__Inbound__","%") ) 
        INTO  _origin_sb_db ;


    
    IF _origin_sb_db IS NULL  then 
      
      INSERT INTO _src_media (id,file_path,user_filename,parent_id,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      is_checked,relative_path,lvl)
      SELECT id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      0, user_filename,0
      FROM media m WHERE m.id =_src_id;
    


      SELECT  id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename  ,_lvl;
      SET  _temp_filename =IFNULL(_temp_filename,'');

      WHILE _id is not null DO
        
          INSERT INTO _src_media (id,file_path,user_filename,parent_id ,parent_path,category,
          origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
          last_download,download_count,metadata,caption,status,approval,rank,
          is_checked,relative_path,lvl)
          SELECT  
            id,file_path,user_filename,parent_id,parent_path,category,
            origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
            last_download,download_count,metadata,caption,status,approval,rank,
            0,CONCAT(_temp_filename,"/",user_filename ) ,_lvl+1
          FROM media WHERE  parent_id =_id;
          
          UPDATE _src_media SET is_checked = 1 WHERE id = _id;
          SELECT NULL INTO _id;
          SELECT id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename ,_lvl ;
          SET  _temp_filename =IFNULL(_temp_filename,"");
      END WHILE;
  ELSE 
    SET @sql = CONCAT('
      INSERT INTO _src_media 
        (id,file_path,user_filename,parent_id ,parent_path,category,
        origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
        last_download,download_count,metadata,caption,status,approval,rank,
        is_checked,relative_path,lvl)
      SELECT
        m.id,m.file_path,m.user_filename,m.parent_id ,m.parent_path,m.category,
        origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
        last_download,download_count,metadata,caption,status,approval,rank,
        0, m.user_filename,0
      FROM ' ,_origin_sb_db ,'.media m
      WHERE 
        m.id ="', _src_id ,'"');

      PREPARE stmt FROM @sql ;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;

    
      SELECT  id ,relative_path,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename,_lvl; 
      SET  _temp_filename =IFNULL(_temp_filename,'''');

      WHILE _id is not null DO
          SET @sql = CONCAT('
          INSERT INTO _src_media (id,file_path,user_filename,parent_id ,parent_path,category,
          origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
          last_download,download_count,metadata,caption,status,approval,rank,
          is_checked,relative_path,lvl)
          SELECT  
            id,file_path,user_filename,parent_id,parent_path,category,
            origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
            last_download,download_count,metadata,caption,status,approval,rank,
            0,','CONCAT("',_temp_filename,'","/",user_filename ) ,',_lvl+1,
                  ' FROM ' ,_origin_sb_db,'.media WHERE  parent_id ="',_id,'"');
          PREPARE stmt FROM @sql ;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt;
          UPDATE _src_media SET is_checked = 1 WHERE id = _id;
          SELECT NULL INTO _id;
          SELECT id ,relative_path,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename,_lvl ;
          SET  _temp_filename =IFNULL(_temp_filename,"");
    END WHILE;

  END IF;



    
    SELECT NULL,NULL INTO _id,_temp_filename;
    SET @sql = CONCAT('
    INSERT INTO _des_media 
      (id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      is_checked,relative_path,lvl)
    SELECT
      m.id,m.file_path,m.user_filename,m.parent_id ,m.parent_path,m.category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      0, m.user_filename,0
    FROM ' ,_des_db ,'.media m
    WHERE 
      parent_id ="', _dest_pid ,'" AND 
      category = ', CASE WHEN _is_src_folder =1 THEN "'folder'" ELSE "category" END ,'     AND 
      user_filename  = ( SELECT  user_filename  FROM _src_media sm WHERE sm.id ="', _src_id,'")');

    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  
    SELECT  id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename,_lvl; 
    SET  _temp_filename =IFNULL(_temp_filename,'''');

    WHILE _id is not null DO
         SET @sql = CONCAT('
        INSERT INTO _des_media (id,file_path,user_filename,parent_id ,parent_path,category,
        origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
        last_download,download_count,metadata,caption,status,approval,rank,
        is_checked,relative_path,lvl)
        SELECT  
          id,file_path,user_filename,parent_id,parent_path,category,
          origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
          last_download,download_count,metadata,caption,status,approval,rank,
          0,','CONCAT("',_temp_filename,'","/",user_filename ) ,',_lvl+1,
                ' FROM ' ,_des_db,'.media WHERE  parent_id ="',_id,'"');
        PREPARE stmt FROM @sql ;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        UPDATE _des_media SET is_checked = 1 WHERE id = _id;
        SELECT NULL INTO _id;
        SELECT id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename,_lvl ;
        SET  _temp_filename =IFNULL(_temp_filename,"");
    END WHILE;
    
    
    UPDATE _des_media dm,_src_media sm SET dm.is_matched = 1 , sm.is_matched =1
	  WHERE  dm.relative_path = sm.relative_path AND dm.category=sm.category;


	  
	  UPDATE _des_media set is_delete=1 WHERE _option =0 ; 
    UPDATE _src_media set is_update=1 WHERE _option =0 ; 
	 
	  
	  UPDATE _des_media SET is_delete=1 WHERE _option =1 and is_matched= 1;  
    UPDATE _des_media SET is_update=1 WHERE _option =1 and is_matched= 0;  
    UPDATE _src_media SET is_update=1 WHERE _option =1;   


	  
	  

    SET @sql = CONCAT('SELECT file_path INTO @temp_parent_path FROM ', _des_db, '.media WHERE id = "', _dest_pid,'"');
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
      
	  UPDATE _src_media SET update_file_path=concat(@temp_parent_path,"/",relative_path);
	  UPDATE _src_media SET update_parent_path= left(update_file_path , LENGTH(update_file_path)- LENGTH(user_filename)-1) ;	
     
     
    
	  UPDATE _des_media SET update_file_path=concat(@temp_parent_path,"/",relative_path);
	  UPDATE _des_media SET update_parent_path= left(update_file_path , LENGTH(update_file_path)- LENGTH(user_filename)-1) ;	

	  
    UPDATE _src_media SET parent_id = _dest_pid WHERE lvl=0;
   
	  
    
    UPDATE _src_media sm, _des_media dm SET dm.parent_id = sm.id 
    WHERE  dm.is_matched=0 AND dm.is_delete=0 AND dm.update_parent_path = sm.update_file_path AND dm.lvl=sm.lvl+1 AND _option = 1 ;
    
    
    UPDATE _src_media SET new_id=yp.uniqueId() WHERE is_update =1 ; 
    

    
    INSERT INTO _final_media SELECT * FROM _src_media where is_update =1;
    INSERT INTO _final_media SELECT * FROM _des_media where is_update =1;

    
    UPDATE _final_media fm,_src_media sm SET fm.new_parent_id = sm.new_id  WHERE fm.parent_id=sm.id;
    
    
    UPDATE _final_media SET 
    update_file_path =  CONCAT( update_parent_path,"/",  id ,"-orig.",extension)
    WHERE category NOT IN ("folder","hub");

    
    UPDATE _final_media SET 
    new_file_path =  CONCAT( update_parent_path,"/",  new_id ,"-orig.",extension)
    WHERE category NOT IN ("folder","hub");

    
       
    UPDATE _src_media SET is_delete =1 
    WHERE 
    _origin_sb_db IS NOT NULL
    AND id NOT IN 
    (
      SELECT id FROM media WHERE EXISTS   
      (SELECT id FROM yp.share_box WHERE id = (SELECT id FROM yp.entity WHERE db_name=DATABASE()))
    );

    
    
    SET @sql = CONCAT('DELETE FROM ', _des_db , '.media WHERE id in (SELECT  id FROM _des_media )');
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    SET @sql = CONCAT( 'INSERT INTO ',_des_db,'.media 
    (
      id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank
    )
    SELECT 
      IFNULL(new_id,id),IFNULL(new_file_path, update_file_path),user_filename,IFNULL(new_parent_id,parent_id),update_parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),
      last_download,download_count,metadata,caption,status,approval,rank FROM _final_media 
    WHERE id NOT IN
      (SELECT id FROM _src_media WHERE is_delete =1 )  
      ') ;
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    
    
    SELECT 
      'MV' flg,
      id,
      user_filename ,
      concat(_home_dir, "/__storage__/", update_parent_path) AS  parent_path,
      concat(_home_dir, "/__storage__/", new_file_path) AS sys_new_file_path,
      concat(_home_dir, "/__storage__/", update_file_path ) AS sys_old_file_path,
      
  
      category
    FROM _final_media 
    WHERE 
      flg ='S' AND
      category NOT IN ("folder","hub") 
   
    UNION

    SELECT 
      'RM' as flg,
      id , 
      user_filename ,
      concat(_home_dir, "/__storage__/", parent_path)  parent_path ,
      NULL AS sys_new_file_path,
      NULL AS sys_old_file_path,
      category
    FROM _des_media 
    WHERE 
      category NOT IN ("folder","hub")  AND
      is_delete =1  AND
      is_matched= 1 
    
    UNION

    SELECT 
      'RMSN' as flg,   
      IFNULL(new_id,id), 
      user_filename ,
      concat(_home_dir, "/__storage__/", update_parent_path)  parent_path ,
      concat(_home_dir, "/__storage__/", new_file_path) AS sys_new_file_path,
      concat(_home_dir, "/__storage__/", update_file_path )  AS sys_old_file_path,
      category
    FROM _src_media 
    WHERE 
      is_delete =1  ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `count_download` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `count_download`(
  IN _id VARCHAR(16)
)
BEGIN

  UPDATE media SET download_count=download_count+1 WHERE id=_id;
  SELECT * from media where id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `count_files` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `count_files`(
)
BEGIN

  SELECT COUNT(*) AS count FROM media WHERE media.category!='folder';

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `count_yet_read` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `count_yet_read`(
IN _in JSON,
OUT _out JSON
)
BEGIN
   
DECLARE _entity_id VARCHAR(16);
DECLARE _uid VARCHAR(16);
DECLARE _total_cnt int(11) unsigned;
DECLARE _room_cnt int(11) unsigned;

  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _uid;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.entity_id")) INTO _entity_id;
  

  SELECT  
    COUNT(1)
  FROM 
    channel c 
  INNER JOIN read_channel rc ON rc.entity_id = c.entity_id  AND c.entity_id = c.author_id
  WHERE c.sys_id > rc.ref_sys_id  AND _uid = rc.uid 
  INTO  _total_cnt;

  SELECT  
    COUNT(1)
  FROM 
    channel c 
  INNER JOIN read_channel rc ON rc.entity_id = c.entity_id AND c.entity_id = c.author_id
  WHERE 
  rc.entity_id = _entity_id AND _uid = rc.uid AND
  c.sys_id > rc.ref_sys_id  INTO  _room_cnt;

  SELECT  JSON_MERGE(IFNULL(_out,'{}'), JSON_OBJECT('total',_total_cnt ),   JSON_OBJECT('room',_room_cnt)) INTO  _out;
  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `count_yet_read_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `count_yet_read_next`(
  IN _uid VARCHAR(16),
  IN _entity_id VARCHAR(16)
)
BEGIN
   
DECLARE _entity_id VARCHAR(16);
DECLARE _uid VARCHAR(16);
DECLARE _total_cnt int(11) unsigned;
DECLARE _room_cnt int(11) unsigned;
DECLARE _type VARCHAR(16);

  SELECT type FROM yp.entity WHERE db_name = DATABASE() INTO _type;
 IF _type != 'hub' THEN
 
    SELECT  
      COUNT(1)
    FROM 
      channel c 
    INNER JOIN read_channel rc ON rc.entity_id = c.entity_id  AND c.entity_id = c.author_id
    WHERE c.sys_id > rc.ref_sys_id  AND _uid = rc.uid 
    INTO  _total_cnt;

    SELECT  
      COUNT(1)
    FROM 
      channel c 
    INNER JOIN read_channel rc ON rc.entity_id = c.entity_id AND c.entity_id = c.author_id
    WHERE 
    rc.entity_id = _entity_id AND _uid = rc.uid AND
    c.sys_id > rc.ref_sys_id  INTO  _room_cnt;

  ELSE 
    SELECT  
      COUNT(1)
    FROM 
      channel c 
    INNER JOIN read_channel rc ON  c.author_id <> rc.uid
    WHERE c.sys_id > rc.ref_sys_id  AND _uid = rc.uid 
    INTO  _room_cnt;

 
  END IF; 
  
  SELECT _total_cnt total , _room_cnt room; 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `creator_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `creator_list`(
  IN _page TINYINT(4),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);
  IF _criteria LIKE "D%" THEN
    SELECT
      id, author_id, hashtag, type, device, lang, firstname, laststname, comment, ctime, mtime, version, status,
      @vhost AS vhost
    FROM layout LEFT JOIN yp.drumate ON author_id=drumate.id WHERE editor='creator'
    ORDER BY mtime DESC LIMIT _offset, _range;
  ELSE
    SELECT
      id, author_id, hashtag, type, device, lang, firstname, laststname, comment, ctime, mtime, version, status,
      @vhost AS vhost
    FROM layout LEFT JOIN yp.drumate ON author_id=drumate.id WHERE editor='creator'
    ORDER BY mtime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `data_usage` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `data_usage`(
)
BEGIN 
  DECLARE _personal_size FLOAT;
  DECLARE _hubs_size FLOAT;
  DECLARE _hubs_count INT(8) DEFAULT 0;
  DECLARE _uid VARCHAR(16);       

  SELECT id FROM yp.entity WHERE db_name = database() INTO _uid;
  SELECT sum(filesize) FROM media INTO _personal_size;
  SELECT IFNULL(yp.disk_usage(_uid),0) INTO _hubs_size;

  SELECT IFNULL(SUM(du.size),0)
  FROM yp.disk_usage du LEFT JOIN(yp.entity e, yp.hub h) ON hub_id=e.id AND h.id = e.id 
  WHERE h.owner_id=_uid INTO _hubs_size;
  SELECT _hubs_size as hub, _personal_size as personal;
  
  
  
  

  
  
  
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `delete_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `delete_agenda`( _agenda_id VARCHAR(16))
BEGIN
    
    DECLARE   _category  VARCHAR(20);
    DECLARE   _owner_id  VARCHAR(16);
    
    
    SELECT category ,owner_id FROM agenda WHERE agenda_id = _agenda_id INTO _category, _owner_id;
    DELETE FROM agenda WHERE agenda_id = _agenda_id;

    IF _category = 'other' AND (IFNULL ((SELECT 1 FROM agenda WHERE owner_id = _owner_id AND category = 'other'),0) =0) THEN
    
        DELETE FROM calendar WHERE owner_id = _owner_id;
    
    END IF;
  
    

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `delete_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `delete_calendar`(
    _calendar_id  VARCHAR(16) ,
    _owner_id  VARCHAR(16)
)
BEGIN
   
    UPDATE agenda SET  calendar_id = NULL WHERE calendar_id = _calendar_id;
    DELETE FROM calendar WHERE calendar_id = _calendar_id AND owner_id = _owner_id ;

    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `delete_map_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `delete_map_agenda`( _agenda_id VARCHAR(16))
BEGIN

    DELETE FROM map_agenda WHERE agenda_id = _agenda_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `desk_create_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `desk_create_hub`(
  IN _hubname VARCHAR(80),
  IN _area VARCHAR(16),
  IN _oid  VARCHAR(16),
  IN _profile JSON
)
BEGIN
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(50);
  DECLARE _is_wicket BOOLEAN DEFAULT 0;
  DECLARE _default_privilege TINYINT(4);
  DECLARE _dmail VARCHAR(500);
  DECLARE _domain VARCHAR(500);
  DECLARE _reason VARCHAR(500);
  DECLARE _folders JSON;
  DECLARE _fqdn VARCHAR(1024);  
  DECLARE _rollback BOOLEAN DEFAULT 0;   
  DECLARE  _domain_id INT;
  DECLARE  _serial INT;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
  BEGIN
    SET _rollback = 1;  
    GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
    @errno = MYSQL_ERRNO, @text = MESSAGE_TEXT;
    SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @text);
  END;

  
  SELECT yp.domain_name(DATABASE()) INTO _domain;
  SELECT yp.domain_id(DATABASE()) INTO _domain_id;
  SELECT JSON_VALUE(_profile, "$.folders") INTO _folders;
  SELECT JSON_VALUE(_profile, "$.is_wicket") INTO _is_wicket;

  SELECT JSON_REMOVE(_profile, "$.folders") INTO _profile;
  START TRANSACTION;
  
  SELECT id, db_name  FROM yp.entity WHERE type='hub' AND area='pool' 
    LIMIT 1 INTO _hub_id, _hub_db;

  SELECT IFNULL(yp.unique_hubname(_hubname, _domain_id), uniqueId()) INTO _hubname;
  IF utils.domain_name() = _domain THEN
    SELECT CONCAT(_hubname, '.', _domain) INTO _fqdn;
  ELSE
    SELECT CONCAT(_hubname, '-', _domain) INTO _fqdn;
  END IF;

  SELECT CASE _area
    WHEN 'public' THEN 3
    WHEN 'dmz' THEN 3
    WHEN 'share' THEN 3
    WHEN 'private' THEN 7 
    ELSE 0 
  END INTO _default_privilege;

  IF _default_privilege = 0 THEN 
    SELECT 1 INTO _rollback;
    SELECT CONCAT("Area ", _area, " is not allowed") INTO _reason;
  END IF;

  UPDATE yp.entity SET 
    area=_area, 
    status='active', 
    dom_id =_domain_id,
    settings=json_set(settings, "$.default_privilege", _default_privilege)
  WHERE id=_hub_id;

  INSERT INTO yp.vhost VALUES (null, _fqdn, _hub_id, _domain_id);

  
  SELECT sys_id FROM yp.vhost WHERE fqdn=_fqdn INTO _serial;
  INSERT INTO yp.hub (
    `id`, `owner_id`, `origin_id`, 
    `name`, `serial`,
    `hubname`, `domain_id`, `profile`)
  VALUES (
    _hub_id, _oid, _oid, 
    IFNULL(JSON_VALUE(_profile, "$.name"), _fqdn), _serial,
    _hubname, _domain_id, _profile);

  CALL join_hub(_hub_id);
  CALL permission_grant(_hub_id, _oid, 0, 63, 'system', '');
  SET @s = CONCAT("CALL `", _hub_db, "`.permission_grant('*', ?, 0, 63, 'system', '')");
  PREPARE stmt FROM @s;
  EXECUTE stmt USING _oid;
  DEALLOCATE PREPARE stmt;

  
  IF _is_wicket AND _area = 'dmz' THEN 
    UPDATE IGNORE yp.hub SET serial = 0 WHERE id = _hub_id;
    SET @s = CONCAT("UPDATE media SET status='hidden' WHERE id=", QUOTE(_hub_id));
    
    PREPARE stmt2 FROM @s;
    EXECUTE stmt2;
    DEALLOCATE PREPARE stmt2;
  END IF; 


  IF _area = "public" THEN 
    SET @s = CONCAT("CALL `", 
      _hub_db, 
      "`.permission_grant('*', '*', 0, 3, 'system', '')"
    );
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;
  
  IF _folders IS NOT NULL THEN 
    SET @s = CONCAT("CALL `", _hub_db,"`.mfs_init_folders(", quote(_folders), ",", true, ");");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;

  SET @s = CONCAT("CALL `", _hub_db,"`.mfs_hub_chat_init();");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @s = CONCAT("CALL `", _hub_db,"`.mfs_trash_init();");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;


  SELECT *, 0 as failed, _default_privilege default_privilege 
    FROM yp.entity WHERE db_name=_hub_db;

  IF _rollback THEN
    ROLLBACK;
    SELECT 1 as failed, IFNULL(_reason, @full_error) AS reason;
  ELSE
    COMMIT;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `desk_create_hub_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `desk_create_hub_next`(
  IN _ident VARCHAR(80),
  IN _area VARCHAR(16),
  IN _oid  VARCHAR(16),
  IN _profile JSON
)
BEGIN
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(50);
  DECLARE _default_privilege TINYINT(4);
  DECLARE _dmail VARCHAR(500);
  DECLARE _domain VARCHAR(500);
  DECLARE _folders JSON;
  DECLARE _fqdn VARCHAR(1024);  
  DECLARE _rollback BOOL DEFAULT 0;   
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;  

  
  SELECT IFNULL(
    get_json_object(_profile, "domain"), domain_name()
  ) INTO _domain;

  SELECT get_json_object(_profile, "folders") INTO _folders;

  SELECT JSON_REMOVE(_profile, "$.domain") INTO _profile;
  SELECT JSON_REMOVE(_profile, "$.folders") INTO _profile;
  START TRANSACTION;
  
  SELECT id, db_name  FROM yp.entity WHERE type='hub' AND area='pool' 
    LIMIT 1 INTO _hub_id, _hub_db;

  SELECT CONCAT(_ident, '.', _domain) INTO _fqdn;

  UPDATE yp.entity SET area=_area, ident=_ident, status='active', 
  vhost=_fqdn WHERE id=_hub_id;
  SELECT CASE _area
    WHEN 'public' THEN 3
    WHEN 'private' THEN 7 
    WHEN 'stricted' THEN 3
    ELSE 0 
  END INTO _default_privilege;

  UPDATE yp.entity SET settings=json_set(settings, "$.default_privilege", _default_privilege) 
    WHERE id=_hub_id;

  INSERT INTO yp.vhost VALUES (null, _fqdn, _hub_id, _domain);
  INSERT INTO yp.hub (
    `id`, `owner_id`, `origin_id`, 
    `name`, 
    `keywords`, `dmail`, `profile`)
  VALUES (
    _hub_id, _oid, _oid, 
    IFNULL(get_json_object(_profile, "name"), _fqdn),
    "Key words", yp.get_dmail(_ident), _profile);

  CALL join_hub(_hub_id);
  CALL permission_grant(_hub_id, _oid, 0, 63, 'system', '');
  SET @s = CONCAT("CALL `", _hub_db, "`.permission_grant('*',", QUOTE(_oid), 
    ", 0, 63, 'system', '');");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  IF _area = "public" THEN 
    SET @s = CONCAT("CALL `", 
      _hub_db, 
      "`.permission_grant('*', '*', 0, 7, 'system', '')"
    );
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;
  
  IF _folders IS NOT NULL THEN 
    SET @s = CONCAT("CALL `", _hub_db,"`.mfs_init_folders(", quote(_folders), ",", true, ");");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;

  SET @s = CONCAT("CALL `", _hub_db,"`.mfs_hub_chat_init();");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @s = CONCAT("CALL `", _hub_db,"`.mfs_trash_init();");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;


  SELECT *, 0 as failed,  _default_privilege default_privilege FROM yp.entity WHERE ident=_ident;

  IF _rollback THEN
    ROLLBACK;
    SELECT 1 as failed;
  ELSE
    COMMIT;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `desk_env` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `desk_env`(
)
BEGIN
  DECLARE _vhost VARCHAR(255);
  DECLARE _holder_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _db_name VARCHAR(512);
  DECLARE _wicket_id VARCHAR(16);

  SELECT h.id FROM yp.hub h 
    INNER JOIN yp.entity e on e.id=h.owner_id 
    WHERE e.db_name = database() AND `serial`=0 INTO _wicket_id;
  SELECT m.id AS nid,
    m.id AS home_id,
    e.id AS hub_id,
    fqdn AS vhost,
    _wicket_id AS wicket_id,
    e.area   
    FROM media m     
    INNER JOIN yp.entity e on db_name=database()     
    INNER JOIN yp.vhost v on v.id = e.id 
  WHERE parent_id='0';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `drumate_contact_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `drumate_contact_search`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    0 as is_mycontact,
    d.id AS id, 
    d.email, 
    IFNULL(c.firstname, IFNULL(d.firstname, '')) AS firstname,
    IFNULL(c.lastname, IFNULL(d.lastname, '')) AS lastname,
    CONCAT(IFNULL(c.firstname, IFNULL(d.firstname, '')), ' ', IFNULL(c.lastname, IFNULL(d.lastname, ''))) as fullname
    FROM yp.drumate d
    LEFT JOIN contact c ON d.email=c.email AND d.id=c.uid 
    WHERE c.firstname LIKE CONCAT(TRIM(_key), '%') OR c.lastname LIKE CONCAT(TRIM(_key), '%')
      OR d.email LIKE CONCAT(TRIM(_key), '%') AND c.id  is null
  UNION 
  SELECT
    _page as `page`, 
    1 as is_mycontact,
    c.uid as id,
    c.email,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname
    FROM contact c
    WHERE c.firstname LIKE CONCAT(TRIM(_key), '%') OR c.lastname LIKE CONCAT(TRIM(_key), '%')
      OR c.email LIKE CONCAT(TRIM(_key), '%')
  ORDER BY is_mycontact desc ,fullname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `drumate_hubs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `drumate_hubs`( 
  IN _page INT(4)
)
BEGIN
  DECLARE _id VARCHAR(16);
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);
  DECLARE _holder_id VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _host_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  SELECT vhost, entity.id, owner_id, area  
    FROM yp.entity LEFT JOIN yp.hub USING(id) WHERE db_name=DATABASE()
    INTO _vhost, _host_id, _owner_id, _area;

  CALL pageToLimits(_page, _offset, _range);
  SELECT 
    m.id  AS nid,
    parent_id AS pid,
    parent_id AS parent_id,
    _host_id AS holder_id,
    IF(m.category='hub', 
      (SELECT id FROM yp.entity WHERE entity.id=m.id), _owner_id
    ) AS owner_id,    
    IF(m.category='hub', 
      (SELECT id FROM yp.entity WHERE entity.id=m.id), _host_id
    ) AS hub_id,    
    IF(m.category='hub', (
      SELECT vhost FROM yp.entity WHERE entity.id=m.id), _vhost
    ) AS vhost,    
    IF(m.category='hub', (
      SELECT status FROM yp.entity WHERE entity.id=m.id), status
    ) AS status,
    IF(m.category='hub', (
      SELECT `name` FROM yp.hub WHERE hub.id=m.id), user_filename
    ) AS filename,
    IF(m.category='hub', (
      SELECT space FROM yp.entity WHERE entity.id=m.id), filesize
    ) AS filesize,
    IF(m.category='hub', m.extension, _area) AS area,
    _page as page,
    rank
  FROM media m LEFT JOIN (yp.hub) USING(id)
  WHERE status='active'
  ORDER BY rank DESC, filename DESC LIMIT _offset, _range;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `drumate_seach_contacts` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `drumate_seach_contacts`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  CALL pageToLimits(_page, _offset, _range);

  select drumate.email, drumate.id, firstname, photo, area from yp.drumate left join(contact, yp.profile) on drumate.email=contact.email 
  AND drumate.id=drumate_id where firstname like "%drey%" and (area='public' or area is NULL) UNION ALL 
  select contact.email, contact.uid as id, fullname, 'default', 'public' from contact where fullname like "%drey%";
  SELECT 
    drumate.id AS id, 
    drumate.email, 
    CONCAT(drumate.firstname, ' ', drumate.lastname) as fullname,
    photo, 
    area
    FROM yp.drumate LEFT JOIN(contact, yp.profile) ON drumate.email=contact.email AND drumate.id=drumate_id 
    WHERE ((CONCAT(firstname, ' ', lastname) LIKE CONCAT('%', TRIM(_key), '%') OR
    drumate.email LIKE CONCAT('%', TRIM(_key), '%'))) AND (area='public' or area is NULL)
  UNION ALL
  SELECT 
    contact.uid as id,
    contact.email,
    fullname,
    'default',
    'public'
    FROM contact
    WHERE fullname LIKE CONCAT('%', TRIM(_key),'%') OR
    contact.email LIKE CONCAT('%', TRIM(_key), '%')
  ORDER BY fullname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `entity_assign` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `entity_assign`(
    _tag_id VARCHAR(50),
    _entity_id VARCHAR(16),
    _category  VARCHAR(16)
   
)
BEGIN
   
    DECLARE _tag_time int(11) unsigned;
    SELECT UNIX_TIMESTAMP() INTO _tag_time; 
  
    INSERT INTO map_tag(tag_id,id, category,ctime) 
    SELECT _tag_id,_entity_id,_category,_tag_time ON DUPLICATE KEY UPDATE ctime =_tag_time , tag_id=_tag_id;

    SELECT * FROM map_tag WHERE tag_id = _tag_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `font_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `font_add`(
   IN _name         VARCHAR(200)
)
BEGIN
  DECLARE _last INT(11) DEFAULT 0;
  INSERT INTO used_fonts VALUES (NULL, _name, UNIX_TIMESTAMP());
  SELECT LAST_INSERT_ID() INTO _last;
  SELECT sys_id AS font_id, name, ctime FROM used_fonts WHERE sys_id = _last;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `font_last` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `font_last`()
BEGIN
  SELECT sys_id AS font_id, name, ctime FROM used_fonts
    WHERE sys_id IN (SELECT MAX(sys_id) FROM used_fonts GROUP BY name)
    ORDER BY sys_id DESC LIMIT 3;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `font_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `font_list`(
  IN _page TINYINT(4)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT * FROM `font` ORDER BY `name` ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `font_list_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `font_list_all`(
)
BEGIN
  SELECT * FROM `font` where status='active';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `forward_message_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `forward_message_get`(IN _in JSON)
BEGIN
 DECLARE _out JSON;
 DECLARE _hub_id VARCHAR(16);
 DECLARE _message_id VARCHAR(16);
 DECLARE _hub_db VARCHAR(255);
 DECLARE _messages JSON;
 DECLARE _idx_node INT(4) DEFAULT 0; 
 DECLARE _temp_result JSON;
 DECLARE _new_nodes JSON;
 
    SELECT '[]' INTO _new_nodes ;

    SELECT get_json_object(_in, "hub_id") INTO _hub_id;
    SELECT get_json_object(_in, "messages") INTO _messages;

    SELECT db_name FROM yp.entity WHERE id=_hub_id INTO _hub_db;
    
    WHILE _idx_node < JSON_LENGTH(_messages) DO 
      
      SELECT get_json_array(_messages, _idx_node) INTO _message_id;
      
      SET @st = CONCAT('CALL ', _hub_db ,'.post_forward_message_get(?,?)');
      PREPARE stamt FROM @st;
      EXECUTE stamt USING  JSON_OBJECT('message_id', _message_id  ) , _temp_result ;
      DEALLOCATE PREPARE stamt; 
      
      SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'hub_id', _hub_id )) INTO _temp_result ;
      SELECT JSON_ARRAY_INSERT(_new_nodes , '$[0]', _temp_result ) INTO _new_nodes;
      
      SELECT NULL INTO _temp_result ;
      SELECT _idx_node + 1 INTO _idx_node;
    END WHILE;

  SELECT JSON_UNQUOTE(_new_nodes) result;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_contributors` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_contributors`(
  IN _privilege    INT(4),
  IN _page         INT(4)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _count int(6);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _p int(4);

  CALL pageToLimits(_page, _offset, _range);
  SELECT COUNT(*) FROM member INTO _count;
  SELECT id FROM yp.entity WHERE db_name = database() INTO _hub_id;
  IF _privilege IS NULL OR _privilege = 0 THEN
    SELECT 0x3F INTO _p;
  ELSE
    SELECT _privilege INTO _p;
  END IF;

  SELECT drumate.id, 
    permission AS privilege,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.firstname')), ''))AS firstname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.lastname')), '')) AS lastname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.mobile')), '')) AS mobile,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.address')), '')) AS address,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city')), ''))) AS city,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.value')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country_code,
    permission.ctime, 
    permission.utime, 
    IF(expiry_time > 0, expiry_time - UNIX_TIMESTAMP(), 0) AS ttl,
    _count as total
    FROM permission LEFT JOIN yp.drumate ON entity_id=drumate.id 
    WHERE entity_id != _hub_id AND (_p & permission > 0) AND expiry_time <>-1
    ORDER BY firstname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_expired_huber` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_expired_huber`()
BEGIN
  SELECT * FROM huber WHERE (expiry_time <> 0 AND expiry_time < UNIX_TIMESTAMP());
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_filename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `get_filename`(
  IN _node_id VARCHAR(16)
)
BEGIN

  SELECT TRIM(TRAILING '/' FROM file_path) as fname FROM media WHERE id=_node_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_fonts_faces` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_fonts_faces`(
)
BEGIN
  SELECT * FROM `font_face`;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_fonts_links` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_fonts_links`(
)
BEGIN
  SELECT * FROM `font_link` where status='active';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_media_comment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_media_comment`(
  IN _id VARBINARY(16)
)
BEGIN
  SELECT
    comment.id AS id,
    ref_id     AS ref_id,
    owner_id   as oid,
    author_id  as author_id,
    content as comment,
    create_time as ctime,
    publish_time as ptime,
    edit_time as mtime,
    rating,
    firstname,
    lastname,
    if((UNIX_TIMESTAMP() - connexion_time)<120, 'on', 'off') as online,
    status
  FROM yp.drumate join comment on author_id=drumate.id WHERE comment.id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_node_link` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_node_link`( 
   IN _src_id VARCHAR(16),
   IN _uid VARCHAR(16)
)
BEGIN
DECLARE _rid VARCHAR(16);
DECLARE _eid VARCHAR(16);
DECLARE _vhost VARCHAR(255);
  
  SELECT m.id ,p.entity_id 
  FROM permission p 
  INNER JOIN media m ON 
    m.id = p.resource_id 
  WHERE m.id =_src_id 
        AND p.entity_id = _uid
        AND p.assign_via='link' 
        INTO _rid,_eid ;

  SELECT 
    d.firstname,
    d.lastname,
    d.email,
    CONCAT ('https://',utils.vhost(e.ident),'/#/share/',_rid,'/',_eid) link
  FROM yp.entity e
  INNER JOIN yp.hub sb on sb.id = e.id
  INNER JOIN yp.drumate d on d.id = sb.owner_id
  WHERE e.db_name= DATABASE() AND _rid IS NOT NULL AND _eid IS NOT NULL ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_privilege` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_privilege`(
  IN _uid VARBINARY(16),
  IN _area VARCHAR(12),
  OUT _priv TINYINT(2),
  OUT _hubers INT(8)
)
BEGIN
  DECLARE _tmp TINYINT(2);

  SELECT privilege FROM huber WHERE id=_uid INTO _tmp;
  SELECT count(*) FROM huber INTO _hubers;

  IF _tmp IS NULL OR _tmp='' THEN
    IF _area = 'public' THEN
      SET _priv=1;
    ELSE
      SELECT IF(_uid='ffffffffffffffff' OR _uid='nobody' OR _uid='' OR _uid IS NULL, -1, 0) INTO _priv;
    END IF;
  ELSE
    SET _priv=_tmp;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_pr_node_attr` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_pr_node_attr`(
   IN _node_id VARCHAR(16)
)
BEGIN

  SELECT 
      d.id entity_id ,  
      user_permission (d.id ,_node_id ) AS privilege, 
      d.email email,
      _node_id resource_id,
      yp.duration_days( user_expiry(d.id ,_node_id ))days,
      yp.duration_hours( user_expiry(d.id ,_node_id ))hours,
      read_json_object(d.profile, 'firstname') AS firstname,
      read_json_object(d.profile, 'lastname') AS lastname
  FROM
  (SELECT distinct entity_id FROM permission WHERE  expiry_time <>-1 ) p
  INNER JOIN yp.drumate d on p.entity_id=d.id 
  WHERE  user_permission (d.id ,_node_id ) > 0 ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_room_chat` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_room_chat`(
  IN  _entity_id  VARCHAR(16),
  IN _filter_by VARCHAR(20),  
  IN _order VARCHAR(20),  
  IN _chat_id varchar(16),
  IN _page INT(6)
)
BEGIN

  DECLARE _drumate_id VARCHAR(16);
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _sys_id bigint; 
  DECLARE _category varchar(50);  
 
	DROP TABLE IF EXISTS  _chat;
	CREATE TEMPORARY TABLE _chat (
	chat_id  varchar(16) 
	
	);  

	CALL pageToLimits(_page, _offset, _range);

	IF _chat_id IS NULL or _chat_id ='' THEN
		SELECT MAX(sys_id) FROM chat WHERE entity_id = _entity_id INTO _sys_id;
		SELECT chat_id ,category FROM chat WHERE sys_id=_sys_id INTO  _chat_id,_category;
	ELSE 
		SELECT sys_id,category FROM chat 
      WHERE chat_id =_chat_id AND entity_id = _entity_id INTO _sys_id,_category; 
	END IF;


  SELECT 
    ch.sys_id,
    ch.chat_id,
    ch.is_forward,
    _chat_id ref_chat_id,
    ch.bound,
    c.uid entity_id,
    m.id file_id,
    m.user_filename filename,
    ch.message,
    ch.ctime,
    ch.ctime AS date,
    IFNULL((SELECT is_read FROM map_chat mc WHERE mc.chat_id= ch.chat_id AND is_read = 1 LIMIT 1), 0) is_read,
    CASE WHEN ch.bound = 'in' THEN
      CONCAT(
        IFNULL(c.firstname, read_json_object(d.profile, 'firstname')), 
        ' ', 
        IFNULL(c.lastname, read_json_object(d.profile, 'lastname'))
      )
    ELSE NULL END name
    FROM 
      chat ch
      LEFT JOIN map_chat mch on ch.chat_id= mch.chat_id  AND ch.bound = 'in'
      LEFT JOIN media m on ch.media_id = m.id 
      LEFT JOIN contact c ON c.uid = mch.drumate_id  
      LEFT JOIN yp.drumate d ON d.id= mch.drumate_id   
    WHERE 
    ch.entity_id = _entity_id 
    AND ch.bound = CASE WHEN _filter_by IN ('in','out') THEN _filter_by ELSE ch.bound END
    AND  1 = CASE WHEN  _filter_by = 'file' AND  ch.media_id IS NULL  THEN 0 ELSE 1 END
    
    ORDER BY 
      CASE WHEN LCASE(_order) = 'asc' THEN ch.ctime END ASC,
      CASE WHEN LCASE(_order) = 'des' THEN ch.ctime END DESC
      
      
    LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `get_room_chat_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `get_room_chat_next`(
    IN  _entity_id  VARCHAR(16),
    IN _filter_by VARCHAR(20),  
    IN _order VARCHAR(20),  
    IN _chat_id varchar(16),
    IN _page INT(6)
)
BEGIN

  DECLARE _drumate_id VARCHAR(16);
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _sys_id bigint; 
  DECLARE _category varchar(50);  
 
	DROP TABLE IF EXISTS  _chat;
	CREATE TEMPORARY TABLE _chat (
	chat_id  varchar(16) 
	
	);  

	CALL pageToLimits(_page, _offset, _range);

	IF _chat_id IS NULL or _chat_id ='' THEN
		SELECT MAX(sys_id) FROM chat WHERE entity_id = _entity_id INTO _sys_id;
		SELECT chat_id ,category FROM chat WHERE sys_id=_sys_id INTO  _chat_id,_category;
	ELSE 
		SELECT sys_id,category FROM chat 
      WHERE chat_id =_chat_id AND entity_id = _entity_id INTO _sys_id,_category; 
	END IF;


  SELECT 
    ch.sys_id,
    ch.chat_id,
    ch.is_forward,
    _chat_id ref_chat_id,
    ch.bound,
    c.uid entity_id,
    m.id file_id,
    m.user_filename filename,
    ch.message,
    ch.ctime,
    IFNULL((SELECT is_read FROM map_chat mc WHERE mc.chat_id= ch.chat_id AND is_read = 1 LIMIT 1), 0) is_read,
    CASE WHEN ch.bound = 'in' THEN
      CONCAT(
        IFNULL(c.firstname, utils.read_json_object(d.profile, 'firstname')), 
        ' ', 
        IFNULL(c.lastname, utils.read_json_object(d.profile, 'lastname'))
      )
    ELSE NULL END name
    FROM 
      chat ch
      LEFT JOIN map_chat mch on ch.chat_id= mch.chat_id  AND ch.bound = 'in'
      LEFT JOIN media m on ch.media_id = m.id 
      LEFT JOIN contact c ON c.uid = mch.drumate_id  
      LEFT JOIN yp.drumate d ON d.id= mch.drumate_id   
    WHERE 
    ch.entity_id = _entity_id 
    AND ch.bound = CASE WHEN _filter_by IN ('in','out') THEN _filter_by ELSE ch.bound END
    AND  1 = CASE WHEN  _filter_by = 'file' AND  ch.media_id IS NULL  THEN 0 ELSE 1 END
    AND  ch.sys_id  <= _sys_id
    ORDER BY 
      CASE WHEN LCASE(_order) = 'asc' THEN ch.sys_id END ASC,
      CASE WHEN LCASE(_order) = 'des' THEN ch.sys_id END DESC
      
      
    LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `group_chat_rooms` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `group_chat_rooms`(
  IN _key VARCHAR(500), 
  IN _page INT(6)
)
BEGIN


DECLARE _range bigint;
DECLARE _offset bigint;
DECLARE _finished  INTEGER DEFAULT 0; 
DECLARE _db_name VARCHAR(500);
DECLARE _temp_result JSON;
DECLARE _uid VARCHAR(16);
DECLARE _nid VARCHAR(16);
DECLARE _read_cnt INT ;

DECLARE _attachment  VARCHAR(6000) ;
DECLARE _ctime INT(11) unsigned;
DECLARE _message mediumtext;
DECLARE _temp_nid VARCHAR(16);

  IF _key IN ('', '0') THEN 
    SELECT NULL INTO  _key;
  END IF;


CALL pageToLimits(_page, _offset, _range); 


SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _uid;
 DROP TABLE IF EXISTS _show_node;
 CREATE TEMPORARY TABLE _show_node  AS  
    SELECT 
      m.id ,  
      IFNULL(h.name, user_filename)  group_name, 
      0 room_count,
      db_name    
    FROM 
    media m
    INNER JOIN yp.hub h on  h.id = m.id 
    INNER  JOIN yp.entity he ON m.id = he.id
    WHERE category = 'hub'
    AND ( IFNULL(h.name, user_filename) LIKE CONCAT(TRIM(IFNULL(_key,IFNULL(h.name, user_filename) )), '%') ); 
   
    ALTER TABLE _show_node ADD message mediumtext;
    ALTER TABLE _show_node ADD ctime INT(11) unsigned;
    ALTER TABLE _show_node ADD `is_checked` boolean default 0 ;


    SELECT id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
    WHILE _nid IS NOT NULL DO
 
          SET @st = CONCAT('CALL ', _db_name ,'.room_detail(?,?)');
          PREPARE stamt FROM @st;
          EXECUTE stamt USING  JSON_OBJECT('uid',_uid ) , _temp_result ;
          DEALLOCATE PREPARE stamt; 
        
          SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.read_cnt")) INTO _read_cnt;  
          SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.message")) INTO _message;  
          SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.ctime")) INTO _ctime;  
          UPDATE _show_node SET  
            room_count =  _read_cnt,
            `message` =  _message,  
            ctime =  _ctime  
          WHERE id = _nid ;

        UPDATE _show_node SET is_checked = 1 WHERE id = _nid ;
        SELECT NULL , NULL ,NULL,NULL INTO _read_cnt,_message,_ctime ,_nid;
        SELECT id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
     END WHILE;



    SELECT  _page as `page`, id,group_name,room_count,message,ctime  FROM  _show_node  
    ORDER BY IFNULL(ctime,0) DESC, id ASC 
    LIMIT _offset, _range;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `hub_add_action_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `hub_add_action_log`(
  
  IN _uid VARCHAR(16),
  IN _action VARCHAR(16),
  IN _category VARCHAR(16),
  IN _notify_to VARCHAR(16),
  IN _entity_id VARCHAR(16),
  IN  _log  VARCHAR(1000)
)
BEGIN

INSERT INTO action_log (uid, category,action,notify_to,entity_id,log,ctime )
SELECT _uid, _category,_action,_notify_to,_entity_id,_log,UNIX_TIMESTAMP();

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `hub_add_font_link` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `hub_add_font_link`(
  IN _name VARCHAR(128),
  IN _variant VARCHAR(128),
  IN _url VARCHAR(1024)
)
BEGIN
  INSERT INTO font(`family`, `name`, `variant`, `url`, `ctime`, `mtime`)
            values(concat(`name`, ", ", `variant`), _name, _variant, _url, UNIX_TIMESTAMP(), UNIX_TIMESTAMP())
  ON DUPLICATE KEY UPDATE `family`=concat(`name`, ", ", `variant`),
            `name`=_name, `variant`=_variant, `url`=_url, mtime=UNIX_TIMESTAMP();
  SELECT * FROM font WHERE `name`=_name;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `hub_get_action_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `hub_get_action_log`(
 IN _uid VARCHAR(16),
 IN _page TINYINT(4)
)
BEGIN

  DECLARE _is_admin int(10);
  DECLARE _range bigint;
  DECLARE _offset bigint;
    
    CALL pageToLimits(_page, _offset, _range);
    SELECT 0 INTO _is_admin; 

    SELECT 1 FROM permission p WHERE  resource_id='*'  and  p.entity_id= _uid  and permission&16 > 0 INTO _is_admin;


    SELECT 
        a.category,
        CASE WHEN a.category = 'media' THEN  CONCAT( a.log ,' by ',  d.firstname, ' ', d.lastname)  ELSE a.log END log,
        a.ctime
    FROM 
       (
        SELECT * FROM action_log where notify_to ='member' and entity_id = _uid
            UNION 
        SELECT * FROM action_log where notify_to = 'all' 
            UNION 
        SELECT * FROM action_log where notify_to ='admin'  and _is_admin =1 
       ) a
  INNER JOIN yp.drumate d ON a.uid=d.id 
   ORDER BY ctime desc LIMIT _offset, _range;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `hub_get_members_by_type` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `hub_get_members_by_type`(
  IN _member_type enum('all', 'owner', 'not_owner', 'admin', 'other'),
  IN _page INT(6) 
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
    CALL pageToLimits(_page, _offset, _range);

    SELECT   
      d.id,
      permission AS privilege,
      d.email,
      TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.firstname')), ''))AS firstname,
      TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.lastname')), '')) AS lastname
      
    FROM permission p 
    INNER JOIN yp.drumate d on p.entity_id=d.id 
    WHERE 
      resource_id='*'  AND 
      CASE 
        WHEN _member_type ='owner' THEN permission&32 > 0 
        WHEN _member_type ='admin' THEN permission&16 > 0 
        WHEN _member_type ='not_owner' THEN permission&32 = 0 
        WHEN _member_type ='other' THEN permission&16 = 0 
        ELSE 1
      END = 1
    ORDER BY firstname ASC LIMIT _offset, _range;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `insert_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `insert_agenda`(
    _agenda_id VARCHAR(16),
    _name  VARCHAR(255),
    _place VARCHAR(255),
    _category VARCHAR(16),
    _owner_id VARCHAR(16),
    _calendar_id VARCHAR(16),
    _stime int(11) ,
    _etime int(11) 
   
)
BEGIN
    DECLARE _time int(11) unsigned;
    SELECT UNIX_TIMESTAMP() INTO _time; 

    IF _category = 'own' AND (IFNULL ((SELECT 1 FROM calendar WHERE owner_id = _owner_id AND category = 'own' LIMIT 1),0) =0) THEN
        CALL add_intial_calendar();
    END IF;

    INSERT INTO agenda (agenda_id,name,place,category,owner_id,stime,etime,calendar_id,ctime,mtime)
    SELECT _agenda_id,_name,_place,_category,_owner_id,_stime,_etime,_calendar_id,_time,_time;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `join_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `join_hub`(
  IN _hid VARCHAR(16)
)
BEGIN
  DECLARE _root_id VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _hub_name VARCHAR(100);
  DECLARE _extension VARCHAR(100);

  SELECT id FROM media WHERE parent_id='0' INTO _root_id;
  SELECT id FROM yp.entity WHERE db_name=database() INTO _owner_id;
  SELECT area, JSON_UNQUOTE(JSON_EXTRACT(`profile`, "$.name")) FROM yp.entity 
    LEFT JOIN yp.hub USING(id) WHERE id=_hid  INTO _extension, _hub_name;
  SELECT clean_path(unique_filename(_root_id, _hub_name, _extension)) INTO _hub_name;
  SELECT COUNT(*) FROM media WHERE parent_id = _root_id INTO @_count;
  
  
  
  REPLACE INTO `media` (
    id, 
    origin_id, 

    file_path, 
    user_filename, 
    parent_id, 
    parent_path,

    extension, 
    mimetype, 
    category,
    isalink,

    filesize, 
    `geometry`, 
    publish_time, 
    upload_time, 

    `status`,
    rank
  ) VALUES (
    _hid, 
    _owner_id, 

    CONCAT('/', _hub_name),
    _hub_name,
    _root_id, 
    '/',

    _extension, 
    'hub', 
    'hub', 
    1,

    0,
    '0x0', 
    UNIX_TIMESTAMP() , 
    UNIX_TIMESTAMP(), 

    'active',
    @_count
  );

  UPDATE media SET metadata=JSON_MERGE(
    IFNULL(metadata, '{}'), JSON_OBJECT('seen', _owner_id)
  )
  WHERE id=_hid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_add`(
   IN _user_id      VARCHAR(100),
   IN _hub_id       VARCHAR(255),
   IN _hub_root     VARCHAR(500),
   IN _locale       VARCHAR(100),
   IN _state        VARCHAR(100)
)
BEGIN
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _base VARCHAR(10);
  DECLARE _name VARCHAR(100);
  DECLARE _db_name   VARCHAR(100);
  DECLARE _job_id   VARCHAR(100);
  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT DATABASE() INTO _db_name;
  SELECT code, locale_en FROM yp.language WHERE lcid = _locale AND `state` = 'active' INTO _base, _name;

  IF IFNULL(_base, '') = "" OR IFNULL(_name, '') = "" THEN
    SELECT 1 AS invalid;
  ELSE
    INSERT INTO language (`base`, `name`, `locale`, `state`, `ctime`, `mtime`)
      VALUES(IFNULL(_base, ''), IFNULL(_name, ''), _locale, _state, _ts, _ts)
      ON DUPLICATE KEY UPDATE state=_state, mtime=_ts;
    
    IF LCASE(_state) = 'frozen' THEN
      SELECT SHA1(UUID()) INTO _job_id;
      INSERT IGNORE INTO yp.job_credential (`app_key`, `customer_key`, `job_id`, `user_id`, `ctime`)
        SELECT "language_management", id, _job_id, _user_id, _ts FROM yp.entity WHERE ident='admin';
      INSERT IGNORE INTO yp.frozen_language (`hub_id`, `dbase_name`, `root_path`, `job_id`, `lang`, `ctime`)
        VALUES(_hub_id, _db_name, _hub_root, _job_id, _locale, _ts);
    ELSEIF LCASE(_state) = 'active' OR LCASE(_state) = 'replaced' or LCASE(_state) = 'deleted' THEN
      DELETE FROM yp.frozen_language WHERE hub_id = _hub_id AND dbase_name = _db_name AND lang = _locale;
    END IF;
    
    SELECT sys_id AS language_id, base, name, locale, state FROM language WHERE locale = _locale;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_add_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_add_next`(
   IN _locale       VARCHAR(100)
)
BEGIN
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _base VARCHAR(10);
  DECLARE _name VARCHAR(100);
  DECLARE _db_name   VARCHAR(100);
  DECLARE _job_id   VARCHAR(100);
  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT DATABASE() INTO _db_name;
  SELECT code, locale_en FROM yp.language WHERE lcid = _locale AND `state` = 'active' 
    INTO _base, _name;

  IF _base IS NULL OR _name IS NULL THEN
    REPLACE INTO `language` SELECT null, "en", "English", "en", "active", _ts,_ts; 
  ELSE
    REPLACE INTO `language` SELECT null, _base, _name, _locale, "active", _ts,_ts;
  END IF;
  SELECT sys_id AS language_id, base, name, locale, state 
    FROM language WHERE locale = _locale;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_available_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_available_list`(
  IN _name         VARCHAR(200),
  IN _page         INT(11)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT code, lcid, locale_en, locale, flag_image FROM yp.language WHERE `state` = 'active'
    AND code NOT IN (SELECT locale FROM language WHERE state = 'active' OR state = 'replaced')
    AND locale_en LIKE CONCAT(TRIM(IFNULL(_name, '')), '%')
    ORDER BY locale_en ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_change_state` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_change_state`(
   IN _user_id      VARCHAR(100),
   IN _hub_id       VARCHAR(255),
   IN _hub_root     VARCHAR(500),
   IN _locale       VARCHAR(100),
   IN _state        VARCHAR(20)
)
BEGIN
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _language_count INT(11) DEFAULT 0;
  DECLARE _db_name   VARCHAR(100);
  DECLARE _job_id   VARCHAR(100);
  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT DATABASE() INTO _db_name;
  SELECT COUNT(*) FROM language WHERE state = 'active' INTO _language_count;
  IF _language_count <= 1 AND (LCASE(_state) = 'frozen' OR LCASE(_state) = 'deleted') THEN
    SELECT 0 AS updated;
  ELSE
    UPDATE language SET state = _state, mtime = _ts WHERE locale = _locale;
    IF LCASE(_state) = 'frozen' THEN
      SELECT SHA1(UUID()) INTO _job_id;
      INSERT IGNORE INTO yp.job_credential (`app_key`, `customer_key`, `job_id`, `user_id`, `ctime`)
        SELECT "language_management", id, _job_id, _user_id, _ts FROM yp.entity WHERE ident='admin';
      INSERT IGNORE INTO yp.frozen_language (`hub_id`, `dbase_name`, `root_path`, `job_id`, `lang`, `ctime`)
        VALUES(_hub_id, _db_name, _hub_root, _job_id, _locale, _ts);
      SELECT 1 AS updated;
    ELSEIF LCASE(_state) = 'active' OR LCASE(_state) = 'replaced' OR LCASE(_state) = 'deleted' THEN
      DELETE FROM yp.frozen_language WHERE hub_id = _hub_id AND dbase_name = _db_name AND lang = _locale;
      SELECT 1 AS updated;
    END IF;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_find_base` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_find_base`()
BEGIN
  SELECT sys_id AS language_id, base, name, locale, state FROM language WHERE state = 'active' OR state = 'replaced' ORDER BY sys_id ASC LIMIT 1;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_get_by_locale` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_get_by_locale`(
   IN _locale       VARCHAR(100)
)
BEGIN
  SELECT sys_id AS language_id, base, name, locale, state FROM language WHERE locale = _locale;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `language_get_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `language_get_list`(
  IN _page         INT(11)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT sys_id AS language_id, 
    base, 
    name, 
    yl.code,
    yl.locale_en,
    yl.lcid,
    name locale, 
    flag_image, 
    l.state 
    FROM `language` l
    JOIN yp.language yl ON yl.lcid = l.locale
    WHERE l.state = 'active' OR l.state = 'replaced' ORDER BY name ASC
    LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_add`(
   IN _tag    VARCHAR(512),
   IN _author     VARBINARY(16),
   IN _lang      VARCHAR(20),
   IN _comment    TEXT,
   IN _context    VARCHAR(16),
   IN _content       MEDIUMTEXT,
   IN _device     VARCHAR(16),
   IN _vesrion    VARCHAR(16)
)
BEGIN
   DECLARE _new_id VARCHAR(16) DEFAULT '';
   DECLARE _hash VARCHAR(512) DEFAULT '';
   DECLARE _ts    INT(11) DEFAULT 0;
   SELECT uniqueId(), UNIX_TIMESTAMP(), layout_ident(_tag, _lang, _device) INTO _new_id, _ts, _hash;

   INSERT INTO layout (`id`, `context`, `hashtag`, `hash`, `tag`, `device`, `lang`, `author`, `author_id`,
   	  `comment`, `content`, `status`, `ctime`, `mtime`, `version`)
   VALUES(_new_id, _context, _tag, _hash, _tag, _device, _lang, _author, _author,
          _comment, _content, 'active', _ts, _ts, _vesrion);

   SELECT *, tag as hashtag FROM layout WHERE id=_new_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_backup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_backup`(
   IN _id           VARBINARY(16),
   IN _letc  MEDIUMTEXT
)
BEGIN
   UPDATE layout SET backup=_letc, mtime=UNIX_TIMESTAMP() WHERE id=_id;
   SELECT backup, id FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_copy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_copy`(
   IN _id    VARCHAR(16),
   IN _author  VARCHAR(160)
)
BEGIN
   DECLARE _new_id VARBINARY(16) DEFAULT '';
   DECLARE _new_tag VARCHAR(512);
   DECLARE _tag VARCHAR(512);
   DECLARE _ident VARCHAR(512);

   SELECT tag, layout_ident(tag, lang, device) FROM layout WHERE id=_id INTO _tag, _ident;
   IF _tag='' OR _tag IS NULL THEN
     SELECT NULL;
   ELSE
     SET _new_id = uniqueId();
     SELECT concat(_tag, '-', COUNT(*)+1) FROM layout WHERE hash LIKE concat(_tag,"%!%!%") INTO _new_tag;
     INSERT INTO layout (`id`, `context`, `hash`, `tag`, `lang`, `device`, `author`, `comment`,
            `content`, `status`, `ctime`, `mtime`, `version`)
     SELECT _new_id, `context`, layout_ident(_new_tag, lang, device), _new_tag, lang, device, _author, comment,
            content, status, ctime, mtime, version FROM layout WHERE id=_id;
     SELECT * FROM layout WHERE id=_new_id;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_delete`(
   IN _tag      varchar(400),
   IN _lang     varchar(10),
   IN _device   varchar(10)
)
BEGIN
   DELETE FROM layout WHERE hash=concat(_tag, '!', _lang, '!', _device);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_find` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_find`(
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    *,
    @vhost AS vhost,
    tag as hashtag,
  MATCH(`content`) against(concat('*', _pattern, '*') IN BOOLEAN MODE) as relevance
  FROM layout HAVING relevance > 1 OR hashtag LIKE concat("%", _pattern, "%")
  ORDER BY relevance DESC, mtime DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_get`(
   IN _tag VARCHAR(512),
   IN _lang  VARCHAR(16),
   IN _device  VARCHAR(16)
)
BEGIN
   SELECT id, get_ident() AS owner, author, comment, context, status, if(status='draft', backup, content) as letc,
      tag as hashtag, lang, device, ctime, mtime, version
   FROM layout WHERE id=_tag OR tag=_tag
     ORDER BY layout_score(hash, tag, lang, device) DESC LIMIT 1;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_get_v2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_get_v2`(
   IN _hashtag VARCHAR(512)
)
BEGIN
   DECLARE _l VARCHAR(20);
   DECLARE _d VARCHAR(20);
   SELECT id, concat(@root, id, '/') AS layout_path, @entity_id AS oid,
     author, status, mtime, version
   FROM layout WHERE id=_hashtag OR hashtag=_hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_home` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_home`(
)
BEGIN
  SELECT
    area, concat(TRIM(TRAILING '/' FROM home_dir), '/Layout/'), id from yp.entity where db_name=database()
  INTO @area, @root, @entity_id;
  SELECT @area as area, @entity_id as eid, @root AS layout_root;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_list`(
  IN _page TINYINT(4),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);
  IF _criteria LIKE "D%" THEN
    SELECT
      *,
      @vhost AS vhost,
      tag as hashtag
    FROM layout ORDER BY mtime DESC LIMIT _offset, _range;
  ELSE
    SELECT
      *,
      @vhost AS vhost,
      tag as hashtag
    FROM layout ORDER BY mtime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_list_by` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_list_by`(
  IN _page TINYINT(4),
  IN _type VARCHAR(16),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);
  IF _criteria LIKE "D%" THEN
    SELECT
      id, author_id, hashtag, type, device, lang, author, comment, ctime, mtime, version, status,
      @vhost AS vhost
    FROM layout WHERE type=_type ORDER BY mtime DESC LIMIT _offset, _range;
  ELSE
    SELECT
      id, author_id, hashtag, type, device, lang, author, comment, ctime, mtime, version, status,
      @vhost AS vhost
    FROM layout WHERE type=_type ORDER BY mtime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_new`(
   IN _author     VARBINARY(16),
   IN _lang      VARCHAR(20),
   IN _context    VARCHAR(16),
   IN _content       MEDIUMTEXT,
   IN _device     VARCHAR(16),
   IN _vesrion    VARCHAR(16)
)
BEGIN
   DECLARE _id VARCHAR(16) DEFAULT '';
   DECLARE _hash VARCHAR(512) DEFAULT '';
   DECLARE _tag VARCHAR(512) DEFAULT '';
   DECLARE _ts    INT(11) DEFAULT 0;

   SELECT uniqueId() INTO _id;
   SET _tag = _id;
   SELECT UNIX_TIMESTAMP(), layout_ident(_tag, _lang, _device) INTO _ts, _hash;

   INSERT INTO layout (`id`, `context`, `hash`, `tag`, `device`, `lang`, `author`, `content`, `backup`,
   	  `status`, `ctime`, `mtime`, `version`)
   VALUES(_id, _context, _hash, _tag, _device, _lang, _author, _content, _content,
          'draft', _ts, _ts, _vesrion)
   ON DUPLICATE KEY UPDATE backup=_content, mtime=_ts;
   SELECT *, tag as hashtag FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_purge` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_purge`(
   IN _id      VARBINARY(16)
)
BEGIN
   DELETE FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_push` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_push`(
   IN _dbname     VARCHAR(80),
   IN _tag    VARCHAR(512)
)
BEGIN
   DECLARE _new_id VARBINARY(16) DEFAULT '';
   DECLARE _new_tag VARCHAR(512);
   DECLARE _ts    INT(11) DEFAULT 0;

   DROP TABLE IF EXISTS `_tmp_layout`;
   CREATE TEMPORARY TABLE _tmp_layout AS (SELECT * FROM layout WHERE tag=_tag);
   UPDATE _tmp_layout SET status='readonly', mtime=UNIX_TIMESTAMP(), id=uniqueId() WHERE tag=_tag;

   SET @s = CONCAT("INSERT IGNORE INTO `", _dbname, "`.`layout` SELECT * FROM _tmp_layout");
   SELECT @s;



   SELECT * FROM _tmp_layout WHERE tag=_tag;
   DROP TABLE IF EXISTS `_tmp_layout`;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_save` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_save`(
   IN _id       VARCHAR(16),
   IN _content  MEDIUMTEXT,
   IN _dummy  VARCHAR(16)
)
BEGIN
   DECLARE _mtime INT(11) DEFAULT 0;
   SELECT UNIX_TIMESTAMP() INTO _mtime;
   UPDATE layout SET content=_content, status='active', mtime=_mtime WHERE id=_id;
   SELECT
     *,
     @vhost AS vhost,
     tag as hashtag
   FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_search`(
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    *,
    @vhost AS vhost,
    tag as hashtag,
    + IF(tag = _pattern, 100, 0)
    + IF(tag LIKE concat(_pattern, "%"), 50, 0)
    + IF(tag LIKE concat("%", _pattern, "%"), 50, 0) AS score
    FROM layout HAVING  score > 30
    ORDER BY score DESC, mtime ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_status` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_status`(
   IN _id      VARBINARY(16),
   IN _status  VARCHAR(16)
)
BEGIN
   UPDATE layout SET status=_status WHERE id=_id;
   SELECT *, tag as hashtag FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_store` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_store`(
   IN _id       VARCHAR(16),
   IN _tagIn    VARCHAR(512),
   IN _author     VARBINARY(16),
   IN _lang      VARCHAR(20),
   IN _comment    TEXT,
   IN _context    VARCHAR(16),
   IN _content       MEDIUMTEXT,
   IN _device     VARCHAR(16),
   IN _vesrion    VARCHAR(16)
)
BEGIN
   UPDATE layout SET content=_content,
     status='active',
     tag = _tagIn,
     hash = layout_ident(_tagIn, _lang, _device),
     author = _author,
     lang = _lang,
     context = _context,
     backup =_content,
     device = _device
   WHERE id=_id;
   SELECT *, tag as hashtag FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `layout_update` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `layout_update`(
   IN _id      VARCHAR(16),
   IN _tag     VARCHAR(512),
   IN _author  VARCHAR(160),
   IN _lang    VARCHAR(20),
   IN _device  VARCHAR(20),
   IN _comment TEXT
)
BEGIN
   DECLARE _mtime INT(11) DEFAULT 0;
   DECLARE _url_key   VARCHAR(1000) DEFAULT '';
   SELECT UNIX_TIMESTAMP() INTO _mtime;
   UPDATE layout SET hash=layout_ident(_tag, _lang, _device),  tag=_tag,
     author=_author, comment=_comment, mtime=_mtime WHERE id=_id;
   SELECT
     *,
     @vhost AS vhost,
     tag as hashtag
   FROM layout WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `leave_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `leave_hub`(
  IN _hub_id VARCHAR(16)
)
BEGIN
  DECLARE _hub_db VARCHAR(20);
  DECLARE _uid VARCHAR(16);

  SELECT id FROM yp.entity WHERE db_name=database() INTO _uid;
  SELECT db_name FROM yp.entity WHERE id=_hub_id INTO _hub_db;

  DELETE FROM media WHERE id =_hub_id;
  DELETE FROM permission WHERE resource_id =_hub_id;

  IF _hub_db IS NOT NULL THEN 
    
    
    
    

    SET @s2 = CONCAT("DELETE FROM `", _hub_db, "`.permission WHERE entity_id=", quote(_uid) );
    PREPARE stmt FROM @s2;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `leave_hubs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `leave_hubs`(
)
BEGIN

  DECLARE _done INT DEFAULT 0;
  DECLARE _hdb VARCHAR(20);
  DECLARE _uid VARCHAR(16);
  DECLARE _hid VARCHAR(16);
  DECLARE _hubs CURSOR FOR SELECT id FROM media WHERE category ='hub';
  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _done = 1;


  SELECT id FROM yp.entity WHERE db_name=database() INTO _uid;

  OPEN _hubs;

  REPEAT
    FETCH _hubs INTO _hid;
    IF IFNULL(_hid, 0) <> 0 THEN
      SELECT db_name FROM yp.entity WHERE id=_hid INTO _hdb;
      SET @s = CONCAT("DELETE FROM `", _hdb, "`.huber WHERE id=", quote(_uid) );
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
    END IF;
  UNTIL _done END REPEAT;

  CLOSE _hubs;
  DELETE FROM media WHERE category ='hub';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `list_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `list_agenda`(
    _ftime INT(11),
    _ttime INT(11)
    )
BEGIN

    SELECT 
        a.agenda_id,
        a.name agenda_name,
        a.place,
        a.category,
        c.calendar_id,
        a.owner_id,
        a.stime,
        a.etime,
        CASE WHEN c.category ='other' THEN CONCAT(con.firstname, " ", con.lastname)
         ELSE c.name END  calendar_name,
        c.color

    FROM 
    agenda a 
    INNER JOIN calendar c 
    ON CASE WHEN c.is_default =1  THEN IFNULL(c.calendar_id,'-99') ELSE c.calendar_id END  = IFNULL(a.calendar_id,'-99')
    LEFT JOIN contact con on con.uid= c.owner_id
    WHERE 
    c.is_selected = 1 AND 
     (
        ( _ftime  between stime and etime) OR   
        ( _ttime  between stime and etime) OR   
        ( stime  between _ftime and _ttime) OR 
        ( etime  between _ftime and _ttime) 
      
      ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `list_media_comments` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `list_media_comments`(
  IN _media_id VARBINARY(16),
  IN _page TINYINT(8)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    comment.id AS id,
    ref_id     AS ref_id,
    origin_id  as oid,
    author_id  as author_id,
    content as comment,
    create_time as ctime,
    publish_time as ptime,
    edit_time as mtime,
    rating,
    firstname,
    lastname,
    if((UNIX_TIMESTAMP() - connexion_time)<120, 'on', 'off') as online,
    status
  FROM yp.drumate join comment on author_id=drumate.id WHERE ref_id=_media_id
  ORDER BY ptime DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `list_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `list_message`(
  IN _in JSON
)
BEGIN

  DECLARE _entity_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _page    TINYINT(4);

  DECLARE _entity_db VARCHAR(255);
  DECLARE _msg_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _timestamp int(11) unsigned;
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _flag VARCHAR(255);

  DECLARE _message_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _uid VARCHAR(16) CHARACTER SET ascii;
  
  DECLARE _ref_sys_id int(11) unsigned default 0 ;
  DECLARE _old_ref_sys_id int(11) unsigned default 0 ;
  DECLARE _max_sys_id  int(11) unsigned   ; 

    SELECT id FROM yp.entity where db_name= DATABASE() INTO _uid;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.entity_id")) INTO _entity_id;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.page")) INTO _page;

    CALL pageToLimits(_page, _offset, _range);

    SELECT ref_sys_id FROM read_channel WHERE entity_id = _entity_id AND  uid = _uid INTO _ref_sys_id;
    
    SELECT c.sys_id  FROM channel c INNER JOIN ( SELECT sys_id  FROM channel WHERE entity_id= _entity_id 
    ORDER BY sys_id DESC  LIMIT  _offset, 1) l ON l.sys_id =c.sys_id INTO _max_sys_id; 
    SELECT message_id FROM channel WHERE sys_id =_max_sys_id INTO _message_id;
    
    CALL acknowledge_message( JSON_MERGE( JSON_OBJECT('message_id',_message_id ) , JSON_OBJECT('entity_id',_entity_id ) ,JSON_OBJECT('uid',_uid ))  );

    SELECT _page as `page`,
        ch.sys_id,
        ch.author_id,
        ch.entity_id,
        ch.message,
        ch.message_id,
        ch.thread_id,
        ch.is_forward, 
        
        get_json_array(ch.attachment, 0) attachment_first,
        JSON_LENGTH(ch.attachment)  attachment_count,
        CASE WHEN LTRIM(RTRIM(ch.attachment))='' OR  ch.attachment IS NULL THEN 0 ELSE 1 END is_attachment, 
        ch.status,
        ch.ctime,
        ch.metadata,
        CASE WHEN _ref_sys_id  <  ch.sys_id THEN 1 ELSE 0 END is_notify,  
        CASE WHEN my_read.ref_sys_id  >=  ch.sys_id THEN 1 ELSE 0 END is_readed,
        CASE WHEN his_read.ref_sys_id  >=  ch.sys_id THEN 1 ELSE 0 END is_seen,
        IFNULL(read_json_object(ch.metadata, "message_type"),'chat')   message_type,  
        read_json_object(ch.metadata, "call_status") call_status,
        read_json_object(ch.metadata, "duration") call_duration      
      FROM 
      (SELECT sys_id FROM channel c  WHERE entity_id = _entity_id 
        ORDER BY c.sys_id  DESC LIMIT _offset, _range) s
      INNER JOIN  channel ch ON ch.sys_id = s.sys_id
      INNER JOIN  read_channel my_read  ON my_read.entity_id =ch.entity_id  AND   my_read.entity_id <> my_read.uid
      INNER JOIN  read_channel his_read  ON his_read.entity_id =ch.entity_id  AND   his_read.entity_id = his_read.uid
      ORDER BY ch.sys_id  DESC;
      
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `log_show_backup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `log_show_backup`(
 IN _page TINYINT(4)
)
BEGIN

  DECLARE _is_admin int(10);
  DECLARE _range bigint;
  DECLARE _offset bigint;
    
  CALL pageToLimits(_page, _offset, _range);


   SELECT * FROM action_log WHERE action='backup'
   ORDER BY ctime ASC LIMIT _offset, _range;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `lookup_hubers` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `lookup_hubers`(
  IN _name   VARCHAR(255),
  IN _page         INT(4)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _count int(6);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _p int(4);

  CALL pageToLimits(_page, _offset, _range);

  SELECT d.id, 
    permission AS privilege,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.firstname')), ''))AS firstname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.lastname')), '')) AS lastname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.mobile')), '')) AS mobile,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.address')), '')) AS address,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.city.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city')), ''))) AS city,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.country.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.country.value')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country_code,
    permission.ctime, 
    permission.utime, 
    IF(expiry_time > 0, expiry_time - UNIX_TIMESTAMP(), 0) AS ttl
    FROM permission LEFT JOIN yp.drumate d ON entity_id=d.id 
    WHERE d.id IS NOT NULL AND (
      firstname LIKE CONCAT("%", _name, "%") OR       
      lastname LIKE CONCAT("%", _name, "%") OR       
      mobile LIKE CONCAT("%", _name, "%") OR      
      email LIKE CONCAT("%", _name, "%")       
    )
    ORDER BY firstname ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mediaEnv` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mediaEnv`(
  OUT _vhost VARCHAR(255),
  OUT _hub_id VARCHAR(16), 
  OUT _area VARCHAR(25),
  OUT _home_dir VARCHAR(512),
  OUT _home_id VARCHAR(16),
  OUT _db_name VARCHAR(50),
  OUT _accessibility VARCHAR(16)
)
BEGIN
  DECLARE _domain VARCHAR(512);
  
  SELECT d.name FROM yp.domain d INNER JOIN 
    yp.entity e ON e.dom_id=d.id WHERE db_name=database() INTO _domain;
  SELECT IFNULL(fqdn, _domain), e.id, area, home_dir, db_name, accessibility, home_id
  FROM yp.entity e INNER JOIN yp.vhost v ON e.id=v.id WHERE db_name=database() LIMIT 1
  INTO _vhost, _hub_id, _area, _home_dir, _db_name, _accessibility, _home_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `media_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `media_search`(
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _finished       INTEGER DEFAULT 0; 
  DECLARE _nid VARCHAR(16);   
  DECLARE _uid VARCHAR(16);
  CALL pageToLimits(_page, _offset, _range);
  
  SELECT id FROM yp.entity where db_name = DATABASE() INTO _uid;   

  DROP TABLE IF EXISTS _search_node;
  CREATE TEMPORARY TABLE _search_node  AS     
  SELECT  
    m.id  as nid,
    m.extension as ext,
    m.origin_id  AS origin_id,
    m.file_path as filepath,
    COALESCE(he.id,me.id) AS hub_id,
    
    COALESCE(he.status,m.status) AS status,
    COALESCE(hh.name,m.user_filename) AS filename,
    COALESCE(me.space,m.filesize) AS filesize,
    _uid AS oid,
    ff.capability,
    IF(m.category='hub', m.extension, me.area) AS area,
    m.category as filetype,
    firstname,
    lastname,
    caption,
    upload_time as ctime,
    publish_time as mtime,
    download_count as views,
    
    
    
    
    IF(user_filename = _pattern, 100, 0)
    + IF(user_filename LIKE concat("%", _pattern, "%"), 50, 0) AS score
    FROM media m  
    INNER JOIN yp.entity me  ON me.db_name=database()
    LEFT JOIN yp.filecap ff ON m.extension=ff.extension
    LEFT JOIN yp.entity he ON m.id = he.id AND m.category='hub'
    LEFT JOIN yp.hub hh ON m.id = hh.id AND m.category='hub'
    
    

    INNER JOIN yp.drumate d  ON m.origin_id=d.id 
    WHERE  m.status='active'
    HAVING  score > 25
     LIMIT _offset, _range;
    
    ALTER table _search_node ADD privilege  tinyint(4) unsigned ;
    ALTER table _search_node ADD expiry_time int(11) ;
    
    BEGIN
      DECLARE dbcursor CURSOR FOR SELECT  nid FROM _search_node;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
      OPEN dbcursor;
        STARTLOOP: LOOP
          FETCH dbcursor INTO _nid;
          
            IF _finished = 1 THEN 
              LEAVE STARTLOOP;
            END IF;
          
            SET @perm = 0;
            SET @s = CONCAT("SELECT user_permission (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @perm");
            PREPARE stmt FROM @s;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt; 
            
            SET @resexpiry = null;    
            SET @s = CONCAT("SELECT user_expiry (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @resexpiry");
            PREPARE stmt FROM @s;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;

            UPDATE   _search_node SET privilege = @perm ,expiry_time = @resexpiry WHERE nid = _nid;

          END LOOP STARTLOOP; 
      CLOSE dbcursor;
    END; 
    
    
    SELECT * FROM _search_node WHERE (expiry_time = 0 OR expiry_time > UNIX_TIMESTAMP())
    ORDER BY score DESC, mtime ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `members_set_privilege` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `members_set_privilege`(
  IN _privilege INT(4)
)
BEGIN
  DECLARE _db_name VARCHAR(30);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _finished INTEGER DEFAULT 0;


  
  SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _hub_id;

  DROP TABLE IF EXISTS  _mid_tmp;  
  CREATE TEMPORARY TABLE `_mid_tmp` (db_name   VARCHAR(50));
  INSERT INTO _mid_tmp SELECT db_name FROM permission 
    LEFT JOIN yp.entity e ON entity_id=e.id WHERE permission < 31;

  BEGIN 
    DECLARE dbcursor CURSOR FOR SELECT db_name FROM _mid_tmp;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
    WHILE NOT _finished DO 
      FETCH dbcursor INTO _db_name;
      IF _db_name IS NOT NULL THEN 
        SET @s = CONCAT(
          "UPDATE `" ,_db_name,"`.permission SET permission=",_privilege, 
          ", utime = UNIX_TIMESTAMP() WHERE resource_id=", QUOTE(_hub_id));
        PREPARE stmt FROM @s;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
      END IF;
    END WHILE;
  END;
  UPDATE permission SET permission=_privilege, utime = UNIX_TIMESTAMP()
    WHERE resource_id='*' AND permission < 31; 

  SELECT 
    p.entity_id AS uid,
    d.firstname,
    JSON_UNQUOTE(JSON_EXTRACT(d.profile, '$.email')) AS email,permission as privilege,
    d.lastname
  FROM permission p INNER JOIN (yp.drumate d) ON 
    p.entity_id=d.id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `member_show_privilege` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `member_show_privilege`(
  _uid VARCHAR(16)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _count int(6);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _p int(4);


  SELECT drumate.id, 
    permission AS privilege,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.firstname')), ''))AS firstname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.lastname')), '')) AS lastname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.mobile')), '')) AS mobile,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.address')), '')) AS address,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city')), ''))) AS city,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.value')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country_code,
    permission.ctime, 
    permission.utime, 
    IF(expiry_time > 0, expiry_time - UNIX_TIMESTAMP(), 0) AS ttl,
    _count as total
    FROM permission LEFT JOIN yp.drumate ON entity_id=drumate.id 
    WHERE entity_id = _uid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `message_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `message_id`()
BEGIN
    SELECT  yp.uniqueId() as id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_access_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_access_node`(
  IN _uid VARCHAR(500) CHARACTER SET ascii,
  IN _node_id VARCHAR(1000) CHARACTER SET ascii
)
BEGIN

  DECLARE _area VARCHAR(25);
  DECLARE _vhost VARCHAR(255);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _hub_id VARCHAR(16) CHARACTER SET ascii ;
  DECLARE _dom_id VARCHAR(16);
  DECLARE _home_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _parent_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _db_name VARCHAR(50);
  DECLARE _hub_name VARCHAR(150);
  DECLARE _hub_db VARCHAR(150);
  DECLARE _actual_home_id VARCHAR(150) CHARACTER SET ascii DEFAULT NULL;
  DECLARE _actual_hub_id VARCHAR(150) CHARACTER SET ascii DEFAULT NULL;
  DECLARE _actual_db VARCHAR(150) DEFAULT NULL;
  DECLARE _remit TINYINT(4) DEFAULT 0;
  

  IF _node_id='0' OR _node_id IS NULL THEN 
    SELECT _home_id INTO _node_id;
  END IF;
  IF _node_id REGEXP ".*/.*" THEN 
    SELECT id FROM media WHERE file_path=_node_id INTO _node_id;
  END IF;

  SELECT 
    COALESCE(h.id, dr.id) AS id,
    e.home_id,
    e.home_dir,
    d.id,
    e.area,
    v.fqdn  AS vhost,
    e.db_name 
  FROM yp.entity e
    INNER JOIN yp.domain d ON d.id = e.dom_id
    LEFT JOIN yp.vhost v ON v.id = e.id
    LEFT JOIN yp.entity dr ON e.id = dr.id AND e.area='personal'
    LEFT JOIN yp.entity h ON e.id = h.id AND e.area IN('private', 'public', 'share','dmz','restricted')

 
  WHERE e.db_name = database() 
  INTO 
    _hub_id, 
    _home_id, 
    _home_dir,
    _dom_id, 
    _area,
    _vhost,
    _db_name;

  SELECT IFNULL(privilege, 0) FROM yp.privilege WHERE  domain_id = _dom_id AND  `uid`=_uid
    INTO _remit;

  SELECT 
    COALESCE(h.name, dr.fullname) AS `name`,
    IFNULL(e.area, _area), 
    IFNULL(e.home_id, _home_id), 
    IFNULL(e.id, _hub_id),
    IFNULL(e.db_name, _db_name)
  FROM yp.entity e 
    LEFT JOIN yp.drumate dr ON e.id = dr.id AND e.type='drumate'
    LEFT JOIN yp.hub h ON e.id = h.id 
    WHERE e.id=_node_id 
  INTO 
    _hub_name, 
    _area,
    _actual_home_id, 
    _actual_hub_id,
    _actual_db;

  
  
  
  
  
  
  
  
  


  SELECT
    media.id,
    media.id  AS nid,
    IFNULL(_actual_home_id, _home_id) AS actual_home_id, 
    IFNULL(_actual_hub_id, _hub_id) AS actual_hub_id,
    IFNULL(_actual_db, _db_name) AS actual_db,
    _db_name AS db_name,
    concat(_home_dir, "/__storage__/") AS mfs_root,
    concat(_home_dir, "/__storage__/") AS home_dir,
    parent_id AS pid,
    parent_id AS parent_id,
    _hub_id AS hub_id,
    _vhost AS vhost,
    caption,
    _area AS accessibility,
    _area AS area,
    _home_id AS home_id,
    capability,
    media.status AS status,
    media.extension,
    media.mimetype,
    media.extension AS ext,
    media.category AS ftype,
    media.category AS filetype,
   
    user_permission(_uid, media.id) as permission,
    download_count AS view_count,
    media.metadata metadata,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    CASE 
      WHEN media.category='hub' THEN _hub_name
      WHEN media.parent_id='0' THEN _hub_name
      ELSE user_filename
    END AS filename,
    parent_path,
    file_path,
    filesize,
    firstname,
    lastname,
    _remit AS remit
  FROM  media LEFT JOIN (yp.filecap, yp.drumate) 
  ON media.extension=filecap.extension AND origin_id=drumate.id 
  WHERE media.id=_node_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_add_comment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_add_comment`(
  IN _ref_id          VARBINARY(16),
  IN _hub_id        VARBINARY(16),
  IN _author_id       VARBINARY(16),
  IN _content         MEDIUMTEXT,
  IN _editable        TINYINT(4),
  IN _rating          DOUBLE,
  IN _lang            VARCHAR(16),
  IN _ext_data        MEDIUMTEXT,
  IN _status          VARCHAR(50),
  IN _version         INT(10) UNSIGNED
)
BEGIN
  DECLARE _id   VARBINARY(16) DEFAULT '';
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _last INT(11) DEFAULT 0;

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT yp.uniqueId() INTO _id;
  INSERT INTO `comment` (id, ref_id, owner_id, author_id, content, create_time, publish_time,
    edit_time, editable, rating, lang, ext_data, `status`, `version`)
    VALUES (_id, _ref_id, _hub_id, _author_id, _content, _ts, _ts, _ts, _editable,
    _rating, _lang, _ext_data, _status, _version);
  SELECT LAST_INSERT_ID() INTO _last;

  SELECT * FROM comment WHERE sys_id = _last;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_attachment_remove` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_attachment_remove`(
  IN _nid VARCHAR(16) 
)
BEGIN
  SELECT * FROM media WHERE file_path  REGEXP '^/__chat__' AND  id = _nid; 
  DELETE FROM media WHERE file_path  REGEXP '^/__chat__' AND id = _nid; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_available_folder` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_available_folder`(
  IN _nid VARCHAR(16),
  IN _fname VARCHAR(256)

)
    DETERMINISTIC
BEGIN

  DECLARE _id VARCHAR(16);
  SELECT id FROM media WHERE parent_id=_nid AND user_filename=_fname INTO _id;

  IF _id='' OR _id IS NULL THEN
    SELECT _fname AS filename, 'available' AS status, 1 AS active;
  ELSE
    SELECT _fname AS filename, 'unavailable' AS status, 0 AS active;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_browse` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_browse`(
  IN _node_id VARCHAR(16),
  IN _cat VARCHAR(32),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  IF _cat='files' OR _cat='' THEN
     SELECT
       media.id  AS nid,
       parent_id AS pid,
       parent_id AS parent_id,
       origin_id AS gid,
       caption,
       media.status AS status,
       extension AS ext,
       media.category AS ftype,
       media.category AS filetype,
       mimetype,
       download_count AS view_count,
       IF(parent_id='0', 'root', 'branch') as npos,
       geometry,
       upload_time AS ctime,
       publish_time AS ptime,
       user_filename AS filename,
       parent_path,
       IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
       file_path,
       filesize,
       firstname,
       lastname,
       remit,
       _page as page,
       concat(@root, file_path) AS file_path,
       @area as area
     FROM  media inner join yp.drumate on origin_id=drumate.id
     WHERE parent_id=_node_id
     ORDER BY ctime DESC LIMIT _offset, _range;
  ELSE
     SELECT
       media.id  AS nid,
       parent_id AS pid,
       parent_id AS parent_id,
       origin_id AS gid,
       caption,
       media.status AS status,
       extension AS ext,
       media.category AS ftype,
       media.category AS filetype,
       mimetype,
       download_count AS view_count,
       IF(parent_id='0', 'root', 'branch') as npos,
       geometry,
       upload_time AS ctime,
       publish_time AS ptime,
       user_filename AS filename,
       parent_path,
       IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
       file_path,
       filesize,
       firstname,
       lastname,
       remit,
       _page as page,
       concat(@root, file_path) AS file_path,
       @area as area
     FROM  media inner join yp.drumate on origin_id=drumate.id
     WHERE (media.category=_cat OR media.category='folder') AND parent_id=_node_id
     ORDER BY ctime DESC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_browse_asc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_browse_asc`(
  IN _node_id VARCHAR(16),
  IN _cat VARCHAR(32),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  IF _cat='files' OR _cat='' THEN
     SELECT
       media.id  AS nid,
       parent_id AS pid,
       parent_id AS parent_id,
       origin_id AS gid,
       caption,
       media.status AS status,
       extension AS ext,
       media.category AS ftype,
       media.category AS filetype,
       mimetype,
       download_count AS view_count,
       IF(parent_id='0', 'root', 'branch') as npos,
       geometry,
       upload_time AS ctime,
       publish_time AS ptime,
       user_filename AS filename,
       parent_path,
       IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
       file_path,
       filesize,
       firstname,
       lastname,
       gender,
       remit,
       _page as page,
       concat(@root, file_path) AS file_path,
       @area as area
     FROM  media inner join yp.drumate on origin_id=drumate.id
     WHERE parent_id=_node_id
     ORDER BY ctime ASC LIMIT _offset, _range;
  ELSE
     SELECT
       media.id  AS nid,
       parent_id AS pid,
       parent_id AS parent_id,
       origin_id AS gid,
       caption,
       media.status AS status,
       extension AS ext,
       media.category AS ftype,
       media.category AS filetype,
       mimetype,
       download_count AS view_count,
       IF(parent_id='0', 'root', 'branch') as npos,
       geometry,
       upload_time AS ctime,
       publish_time AS ptime,
       user_filename AS filename,
       parent_path,
       IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
       file_path,
       filesize,
       firstname,
       lastname,
       gender,
       remit,
       _page as page,
       concat(@root, file_path) AS file_path,
       @area as area
     FROM  media inner join yp.drumate on origin_id=drumate.id
     WHERE (media.category=_cat OR media.category='folder') AND parent_id=_node_id
     ORDER BY ctime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_chat_init` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_chat_init`()
BEGIN
 
  SELECT node_id_from_path('/__chat__') INTO @temp_chat_id;

  IF @temp_chat_id IS NULL THEN 
    call mfs_make_dir("0", JSON_ARRAY('__chat__'), 0);
    UPDATE media SET status='hidden' where file_path='/__chat__.folder';
  END IF;
  
  SELECT node_id_from_path('/__chat__') INTO @temp_chat_id;
  SELECT node_id_from_path('/__chat__/__send__') INTO @temp_send_id;
  SELECT node_id_from_path('/__chat__/__receive__') INTO @temp_receive_id;
  SELECT node_id_from_path('/__chat__/__upload__') INTO @temp_upload_id;

  IF @temp_send_id IS NULL THEN 
    CALL mfs_make_dir(@temp_chat_id, JSON_ARRAY('__send__'), 0);
    UPDATE media set status='hidden' where file_path='/__chat__/__send__.folder';
  END IF;
  
  IF @temp_receive_id IS NULL THEN 
    CALL mfs_make_dir(@temp_chat_id, JSON_ARRAY("__receive__"), 0);
    UPDATE media set status='hidden' where file_path='/__chat__/__receive__.folder';
  END IF;

  IF @temp_upload_id IS NULL THEN 
    CALL mfs_make_dir(@temp_chat_id, JSON_ARRAY("__upload__"), 0);
    UPDATE media set status='hidden' where file_path='/__chat__/__upload__.folder';
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_check_consistency` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_check_consistency`(
)
BEGIN
 UPDATE media m LEFT JOIN yp.entity e USING(id) 
   SET m.status= 'orphaned' WHERE category='hub' AND e.id IS NULL;
 DELETE FROM media WHERE STATUS = 'orphaned';

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_child_is_exist` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_child_is_exist`(
  IN _src_id VARCHAR(16),
  IN _dest_pid VARCHAR(16),
  IN _des_entity_id VARCHAR(16)
  )
BEGIN
  DECLARE _id varchar(16);
  DECLARE _temp_filename varchar(1024);
  DECLARE _lvl int;
  DECLARE _des_db   VARCHAR(255);

  
  SELECT db_name from yp.entity WHERE id=_des_entity_id INTO _des_db;

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
    `id` varchar(16) DEFAULT NULL,
    `file_path` varchar(512) DEFAULT NULL,
    `user_filename` varchar(128) DEFAULT NULL,
    `parent_id` varchar(16) NOT NULL DEFAULT '',
    `parent_path` varchar(1024) NOT NULL,
    `category`  varchar(16) NOT NULL,
    `is_checked` boolean default 0,
    `relative_path` varchar(1024) NOT NULL,
    `lvl` int default 0
    );

    DROP TABLE IF EXISTS  _des_media;
    CREATE TEMPORARY TABLE `_des_media` as select * from _src_media where 1=2;
    
    
    
    
    INSERT INTO _src_media (id,file_path,user_filename,parent_id,parent_path,category,
    is_checked,relative_path,lvl)
    SELECT id,file_path,user_filename,parent_id ,parent_path,category,
    0, user_filename,0
    FROM media m WHERE m.id =_src_id;
   
    SELECT  id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename  ,_lvl;
    SET  _temp_filename =IFNULL(_temp_filename,'''');

    WHILE _id is not null DO
     
        INSERT INTO _src_media (id,file_path,user_filename,parent_id ,parent_path,category,
        is_checked,relative_path,lvl)
        SELECT  
          id,file_path,user_filename,parent_id,parent_path,category,
          0,CONCAT(_temp_filename,'/',user_filename ) ,_lvl+1
        FROM media WHERE  parent_id =_id;
        
        UPDATE _src_media SET is_checked = 1 WHERE id = _id;
        SELECT NULL INTO _id;
        SELECT id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename ,_lvl ;
        SET  _temp_filename =IFNULL(_temp_filename,'''');
    END WHILE;



    
    SELECT NULL,NULL INTO _id,_temp_filename;
    SET @sql = CONCAT('
    INSERT INTO _des_media 
      (id,file_path,user_filename,parent_id ,parent_path,category,
      is_checked,relative_path,lvl)
    SELECT
      m.id,m.file_path,m.user_filename,m.parent_id ,m.parent_path,m.category,
      0, m.user_filename,0
    FROM ' ,_des_db ,'.media m
    WHERE 
      parent_id =''', _dest_pid ,''' AND 
      category = ''folder'' AND 
      user_filename  = ( SELECT  user_filename  FROM _src_media sm WHERE sm.id =''', _src_id,''')');

    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  
    SELECT  id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename,_lvl; 
    SET  _temp_filename =IFNULL(_temp_filename,'''');

    WHILE _id is not null DO
         SET @sql = CONCAT('
        INSERT INTO _des_media (id,file_path,user_filename,parent_id ,parent_path,category,
        is_checked,relative_path,lvl)
        SELECT  
          id,file_path,user_filename,parent_id,parent_path,category,
          0,','CONCAT(''',_temp_filename,''',''/'',user_filename ) ,',_lvl+1,
                ' FROM ' ,_des_db,'.media WHERE  parent_id =''',_id,'''');
        PREPARE stmt FROM @sql ;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        UPDATE _des_media SET is_checked = 1 WHERE id = _id;
        SELECT NULL INTO _id;
        SELECT id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename,_lvl ;
        SET  _temp_filename =IFNULL(_temp_filename,'''');
    END WHILE;
    
    
    SELECT EXISTS
      (SELECT 1
      FROM _src_media s
      INNER JOIN _des_media d ON 
        s.relative_path = d.relative_path AND 
        s.category=d.category and s.lvl>0) status;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_chk_circular_ref` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_chk_circular_ref`(
  IN _nodes MEDIUMTEXT,
  IN _uid VARCHAR(16),
  IN _dest_id VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
  DECLARE  _idx INT(4) DEFAULT 0; 
  DECLARE  _nid VARCHAR(16);
  DECLARE  _hub_id VARCHAR(16);
  DECLARE  _hub_db VARCHAR(40);
  DECLARE  _home_dir VARCHAR(512);
  DECLARE  _dest_db VARCHAR(40);
  DECLARE _dest_home_dir VARCHAR(512);

  DROP TABLE IF EXISTS  _src_tree_media;
  CREATE TEMPORARY TABLE _src_tree_media (
    `id`              varchar(16) NOT NULL,
    `parent_id`       varchar(16) DEFAULT NULL
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;


  SELECT db_name,home_dir FROM yp.entity WHERE id=_recipient_id INTO _dest_db,_dest_home_dir;

  WHILE _idx < JSON_LENGTH(_nodes) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _idx, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.nid")) INTO _nid;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.hub_id")) INTO _hub_id;

    SELECT db_name,home_dir FROM yp.entity WHERE id=_hub_id INTO _hub_db ,_home_dir;

    SET @streg = CONCAT("
      INSERT INTO _src_tree_media  WITH RECURSIVE mytree AS (
        SELECT  id,  parent_id
        FROM " , _hub_db ,".media  WHERE id = ?
        UNION 
        SELECT m.id,m.parent_id
        FROM " , _hub_db ,".media  m JOIN mytree t ON m.parent_id = t.id AND m.category <> 'hub'
      )
      SELECT 
        *
      FROM mytree;
    ");
    PREPARE stamtreg FROM @streg;
    EXECUTE stamtreg USING _nid;
    DEALLOCATE PREPARE stamtreg;
    SELECT _idx + 1 INTO _idx;
  END WHILE; 

  SELECT * from _src_tree_media where id =_dest_id ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_clear_notification` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_clear_notification`(
  IN _id     VARCHAR(16),
  IN _uid    VARCHAR(16),
  IN _show_results BOOLEAN
)
BEGIN
  DECLARE _md JSON;
  DECLARE _cat VARCHAR(100);
  DECLARE _seen INT(11) DEFAULT NULL;
  SELECT metadata, category FROM media WHERE id=_id INTO _md, _cat;
  IF _cat = 'folder' THEN
    DROP TABLE IF EXISTS _innerfile; 
    CREATE TEMPORARY TABLE `_innerfile` (
      seq  int NOT NULL AUTO_INCREMENT,
      id varchar(16) DEFAULT NULL, 
      parent_id varchar(16) DEFAULT NULL, 
      PRIMARY KEY `seq`(`seq`)  
    );
    INSERT INTO _innerfile (id, parent_id) 
      WITH RECURSIVE myfile AS 
      (
        SELECT id, parent_id
          FROM media WHERE id = _id AND file_path not REGEXP '^/__(chat|trash)__' 
        UNION ALL
        SELECT m.id, m.parent_id
          FROM media AS m JOIN myfile AS t ON m.parent_id =t.id 
            WHERE m.parent_id !='0' AND m.file_path not REGEXP '^/__(chat|trash)__' 
      )
    SELECT id, parent_id FROM myfile;
    UPDATE media m INNER JOIN _innerfile ii USING(id) SET 
      metadata=IF(JSON_VALID(metadata), 
        JSON_REPLACE(metadata, CONCAT("$._seen_.", _uid), UNIX_TIMESTAMP()),
        JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP()))
      );

  ELSE   
    IF NOT JSON_VALID(_md) THEN
      UPDATE media SET metadata=JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP())) WHERE id=_id;
    END IF; 
    IF _md IS NULL THEN 
      UPDATE media SET metadata=JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP())) WHERE id=_id;
    END IF;
    IF NOT JSON_EXISTS(_md, CONCAT("$._seen_.", _uid)) THEN 
      UPDATE media SET metadata=JSON_MERGE(metadata, JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP()))) WHERE id=_id;
    ELSE 
      UPDATE media SET metadata=JSON_REPLACE(metadata, CONCAT("$._seen_.", _uid), UNIX_TIMESTAMP()) WHERE id=_id;
    END IF;
    IF _show_results THEN 
      SELECT metadata FROM media WHERE id=_id;
    END IF;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_clear_notifications` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_clear_notifications`(
  IN _nodes  JSON,
  IN _uid    VARCHAR(16)
)
BEGIN
  DECLARE _i INT(8) DEFAULT 0;
  DECLARE _nid VARCHAR(16);

  WHILE _i < JSON_LENGTH(_nodes) DO 
    SELECT get_json_array(_nodes, _i) INTO _nid;
    SELECT _nid;
    CALL mfs_clear_notification(_nid, _uid, 0);
    SET _i = _i + 1;
  END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_copy_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_copy_all`(
  IN _nodes JSON,
  IN _uid VARCHAR(16),
  IN _dest_id VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
  DECLARE _idx INT(4) DEFAULT 0; 
  DECLARE _nid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(40);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _dest_db VARCHAR(50);
  DECLARE _dest_home_dir VARCHAR(512);
  DECLARE _temp_nid  VARCHAR(16);
  


  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _file_name      VARCHAR(512); 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50); 
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _seq            INTEGER;  
  DECLARE _id             VARCHAR(16);   
  DECLARE _new_parent_id  VARCHAR(16);  


  SELECT db_name, home_dir FROM yp.entity 
    WHERE id=_recipient_id INTO _dest_db, _dest_home_dir;

  DROP TABLE IF EXISTS  _src_media;
  CREATE TEMPORARY TABLE `_src_media` (
    `seq`  int NOT NULL AUTO_INCREMENT,
    `is_root` boolean default 0 ,
    `id` varchar(16) DEFAULT NULL,
    `origin_id` varchar(16) DEFAULT NULL,
    `owner_id` varchar(16) DEFAULT NULL,
    `user_filename` varchar(128) DEFAULT NULL,
    `category`      VARCHAR(50) DEFAULT NULL,
    `parent_id` varchar(16) DEFAULT null,
    `extension` varchar(100) NOT NULL DEFAULT '',
    `mimetype` varchar(100) NOT NULL,
    `filesize` int(20) unsigned NOT NULL DEFAULT '0',
    `geometry` varchar(200) NOT NULL DEFAULT '0x0',
    `new_id` varchar(16) DEFAULT NULL,  
    `new_parent_id` varchar(16) DEFAULT '' ,
    `is_checked` boolean default 0 ,
    `home_dir` VARCHAR(512) DEFAULT null,
    `db_name` VARCHAR(512) DEFAULT null,
    `hub_id` VARCHAR(16) DEFAULT null,
    PRIMARY KEY `seq`(`seq`)  
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

  DROP TABLE IF EXISTS _final_media; 
  CREATE TEMPORARY TABLE `_final_media` (
    nid varchar(16) DEFAULT NULL,  
    category varchar(50) DEFAULT NULL,  
    src_mfs_root varchar(1024) DEFAULT NULL,  
    src_db varchar(160) DEFAULT NULL,  
    des_id varchar(16) DEFAULT NULL,  
    des_mfs_root varchar(1024) DEFAULT NULL,  
    des_db varchar(160) DEFAULT NULL, 
    des_entity varchar(16) DEFAULT NULL,  
    action varchar(16) DEFAULT NULL
  );


  SET @st = CONCAT("DROP TABLE IF EXISTS ",_dest_db, ".__register_stack"); 
  PREPARE stmt FROM @st;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @st = CONCAT("CREATE TEMPORARY TABLE IF NOT EXISTS ", _dest_db,".__register_stack 
    LIKE template.__register_stack"); 
  PREPARE stmt FROM @st;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  
  


  WHILE _idx < JSON_LENGTH(_nodes) DO 
    DELETE FROM _src_media;
    
    SELECT get_json_array(_nodes, _idx) INTO @_node;
    SELECT get_json_object(@_node, "nid") INTO _nid;
    SELECT get_json_object(@_node, "hub_id") INTO _hub_id;

    SELECT db_name, home_dir FROM yp.entity WHERE id=_hub_id INTO _hub_db ,_home_dir;
    
    
    SET @st = CONCAT("
      INSERT INTO _src_media SELECT 
      null, 1, id, origin_id, ?, user_filename, category, parent_id, 
      extension, mimetype, filesize, geometry, null, null, 0, ?, ?, ? 
      FROM ", _hub_db,".media m  WHERE category <> 'hub' AND m.id =?
    ");  
    PREPARE stmt FROM @st;
    EXECUTE stmt USING _uid, _home_dir, _hub_db, _hub_id, _nid;
    DEALLOCATE PREPARE stmt;

    UPDATE _src_media SET new_parent_id = _dest_id  WHERE  id=_nid; 
    SELECT id FROM _src_media WHERE id = _nid INTO _temp_nid ;

     WHILE _temp_nid IS NOT NULL DO
       
      SELECT seq,id,origin_id,user_filename,category,
        extension,mimetype,`geometry`,filesize,new_parent_id 
      FROM _src_media WHERE id =_temp_nid 
      INTO _seq,_id,_origin_id,_file_name,_category,
        _extension,_mimetype,_geometry,_file_size, _new_parent_id;        
    

      
      IF _category = 'folder' THEN
        SET @st = CONCAT("
          INSERT INTO _src_media SELECT 
          null, 0, id, origin_id, ?, user_filename, category, parent_id, extension, 
          mimetype, filesize, geometry, null, null, 0, ?, ?, ?  
          FROM ", _hub_db,".media m WHERE status <> 'hidden' AND  category <> 'hub' AND m.parent_id =?
        ");  
        PREPARE stmt FROM @st;
        EXECUTE stmt USING _uid, _home_dir, _hub_db, _hub_id, _temp_nid;
        DEALLOCATE PREPARE stmt; 
      END IF ;

      SET @st = CONCAT("DELETE FROM ", _dest_db, ".__register_stack"); 
      PREPARE stmt1 FROM @st;
      EXECUTE stmt1;
      DEALLOCATE PREPARE stmt1;

      SET @st = CONCAT("CALL ", _dest_db, ".mfs_new_node(?,?,?,?,?,?,?,?,?,?)");
      PREPARE stmt2 FROM @st;
      EXECUTE stmt2 USING 
        _origin_id     ,
        _uid           ,
        _file_name     ,
        _new_parent_id ,
        _category      ,
        _extension     ,
        _mimetype      ,
        _geometry      ,
        _file_size     , 
        0;           
      DEALLOCATE PREPARE stmt2;

      SET @st = CONCAT("SELECT id, parent_id FROM ", _dest_db, 
        ".__register_stack INTO @temp_nid, @pid");
      PREPARE stmt3 FROM @st;
      EXECUTE stmt3;
      DEALLOCATE PREPARE stmt3;   
              
      UPDATE _src_media SET new_id =@temp_nid  WHERE seq =_seq ; 
      UPDATE _src_media SET new_parent_id =  @temp_nid WHERE parent_id = _temp_nid; 
      

      
      UPDATE _src_media SET is_checked = 1 WHERE id = _temp_nid ;
      SELECT NULL,NULL,NULL INTO _temp_nid ,@temp_nid,@pid;
      SELECT id FROM _src_media WHERE is_checked =0 
        AND new_parent_id IS NOT NULL LIMIT 1 INTO _temp_nid ;

     END WHILE;

    SELECT _idx + 1 INTO _idx;
    INSERT INTO _final_media (nid, category, src_db, des_db,des_entity, `action`)
      SELECT IFNULL(new_id,id), category, _hub_db, _dest_db,_recipient_id, 'showone' 
      FROM _src_media WHERE seq=1; 

    INSERT INTO _final_media (nid, category, src_db, des_db,des_entity, `action`)
      SELECT IFNULL(new_id,id), category, _hub_db, _dest_db, _recipient_id, 'show' 
      FROM _src_media WHERE is_root=1;

    INSERT INTO _final_media (nid, category, src_mfs_root, des_id, des_mfs_root, `action`)
      SELECT id, category, CONCAT(home_dir, "/__storage__/"), new_id, CONCAT(_dest_home_dir, "/__storage__/"), 'copy'  
      FROM _src_media WHERE category NOT IN ("folder","hub") ; 

     
    
    
    
    

    
    
  END WHILE;

  SELECT * FROM _final_media;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_copy_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_copy_node`(
  IN _id VARCHAR(100),
  IN _dest_id VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
  DECLARE _type           VARCHAR(100);
  DECLARE _new_id         VARCHAR(16);
  DECLARE _dest_db        VARCHAR(50);
  
  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _user_filename  VARCHAR(512); 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50);            

  SELECT category FROM media WHERE id=_dest_id INTO _type;
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id 
    INTO _dest_db;

  SELECT
    origin_id       ,       
    user_filename   ,   
    category        ,        
    extension       ,       
    mimetype        ,        
    filesize        ,       
    IFNULL(geometry, '0x0'),        
    status                    
  FROM media WHERE id = _id INTO
    _origin_id       ,       
    _user_filename   ,   
    _category        ,        
    _extension       ,       
    _mimetype        ,        
    _file_size       ,       
    _geometry        ,        
    _status;                    

   
  SET @s = CONCAT("CALL mfs_register(",
    "'"  , _origin_id     , "'," ,
    "'"  , _user_filename , "'," ,
    "'"  , _dest_id       , "'," ,
    "'"  , _category      , "'," ,
    "'"  , _extension     , "'," ,
    "'"  , _mimetype      , "'," ,
    "'"  , _geometry      , "'," ,
           _file_size     , ",1)"          
  );
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;   

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_copy_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_copy_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
    DECLARE  _temp_nid      VARCHAR(16);
    DECLARE  _lvl           INTEGER;
    DECLARE _dest_db        VARCHAR(50);
    DECLARE _origin_db      VARCHAR(50);

    DECLARE _origin_id      VARCHAR(16);   
    DECLARE _src_path       VARCHAR(1024); 
    DECLARE _des_path       VARCHAR(1024); 
    DECLARE _file_name      VARCHAR(512); 
    DECLARE _category       VARCHAR(50);   
    DECLARE _extension      VARCHAR(100); 
    DECLARE _mimetype       VARCHAR(100);      
    DECLARE _file_size      INT(20) UNSIGNED;
    DECLARE _geometry       VARCHAR(200);       
    DECLARE _status         VARCHAR(50); 
    DECLARE _finished       INTEGER DEFAULT 0;
    DECLARE _seq            INTEGER;  
    DECLARE _id             VARCHAR(16);   

    SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _dest_db;
    
    SELECT db_name FROM yp.entity WHERE id =( 
        SELECT origin_id FROM media where id=_nid and parent_path(_nid) LIKE CONCAT("/__Inbound__/","%",'/') 
        ) 
        INTO  _origin_db ;   

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' ,
      `lvl` int default 0, 
      `is_checked` boolean default 0 ,
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    SELECT _nid,0  INTO _temp_nid , _lvl;
   
    WHILE _temp_nid IS NOT NULL DO
      
      INSERT INTO _src_media
      SELECT 
      null, id,origin_id,user_filename,category,parent_id,extension,mimetype,filesize,geometry,null,null,_lvl ,0
      FROM media m1 WHERE  category <> "hub" AND CASE WHEN _lvl <> 0 THEN m1.parent_id ELSE m1.id END  =_temp_nid;
      
      
      UPDATE _src_media SET is_checked = 1 WHERE id = _temp_nid and _lvl <> 0;
      SELECT NULL,_lvl+1 INTO _temp_nid,_lvl;
      SELECT id FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _temp_nid ;
  
    END WHILE;
 
  UPDATE _src_media SET new_parent_id = _pid  WHERE  seq=1;  
  
  BEGIN
    DECLARE dbcursor CURSOR FOR SELECT seq,id,origin_id,user_filename,category,extension,mimetype,`geometry`,filesize FROM _src_media order by seq;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _seq,_id,_origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    

       

        SET @s1 = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_dest_db,".__register_stack LIKE template.tmp_media"); 
        PREPARE stmt FROM @s1;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;


        SET @s1 = CONCAT( "DELETE FROM ",_dest_db,".__register_stack"); 
        PREPARE stmt1 FROM @s1;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
        
        SELECT new_parent_id  FROM _src_media WHERE seq =_seq INTO _pid; 
       

        SET @s2 = CONCAT("CALL ",_dest_db,".mfs_register(",
            "'"  , _origin_id     , "'," ,
            "'"  , _file_name     , "'," ,
            "'"  , _pid           , "'," ,
            "'"  , _category      , "'," ,
            "'"  , _extension     , "'," ,
            "'"  , _mimetype      , "'," ,
            "'"  , _geometry      , "'," ,
                   _file_size     , ", 0 )"          
          );
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;   
 

      
        SET @s3 = CONCAT( "SELECT id ,parent_id FROM ",_dest_db,".__register_stack INTO @temp_nid,@pid");
        PREPARE stmt3 FROM @s3;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;   
        

        UPDATE _src_media SET new_id =@temp_nid , new_parent_id = @pid  WHERE seq =_seq ; 
        UPDATE _src_media SET new_parent_id =  @temp_nid    WHERE parent_id = _id; 

      END LOOP STARTLOOP;   

    CLOSE dbcursor;
  END;  
   
  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      new_id varchar(16) DEFAULT NULL,    
      action varchar(16) DEFAULT NULL,
      mfs_root varchar(1024)  DEFAULT NULL
      );   
    
  INSERT INTO   _final_media  
  SELECT new_id AS nid ,new_id AS dest_id, 'show'   AS action, null as mfs_root  FROM _src_media WHERE seq = 1 ;

  INSERT INTO   _final_media
  SELECT id   AS nid ,new_id AS dest_id, 'copy'   AS action, null as mfs_root  FROM _src_media WHERE category NOT IN ("folder","hub");

  SELECT * FROM  _final_media;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_count_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_count_new`(
  IN _node_id VARCHAR(16), 
  IN _uid VARCHAR(16)
)
BEGIN
  DECLARE _tempid VARCHAR(16);
  DECLARE _category VARCHAR(16);
  DECLARE _lvl INT;
  DECLARE _hub_db_name VARCHAR(255);
  DECLARE _hubs MEDIUMTEXT DEFAULT NULL;
  DECLARE _hub_id VARCHAR(16);


    SELECT id FROM yp.entity WHERE db_name = database() INTO  _hub_id;
  
    DROP TABLE IF EXISTS _show_node; 
    CREATE TEMPORARY TABLE _show_node (
     `seq`  int NOT NULL AUTO_INCREMENT,
     `id` varchar(16),
     `parent_id` varchar(16), 
     `category` varchar(16) ,
      PRIMARY KEY `seq`(`seq`) 
    );

    INSERT INTO _show_node 
    (id, parent_id ,category)
    WITH RECURSIVE mytree AS 
    ( 
      SELECT id, parent_id ,category
      FROM media WHERE id = _node_id
        UNION ALL
      SELECT m.id,m.parent_id ,m.category
      FROM media AS m JOIN mytree AS t ON m.parent_id = t.id
    ) SELECT id, parent_id ,category FROM mytree;
    
    
 
    SELECT MAX(seq) FROM _show_node  INTO _lvl; 
    SELECT id,category FROM _show_node WHERE seq = _lvl 
      INTO _tempid  ,_category;

    SET @_new_chat = 0;
    SET @_new_file = 0;
    WHILE ( _lvl >= 1 AND  _tempid IS NOT NULL) DO
        IF (_category = 'hub') THEN
        SET @_temp_file_count = 0;
        SET @_temp_read_cnt = 0; 
        SET @_temp_result = NULL;
        SELECT db_name FROM yp.entity WHERE id = _tempid
        INTO _hub_db_name; 
        SET @s = CONCAT(
          "SELECT IFNULL(SUM(is_new(metadata, owner_id, ?)), 0) FROM ", _hub_db_name ,
          ".media WHERE file_path not REGEXP '^/__(chat|trash)__' INTO @_temp_file_count"
         );
        PREPARE stmt FROM @s;
        EXECUTE stmt USING _uid;
        DEALLOCATE PREPARE stmt;


        SET @st = CONCAT('CALL ', _hub_db_name ,'.room_detail(?,?)');
        PREPARE stamt FROM @st;
        EXECUTE stamt USING  JSON_OBJECT('uid',_uid ) , @_temp_result ;
        DEALLOCATE PREPARE stamt; 
      
        SELECT JSON_UNQUOTE(JSON_EXTRACT( @_temp_result, "$.read_cnt")) INTO @_temp_read_cnt;
    

        SELECT @_temp_file_count + @_new_file INTO @_new_file;
        SELECT @_temp_read_cnt + @_new_chat INTO @_new_chat;    
      END IF;
    
     
      SELECT _lvl - 1  INTO _lvl; 
      SELECT NULL, NULL INTO _tempid,_category;
      SELECT id,category FROM _show_node WHERE seq = _lvl 
      INTO _tempid,_category;

    END WHILE;
  
  SELECT SUM(is_new(m.metadata, owner_id, _uid)) FROM _show_node 
  INNER JOIN media m USING(id)  INTO @_file_count;
  SELECT IFNULL(GROUP_CONCAT(id), _hubs) FROM _show_node 
  WHERE category='hub' INTO @_hubs;
 
  SELECT @_file_count + @_new_file INTO @_new_file;
  SELECT _node_id nid, _uid `uid`, _hub_id AS hub_id, @_hubs hubs,
    @_new_chat new_chat, @_new_file AS count, @_new_file new_file,
    CAST((@_new_chat + @_new_file) as UNSIGNED INTEGER) notify;
  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_delete`(
  IN _rid VARCHAR(16),
  IN _uid VARCHAR(16),
  IN _bound VARCHAR(255)
)
BEGIN
  DECLARE _node_path VARCHAR(255);
  DECLARE _category VARCHAR(40);
  
  DECLARE _src_share_box_id VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _des_share_box_id VARCHAR(16);
  DECLARE _des_db_name VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _sid VARCHAR(16);
  DECLARE _eid VARCHAR(16);
  DECLARE _status VARCHAR(16); 

 
  IF _bound = '__Nobound__' THEN

    SELECT category from media WHERE id=_rid into _category;
    IF _category='folder' THEN
      SELECT TRIM(TRAILING '/' FROM file_path) from media WHERE id=_rid into _node_path;
      DELETE FROM media WHERE file_path LIKE concat(_node_path, '/%');
    END IF;
    DELETE FROM media WHERE id=_rid;

  END IF ;
  
 
  IF _bound = '__Outbound__' THEN

    DROP TABLE IF EXISTS  _user_box_media;
    CREATE TEMPORARY TABLE _user_box_media (
        `id` varchar(16) DEFAULT NULL,
        `entity_id` varchar(16) NOT NULL,
        `status` enum('receive','accept','refuse','remove','change') DEFAULT 'receive',  
        `is_checked` boolean default 0
    );

    INSERT INTO _user_box_media
    SELECT sys_id,n.entity_id,n.status,0 
    FROM yp.notification n 
    WHERE  n.status IN ('receive','change','accept')
    AND owner_id = _uid
    AND resource_id =(
      SELECT id
      FROM media m 
      INNER JOIN yp.notification n ON  n.resource_id=m.id 
      WHERE (SELECT concat(parent_path,'/',user_filename) 
        FROM media WHERE id = _rid) REGEXP user_filename AND n.permission IS NOT NULL
      ORDER BY (LENGTH(parent_path)-LENGTH(REPLACE(parent_path, '/', '')))  DESC LIMIT 1 
    );

    WHILE (IFNULL(
      (SELECT 1 FROM _user_box_media  WHERE  is_checked = 0 limit 1 ),0)  = 1 ) DO
      
      SELECT id, entity_id, status  FROM _user_box_media WHERE is_checked = 0 LIMIT 1 
        INTO _sid ,_eid,_status;
      
      IF _status <> 'receive' THEN
        SET @s = CONCAT(" CALL sb_to_sb("
                        , QUOTE(_uid) ,"," 
                        , QUOTE(_rid) ,"," 
                        , QUOTE(_eid), ",null,null,null,'remove')"
                    );
        PREPARE pstmt FROM @s;
        EXECUTE pstmt;
        DEALLOCATE PREPARE pstmt;
      END IF;  

      SET @s = CONCAT(" CALL  yp.yp_notification_remove(", QUOTE(_rid) ,"," , QUOTE(_eid), ")");
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      
      UPDATE _user_box_media SET is_checked =  1 WHERE id =_sid  AND  entity_id =_eid ; 
    END WHILE ; 

    
    SET @s = CONCAT(" CALL  permission_revoke(", QUOTE(_rid) ,",'nobody')");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;


    SELECT category from media WHERE id=_rid into _category;
    IF _category='folder' THEN
      SELECT TRIM(TRAILING '/' FROM file_path) from media WHERE id=_rid into _node_path;
      DELETE FROM media WHERE file_path LIKE concat(_node_path, '/%');
    END IF;
    DELETE FROM media WHERE id=_rid;

  END IF;

  IF _bound = '__Inbound__' THEN
     
    
    SELECT owner_id FROM yp.share_box where id =(SELECT host_id from media WHERE id = _rid ) INTO _hub_id;

    SET @s = CONCAT(" CALL sb_to_sb("
                      , QUOTE(_hub_id) ,"," 
                      , QUOTE(_rid) ,"," 
                      , QUOTE(_uid), ",null,null,null,'remove')"
                   );
    PREPARE pstmt FROM @s;
    EXECUTE pstmt;
    DEALLOCATE PREPARE pstmt;

    SET @s = CONCAT(" CALL  yp.yp_notification_remove(", QUOTE(_rid) ,"," , QUOTE(_uid), ")");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;


    SELECT category from media WHERE id=_rid into _category;
    IF _category='folder' THEN
      SELECT TRIM(TRAILING '/' FROM file_path) from media WHERE id=_rid into _node_path;
      DELETE FROM media WHERE file_path LIKE concat(_node_path, '/%');
    END IF;
    DELETE FROM media WHERE id=_rid;
      
    DELETE FROM media WHERE  parent_path =  "/__Inbound__" AND id 
    NOT IN (SELECT parent_id FROM(SELECT parent_id FROM media)a);
  
  END IF ;

 SELECT _rid as id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_delete_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_delete_node`(
  IN _id VARCHAR(16)
)
BEGIN
  DECLARE _node_path VARCHAR(255);
  DECLARE _category VARCHAR(40);
  
  SELECT category from media WHERE id=_id into _category;
  
  IF _category='folder' THEN
    SELECT CONCAT(parent_path(id),user_filename) from media WHERE id=_id into _node_path;
    DELETE FROM media  WHERE CONCAT(parent_path(id),user_filename ) LIKE concat(_node_path, '/%');
  END IF;
  DELETE FROM media WHERE id=_id;
  DELETE FROM media_stats WHERE id=_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_empty_bin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_empty_bin`(
)
BEGIN

  DECLARE _count INT(6);
  SELECT count(*) FROM media WHERE status='deleted' INTO _count;
  DELETE FROM media WHERE status='deleted' AND id=_id;
  SELECT _count AS count;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_fetch` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_fetch`(
  IN _in JSON , 
  OUT _out JSON
)
BEGIN
DECLARE _nid VARCHAR(16) ; 
  SELECT get_json_object(_in, "nid") INTO _nid;
  SELECT 
  JSON_MERGE( 
    JSON_OBJECT('origin_id',origin_id),
    JSON_OBJECT('user_filename',user_filename),
    JSON_OBJECT('category',category),
    JSON_OBJECT('extension',extension),
    JSON_OBJECT('mimetype',mimetype),
    JSON_OBJECT('filesize',filesize)    
  )
  FROM media WHERE id= _nid  INTO _out; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_file_stat` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_file_stat`(
  IN _node_id VARCHAR(16)
)
BEGIN

  DECLARE _vhost VARCHAR(255);
  DECLARE _home_id VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);

  CALL mediaEnv(_vhost, _hub_id, _area, _home_dir, _home_id, _db_name, _accessibility);

  SELECT
    media.id  AS nid,
    parent_id AS pid,
    parent_id AS parent_id,
    _hub_id AS holder_id,
    _home_id AS home_id,
    IF(media.category='hub', 
      (SELECT id FROM yp.entity WHERE entity.id=media.id), _hub_id
    ) AS oid,    
    caption,
    capability,
    IF(media.category='hub', (
      SELECT accessibility FROM yp.entity WHERE entity.id=media.id), _accessibility
    ) AS accessibility,
    IF(media.category='hub', (
      SELECT status FROM yp.entity WHERE entity.id=media.id), status
    ) AS status,
    media.extension AS ext,
    media.category AS ftype,
    media.category AS filetype,
    media.mimetype,
    download_count AS view_count,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    parent_path,
    IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
    IF(media.category='hub', (
      SELECT `name` FROM yp.hub WHERE hub.id=media.id), user_filename
    ) AS filename,
    IF(media.category='hub', (
      SELECT space FROM yp.entity WHERE entity.id=media.id), filesize
    ) AS filesize,
    firstname,
    lastname,
    remit,
    IF(media.category='hub', (
      SELECT utils.vhost(ident) FROM yp.entity WHERE entity.id=media.id), _vhost
    ) AS vhost,
    IF(media.category='hub', media.extension, _area) AS area
  FROM  media LEFT JOIN (yp.filecap, yp.drumate) ON 
  media.extension=filecap.extension AND origin_id=yp.drumate.id 
  WHERE media.id=_node_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_find` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_find`(
  IN _uid VARCHAR(512),
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _finished       INTEGER DEFAULT 0; 
  DECLARE _nid VARCHAR(16);   
  CALL pageToLimits(_page, _offset, _range);
  
   

  DROP TABLE IF EXISTS _search_node;
  CREATE TEMPORARY TABLE _search_node  AS     
  SELECT  
    m.id  as nid,
    m.extension as ext,
    m.origin_id  AS origin_id,
    m.file_path as filepath,
    COALESCE(he.id,me.id) AS hub_id,
    
    COALESCE(he.status,m.status) AS status,
    COALESCE(hh.name,m.user_filename) AS filename,
    COALESCE(me.space,m.filesize) AS filesize,
    _uid AS oid,
    ff.capability,
    IF(m.category='hub', m.extension, me.area) AS area,
    m.category as filetype,
    firstname,
    lastname,
    caption,
    upload_time as mtime,
    download_count as views,
    MATCH(`caption`,`user_filename`,`metadata`)
      against(_pattern IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION)
    + IF(MATCH(`caption`,`user_filename`,`metadata`)
      against(concat(_pattern, '*') IN BOOLEAN MODE), 30, 0)
    + IF(user_filename = _pattern, 100, 0)
    + IF(user_filename LIKE concat("%", _pattern, "%"), 27, 0) AS score
    FROM media m  
    LEFT  JOIN yp.filecap ff ON m.extension=ff.extension
    LEFT  JOIN yp.entity he ON m.id = he.id AND m.category='hub'
    LEFT  JOIN yp.hub hh ON m.id = hh.id AND m.category='hub'
    INNER JOIN yp.drumate d  ON m.origin_id=d.id 
    INNER JOIN yp.entity me  ON me.db_name=database()
    WHERE  m.status='active'
    HAVING  score > 25
     LIMIT _offset, _range;
    
    ALTER table _search_node ADD privilege  tinyint(4) unsigned ;
    ALTER table _search_node ADD expiry_time int(11) ;
    
    BEGIN
      DECLARE dbcursor CURSOR FOR SELECT  nid FROM _search_node;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
      OPEN dbcursor;
        STARTLOOP: LOOP
          FETCH dbcursor INTO _nid;
          
            IF _finished = 1 THEN 
              LEAVE STARTLOOP;
            END IF;
          
            SET @perm = 0;
            SET @s = CONCAT("SELECT user_permission (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @perm");
            PREPARE stmt FROM @s;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt; 
            
            SET @resexpiry = null;    
            SET @s = CONCAT("SELECT user_expiry (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @resexpiry");
            PREPARE stmt FROM @s;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;

            UPDATE   _search_node SET privilege = @perm ,expiry_time = @resexpiry WHERE nid = _nid;

          END LOOP STARTLOOP; 
      CLOSE dbcursor;
    END; 
    
    
    SELECT * FROM _search_node WHERE (expiry_time = 0 OR expiry_time > UNIX_TIMESTAMP())
    ORDER BY score DESC, mtime ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_get_bin_content` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_get_bin_content`(
  IN _id VARCHAR(16)
)
BEGIN
  DECLARE _node_path VARCHAR(255);
  DECLARE _category VARCHAR(40);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _uid VARCHAR(16);

  
  
  

  DECLARE _db_name VARCHAR(50);
  DECLARE _finished INTEGER DEFAULT 0;
  DECLARE _hubid VARCHAR(16);
  

  
  
  
  

 
  SELECT id, home_dir FROM yp.entity WHERE db_name=database() INTO _uid, _home_dir;

  DROP TABLE IF EXISTS  _bin_media; 
  CREATE TEMPORARY TABLE `_bin_media` (
  `id` varchar(16) DEFAULT NULL,
  `hub_root` varchar(512) DEFAULT NULL,
  `owner_id` varchar(16) DEFAULT NULL,
  `mfs_root` varchar(500) DEFAULT NULL,
  `parent_id` varchar(16) NOT NULL DEFAULT '',
  `category` enum('hub', 'web' ,'folder','link','video','image','audio','document','stylesheet','script','vector','other') NOT NULL DEFAULT 'other',
  `privilege` tinyint(2) DEFAULT NULL,
  `user_filename` varchar(128) DEFAULT NULL,
  `parent_path` varchar(1024) DEFAULT NULL,
  `bound` varchar(128) DEFAULT '__Nobound__',
  `db_name` varchar(128) DEFAULT NULL
  ); 

  IF _id IS NULL OR _id="" OR _id='0' THEN
    INSERT INTO _bin_media  
    SELECT id, 
      (SELECT home_dir FROM yp.entity y WHERE y.id=m.id) AS hub_root,
      IFNULL((SELECT owner_id FROM yp.hub y WHERE y.id=m.id),_uid) AS owner_id,
      concat(_home_dir, "/__storage__/"), 
      parent_id,
      category, 
      user_permission(_uid, m.id) AS privilege, 
      user_filename, 
      concat(_home_dir, "/__storage__/", parent_path),
      '__Nobound__',
      IF(category='hub', 
        (SELECT db_name FROM yp.entity y WHERE y.id=m.id),
      database()) AS db_name
    FROM media m WHERE 
    parent_id NOT IN (SELECT id FROM media WHERE status='deleted')
    AND m.status='deleted';
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    BEGIN
    DECLARE dbcursor CURSOR FOR  SELECT id, db_name FROM 
      yp.entity WHERE id IN(
        SELECT id FROM media WHERE category = 'hub' AND status='active'
    );
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _hubid , _db_name ;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    

        SET @sql = CONCAT("
          INSERT INTO _bin_media 
          SELECT 
            m.id,
            null as hub_root,
            null as owner_id,
            concat(e.home_dir, '/__storage__/'),
            parent_id,
            category,
            null as privilege,
            user_filename,
            concat(e.home_dir, '/__storage__/', parent_path) parent_path,
            '__Nobound__',
            " ,QUOTE(_db_name ),"
          FROM " ,_db_name ,".media m 
          INNER JOIN yp.entity e on e.id = ",QUOTE(_hubid),"  
          LEFT JOIN " ,_db_name ,".permission p on p.entity_id = ",QUOTE(_uid)," AND  p.resource_id = m.id
          WHERE 
          ( IFNULL(p.expiry_time,0) = 0 OR   IFNULL(p.expiry_time,0) > UNIX_TIMESTAMP() )
          AND parent_id NOT IN (SELECT id FROM " ,_db_name , ".media WHERE status='deleted')
          AND m.status='deleted'");
        PREPARE stmt FROM @sql ;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
      END LOOP STARTLOOP;   

    CLOSE dbcursor;
    END;
  ELSE
    INSERT INTO _bin_media 
    SELECT id, 
      (SELECT home_dir FROM yp.entity y WHERE y.id=m.id) AS hub_root,
      IFNULL((SELECT owner_id FROM yp.hub y WHERE y.id=m.id),_uid) AS owner_id,
      concat(_home_dir, "/__storage__/"),
      parent_id,
      category, 
      user_permission(_uid, _id) AS privilege, 
      user_filename, 
      concat(_home_dir, "/__storage__/", parent_path),
      null,
       IF(category='hub', 
        (SELECT db_name FROM yp.entity y WHERE y.id=m.id),
      database()) AS db_name
    FROM media m WHERE id=_id;
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    BEGIN
    DECLARE dbcursor CURSOR FOR  SELECT id, db_name FROM  yp.entity WHERE id IN(SELECT id FROM media WHERE category = 'hub' AND status='active');
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _hubid , _db_name ;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    

        SET @sql = CONCAT("
          INSERT INTO _bin_media 
          SELECT 
            m.id,
            null as hub_root,
            null as owner_id,
            concat(e.home_dir, '/__storage__/'),
            parent_id,
            category,
            null as privilege,
            user_filename,
            concat(e.home_dir, '/__storage__/', parent_path) parent_path,
            '__Nobound__',
            " ,QUOTE(_db_name ),"
          FROM " ,_db_name ,".media m 
          INNER JOIN yp.entity e on e.id = ",QUOTE(_hubid),"  
          WHERE 
          m.id =" ,QUOTE(_id) );
        PREPARE stmt FROM @sql ;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
      END LOOP STARTLOOP;   

    CLOSE dbcursor;
    END;
  END IF;
  SELECT *  FROM _bin_media;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_get_by_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_get_by_path`(
  IN _path VARCHAR(1024)
)
BEGIN
  SELECT * FROM media WHERE file_path=clean_path(_path);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_get_dmz_link` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_get_dmz_link`( 
   IN _src_id VARCHAR(16),
   IN _uid VARCHAR(16)
)
BEGIN
DECLARE _rid VARCHAR(16);
DECLARE _eid VARCHAR(16);
DECLARE _vhost VARCHAR(255);
  
  SELECT m.id ,p.entity_id 
  FROM permission p 
  INNER JOIN media m ON 
    m.id = p.resource_id 
  WHERE m.id =_src_id 
    AND p.entity_id = _uid
    AND p.assign_via='link' 
    INTO _rid,_eid ;

  SELECT 
    d.firstname,
    d.lastname,
    d.email,
    _rid AS nid,
    _eid AS entity_id
  FROM yp.entity e
  INNER JOIN yp.hub sb on sb.id = e.id
  INNER JOIN yp.drumate d on d.id = sb.owner_id
  WHERE e.db_name= DATABASE() AND _rid IS NOT NULL AND _eid IS NOT NULL ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_get_filenames` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_get_filenames`(
  IN _pid VARCHAR(16)
)
BEGIN
  select id, user_filename `filename` FROM media WHERE parent_id=_pid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_get_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_get_path`(
  IN _id VARCHAR(16)
)
    DETERMINISTIC
BEGIN
  DECLARE _nid VARCHAR(16);
  DECLARE _pid VARCHAR(16);
  DECLARE _fname VARCHAR(255);
  DECLARE _ppath VARCHAR(600);
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);
  DECLARE _ext varchar(50);  
 
  

  
  

  SELECT e.id, e.area, e.home_dir, m.id, e.db_name, e.accessibility from media m 
    INNER JOIN yp.entity e  ON e.db_name=database()
    WHERE parent_id='0' 
    INTO _hub_id, _area, _home_dir, _home_id, _db_name, _accessibility;

  DROP TABLE IF EXISTS  __media_path;  
  CREATE TEMPORARY TABLE `__media_path` (
    home_id varchar(16) DEFAULT NULL,
    nid varchar(16) DEFAULT NULL, 
    pid varchar(16) DEFAULT NULL, 
    filename varchar(1024) DEFAULT NULL, 
    parent_path varchar(1024) DEFAULT NULL,
    ext varchar(50) DEFAULT NULL,  
    area varchar(50) DEFAULT NULL
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;   

  SELECT m.id, m.parent_id, m.user_filename, m.parent_path,
    m.extension AS ext,
    IF(m.category='hub', m.extension, me.area)
    FROM media m
    INNER JOIN yp.entity me  ON me.db_name=database()
    WHERE m.id=_id INTO _nid, _pid, _fname, _ppath, _ext,_area;
  INSERT INTO __media_path 
    SELECT _home_id, _nid, _pid, _fname, _ppath,_ext,_area FROM media WHERE id=_id;
  WHILE _pid != "0" DO
    SELECT m.id, m.parent_id, m.user_filename, m.parent_path,
    m.extension AS ext,
    IF(m.category='hub', m.extension, me.area)
    FROM media m  
    INNER JOIN yp.entity me  ON me.db_name=database()
    WHERE m.id=_pid INTO _nid, _pid, _fname, _ppath, _ext,_area ;
    INSERT INTO __media_path SELECT _home_id, _nid, _pid, _fname, _ppath,_ext,_area;
  END WHILE;


  
  

  SELECT * FROM __media_path;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_home` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_home`(
)
BEGIN
  DECLARE _area VARCHAR(25);
  DECLARE _vhost VARCHAR(255);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _name VARCHAR(500);
  DECLARE _type VARCHAR(50);
  DECLARE _home_id VARCHAR(16); 
  DECLARE _chat_upload_id VARCHAR(16); 
  DECLARE _chat_id VARCHAR(16); 
  DECLARE _memberload_id VARCHAR(16);
  DECLARE _ticket_id VARCHAR(16); 
  SELECT id  FROM media WHERE parent_id='0' INTO _home_id;
  SELECT node_id_from_path('/__chat__/__upload__') INTO _chat_upload_id;
  SELECT node_id_from_path('/__chat__/') INTO _chat_id;
  SELECT node_id_from_path('/__ticket__/') INTO _ticket_id;
  
  
  SELECT name, `type` FROM yp.entity  INNER JOIN yp.hub 
    USING(id) WHERE db_name=database()  INTO _name, _type;

  IF _type IS NULL THEN 
    SELECT CONCAT(firstname, ' ', lastname) FROM yp.entity INNER JOIN yp.drumate 
    USING(id) WHERE db_name=database() INTO _name;
  END IF;

  SELECT utils.vhost(id) vhost, 
    id AS hub_id, 
    area, 
    home_dir, 
    _name AS `name`,
    _home_id AS home_id,
    _chat_upload_id chat_upload_id,
    _chat_id  chat_id,
    _ticket_id ticket_id
    
    FROM yp.entity WHERE db_name=database();
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_hub_chat_init` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_hub_chat_init`()
BEGIN
 
  SELECT node_id_from_path('/__chat__') INTO @temp_chat_id;

  IF @temp_chat_id IS NULL THEN 
    call mfs_make_dir("0", JSON_ARRAY('__chat__'), 0);
    UPDATE media SET status='hidden' where file_path='/__chat__.folder';
  END IF;
  
  SELECT node_id_from_path('/__chat__') INTO @temp_chat_id;
  SELECT node_id_from_path('/__chat__/__upload__') INTO @temp_upload_id;

 
  IF @temp_upload_id IS NULL THEN 
    CALL mfs_make_dir(@temp_chat_id, JSON_ARRAY("__upload__"), 0);
    UPDATE media set status='hidden' where file_path='/__chat__/__upload__.folder';
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_init_folders` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_init_folders`(
  IN _folders JSON,
  IN _clear_existing boolean
)
BEGIN
  DECLARE _i INT(4) DEFAULT 0; 
  DECLARE _pid VARCHAR(16);
  DECLARE _home_id VARCHAR(16);
  DECLARE _uid VARCHAR(16);
  DECLARE _status VARCHAR(16);
  DECLARE _path TEXT;
  IF _clear_existing THEN 
    SELECT id FROM media WHERE parent_id='0' INTO _home_id;
    DELETE FROM media WHERE status='active' AND parent_id=_home_id;
    SELECT id FROM yp.entity WHERE db_name=database() INTO _uid;
    UPDATE media SET origin_id=_uid;
  END IF;
  WHILE _i < JSON_LENGTH(_folders) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_folders, CONCAT("$[", _i, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.path")) INTO _path;
    SELECT TRIM(TRAILING '/' FROM TRIM(LEADING '/' FROM _path)) INTO _path;
    SELECT IFNULL(JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.pid")), _home_id) INTO _pid;
    SELECT IFNULL(JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.status")), 'active') INTO _status;
    CALL mfs_make_dir(_pid, JSON_ARRAY(_path), 0);
    UPDATE media SET status=_status WHERE file_path=CONCAT('/', _path, '.folder');
    SELECT _i + 1 INTO _i;
  END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_list_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_list_all`(
  IN _node_id VARCHAR(16),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);

  CALL pageToLimits(_page, _offset, _range);
  CALL mediaEnv(_vhost, _hub_id, _area, _home_dir, _home_id, _db_name, _accessibility);

  SELECT
    media.id  AS nid,
    parent_id AS pid,
    parent_id AS parent_id,
    _hub_id AS holder_id,
    _home_id AS home_id,
    IF(media.category='hub', 
      (SELECT id FROM yp.entity WHERE entity.id=media.id), _hub_id
    ) AS oid,    
    caption,
    capability,
    IF(media.category='hub', (
      SELECT accessibility FROM yp.entity WHERE entity.id=media.id), _accessibility
    ) AS accessibility,
    IF(media.category='hub', (
      SELECT status FROM yp.entity WHERE entity.id=media.id), status
    ) AS status,
    media.extension AS ext,
    media.category AS ftype,
    media.category AS filetype,
    media.mimetype,
    download_count AS view_count,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    parent_path,
    IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
    IF(media.category='hub', (
      SELECT `name` FROM yp.hub WHERE hub.id=media.id), user_filename
    ) AS filename,
    IF(media.category='hub', (
      SELECT space FROM yp.entity WHERE entity.id=media.id), filesize
    ) AS filesize,
    firstname,
    lastname,
    remit,
    IF(media.category='hub', (
      SELECT utils.vhost(ident) FROM yp.entity WHERE entity.id=media.id), _vhost
    ) AS vhost,    
    
    
    
    _page as page,
    IF(media.category='hub', media.extension, _area) AS area
  FROM  media LEFT JOIN (yp.filecap, yp.drumate) ON 
  media.extension=filecap.extension AND origin_id=yp.drumate.id 
  WHERE parent_id=_node_id AND status='active'
  ORDER BY ctime DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_list_by` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_list_by`(
  IN _cat VARCHAR(32),
  IN _pid VARCHAR(16),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);

  CALL pageToLimits(_page, _offset, _range);

  SELECT
    m.id  AS nid,
    parent_id AS pid,
    parent_id AS parent_id,
    origin_id AS gid,
    file_path,
    capability,
    m.status AS status,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    m.mimetype,
    download_count AS view_count,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    user_filename AS filename,
    parent_path,
    filesize,
    firstname,
    lastname,
    remit,
    _page as page,
    me.area,
    me.id as hub_id,
    me.home_id,
    COALESCE(vv.fqdn, v.fqdn) AS vhost
  FROM  media m 
    INNER JOIN yp.entity me  ON me.db_name=database()
    LEFT JOIN yp.filecap f ON m.extension=f.extension
    LEFT JOIN yp.drumate dr ON origin_id=dr.id 
    LEFT JOIN yp.vhost v ON  v.id=me.id
    LEFT JOIN yp.vhost vv ON  vv.id=m.id

  WHERE m.category=_cat AND parent_id=_pid 
  ORDER BY ctime DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_list_dir` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_list_dir`(
  IN _node_id VARCHAR(16),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    media.id  AS nid,
    parent_id AS pid,
    parent_id AS parent_id,
    origin_id AS gid,
    caption,
    media.status AS status,
    extension AS ext,
    media.category AS ftype,
    media.category AS filetype,
    mimetype,
    download_count AS view_count,
    IF(parent_id='0', 'root', 'branch') as npos,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    user_filename AS filename,
    parent_path,
    IF(parent_path='' or parent_path is NULL , '/', parent_path) AS user_path,
    file_path,
    filesize,
    firstname,
    lastname,
    gender,
    remit,
    _page as page,
    concat(@root, file_path) AS file_path,
    @area as area
  FROM media inner join yp.drumate on origin_id=drumate.id WHERE parent_id=_node_id AND media.category='folder'
  ORDER BY ctime DESC LIMIT _offset, _range;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_log_stats` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_log_stats`(
  IN _nid VARCHAR(16),
  IN _uid VARCHAR(16),
  IN _sid VARCHAR(128)
)
BEGIN
  DECLARE _oid  VARCHAR(16) DEFAULT NULL;
  SELECT owner_id FROM media WHERE id=_nid INTO _oid;
  IF _oid != _uid THEN 
    INSERT INTO media_stats VALUES(null, _nid, _uid, _sid, UNIX_TIMESTAMP());
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_make_dir` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_make_dir`(
  IN _pid TEXT,
  IN _rel_path JSON,
  IN _show_results  BOOLEAN
)
BEGIN

  DECLARE _idx INT(4) DEFAULT 0;
  DECLARE _parent_path TEXT DEFAULT '/'; 
  DECLARE _file_name VARCHAR(80);
  DECLARE _file_path TEXT DEFAULT NULL;
  DECLARE _temp_nid  VARCHAR(16);
  DECLARE _parent_id  VARCHAR(16);
  DECLARE _nid  VARCHAR(16) DEFAULT null;

  DECLARE _hub_id VARCHAR(16);
  DECLARE _home_id VARCHAR(16);


  

  SELECT id FROM media WHERE parent_id='0' INTO _home_id;



  IF _pid REGEXP "^/" THEN 
    SELECT id, file_path FROM media WHERE file_path=clean_path(_pid) INTO _pid, _file_path;
  END IF; 

  IF _file_path IS NULL THEN 
    SELECT REPLACE(file_path, '.folder', '') FROM media WHERE id = _pid INTO _file_path;
  END IF; 

  IF _file_path IS NULL THEN 
    SELECT _home_id, '' INTO _parent_id, _file_path;
  ELSE 
    SELECT _pid INTO _parent_id;
  END IF;

  
  WHILE _idx < JSON_LENGTH(_rel_path) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_rel_path, CONCAT("$[", _idx, "]"))) INTO _file_name;
    
    SELECT _file_path INTO _parent_path;
    SELECT clean_path(CONCAT(_file_path, '/', _file_name)) INTO _file_path;

    
    SELECT id FROM media WHERE file_path = clean_path(CONCAT(_file_path, '.folder')) INTO _nid;
    
    SELECT _idx + 1 INTO _idx;
    IF _nid IS NULL THEN
      SELECT yp.uniqueId() INTO _temp_nid;
      INSERT INTO `media` (
        id, 
        origin_id, 

        file_path, 
        user_filename, 
        parent_id, 
        parent_path,

        extension, 
        mimetype, 
        category,
        isalink,

        filesize, 
        `geometry`, 
        publish_time, 
        upload_time, 

        `status`,
        rank
      ) VALUES (
        _temp_nid,
        _hub_id, 

        CONCAT(_file_path, '.folder'), 
        TRIM('/' FROM _file_name),
        _parent_id, 
        _parent_path,

        'folder', 
        'folder', 
        'folder', 
        0,

        4096,
        '0x0', 
        UNIX_TIMESTAMP(), 
        UNIX_TIMESTAMP(), 

        'active',
        0
      );
      SELECT _temp_nid INTO _parent_id;
    ELSE 
      SELECT id, parent_path, REPLACE(file_path, '.folder', '') FROM media WHERE id = _nid 
        INTO _parent_id, _parent_path, _file_path;
      SELECT _nid INTO _temp_nid;
      SELECT null INTO _nid;
    END IF;
    
  END WHILE;

  IF IFNULL(_show_results, 1) = 1  THEN
    CALL mfs_node_attr(_temp_nid);
  END IF;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_mark_as_seen` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_mark_as_seen`(
  IN _id     VARCHAR(16),
  IN _uid    VARCHAR(16),
  IN _show_results BOOLEAN
)
BEGIN
  DECLARE _md JSON;
  DECLARE _seen INT(11) DEFAULT NULL;
  SELECT metadata FROM media WHERE id=_id INTO _md;
  IF _md IS NULL THEN 
    UPDATE media SET metadata=JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP())) WHERE id=_id;
  END IF;
  SELECT metadata FROM media WHERE id=_id INTO _md;
  IF NOT JSON_EXISTS(_md, CONCAT("$._seen_.", _uid)) THEN 
    UPDATE media SET metadata=JSON_MERGE(metadata, JSON_OBJECT('_seen_', JSON_OBJECT(_uid, UNIX_TIMESTAMP()))) WHERE id=_id;
  ELSE 
    UPDATE media SET metadata=JSON_REPLACE(metadata, CONCAT("$._seen_.", _uid), UNIX_TIMESTAMP()) WHERE id=_id;
  END IF;
  IF _show_results THEN 
    SELECT metadata FROM media WHERE id=_id;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_media_replace` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_media_replace`(
  IN _origin_id       VARCHAR(16),
  IN _id              VARBINARY(16),
  IN _user_filename   VARCHAR(80),
  IN _category        VARCHAR(50),
  IN _extension       VARCHAR(100),
  IN _mimetype        VARCHAR(100),
  IN _filesize        INT(11) UNSIGNED,
  IN _geometry        VARCHAR(200),
  IN _metadata        VARCHAR(1024),
  IN _caption         VARCHAR(1024)
)
BEGIN
  DECLARE _ts   INT(11) DEFAULT 0;

  SELECT UNIX_TIMESTAMP() INTO _ts;
  UPDATE media SET 
    origin_id     = _origin_id,
    user_filename = _user_filename,
    category      = _category,
    extension     = _extension,
    mimetype      = _mimetype,
    filesize      = _filesize,
    geometry      = _geometry,
    metadata      = _metadata,
    caption       = _caption,
    upload_time   = _ts
  WHERE id = _id;

  SELECT 
    id, 
    origin_id, 
    parent_id,
    file_path, 
    user_filename,
    parent_path, extension, mimetype, category, isalink, filesize,
    geometry, publish_time, upload_time, last_download, download_count,
    metadata, caption, status, approval FROM media WHERE id = _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_memberload_init` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_memberload_init`()
BEGIN

 SELECT node_id_from_path('/__memberload__') INTO @temp_chat_id;
 IF @temp_chat_id IS NULL THEN 
    call mfs_make_dir("0", JSON_ARRAY('__memberload__'), 0);
    UPDATE media SET status='hidden' where file_path='/__memberload__.folder';
 END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_merge_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_merge_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
  DECLARE _src_db VARCHAR(255);
  DECLARE _des_db VARCHAR(255); 


  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _src_path       VARCHAR(1024); 
  DECLARE _des_path       VARCHAR(1024); 
  DECLARE _file_name      VARCHAR(512); 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50); 
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _seq            INTEGER;  
  DECLARE _id             VARCHAR(16);  

  
  SELECT  database() INTO _src_db;  
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _des_db;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_src_db ,".parent_path(id),user_filename, '/') FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;


   SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename, '/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @descpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;  


  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename) FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @despath ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SELECT  clean_path(@srcpattern) INTO @srcpattern; 
  SELECT  clean_path(@despath) INTO @srcpath; 
  SELECT  clean_path(@descpattern) INTO @descpattern;   
  
    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT ''  ,
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' , 
      `is_checked` boolean default 0 ,
       lvl int(3),
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
    DROP TABLE IF EXISTS _des_media;
    CREATE TEMPORARY TABLE `_des_media` (
      
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT '' 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
   

  SET @sql = CONCAT(" 
    INSERT INTO _src_media 
    SELECT null, id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    clean_path(CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'.', extension )) xpath     
    ,null,null,0,0
    FROM  " ,_src_db ,".media m 
    WHERE   m.category <> 'hub' AND CONCAT(" ,_src_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@srcpattern,'%') ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @sql = CONCAT(" 
    INSERT INTO _des_media
    SELECT  id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    clean_path(REPLACE (clean_path(CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'.',extension )),@despath,'' )) xpath 
    FROM  " ,_des_db ,".media m      	
    WHERE id <> ", QUOTE( _pid) ,"
    AND CONCAT(" ,_des_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@descpattern,'%')");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;  

 UPDATE _src_media SET new_parent_id = _pid where id = _nid; 

 UPDATE _src_media s , _des_media d SET s.new_parent_id = d.parent_id , s.new_id=d.id
 WHERE  s.xpath = d.xpath;

 DROP TABLE IF EXISTS _src_temp_media;
 CREATE TABLE _src_temp_media as SELECT * FROM _src_media;

 UPDATE _src_media s , _src_temp_media d SET s.new_parent_id = d.new_id  WHERE  s.parent_id = d.id;

 UPDATE _src_media set lvl= (LENGTH(xpath)-LENGTH(REPLACE(xpath, '/', '')));

 BEGIN
    DECLARE dbcursor CURSOR FOR SELECT seq,id,origin_id,user_filename,category,extension,mimetype,`geometry`,filesize FROM _src_media WHERE new_id is null order by lvl asc;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
        STARTLOOP: LOOP
         FETCH dbcursor INTO _seq,_id,_origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;


    
        SET @s1 = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_des_db,".__register_stack LIKE template.tmp_media"); 
        PREPARE stmt FROM @s1;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

        SET @s1 = CONCAT( "DELETE FROM ",_des_db,".__register_stack"); 
        PREPARE stmt1 FROM @s1;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
        
        SELECT new_parent_id  FROM _src_media WHERE seq =_seq INTO _pid; 

        SET @s2 = CONCAT("CALL ",_des_db,".mfs_register(",
            "'"  , _origin_id     , "'," ,
            "'"  , _file_name     , "'," ,
            "'"  , _pid           , "'," ,
            "'"  , _category      , "'," ,
            "'"  , _extension     , "'," ,
            "'"  , _mimetype      , "'," ,
            "'"  , _geometry      , "'," ,
                   _file_size     , ", 0 )"          
          );
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;  

        SET @s3 = CONCAT( "SELECT id ,parent_id FROM ",_des_db,".__register_stack INTO @temp_nid,@pid");
        PREPARE stmt3 FROM @s3;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;

        UPDATE _src_media SET new_id =@temp_nid , new_parent_id = @pid  WHERE seq =_seq ; 
        UPDATE _src_media SET new_parent_id =  @temp_nid    WHERE parent_id = _id; 
    END LOOP STARTLOOP;
   CLOSE dbcursor; 

 END;   

  

  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      new_id varchar(16) DEFAULT NULL,    
      action varchar(16) DEFAULT NULL,
      mfs_root varchar(1024)  DEFAULT NULL
      );   
        
 
  INSERT INTO   _final_media  
  SELECT new_id AS nid ,new_id AS dest_id, 'show'   AS action, null as mfs_root  FROM _src_media WHERE seq = 1 ;

  INSERT INTO   _final_media
  SELECT id   AS nid ,new_id AS dest_id, 'copy'   AS action, null as mfs_root  FROM _src_media WHERE category NOT IN ("folder","hub");

  SELECT * FROM  _final_media;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_move`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16)
)
BEGIN
  DECLARE _src_type VARCHAR(100);
  DECLARE _des_type VARCHAR(100);
  DECLARE _file_name VARCHAR(1024);
  DECLARE _file_path VARCHAR(1024);
  DECLARE _extension VARCHAR(100);
  DECLARE _parent_name VARCHAR(1024);
  DECLARE _parent_path VARCHAR(1024);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _src_db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);

  SELECT COUNT(*) FROM media WHERE parent_id = _pid INTO @_count;
  SELECT category, TRIM('/' FROM user_filename) FROM media 
    WHERE id=_pid INTO _des_type, _parent_name;

  SELECT TRIM('/' FROM user_filename), category, extension FROM media WHERE id=_nid 
    INTO _file_name, _src_type, _extension;

  SELECT e.id, e.area, e.home_dir, m.id, e.db_name, e.accessibility from media m 
    INNER JOIN yp.entity e  ON e.db_name=database()
    WHERE parent_id='0' 
    INTO _hub_id, _area, _home_dir, _home_id, _src_db_name, _accessibility;

  
  

  IF _des_type='folder' THEN   
    SELECT clean_path(parent_path(_pid)) INTO _parent_path;
    SELECT unique_filename(_pid, _file_name, _extension) INTO _file_name;
    SELECT clean_path(CONCAT(
      _parent_path, '/', _parent_name, '/', _file_name, '.', _extension
      ))INTO _file_path;

    SELECT REPLACE(file_path, CONCAT('.', extension), "/%")
      FROM media WHERE id=_nid INTO @_src_pattern;
    SELECT REPLACE(file_path, CONCAT('.', extension), "/%")
      FROM media WHERE id=_pid INTO @_des_pattern;

    UPDATE media SET parent_id = _pid , rank=@_count WHERE id = _nid;
    UPDATE media SET parent_path = parent_path(_nid) WHERE id = _nid;
    UPDATE media SET file_path = CONCAT(parent_path, '/', user_filename, '.', extension) 
      WHERE id = _nid;
    IF _src_type='folder' THEN
      UPDATE media m SET parent_path=parent_path(m.id) WHERE file_path LIKE @_src_pattern;
      UPDATE media m set file_path=concat(parent_path, '/', m.user_filename, '.', extension)
        WHERE file_path LIKE @_des_pattern;
    END IF;
    IF _src_type='hub' THEN
      SELECT area FROM yp.entity WHERE id = _nid INTO _area;
    END IF;
  END IF;

  SELECT 
    m.id, 
    m.id as nid, 
    concat(_home_dir, "/__storage__/") AS mfs_root,
    parent_id AS pid,
    parent_id,
    _hub_id AS holder_id,
    _home_id AS home_id,
    _home_dir AS home_dir,
    @perm  AS privilege,
    _hub_id AS owner_id,    
    _hub_id AS hub_id,    
    yp.vhost(_hub_id) AS vhost,    
    _area AS area,
    _accessibility AS accessibility,
    user_filename AS filename,
    filesize,
    caption,
    capability,
    m.extension,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    m.mimetype,
    download_count AS view_count,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    firstname,
    lastname,
    m.category,
    user_filename,
    file_path, 
    parent_path
    FROM media m LEFT JOIN (yp.filecap, yp.drumate) ON 
    m.extension=filecap.extension AND origin_id=yp.drumate.id 
  WHERE m.id = _nid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_move_all`(
  IN _nodes JSON,
  IN _uid VARCHAR(16),
  IN _dest_id VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
  DECLARE _idx INT(4) DEFAULT 0; 
  DECLARE _nid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(40);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _dest_db VARCHAR(50);
  DECLARE _dest_home_dir VARCHAR(512);
  DECLARE _temp_nid  VARCHAR(16);
  


  DECLARE _is_root tinyint(2) ;
  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _file_name      VARCHAR(512); 
  DECLARE _metadata       JSON; 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50); 
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _seq            INTEGER;  
  DECLARE _id             VARCHAR(16);   
  DECLARE _new_parent_id  VARCHAR(16);  



  SELECT db_name, home_dir FROM yp.entity WHERE id=_recipient_id  
    INTO _dest_db, _dest_home_dir;

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `is_root` boolean default 0 ,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `owner_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `metadata` JSON,
      `status`  varchar(20) ,
      `category` VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT null,
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' ,
      `is_checked` boolean default 0 ,
       home_dir VARCHAR(512) DEFAULT null,
       db_name VARCHAR(512) DEFAULT null,
       hub_id VARCHAR(16) DEFAULT null,
    
       permission   tinyint(4) unsigned , 
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;


  DROP TABLE IF EXISTS _final_media; 
  CREATE TEMPORARY TABLE `_final_media` (
    nid varchar(16) DEFAULT NULL,  
    category varchar(50) DEFAULT NULL,  
    src_mfs_root varchar(1024) DEFAULT NULL,  
    src_db varchar(160) DEFAULT NULL,  
    des_id varchar(16) DEFAULT NULL,  
    des_mfs_root varchar(1024) DEFAULT NULL,  
    des_db varchar(160) DEFAULT NULL,  
    `type` varchar(10) DEFAULT 'cross' ,
    action varchar(16) DEFAULT NULL
  );


  
  SET @st = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",
    _dest_db,".__register_stack LIKE template.__register_stack"
  ); 
  PREPARE stmt FROM @st;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  
  

  WHILE _idx < JSON_LENGTH(_nodes) DO 
    DELETE FROM _src_media;
    
    SELECT get_json_array(_nodes, _idx) INTO @_node;
    SELECT get_json_object(@_node, "nid") INTO _nid;
    SELECT get_json_object(@_node, "hub_id") INTO _hub_id;

    SELECT db_name, home_dir FROM yp.entity WHERE id=_hub_id INTO _hub_db, _home_dir;
    
    IF _hub_id = _recipient_id   THEN

      SET @st = CONCAT("UPDATE ", _hub_db, ".media SET file_path=?, parent_id=? WHERE id =?");
      PREPARE stmt3 FROM @st;
      EXECUTE stmt3 USING _nid, _dest_id, _nid;
      DEALLOCATE PREPARE stmt3;


      SET @st = CONCAT("UPDATE ", _hub_db,
      ".media SET parent_path=", _hub_db,".parent_path(?) WHERE id=?"
      );
      PREPARE stmt3 FROM @st;
      EXECUTE stmt3 USING _nid, _nid;
      DEALLOCATE PREPARE stmt3;

      SET @st = CONCAT("UPDATE ", _hub_db,
      ".media SET file_path =clean_path(concat(parent_path, '/', user_filename, '.', id)) WHERE id =?"
      );
      PREPARE stmt3 FROM @st;
      EXECUTE stmt3 USING _nid;
      DEALLOCATE PREPARE stmt3;


      INSERT INTO _final_media (nid, category, src_db, des_db, `action`, `type`)
      SELECT _nid, NULL, _hub_db, _hub_db, 'show','same' ;


    ELSE 
      
      SET @st = CONCAT( "INSERT INTO _src_media SELECT 
      null, 1, id, origin_id, ?, user_filename, metadata,status, category, parent_id,  
      extension, mimetype, filesize, geometry, null, null, 0, ?, ?, ? ,0
      FROM ", _hub_db ,".media m  WHERE  m.id =?");  
      PREPARE stmt FROM @st;
      EXECUTE stmt USING _uid, _home_dir, _hub_db, _hub_id, _nid;
      DEALLOCATE PREPARE stmt;

      UPDATE _src_media SET new_parent_id = _dest_id  WHERE  id=_nid; 
      SELECT id FROM _src_media WHERE id = _nid INTO _temp_nid ;
    END IF ;

    WHILE _temp_nid IS NOT NULL DO
       
      SELECT seq, id, origin_id, user_filename, metadata,`status`, category,
        extension, mimetype, `geometry`, filesize, new_parent_id, is_root
      FROM _src_media WHERE id =_temp_nid 
      INTO _seq,_id, _origin_id, _file_name, _metadata,_status, _category,
        _extension, _mimetype, _geometry, _file_size, _new_parent_id, _is_root;        
     

      IF _category = 'hub' THEN
        
        IF _hub_id = _recipient_id   THEN
        
          SET @st = CONCAT("UPDATE ", _hub_db, ".media SET file_path=?, parent_id=? WHERE id =?");
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3 USING _temp_nid, _new_parent_id, _temp_nid;
          DEALLOCATE PREPARE stmt3;

          SET @st = CONCAT("UPDATE ", _hub_db,
            ".media SET parent_path=", _hub_db,".parent_path(?) WHERE id=?"
          );
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3 USING _temp_nid, _temp_nid;
          DEALLOCATE PREPARE stmt3;

          SET @st = CONCAT("UPDATE ", _hub_db,
            ".media SET file_path =clean_path(concat(parent_path, '/', user_filename, '.', id)) WHERE id =?"
          );
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3 USING _temp_nid;
          DEALLOCATE PREPARE stmt3;

        END IF;
      
        IF _hub_id <> _recipient_id AND _is_root = 0  THEN
          SET @st = CONCAT( "UPDATE ",_hub_db,
            ".media m , (SELECT id FROM ",_hub_db,".media WHERE  parent_id = '0') p SET 
            m.parent_id =p.id,
            m.parent_path ='/',
            m.file_path =  clean_path(CONCAT('/', m.user_filename, '.', m.id))
            WHERE m.id =?");
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3 USING _temp_nid;
          DEALLOCATE PREPARE stmt3;
        END IF;

      ELSE 
        
        IF _category = 'folder' THEN
          SET @st = CONCAT( "INSERT INTO _src_media SELECT 
          null, 0, id, origin_id, ?, user_filename, metadata,status, category, parent_id, extension, 
          mimetype, filesize, geometry, null, null, 0, ?, ?, ?, 0 
          FROM ", _hub_db ,".media m WHERE m.parent_id =?");  
          PREPARE stmt FROM @st;
          EXECUTE stmt USING _uid, _home_dir, _hub_db, _hub_id, _temp_nid;
          DEALLOCATE PREPARE stmt; 
        END IF ;

        SET @st = CONCAT( "DELETE FROM ",_hub_db,".media WHERE category <> 'hub' AND id=?");
        PREPARE stmt3 FROM @st;
        EXECUTE stmt3 USING _temp_nid;
        DEALLOCATE PREPARE stmt3;


        SET @st = CONCAT( "DELETE FROM ",_dest_db,".__register_stack"); 
        PREPARE stmt1 FROM @st;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;

        SET @st = CONCAT("CALL ", _dest_db, ".mfs_new_node(?,?,?,?,?,?,?,?,?,?)");
        PREPARE stmt2 FROM @st;
        EXECUTE stmt2 USING 
          _origin_id     ,
          _uid           ,
          _file_name     ,
          _new_parent_id ,
          _category      ,
          _extension     ,
          _mimetype      ,
          _geometry      ,
          _file_size     , 
          0;           
        DEALLOCATE PREPARE stmt2;

        SET @st = CONCAT( "SELECT id, parent_id FROM ",_dest_db,".__register_stack INTO @temp_nid, @pid");
        PREPARE stmt3 FROM @st;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;   

        SET @st = CONCAT( "UPDATE ",_dest_db,".media SET metadata=?,status=? WHERE id=?");
        PREPARE stmt3 FROM @st;
        EXECUTE stmt3 USING _metadata, _status, @temp_nid;
        DEALLOCATE PREPARE stmt3;   

        UPDATE _src_media SET new_id =@temp_nid  WHERE seq =_seq ; 
        UPDATE _src_media SET new_parent_id =  @temp_nid WHERE parent_id = _temp_nid; 
      END IF;

        
      UPDATE _src_media SET is_checked = 1 WHERE id = _temp_nid ;
      SELECT NULL,NULL,NULL INTO _temp_nid, @temp_nid, @pid;
      SELECT id FROM _src_media WHERE is_checked =0 AND new_parent_id IS NOT NULL LIMIT 1 INTO _temp_nid ;

    END WHILE;
    

    INSERT INTO _final_media (nid, category, src_db, des_db, `action`)
      SELECT IFNULL(new_id,id), category, _hub_db, _dest_db, 'showone' 
      FROM _src_media WHERE seq=1; 

    INSERT INTO _final_media (nid, category, src_db, des_db, `action`)
      SELECT IFNULL(new_id,id), category, _hub_db, _dest_db, 'show' 
      FROM _src_media WHERE is_root=1;

    INSERT INTO _final_media (nid, category, src_mfs_root, des_id, des_mfs_root, `action`)
      SELECT id, category, CONCAT(home_dir, "/__storage__/"), new_id, CONCAT(_dest_home_dir, "/__storage__/"), 'copy'  
      FROM _src_media WHERE category NOT IN ("folder","hub") ; 

    INSERT INTO _final_media (nid, category, src_mfs_root,  `action`)
      SELECT id, category, CONCAT(home_dir, "/__storage__/") , 'delete' 
      FROM _src_media WHERE category NOT IN ("folder","hub") ;  
 

    SELECT _idx + 1 INTO _idx;
  END WHILE;
  SELECT * FROM _final_media;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_merge_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_move_merge_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
  DECLARE _src_db VARCHAR(255);
  DECLARE _des_db VARCHAR(255); 
  DECLARE _src_root_id  VARCHAR(16);
  DECLARE _cross_hub  INT;

  
  SELECT  database() INTO _src_db;  
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _des_db;
  
  SELECT  0 INTO _cross_hub;
  SELECT CASE WHEN _src_db <> _des_db THEN 1 ELSE 0 END INTO _cross_hub;


  SELECT NULL ,NULL ,NULL ,NULL,NULL  INTO  @srcfilename ,@srcpattern,@srcpath ,@descpattern,@despath;


  SET @sql = CONCAT( 
    "SELECT user_filename FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcfilename ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_src_db ,".parent_path(id),user_filename, '/') FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_src_db ,".parent_path(id),'/',user_filename,'/') FROM " ,_src_db ,".media WHERE  id=
    ( SELECT parent_id FROM " ,_src_db ,".media
     WHERE id =" ,QUOTE( _nid),
    ") INTO @srcpath ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename, '/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @descpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;  

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @despath ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;


  SELECT  clean_path(@srcpattern) INTO @srcpattern;
  SELECT  clean_path(@descpattern) INTO @descpattern; 
  SELECT  clean_path(@srcpath) INTO @srcpath; 
  SELECT  clean_path(@despath) INTO @despath;
  
  


  DROP TABLE IF EXISTS  _src_media;
  CREATE TEMPORARY TABLE `_src_media` (
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT '' ,
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' 
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    DROP TABLE IF EXISTS _des_media;
    CREATE TEMPORARY TABLE `_des_media` (
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT '' 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;



  SET @sql = CONCAT(" 
    INSERT INTO _src_media 
    SELECT id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    TRIM(LEADING @srcpath  FROM clean_path(CONCAT(" ,_src_db ,".parent_path(id),'/',user_filename,'.',extension ))) xpath,NULL,NULL
    FROM  " ,_src_db ,".media m 
    WHERE  CONCAT(" ,_src_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@srcpattern,'%') ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  
  SET @sql = CONCAT(" 
    INSERT INTO _des_media
    SELECT  id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    TRIM(LEADING @despath  FROM clean_path(CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'.',extension ))) xpath
    FROM  " ,_des_db ,".media m      	
    WHERE id <> ", QUOTE( _pid) ,"
    AND CONCAT(" ,_des_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@descpattern,@srcfilename,'/','%')");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  UPDATE _src_media SET new_parent_id = _pid  WHERE id=_nid;
  UPDATE _src_media s,_des_media d SET s.new_parent_id = d.parent_id , s.new_id=d.id WHERE  s.xpath = d.xpath;
  DROP TABLE IF EXISTS _src_temp_media;
  CREATE TABLE _src_temp_media as SELECT * FROM _src_media;
  UPDATE _src_media s , _src_temp_media d SET s.new_parent_id = d.new_id  WHERE  s.parent_id = d.id;

  
  

  SELECT id FROM media WHERE parent_id = '0' INTO _src_root_id;
  UPDATE media SET parent_id = _src_root_id WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  UPDATE media SET parent_path = parent_path(id) WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  UPDATE media SET file_path = CONCAT(parent_path, '/', user_filename, '.', extension) WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  

  SET @sql = CONCAT( "DELETE FROM _src_media WHERE id in (SELECT id from _des_media) ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;  

  SET @sql = CONCAT( "DELETE FROM ",_src_db,".media WHERE id in (SELECT id from _src_media where  category <> 'hub' ) ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @sql = CONCAT( 
    'INSERT INTO ',_des_db,'.media (
    id,origin_id,user_filename,category,parent_id,parent_path, file_path,extension,mimetype,filesize,geometry,publish_time,upload_time,status,rank)
    SELECT IFNULL(new_id,id),origin_id,user_filename,category,IFNULL(new_parent_id,parent_id), IFNULL(new_id,id), IFNULL(new_id,id),extension,mimetype,filesize,geometry,UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),"active",0
    FROM _src_media WHERE  category <> "hub"  AND xpath NOT IN (SELECT xpath FROM _des_media) ') ;
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @sql = CONCAT( 
     "UPDATE ",_des_db,".media SET parent_path = clean_path(  ",_des_db,".parent_path(id)) WHERE id IN (SELECT id FROM _src_media WHERE category <> 'hub')" );
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt; 
  
  SET @sql = CONCAT( 
     "UPDATE ",_des_db,".media SET file_path = clean_path(concat(parent_path, '/', user_filename, '.', extension)) WHERE id IN (SELECT id FROM _src_media WHERE category <> 'hub')" );
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt; 


  SET @s2 = CONCAT( "CALL ",_src_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @src_home_dir, @_tmp, @_tmp, @_tmp)") ;
  PREPARE stmt2 FROM @s2;
  EXECUTE stmt2;
  DEALLOCATE PREPARE stmt2;

  SET @s2 = CONCAT( "CALL ",_des_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
  PREPARE stmt2 FROM @s2;
  EXECUTE stmt2;
  DEALLOCATE PREPARE stmt2;

  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      src_mfs_root varchar(1024) DEFAULT NULL,  
      des_id varchar(16) DEFAULT NULL,  
      des_mfs_root varchar(1024) DEFAULT NULL,  
      action varchar(16) DEFAULT NULL
  );
  


  SELECT NULL ,NULL ,NULL ,NULL,NULL  INTO  @srcfilename ,@srcpattern,@srcpath ,@descpattern,@despath;

  INSERT INTO _final_media  
  SELECT IFNULL( new_id, id) ,NULL, NULL, NULL,'show'  FROM _src_media WHERE id=_nid ;

  IF _cross_hub = 1 THEN
  
    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") ,new_id, CONCAT(@des_home_dir, "/__storage__/") ,'move'  
    FROM _src_media WHERE category NOT IN ("folder","hub")  AND new_id IS NOT NULL;

    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") ,id, CONCAT(@des_home_dir, "/__storage__/") ,'move'  
    FROM _src_media WHERE category NOT IN ("folder","hub")  AND new_id IS NULL;
  
    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") , NULL ,null,'delete'  FROM _src_media WHERE category NOT IN ("folder","hub") ;

  ELSE 
    
    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") ,new_id, CONCAT(@des_home_dir, "/__storage__/") ,'move'  
    FROM _src_media WHERE category NOT IN ("folder","hub")  AND new_id IS NOT NULL;

    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") , NULL ,null,'delete'  
    FROM _src_media WHERE category NOT IN ("folder","hub")  AND new_id IS NOT NULL;

  END IF; 
  SELECT * FROM _final_media;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_move_node`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN

DECLARE _dest_db        VARCHAR(50);
DECLARE _origin_id      VARCHAR(16);   
DECLARE _file_name      VARCHAR(512); 
DECLARE _category       VARCHAR(50);   
DECLARE _extension      VARCHAR(100); 
DECLARE _mimetype       VARCHAR(100);      
DECLARE _file_size      INT(20) UNSIGNED;
DECLARE _geometry       VARCHAR(200);       



SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _dest_db;

SELECT origin_id,user_filename,category,extension,mimetype,geometry,filesize 
FROM media  WHERE id =_nid
INTO _origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size;

DELETE FROM media WHERE id = _nid ; 

        SET @s1 = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_dest_db,".__register_stack LIKE template.tmp_media"); 
        PREPARE stmt FROM @s1;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;


        SET @s1 = CONCAT( "DELETE FROM ",_dest_db,".__register_stack"); 
        PREPARE stmt1 FROM @s1;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;

        SET @s2 = CONCAT("CALL ",_dest_db,".mfs_register(",
            ""  ,   QUOTE(_origin_id )    , "," ,
            ""  ,   QUOTE( _file_name )    , "," ,
            ""  ,   QUOTE( _pid  )         , "," ,
            ""  ,   QUOTE( _category)      , "," ,
            ""  ,   QUOTE( _extension)     , "," ,
            ""  ,   QUOTE( _mimetype)      , "," ,
            ""  ,   QUOTE(_geometry)      , "," ,
                   _file_size     , ", 0 )"          
          );
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;   
 

        SET @s3 = CONCAT( "SELECT id ,parent_id FROM ",_dest_db,".__register_stack INTO @temp_nid,@pid");
        PREPARE stmt3 FROM @s3;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;


        CALL mediaEnv(@_tmp, @_tmp, @_tmp, @src_home_dir, @_tmp, @_tmp, @_tmp);
  
        SET @s2 = CONCAT( "CALL ",_dest_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;


        DROP TABLE IF EXISTS _final_media; 
              CREATE TEMPORARY TABLE `_final_media` (
              nid varchar(16) DEFAULT NULL,  
              src_mfs_root varchar(1024) DEFAULT NULL,  
              des_id varchar(16) DEFAULT NULL,  
              des_mfs_root varchar(1024) DEFAULT NULL,  
              action varchar(16) DEFAULT NULL
          );   

        INSERT INTO _final_media  
        SELECT @temp_nid,NULL ,@temp_nid, NULL ,'show' ;
        INSERT INTO _final_media  
        SELECT _nid ,  CONCAT(@src_home_dir, "/__storage__/") ,  @temp_nid , CONCAT(@des_home_dir, "/__storage__/")  , 'move'  ;
        INSERT INTO _final_media
        SELECT _nid , CONCAT(@src_home_dir, "/__storage__/") , NULL ,NULL,'delete'  ;

        SELECT * FROM _final_media;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_replace_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_move_replace_node`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
  DECLARE _src_db VARCHAR(255);
  DECLARE _des_db VARCHAR(255); 
  DECLARE _src_root_id  VARCHAR(16);
  DECLARE _cross_hub  INT;


  SELECT NULL,NULL,NULL INTO  @srcfilename, @descpattern, @destnid;

  SELECT  database() INTO _src_db;  
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _des_db;
  
  SELECT  0 INTO _cross_hub;
  SELECT CASE WHEN _src_db <> _des_db THEN 1 ELSE 0 END INTO _cross_hub;
 
  SELECT concat(user_filename, '.', extension) FROM media WHERE id = _nid INTO @srcfilename ;
  

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename, '/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @descpattern" );
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT(" 
    SELECT id 
    FROM  ",_des_db ,".media m      	
    WHERE id <> ", QUOTE( _pid) ,"
    AND CONCAT(" ,_des_db ,".parent_path(id),user_filename,'.',extension ) 
    = CONCAT(@descpattern,@srcfilename) INTO @destnid");
   PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

 
  DELETE FROM media WHERE id = _nid AND _nid <> @destnid;
 
  CALL mediaEnv(@_tmp, @_tmp, @_tmp, @src_home_dir, @_tmp, @_tmp, @_tmp);

  SET @s2 = CONCAT( "CALL ",_des_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
  PREPARE stmt2 FROM @s2;
  EXECUTE stmt2;
  DEALLOCATE PREPARE stmt2;


  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      src_mfs_root varchar(1024) DEFAULT NULL,  
      des_id varchar(16) DEFAULT NULL,  
      des_mfs_root varchar(1024) DEFAULT NULL,  
      action varchar(16) DEFAULT NULL
  );
  
  INSERT INTO _final_media  SELECT IFNULL(@destnid,_nid) ,NULL, NULL, NULL,'show' ;
 
  INSERT INTO _final_media
    SELECT _nid , CONCAT(@src_home_dir, "/__storage__/") ,IFNULL(@destnid,_nid), CONCAT(@des_home_dir, "/__storage__/") ,'move' 
    WHERE _nid <> @destnid ; 
  
  INSERT INTO _final_media
    SELECT _nid , CONCAT(@src_home_dir, "/__storage__/") , NULL ,null,'delete' WHERE _nid <> @destnid ; 
  
  
  
  SELECT * FROM _final_media;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_replace_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_move_replace_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
  DECLARE _src_db VARCHAR(255);
  DECLARE _des_db VARCHAR(255); 
  DECLARE _src_root_id  VARCHAR(16);
  DECLARE _cross_hub  INT;

  
  SELECT  database() INTO _src_db;  
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _des_db;
  
  SELECT  0 INTO _cross_hub;
  SELECT CASE WHEN _src_db <> _des_db THEN 1 ELSE 0 END INTO _cross_hub;


  SELECT NULL ,NULL ,NULL ,NULL  INTO  @srcfilename ,@srcpattern ,@descpattern,@despath;


  SET @sql = CONCAT( 
    "SELECT user_filename FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcfilename ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_src_db ,".parent_path(id),user_filename, '/') FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename, '/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @descpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;  

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @despath ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;


  SELECT  clean_path(@srcpattern) INTO @srcpattern;
  SELECT  clean_path(@descpattern) INTO @descpattern; 
  SELECT  clean_path(@despath) INTO @despath;
  
  


  DROP TABLE IF EXISTS  _src_media;
  CREATE TEMPORARY TABLE `_src_media` (
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0'
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    DROP TABLE IF EXISTS _des_media;
    CREATE TEMPORARY TABLE `_des_media` (
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0'

    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

  SET @sql = CONCAT(" 
    INSERT INTO _src_media 
    SELECT id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry
    FROM  " ,_src_db ,".media m 
    WHERE  CONCAT(" ,_src_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@srcpattern,'%') ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  
  SET @sql = CONCAT(" 
    INSERT INTO _des_media
    SELECT  id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry 
    FROM  " ,_des_db ,".media m      	
    WHERE id <> ", QUOTE( _pid) ,"
    AND CONCAT(" ,_des_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@descpattern,@srcfilename,'/','%')");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  UPDATE _src_media SET parent_id = _pid  WHERE id=_nid;
  
  SELECT id FROM media WHERE parent_id = '0' INTO _src_root_id;
  UPDATE media SET parent_id = _src_root_id WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  UPDATE media SET parent_path = parent_path(id) WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  UPDATE media SET file_path = clean_path(CONCAT(parent_path, '/', user_filename, '.', extension)) WHERE id IN (SELECT id FROM _src_media WHERE category ='hub');
  

  

  SET @sql = CONCAT( "DELETE FROM ",_des_db,".media WHERE id in (SELECT id from _des_media ) ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

   

  SET @sql = CONCAT( "DELETE FROM ",_src_db,".media WHERE id in (SELECT id from _src_media where  category <> 'hub' ) ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  

  SET @sql = CONCAT( 
    'INSERT INTO ',_des_db,'.media (
    id,origin_id,user_filename,category,parent_id,parent_path, file_path,extension,mimetype,filesize,geometry,publish_time,upload_time,status,rank)
    SELECT id,origin_id,user_filename,category,parent_id, id, id,extension,mimetype,filesize,geometry,UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),"active",0
    FROM _src_media WHERE  category <> "hub"') ;
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @sql = CONCAT( 
      "UPDATE ",_des_db,".media SET parent_path = clean_path(  ",_des_db,".parent_path(id)) WHERE id IN (SELECT id FROM _src_media WHERE category <> 'hub')" );
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt; 
  
  SET @sql = CONCAT( 
     "UPDATE ",_des_db,".media SET file_path =clean_path(concat(parent_path, '/', user_filename, '.', extension)) WHERE id IN (SELECT id FROM _src_media WHERE category <> 'hub')" );
  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt; 


  SET @s2 = CONCAT( "CALL ",_src_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @src_home_dir, @_tmp, @_tmp, @_tmp)") ;
  PREPARE stmt2 FROM @s2;
  EXECUTE stmt2;
  DEALLOCATE PREPARE stmt2;

  SET @s2 = CONCAT( "CALL ",_des_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
  PREPARE stmt2 FROM @s2;
  EXECUTE stmt2;
  DEALLOCATE PREPARE stmt2;

  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      src_mfs_root varchar(1024) DEFAULT NULL,  
      des_id varchar(16) DEFAULT NULL,  
      des_mfs_root varchar(1024) DEFAULT NULL,  
      action varchar(16) DEFAULT NULL
  );
  


  SELECT NULL ,NULL ,NULL  INTO  @srcfilename ,@srcpattern,@descpattern;

  INSERT INTO _final_media  
  SELECT id ,NULL, NULL, NULL,'show'  FROM _src_media WHERE id=_nid ;

  IF _cross_hub = 1 THEN
    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") ,id, CONCAT(@des_home_dir, "/__storage__/") ,'move'  
    FROM _src_media WHERE category NOT IN ("folder","hub");

    INSERT INTO _final_media
    SELECT id , CONCAT(@src_home_dir, "/__storage__/") , NULL ,null,'delete'  FROM _src_media WHERE category NOT IN ("folder","hub") ;
  END IF; 

  INSERT INTO _final_media 
  SELECT  id, CONCAT(@des_home_dir, "/__storage__/") ,null,null,'delete'  
  FROM _des_media WHERE category NOT IN ("folder","hub");
  
  SELECT * FROM _final_media;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_move_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_move_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
    DECLARE  _temp_nid      VARCHAR(16);
    DECLARE  _lvl           INTEGER;
    DECLARE _dest_db        VARCHAR(50);


    DECLARE _origin_id      VARCHAR(16);   
    DECLARE _src_path       VARCHAR(1024); 
    DECLARE _des_path       VARCHAR(1024); 
    DECLARE _file_name      VARCHAR(512); 
    DECLARE _category       VARCHAR(50);   
    DECLARE _extension      VARCHAR(100); 
    DECLARE _mimetype       VARCHAR(100);      
    DECLARE _file_size      INT(20) UNSIGNED;
    DECLARE _geometry       VARCHAR(200);       
    DECLARE _status         VARCHAR(50); 
    DECLARE _finished       INTEGER DEFAULT 0;
    DECLARE _seq            INTEGER;  
    DECLARE _id             VARCHAR(16);   
    DECLARE _src_root_id    VARCHAR(16);  

    SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _dest_db;
    SELECT id FROM media WHERE parent_id = '0' INTO _src_root_id;
    

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' ,
      `lvl` int default 0, 
      `is_checked` boolean default 0 ,
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    SELECT _nid,0  INTO _temp_nid , _lvl;
   
    WHILE _temp_nid IS NOT NULL DO
      
      INSERT INTO _src_media
      SELECT 
      null, id,origin_id,user_filename,category,parent_id,extension,mimetype,filesize,geometry,null,null,_lvl ,0
      FROM media m1 WHERE  category <> "hub" AND CASE WHEN _lvl <> 0 THEN m1.parent_id ELSE m1.id END  =_temp_nid;
      
      UPDATE media m1 
      SET 
        parent_id = _src_root_id ,
        parent_path ='/',
        file_path =  clean_path(CONCAT('/', user_filename, '.', extension))

      WHERE  category = "hub" AND CASE WHEN _lvl <> 0 THEN m1.parent_id ELSE m1.id END  =_temp_nid;
      
      
      UPDATE _src_media SET is_checked = 1 WHERE id = _temp_nid and _lvl <> 0;
      SELECT NULL,_lvl+1 INTO _temp_nid,_lvl;
      SELECT id FROM _src_media WHERE is_checked = 0 LIMIT 1 INTO _temp_nid ;
  
    END WHILE;
 
  DELETE FROM media WHERE id in (SELECT id from _src_media ) ;  


  UPDATE _src_media SET new_parent_id = _pid  WHERE  seq=1;  
  
  BEGIN
    DECLARE dbcursor CURSOR FOR SELECT seq,id,origin_id,user_filename,category,extension,mimetype,`geometry`,filesize FROM _src_media order by seq;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _seq,_id,_origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    

       

        SET @s1 = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_dest_db,".__register_stack LIKE template.tmp_media"); 
        PREPARE stmt FROM @s1;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;


        SET @s1 = CONCAT( "DELETE FROM ",_dest_db,".__register_stack"); 
        PREPARE stmt1 FROM @s1;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
        
        SELECT new_parent_id  FROM _src_media WHERE seq =_seq INTO _pid; 
       

        SET @s2 = CONCAT("CALL ",_dest_db,".mfs_register(",
            "'"  , _origin_id     , "'," ,
            "'"  , _file_name     , "'," ,
            "'"  , _pid           , "'," ,
            "'"  , _category      , "'," ,
            "'"  , _extension     , "'," ,
            "'"  , _mimetype      , "'," ,
            "'"  , _geometry      , "'," ,
                   _file_size     , ", 0 )"          
          );
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;   
 

      
        SET @s3 = CONCAT( "SELECT id ,parent_id FROM ",_dest_db,".__register_stack INTO @temp_nid,@pid");
        PREPARE stmt3 FROM @s3;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;   
        

        UPDATE _src_media SET new_id =@temp_nid , new_parent_id = @pid  WHERE seq =_seq ; 
        UPDATE _src_media SET new_parent_id =  @temp_nid    WHERE parent_id = _id; 

      END LOOP STARTLOOP;   

    CLOSE dbcursor;
  END;  
   

    CALL mediaEnv(@_tmp, @_tmp, @_tmp, @src_home_dir, @_tmp, @_tmp, @_tmp);
  
    SET @s2 = CONCAT( "CALL ",_dest_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
    PREPARE stmt2 FROM @s2;
    EXECUTE stmt2;
    DEALLOCATE PREPARE stmt2;


  


  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      src_mfs_root varchar(1024) DEFAULT NULL,  
      des_id varchar(16) DEFAULT NULL,  
      des_mfs_root varchar(1024) DEFAULT NULL,  
      action varchar(16) DEFAULT NULL
  );   

  INSERT INTO _final_media  
  SELECT new_id,NULL ,new_id, NULL ,'show' FROM _src_media WHERE seq = 1 ;
  INSERT INTO _final_media  
  SELECT id ,  CONCAT(@src_home_dir, "/__storage__/") ,  new_id , CONCAT(@des_home_dir, "/__storage__/")  , 'move'  FROM _src_media WHERE category NOT IN ("folder","hub");
  INSERT INTO _final_media
  SELECT id , CONCAT(@src_home_dir, "/__storage__/") , NULL ,NULL,'delete'  FROM _src_media WHERE category NOT IN ("folder","hub") ;

  SELECT * FROM _final_media;
    

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_new_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_new_node`(
  IN _origin_id       VARCHAR(16),
  IN _owner_id       VARCHAR(16),
  IN _user_filename   VARCHAR(512),
  IN _pid             VARCHAR(20),
  IN _category        VARCHAR(50),
  IN _extension       VARCHAR(100),
  IN _mimetype        VARCHAR(100),
  IN _geometry        VARCHAR(200),
  IN _file_size       INT(20) UNSIGNED,
  IN _show_results    BOOLEAN
)
BEGIN
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _src_db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(20);

  DECLARE _fileid   VARCHAR(16) DEFAULT '';
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _parent_id TEXT;
  DECLARE _root_id VARCHAR(16);
  DECLARE _parent_path TEXT;
  DECLARE _parent_name VARCHAR(100) DEFAULT '';
  DECLARE _file_path   VARCHAR(1024);
  DECLARE _file_name VARCHAR(1024);

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT yp.uniqueId() INTO _fileid;

  

  IF IFNULL(_pid, '0') IN('', '0') THEN 
    SELECT id FROM media WHERE parent_id='0' INTO  _pid;
  END IF;

  SELECT id, TRIM('/' FROM user_filename) FROM media WHERE id=_pid 
    INTO _parent_id, _parent_name;
  IF _parent_id IS NULL OR _parent_id='' THEN 
    SELECT id FROM media m WHERE m.parent_id='0' INTO  _parent_id;
    
  END IF;
  

  SELECT COUNT(*) FROM media WHERE parent_id = _pid INTO @_count;

  SELECT parent_path(_parent_id) INTO _parent_path;
  SELECT REPLACE(_user_filename, CONCAT('.', _extension), '') INTO _file_name;
  SELECT unique_filename(_parent_id, _file_name, _extension) INTO _file_name;
  SELECT CONCAT(_parent_path, '/', _parent_name, '/', _file_name, '.', _extension) 
    INTO _file_path;


  INSERT INTO `media` (
    id, 
    origin_id, 
    owner_id,
    file_path, 
    user_filename, 
    parent_id, 
    parent_path,

    extension, 
    mimetype, 
    category,
    isalink,

    filesize, 
    `geometry`, 
    publish_time, 
    upload_time, 

    `status`,
    rank
  ) VALUES (
    _fileid, 
    _origin_id, 
    _owner_id,
    clean_path(_file_path), 
    TRIM('/' FROM _file_name),
    _pid, 
    _parent_path,

    _extension, 
    _mimetype, 
    _category, 
    0,

    IFNULL(_file_size, 4096),
    IFNULL(_geometry, '0x0'), 
    _ts, 
    _ts, 

    IF(_category='stylesheet', 'idle', 'active'),
    @_count
  );
  
  
  DROP TABLE IF EXISTS __register_stack;
  CREATE TEMPORARY TABLE __register_stack LIKE template.__register_stack;
  INSERT INTO __register_stack VALUES (
    _fileid, 
    _origin_id, 
    _owner_id, 
    clean_path(_file_path), 
    _file_name,
    _pid, 
    _parent_path,

    _extension, 
    _mimetype, 
    _category, 
    0,

    IFNULL(_file_size, 4096),
    IFNULL(_geometry, '0x0'), 
    _ts, 
    _ts, 

    'active',
    @_count
  );

  SET @perm = 0;
  
  
  
  
  
  

  IF _category NOT IN ('hub', 'folder') THEN 
    UPDATE media SET metadata=JSON_MERGE(
      IFNULL(metadata, '{}'), 
      JSON_OBJECT('_seen_', JSON_OBJECT(_owner_id, UNIX_TIMESTAMP()))
    )
    WHERE id=_fileid;
  END IF; 

  IF IFNULL(_show_results, 0) != 0  THEN
    SELECT 
      m.id, 
      m.id as nid, 
      concat(_home_dir, "/__storage__/") AS mfs_root,
      parent_id AS pid,
      parent_id,
      e.id AS holder_id,
      e.home_id,
      e.home_dir,
      user_permission(_origin_id, m.id)  AS privilege,
      e.id AS owner_id,    
      e.id AS hub_id,    
      yp.vhost(e.id) AS vhost,    
      user_filename AS filename,
      filesize,
      e.area,
      caption,
      e.accessibility,
      capability,
      m.extension,
      m.extension AS ext,
      m.category AS ftype,
      m.category AS filetype,
      m.mimetype,
      download_count AS view_count,
      geometry,
      upload_time AS ctime,
      publish_time AS ptime,
      firstname,
      lastname,
      m.category,
      user_filename,
      file_path, 
      parent_path
    FROM media m
      INNER JOIN yp.entity e  ON e.db_name=database()
      LEFT JOIN yp.drumate dr ON e.id = dr.id
      LEFT JOIN yp.domain d ON d.id = e.dom_id
      LEFT JOIN yp.filecap ff ON m.extension=ff.extension

      
      
      WHERE m.id = _fileid;
  END IF ;

  SELECT id FROM yp.entity WHERE db_name=database() INTO _hub_id;
  UPDATE yp.disk_usage SET size = (size + _file_size) WHERE hub_id = _hub_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_node_attr` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_node_attr`(
  IN _key VARCHAR(1024) 
)
BEGIN

  DECLARE _area VARCHAR(25);
  DECLARE _vhost VARCHAR(255);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _hub_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _dom_id VARCHAR(16) ;
  DECLARE _home_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _parent_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _db_name VARCHAR(50);
  DECLARE _hub_name VARCHAR(150);
  DECLARE _hub_db VARCHAR(150);
  DECLARE _actual_home_id VARCHAR(150) CHARACTER SET ascii;
  DECLARE _actual_hub_id VARCHAR(150) CHARACTER SET ascii;
  DECLARE _actual_db VARCHAR(150);
  DECLARE _node_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _remit TINYINT(4) DEFAULT 0;

  IF _key regexp  '^\/.+' THEN 
    SELECT id FROM media 
      WHERE REPLACE(file_path, '/', '') = 
      REPLACE(IF(category='folder' OR category ='hub', CONCAT(_key, '.', extension), _key), '/','')
      INTO _node_id;
  ELSE 
    SELECT _key INTO _node_id;
  END IF;


  SELECT 
    COALESCE(h.name, dr.fullname) AS `name`,
    e.id,
    e.home_id,
    e.home_dir,
    d.id,
    e.area,
    v.fqdn,
    e.db_name
  FROM yp.entity e
    INNER JOIN yp.vhost v ON e.id = v.id 
    INNER JOIN yp.domain d ON d.id = e.dom_id
    LEFT JOIN yp.drumate dr ON e.id = dr.id 
    LEFT JOIN yp.hub h ON e.id = h.id 
  WHERE e.db_name = database() 
  INTO 
    _hub_name,
    _hub_id, 
    _home_id, 
    _home_dir,
    _dom_id, 
    _area,
    _vhost,
    _db_name;

  SELECT _home_id , _hub_id, _db_name
    INTO _actual_home_id, _actual_hub_id, _actual_db;



  SELECT
    m.id,
    m.id  AS nid,
    _actual_home_id AS actual_home_id, 
    _actual_hub_id AS actual_hub_id,
    _actual_db AS actual_db,
    _db_name AS db_name,
    concat(_home_dir, "/__storage__/") AS mfs_root,
    concat(_home_dir, "/__storage__/") AS home_dir,
    parent_id AS pid,
    parent_id AS parent_id,
    _hub_id AS hub_id,
    _vhost AS vhost,
    caption,
    _area AS accessibility,
    _area AS area,
    _home_id AS home_id,
    capability,
    m.status AS status,
    m.extension,
    m.mimetype,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    download_count AS view_count,
    m.metadata metadata,
    geometry,
    upload_time AS ctime,
    publish_time AS ptime,
    publish_time AS mtime,
    CASE 
      WHEN m.category='hub' THEN _hub_name
      WHEN m.parent_id='0' THEN _hub_name
      ELSE user_filename
    END AS filename,
    parent_path,
    file_path,
    filesize,
    _remit AS remit
  FROM  media m LEFT JOIN (yp.filecap, yp.drumate) 
  ON m.extension=filecap.extension AND origin_id=drumate.id 
  WHERE m.id=_node_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_parent_node_attr` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_parent_node_attr`(
  IN _node_id VARCHAR(16)
)
BEGIN
  DECLARE _parent_id VARCHAR(16);
  SELECT parent_id FROM media WHERE id=_node_id INTO _parent_id;
  CALL mfs_node_attr(_parent_id);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_post_chatfile` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_post_chatfile`(
  IN _in JSON , 
  OUT _out JSON
)
BEGIN
  DECLARE _message_id VARCHAR(16);
  DECLARE _author_id VARCHAR(16);
  

  CREATE TEMPORARY TABLE IF NOT EXISTS __register_stack LIKE template.__register_stack;
  DELETE FROM __register_stack;
  
  SELECT get_json_object(_in, 'message_id') INTO _message_id;
  SELECT get_json_object(_in, 'author_id') INTO _author_id;
  
  
  CALL mfs_make_dir(node_id_from_path('/__chat__'), JSON_ARRAY(_message_id),0);
  SELECT node_id_from_path( CONCAT('/__chat__/',_message_id)) INTO _message_id;
  CALL mfs_new_node(
    get_json_object(_in, 'origin_id'),
    _author_id,
    get_json_object(_in, 'user_filename'),
    _message_id     ,
    get_json_object(_in, 'category'),
    get_json_object(_in, 'extension'),
    get_json_object(_in, 'mimetype'),
    'geometry',
    get_json_object(_in, 'filesize'), 
    0
  );

  SELECT  id FROM __register_stack  INTO _out; 


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_pre_trash` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_pre_trash`(
  IN _nodes JSON,
  IN _uid VARCHAR(16),
  IN _modify_perm TINYINT(4)
)
BEGIN
  
  DECLARE _i INT(4) DEFAULT 0; 
  
  DECLARE _nid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(40);
  
  DECLARE _usr_hub_id VARCHAR(16);


  DECLARE _node_hub_id VARCHAR(16);
  DECLARE _node_hub_db VARCHAR(40);
  DECLARE _wicket_db VARCHAR(40);

  DECLARE _cum_output MEDIUMTEXT;
  
  
  SELECT id FROM yp.entity WHERE id = _uid INTO _usr_hub_id;


  SET @_current_hub_id = '0';
  START TRANSACTION;
    WHILE _i < JSON_LENGTH(_nodes) DO 
      
      SELECT get_json_array(_nodes, _i) INTO @_node;
      SELECT JSON_VALUE(@_node, "$.nid") INTO _nid;
      SELECT JSON_VALUE(@_node, "$.hub_id") INTO _hub_id;

      IF @_current_hub_id <> _hub_id THEN 
        SELECT db_name, id FROM yp.entity WHERE id = _hub_id INTO _hub_db,  @_current_hub_id;  
      END IF;

      SELECT NULL, NULL, 0 INTO @_category, @_getoutput, @_is_home; 


      SET @sql = CONCAT( 
        "SELECT 1 from ",_hub_db, ".media WHERE parent_id='0' AND id = ", 
        QUOTE(_nid), " INTO @_is_home"
      );
      PREPARE trash_stmt FROM @sql;
      EXECUTE trash_stmt;
      DEALLOCATE PREPARE trash_stmt;


      SET @sql = CONCAT( 
        "SELECT category, user_filename from ", _hub_db, ".media WHERE id= ", 
        QUOTE(_nid), " INTO @_category, @_user_filename"
      );
      PREPARE trash_stmt FROM @sql;
      EXECUTE trash_stmt;
      DEALLOCATE PREPARE trash_stmt;

      
      
      
      
      
      
      
      
      
      
      
      
      
      IF _hub_id <> _usr_hub_id AND  @_is_home = 0  THEN
        SET @sql = CONCAT(
          'CALL ' ,_hub_db ,'.mfs_trash_cross_node (',QUOTE(_nid),',',QUOTE(_uid) ,',', _modify_perm ,',@_getoutput )');
        PREPARE trash_stmt FROM @sql;
        EXECUTE trash_stmt;
        DEALLOCATE PREPARE trash_stmt;
      END IF ;


      
      IF _hub_id =  _usr_hub_id AND @_category <> 'hub' AND @_is_home = 0  THEN
        CALL mfs_trash_node (_nid);
      END IF;

      IF @_category = 'schedule' THEN 
        SELECT db_name FROM yp.entity e
          INNER JOIN yp.hub h ON e.id=h.id 
          WHERE owner_id=_uid AND serial=0 INTO _wicket_db;
        CALL room_delete (_nid);
        SET @sql = CONCAT('CALL ' ,_wicket_db ,'.room_delete (?)');
        PREPARE trash_stmt FROM @sql;
        EXECUTE trash_stmt USING _nid;
        DEALLOCATE PREPARE trash_stmt;
      END IF;

      
      
      
      
      
      
      
      
      
      SELECT _i + 1 INTO _i;
    END WHILE;
    

  IF  @_is_home = 0  THEN
    COMMIT;
    SELECT filename FROM (SELECT _cum_output as filename ) a WHERE filename IS NOT NULL ;
  ELSE 
    ROLLBACK;
  END IF;

 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_purge` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_purge`(
  IN _id VARCHAR(16)
)
BEGIN
  DECLARE _node_path VARCHAR(255);
  DECLARE _category VARCHAR(40);
  DECLARE _filesize BIGINT UNSIGNED;
  DECLARE _hub_id VARCHAR(20);
  DECLARE _home_dir VARCHAR(1024);

  SELECT id ,home_dir FROM yp.entity WHERE db_name=database() INTO _hub_id, _home_dir;

  DROP TABLE IF EXISTS _mytree; 
  CREATE TEMPORARY TABLE _mytree (
      id varchar(16) DEFAULT NULL
  );

  INSERT INTO _mytree (id)  
    WITH RECURSIVE mytree AS (
      SELECT id, parent_id FROM media WHERE id = _id
      UNION ALL
      SELECT m.id,m.parent_id
      FROM media AS m JOIN mytree AS t ON m.parent_id = t.id
    )
    SELECT id FROM mytree;


  
  
  SELECT category, filesize from media WHERE id=_id into _category, _filesize;



  DROP TABLE IF EXISTS __purge_stack;
  CREATE TEMPORARY TABLE IF NOT EXISTS  __purge_stack LIKE template.tmp_id;

  IF _category='folder' THEN    
    SELECT SUM(filesize) FROM media 
    WHERE id IN (SELECT id FROM _mytree)
      AND category != 'hub' INTO _filesize;
  END IF;

  
  INSERT INTO __purge_stack SELECT id, CONCAT(_home_dir, "/__storage__/") 
  FROM media WHERE id IN ( SELECT id FROM _mytree);


  DELETE FROM media WHERE id IN (SELECT nid FROM __purge_stack);

  IF(SELECT count(*) FROM yp.disk_usage where hub_id=_hub_id) > 0 THEN 
    UPDATE yp.disk_usage SET size = (size - _filesize) WHERE hub_id = _hub_id;
  ELSE 
    INSERT INTO yp.disk_usage VALUES(null, _hub_id, 0);
  END IF;

  SELECT * FROM __purge_stack;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_push_chatfile` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_push_chatfile`(
  IN _author_id VARCHAR(16),
  IN _nodes     JSON,
  IN _entities  JSON
)
BEGIN
  DECLARE _out JSON ;
  DECLARE _mfs_copy JSON;
  DECLARE _new_attachment JSON;
  DECLARE _new_nodes JSON;
  DECLARE _this_new_attachment JSON;


  DECLARE _attachment JSON;

  DECLARE _entity_id VARCHAR(16);
  DECLARE _entity_db VARCHAR(255);
  DECLARE _entity_type  VARCHAR(512);

  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(255);
  


  DECLARE _this_hub_id VARCHAR(16);
  DECLARE _this_hub_db VARCHAR(255);

  DECLARE _message_id VARCHAR(16);
  DECLARE _forward_message_id VARCHAR(16);
  DECLARE _thread_id VARCHAR(16);

  DECLARE _message VARCHAR(6000);

  DECLARE _node JSON;

  DECLARE _idx_node INT(4) DEFAULT 0; 
  DECLARE _idx_entity INT(4) DEFAULT 0;
  DECLARE _idx_attachment INT(4) DEFAULT 0; 
  
  DECLARE _nid VARCHAR(16);
  DECLARE _new_id json;

  DECLARE _mfs_detail JSON;
  DECLARE _temp_result JSON;
  DECLARE _hub_dir VARCHAR(512);
  DECLARE _entity_dir VARCHAR(512);
  DECLARE _this_hub_dir VARCHAR(512);

  
  SELECT '[]' INTO _out ;
  SELECT '[]' INTO _mfs_copy ;
  SELECT '[]' INTO _new_attachment ;
  SELECT '[]' INTO _new_nodes ;
  SELECT '[]' INTO _this_new_attachment ;
  



    WHILE _idx_entity < JSON_LENGTH(_entities) DO 
      
      SELECT get_json_array(_entities, _idx_entity) INTO _entity_id;
     
      SELECT db_name,home_dir, type FROM yp.entity WHERE id=_entity_id INTO _entity_db,_entity_dir, _entity_type ;
      
        SELECT 0 INTO _idx_node;

        WHILE _idx_node < JSON_LENGTH(_nodes) DO 
        
         

          SELECT JSON_QUERY(_nodes, CONCAT("$[", _idx_node, "]") ) INTO _node;
                
          SELECT JSON_VALUE(_node, '$.message_id') INTO _message_id;
          SELECT JSON_VALUE(_node, '$.message') INTO _message;
          SELECT JSON_QUERY(_node, '$.attachment') INTO _attachment;
          SELECT JSON_VALUE(_node, '$.hub_id') INTO _hub_id;
          SELECT JSON_VALUE(_node, '$.forward_message_id') INTO _forward_message_id;
          SELECT JSON_VALUE(_node, '$.thread_id') INTO _thread_id;


          
          SELECT db_name,home_dir FROM yp.entity WHERE id=_hub_id INTO _hub_db,_hub_dir ;
          SELECT db_name,home_dir,id FROM yp.entity WHERE db_name=DATABASE() INTO  _this_hub_db ,_this_hub_dir, _this_hub_id ;


          SELECT 0 INTO _idx_attachment;
         

            WHILE _idx_attachment < JSON_LENGTH(_attachment) DO 
  
                SELECT get_json_array(_attachment, _idx_attachment) INTO _nid;
  
                SET @st = CONCAT('CALL ', _hub_db ,'.mfs_fetch(?,?)');
                PREPARE stamt FROM @st;
                EXECUTE stamt USING JSON_OBJECT('nid',_nid),_mfs_detail  ;
                DEALLOCATE PREPARE stamt; 

                SET @st = CONCAT('CALL ', _entity_db ,'.mfs_post_chatfile(?,?)');
                PREPARE stamt FROM @st;
                EXECUTE stamt USING JSON_MERGE(_mfs_detail, JSON_OBJECT('message_id',_message_id),JSON_OBJECT('author_id',_author_id)),_new_id;
                DEALLOCATE PREPARE stamt;

               SELECT NULL INTO _temp_result ;
               SELECT 
               JSON_MERGE ( 
                JSON_OBJECT( 'srclst',   JSON_MERGE( JSON_OBJECT('nid', _nid),  JSON_OBJECT('mfs_root',CONCAT (_hub_dir  , "/__storage__/"  )))),
                JSON_OBJECT( 'desclst',   JSON_MERGE( JSON_OBJECT('nid', _new_id),  JSON_OBJECT('mfs_root',CONCAT( _entity_dir  ,"/__storage__/"))))
               ) INTO _temp_result;
              
               SELECT JSON_ARRAY_INSERT(_mfs_copy , '$[0]', _temp_result ) INTO _mfs_copy;
               SELECT JSON_ARRAY_INSERT(_new_attachment , '$[0]', _new_id ) INTO _new_attachment;



              IF _this_hub_id <> _hub_id THEN 
                  SET @st = CONCAT('CALL ', _this_hub_db ,'.mfs_post_chatfile(?,?)');
                  PREPARE stamt FROM @st;
                  EXECUTE stamt USING JSON_MERGE(_mfs_detail, JSON_OBJECT('message_id',_message_id),JSON_OBJECT('author_id',_author_id)),_new_id;
                  DEALLOCATE PREPARE stamt;
              
                  SELECT NULL INTO _temp_result ;
                  SELECT 
                    JSON_MERGE ( 
                      JSON_OBJECT( 'srclst',   JSON_MERGE( JSON_OBJECT('nid', _nid),  JSON_OBJECT('mfs_root',CONCAT (_hub_dir  , "/__storage__/"  )))),
                      JSON_OBJECT( 'desclst',   JSON_MERGE( JSON_OBJECT('nid', _new_id),  JSON_OBJECT('mfs_root',CONCAT( _this_hub_dir  ,"/__storage__/"))))
                    ) INTO _temp_result;
                    
                  SELECT JSON_ARRAY_INSERT(_mfs_copy , '$[0]', _temp_result ) INTO _mfs_copy;
                  SELECT JSON_ARRAY_INSERT(_this_new_attachment , '$[0]', _new_id ) INTO _this_new_attachment;
             
              END IF ; 


               SELECT _idx_attachment + 1 INTO _idx_attachment;
            END WHILE;

          SELECT NULL INTO _temp_result ;
          SELECT 
          JSON_MERGE ( 
                JSON_OBJECT( 'author_id',_author_id ),
                JSON_OBJECT( 'message_id',_message_id ),
                JSON_OBJECT( 'entity_id',_entity_id ),
                JSON_OBJECT( 'entity_type',_entity_type )
                
                
          ) INTO _temp_result;
          SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'forward_message_id', _forward_message_id ) , JSON_OBJECT( 'hub_id', _hub_id)) INTO _temp_result WHERE _forward_message_id IS NOT NULL;
          SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'thread_id', _thread_id )) INTO _temp_result WHERE _thread_id IS NOT NULL;

           SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'message', _message )) INTO _temp_result WHERE _message IS NOT NULL;
           SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'postattachment', _new_attachment ), JSON_OBJECT( 'attachment', _attachment )) INTO _temp_result WHERE _new_attachment <> '[]';
           SELECT JSON_MERGE ( _temp_result, JSON_OBJECT( 'preattachment', _this_new_attachment )) INTO _temp_result WHERE _this_new_attachment <> '[]';


          SELECT JSON_ARRAY_INSERT(_new_nodes , '$[0]', _temp_result ) INTO _new_nodes;
          SELECT '[]' INTO _new_attachment ;
          SELECT '[]' INTO _this_new_attachment ;
          SELECT _idx_node + 1 INTO _idx_node;
        END WHILE;

      SELECT _idx_entity + 1 INTO _idx_entity;
      
    END WHILE;

 SELECT _mfs_copy mfs, JSON_UNQUOTE(_new_nodes) new_nodes ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_register` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_register`(
  IN _origin_id       VARCHAR(16),
  IN _user_filename   VARCHAR(512),
  IN _pid             VARCHAR(20),
  IN _category        VARCHAR(50),
  IN _extension       VARCHAR(100),
  IN _mimetype        VARCHAR(100),
  IN _geometry        VARCHAR(200),
  IN _file_size       INT(20) UNSIGNED,
  IN _show_results    BOOLEAN
)
BEGIN
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _src_db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(20);

  DECLARE _fileid   VARCHAR(16) DEFAULT '';
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _parent_id TEXT;
  DECLARE _root_id VARCHAR(16);
  DECLARE _parent_path TEXT;
  DECLARE _parent_name VARCHAR(100) DEFAULT '';
  DECLARE _file_path   VARCHAR(1024);
  DECLARE _file_name VARCHAR(1024);

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT yp.uniqueId() INTO _fileid;

  CALL mediaEnv(_vhost, _hub_id, _area, _home_dir, _home_id, _src_db_name, _accessibility);

  IF IFNULL(_pid, '0') IN('', '0') THEN 
    SELECT id FROM media WHERE parent_id='0' INTO  _pid;
  END IF;

  SELECT id, TRIM('/' FROM user_filename) FROM media WHERE id=_pid 
    INTO _parent_id, _parent_name;
  IF _parent_id IS NULL OR _parent_id='' THEN 
    SELECT id FROM media m WHERE m.parent_id='0' INTO  _parent_id;
    
  END IF;
  

  SELECT COUNT(*) FROM media WHERE parent_id = _pid INTO @_count;

  SELECT parent_path(_parent_id) INTO _parent_path;
  SELECT REPLACE(_user_filename, CONCAT('.', _extension), '') INTO _file_name;
  SELECT unique_filename(_parent_id, _file_name, _extension) INTO _file_name;
  SELECT CONCAT(_parent_path, '/', _parent_name, '/', _file_name, '.', _extension) 
    INTO _file_path;


  INSERT INTO `media` (
    id, 
    origin_id, 

    file_path, 
    user_filename, 
    parent_id, 
    parent_path,

    extension, 
    mimetype, 
    category,
    isalink,

    filesize, 
    `geometry`, 
    publish_time, 
    upload_time, 

    `status`,
    rank
  ) VALUES (
    _fileid, 
    _origin_id, 

    clean_path(_file_path), 
    TRIM('/' FROM _file_name),
    _pid, 
    _parent_path,

    _extension, 
    _mimetype, 
    _category, 
    0,

    IFNULL(_file_size, 4096),
    IFNULL(_geometry, '0x0'), 
    _ts, 
    _ts, 

    IF(_category='stylesheet', 'idle', 'active'),
    @_count
  );
  
  
  DROP TABLE IF EXISTS __register_stack;
  CREATE TEMPORARY TABLE __register_stack LIKE template.tmp_media;
  INSERT INTO __register_stack VALUES (
    _fileid, 
    _origin_id, 

    clean_path(_file_path), 
    _file_name,
    _pid, 
    _parent_path,

    _extension, 
    _mimetype, 
    _category, 
    0,

    IFNULL(_file_size, 4096),
    IFNULL(_geometry, '0x0'), 
    _ts, 
    _ts, 

    'active',
    @_count
  );

  SET @perm = 0;
  SET @s = CONCAT(
    "SELECT " ,_src_db_name,".user_permission (", 
    QUOTE(_origin_id),",",QUOTE(_fileid), ") INTO @perm");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;   

  IF _category NOT IN ('hub', 'folder') THEN 
    UPDATE media SET metadata=JSON_MERGE(
      IFNULL(metadata, '{}'), 
      JSON_OBJECT('_seen_', JSON_OBJECT(_origin_id, 1))
    )
    WHERE id=_fileid;
  END IF; 

  IF IFNULL(_show_results, 0) != 0  THEN
    SELECT 
      m.id, 
      m.id as nid, 
      concat(_home_dir, "/__storage__/") AS mfs_root,
      parent_id AS pid,
      parent_id,
      _hub_id AS holder_id,
      _home_id AS home_id,
      _home_dir AS home_dir,
      @perm  AS privilege,
      _hub_id AS owner_id,    
      _hub_id AS hub_id,    
      _vhost AS vhost,    
      user_filename AS filename,
      filesize,
      _area AS area,
      caption,
      _accessibility AS accessibility,
      capability,
      m.extension,
      m.extension AS ext,
      m.category AS ftype,
      m.category AS filetype,
      m.mimetype,
      download_count AS view_count,
      geometry,
      upload_time AS ctime,
      publish_time AS ptime,
      firstname,
      lastname,
      m.category,
      user_filename,
      file_path, 
      parent_path
      FROM media m LEFT JOIN (yp.filecap, yp.drumate) ON 
      m.extension=filecap.extension AND origin_id=yp.drumate.id 
      WHERE m.id = _fileid;
  END IF ;

  IF(SELECT count(*) FROM yp.disk_usage where hub_id=_hub_id) > 0 THEN 
    UPDATE yp.disk_usage SET size = (size + _file_size) WHERE hub_id = _hub_id;
  ELSE 
    INSERT INTO yp.disk_usage VALUES(null, _hub_id, _file_size);
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_remove_comment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_remove_comment`(
  IN _id          VARBINARY(16)
)
BEGIN
  DELETE FROM comment WHERE id = _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_rename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_rename`(
  IN _nid VARCHAR(16),
  IN _new_name VARCHAR(255)
)
BEGIN
  DECLARE _category VARCHAR(40);
  DECLARE _parent_id VARCHAR(16);
  DECLARE _old_name VARCHAR(255);
  DECLARE _uniq_name VARCHAR(255);
  DECLARE _extension VARCHAR(255);

  SELECT category, parent_id, user_filename FROM media WHERE id=_nid 
    INTO _category, _parent_id, _old_name;

  IF _new_name != TRIM('/' FROM _old_name) THEN 
    IF _category='folder' THEN
      SELECT REPLACE(file_path, CONCAT('.', extension), "/%"), extension
        FROM media WHERE id=_nid INTO @_pattern, _extension;
      SELECT unique_filename(_parent_id, _new_name, _extension) INTO _uniq_name;

      UPDATE media SET file_path=REPLACE(file_path, _old_name, _uniq_name) WHERE id=_nid;
      UPDATE media SET user_filename=_uniq_name WHERE id=_nid;
      UPDATE media SET file_path=REPLACE(file_path, _old_name, _uniq_name) 
        WHERE file_path LIKE @_pattern;
    ELSE
      UPDATE media SET user_filename=unique_filename(_parent_id, _new_name, _extension) WHERE id=_nid;
      UPDATE media SET file_path=filepath(_nid) WHERE id=_nid;
    END IF;
  END IF;

  

  SELECT
    *,
    extension as ext,
    id as nid,
    origin_id as oid,
    parent_id as pid,
    IF(parent_id='0', 'root', 'branch') as npos,
    TRIM(TRAILING '/' FROM user_filename) as fname,
    TRIM(TRAILING '/' FROM user_filename) as filename,
    category AS filetype,
    category as ftype
  FROM media WHERE id=_nid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_reorder` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_reorder`(
  IN _nodes JSON
)
BEGIN
  DECLARE _i INTEGER DEFAULT 0;
  DROP TABLE IF EXISTS __tmp_rank;
  CREATE TEMPORARY TABLE __tmp_rank(
    `rank` INTEGER,
    `id` varchar(16) CHARACTER SET utf8
  ); 

  WHILE _i < JSON_LENGTH(_nodes) DO 
     UPDATE media SET rank = _i 
       WHERE id = JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _i, "]")));
    INSERT INTO __tmp_rank 
      SELECT _i, JSON_VALUE(_nodes, CONCAT("$[", _i, "]"));
    SELECT _i + 1 INTO _i;
  END WHILE;

  SELECT * FROM __tmp_rank;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_replace_tree` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_replace_tree`(
  IN _nid VARCHAR(16),
  IN _pid VARCHAR(16),
  IN _recipient_id VARCHAR(16)
)
BEGIN
   
  DECLARE _src_db VARCHAR(255);
  DECLARE _des_db VARCHAR(255); 


  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _src_path       VARCHAR(1024); 
  DECLARE _des_path       VARCHAR(1024); 
  DECLARE _file_name      VARCHAR(512); 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50); 
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _seq            INTEGER;  
  DECLARE _id             VARCHAR(16);  

  
  SELECT  database() INTO _src_db;  
  SELECT db_name FROM yp.entity WHERE id=_recipient_id OR ident =_recipient_id INTO _des_db;

  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_src_db ,".parent_path(id),user_filename, '/') FROM " ,_src_db ,".media WHERE id =" ,QUOTE( _nid),
    "INTO @srcpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;


   SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename, '/') FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @descpattern ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;  


  SET @sql = CONCAT( 
    "SELECT CONCAT(" ,_des_db ,".parent_path(id),user_filename) FROM " ,_des_db ,".media WHERE id =" ,QUOTE( _pid),
    "INTO @despath ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;

 SELECT  clean_path(@srcpattern) INTO @srcpattern; 
 SELECT  clean_path(@despath) INTO @srcpath; 
 SELECT  clean_path(@descpattern) INTO @descpattern;   
  
    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT ''  ,
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' , 
      `is_checked` boolean default 0 ,
       lvl int(3),
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
    DROP TABLE IF EXISTS _des_media;
    CREATE TEMPORARY TABLE `_des_media` (
      
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT '',
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `xpath` varchar(5000) DEFAULT '' 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
   

  SET @sql = CONCAT(" 
    INSERT INTO _src_media 
    SELECT null, id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    clean_path(CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'.', extension )) xpath     
    ,null,null,0,0
    FROM  " ,_src_db ,".media m 
    WHERE m.category <> 'hub'  AND CONCAT(" ,_src_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@srcpattern,'%') ");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  SET @sql = CONCAT(" 
    INSERT INTO _des_media
    SELECT  id,origin_id,user_filename,category,parent_id, extension,mimetype,filesize,geometry,
    clean_path(REPLACE (clean_path(CONCAT(" ,_des_db ,".parent_path(id),'/',user_filename,'.',extension )),@despath,'' )) xpath 
    FROM  " ,_des_db ,".media m      	
    WHERE id <> ", QUOTE( _pid) ,"
    AND CONCAT(" ,_des_db ,".parent_path(id),user_filename,'/' ) 
    LIKE CONCAT(@descpattern,'%')");
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;  
 
 
 UPDATE _src_media SET new_parent_id = _pid where id = _nid; 

 UPDATE _src_media s,_des_media d SET s.new_parent_id = d.parent_id , s.new_id=d.id WHERE  s.xpath = d.xpath;

 DROP TABLE IF EXISTS _src_temp_media;
 CREATE TABLE _src_temp_media as SELECT * FROM _src_media;

 UPDATE _src_media s , _src_temp_media d SET s.new_parent_id = d.new_id  WHERE  s.parent_id = d.id;

 
 UPDATE _src_media set lvl= (LENGTH(xpath)-LENGTH(REPLACE(xpath, '/', '')));

 BEGIN
    DECLARE dbcursor CURSOR FOR SELECT seq,id,origin_id,user_filename,category,extension,mimetype,`geometry`,filesize FROM _src_media WHERE new_id is null order by lvl asc;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
        STARTLOOP: LOOP
         FETCH dbcursor INTO _seq,_id,_origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;


    
        SET @s1 = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_des_db,".__register_stack LIKE template.tmp_media"); 
        PREPARE stmt FROM @s1;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

        SET @s1 = CONCAT( "DELETE FROM ",_des_db,".__register_stack"); 
        PREPARE stmt1 FROM @s1;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
        
        SELECT new_parent_id  FROM _src_media WHERE seq =_seq INTO _pid; 

        SET @s2 = CONCAT("CALL ",_des_db,".mfs_register(",
            "'"  , _origin_id     , "'," ,
            "'"  , _file_name     , "'," ,
            "'"  , _pid           , "'," ,
            "'"  , _category      , "'," ,
            "'"  , _extension     , "'," ,
            "'"  , _mimetype      , "'," ,
            "'"  , _geometry      , "'," ,
                   _file_size     , ", 0 )"          
          );
        PREPARE stmt2 FROM @s2;
        EXECUTE stmt2;
        DEALLOCATE PREPARE stmt2;  

        SET @s3 = CONCAT( "SELECT id ,parent_id FROM ",_des_db,".__register_stack INTO @temp_nid,@pid");
        PREPARE stmt3 FROM @s3;
        EXECUTE stmt3;
        DEALLOCATE PREPARE stmt3;

        UPDATE _src_media SET new_id =@temp_nid , new_parent_id = @pid  WHERE seq =_seq ; 
        UPDATE _src_media SET new_parent_id =  @temp_nid    WHERE parent_id = _id; 
    END LOOP STARTLOOP;
   CLOSE dbcursor; 

 END;   



    SET @s3 = CONCAT( "DELETE FROM ",_des_db,".media WHERE id in (SELECT id from _des_media WHERE xpath NOT IN ( SELECT xpath FROM _src_media)) ");
    PREPARE stmt3 FROM @s3;
    EXECUTE stmt3;
    DEALLOCATE PREPARE stmt3;



    CALL mediaEnv(@_tmp, @tmp, @_tmp, @home_dir, @_tmp, @_tmp, @_tmp);   
    
    SET @s2 = CONCAT( "CALL ",_des_db,".mediaEnv(@_tmp, @_tmp, @_tmp, @des_home_dir, @_tmp, @_tmp, @_tmp)") ;
     PREPARE stmt2 FROM @s2;
     EXECUTE stmt2;
     DEALLOCATE PREPARE stmt2; 



  DROP TABLE IF EXISTS _final_media; 
      CREATE TEMPORARY TABLE `_final_media` (
      nid varchar(16) DEFAULT NULL,  
      new_id varchar(16) DEFAULT NULL,    
      action varchar(16) DEFAULT NULL,
      mfs_root varchar(1024)  DEFAULT NULL
      );   
        
 

  INSERT INTO   _final_media  
  SELECT new_id AS nid ,new_id AS dest_id, 'show'   AS action, null as mfs_root  FROM _src_media WHERE seq = 1 ;

  INSERT INTO   _final_media
  SELECT id   AS nid ,new_id AS dest_id, 'copy'   AS action, null as mfs_root  FROM _src_media WHERE category NOT IN ("folder","hub");

  INSERT INTO   _final_media
  SELECT id   AS nid ,null   AS dest_id, 'delete' AS action, CONCAT(@des_home_dir, "/__storage__/") as mfs_root  FROM _des_media WHERE xpath NOT IN ( SELECT xpath FROM  _src_media) AND category NOT IN ("folder","hub");

  SELECT * FROM  _final_media;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_restore` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_restore`(
  IN _id VARCHAR(16)
)
BEGIN
  
  DECLARE _category VARCHAR(40);
  DECLARE _node_path VARCHAR(6000);
  DECLARE _trash_parent_parent_path VARCHAR(6000);
  DECLARE _trash_parent_id VARCHAR(16);
  DECLARE _restore_parent_id VARCHAR(16);
  DECLARE _home_id VARCHAR(16);
  
  DECLARE _temp_id VARCHAR(16);
  DECLARE _trash_home_id VARCHAR(16);

  DECLARE _lvl INT;

  SELECT node_id_from_path('/__trash__') INTO _trash_home_id;
  
  SELECT category INTO _category FROM media t WHERE id = _id;
  SELECT id INTO _home_id FROM media t WHERE ( parent_id IS NULL OR parent_id="" OR parent_id='0');

  IF _id <> _home_id THEN 
    SELECT 
      id,
      clean_path(concat(parent_path(t.id), '/', t.user_filename))
    INTO 
      _trash_parent_id, 
      _trash_parent_parent_path 
    FROM media t WHERE id=(SELECT parent_id FROM media WHERE id = _id); 
    

    IF _trash_parent_id = _trash_home_id THEN 
      SELECT id FROM media WHERE ( parent_id IS NULL OR parent_id="" OR parent_id='0') INTO _restore_parent_id;
    ELSE  
      SELECT node_id_from_path(REPLACE(_trash_parent_parent_path,'/__trash__','')) INTO _restore_parent_id;
    END IF; 


    UPDATE media SET parent_id=_restore_parent_id, status='active' WHERE id=_id;  
    UPDATE media SET parent_path = parent_path(id),file_path = clean_path(concat(parent_path(id), '/', user_filename, '.', extension)) 
    WHERE id = _id;

    IF _category='folder' THEN
      SELECT CONCAT(parent_path(id),user_filename) FROM media WHERE id=_id INTO _node_path;
      UPDATE media 
        SET parent_path = parent_path(id),file_path = clean_path(concat(parent_path(id), '/', user_filename, '.', extension)), status='active'
      WHERE CONCAT(parent_path(id),user_filename ) LIKE concat(_node_path, '/%'); 
    END IF;

    WHILE  _trash_parent_id <> _trash_home_id AND IFNULL(_lvl,0) < 1000 DO 
      SELECT NULL INTO _temp_id;
      SELECT parent_id FROM media WHERE id =_trash_parent_id INTO _temp_id; 
      DELETE FROM media WHERE id = _trash_parent_id  AND  CONCAT(parent_path(id),user_filename ) LIKE concat('/__trash__', '/%'); 
      SELECT _temp_id INTO _trash_parent_id;
      SELECT IFNULL(_lvl,0) +1  INTO _lvl;
    END WHILE;
  ELSE 
    SELECT 1 failed, "Could not restore root itself";
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_restore_into` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_restore_into`(
  IN _nodes JSON,
  IN _uid VARCHAR(16)
)
BEGIN
  DECLARE _idx INT(4) DEFAULT 0; 
  DECLARE _nid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(40);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _dest_db VARCHAR(50);
  DECLARE _dest_home_dir VARCHAR(512);
  DECLARE _temp_nid  VARCHAR(16);


  DECLARE _dest_id VARCHAR(16);
  DECLARE _recipient_id VARCHAR(16);

  
  DECLARE _is_root tinyint(2) ;
  DECLARE _is_sbx tinyint(2) DEFAULT 0;
  DECLARE _origin_id      VARCHAR(16);   
  DECLARE _file_name      VARCHAR(512); 
  DECLARE _category       VARCHAR(50);   
  DECLARE _extension      VARCHAR(100); 
  DECLARE _mimetype       VARCHAR(100);      
  DECLARE _file_size      INT(20) UNSIGNED;
  DECLARE _geometry       VARCHAR(200);       
  DECLARE _status         VARCHAR(50); 
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _seq            INTEGER;  
  DECLARE _id             VARCHAR(16);   
  DECLARE _new_parent_id  VARCHAR(16);  

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE `_src_media` (
      `seq`  int NOT NULL AUTO_INCREMENT,
      `is_root` boolean default 0 ,
      `id` varchar(16) DEFAULT NULL,
      `origin_id` varchar(16) DEFAULT NULL,
      `user_filename` varchar(128) DEFAULT NULL,
      `category`      VARCHAR(50) DEFAULT NULL,
      `parent_id` varchar(16) DEFAULT null,
      `extension` varchar(100) NOT NULL DEFAULT '',
      `mimetype` varchar(100) NOT NULL,
      `filesize` int(20) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `new_id` varchar(16) DEFAULT NULL,  
      `new_parent_id` varchar(16) DEFAULT '' ,
      `is_checked` boolean default 0 ,
       home_dir VARCHAR(512) DEFAULT null,
       db_name VARCHAR(512) DEFAULT null,
       hub_id VARCHAR(16) DEFAULT null,
       dest_home_dir VARCHAR(512) DEFAULT null,
       dest_db_name VARCHAR(512) DEFAULT null,
       dest_hub_id VARCHAR(16) DEFAULT null,
    
       permission   tinyint(4) unsigned , 
       PRIMARY KEY `seq`(`seq`)  
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;


  DROP TABLE IF EXISTS _final_media; 
  CREATE TEMPORARY TABLE `_final_media` (
    nid varchar(16) DEFAULT NULL,  
    src_mfs_root varchar(1024) DEFAULT NULL,  
    des_id varchar(16) DEFAULT NULL,  
    des_mfs_root varchar(1024) DEFAULT NULL, 
    dest_hub_id VARCHAR(16) DEFAULT null, 
    dest_db_name VARCHAR(512) DEFAULT null,
    action varchar(16) DEFAULT NULL
    );

  
  


  WHILE _idx < JSON_LENGTH(_nodes) DO 
    DELETE FROM _src_media;

    
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _idx, "]"))) INTO @_node;
    SELECT JSON_VALUE(@_node, "$.nid") INTO _nid;
    SELECT JSON_VALUE(@_node, "$.hub_id") INTO _hub_id;
    SELECT JSON_VALUE(@_node, "$.pid") INTO _dest_id;
    SELECT JSON_VALUE(@_node, "$.recipient_id") INTO _recipient_id;
    
    SELECT db_name, home_dir FROM yp.entity WHERE id=_recipient_id  
      INTO _dest_db, _dest_home_dir;


    
    SET @st = CONCAT("CREATE TEMPORARY TABLE IF NOT EXISTS  ",
      _dest_db,".__register_stack LIKE template.__register_stack"
    ); 
    PREPARE stmt FROM @st;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;



    SELECT db_name, home_dir FROM yp.entity WHERE id=_hub_id INTO _hub_db ,_home_dir;
    
    
    SET @st = CONCAT("
      INSERT INTO _src_media SELECT 
      null,0, id, origin_id, user_filename, category, parent_id, 
      extension, mimetype, filesize, geometry, null, null, 0,
      ?, ?, ?, ?, ?, ?, 0
      FROM ", _hub_db , ".media m WHERE  parent_id <>'0' AND  m.id =?"
    );  
    PREPARE stmt FROM @st;
    EXECUTE stmt USING _home_dir, _hub_db, _hub_id, _dest_home_dir, _dest_db, _recipient_id, _nid;
    DEALLOCATE PREPARE stmt; 

    UPDATE _src_media SET new_parent_id = _dest_id  WHERE  id=_nid; 
    SELECT id FROM _src_media WHERE id = _nid INTO _temp_nid ;

     WHILE _temp_nid IS NOT NULL DO
       
        SELECT seq,id,origin_id,user_filename,category,extension,mimetype,`geometry`,filesize,new_parent_id ,is_root
        FROM _src_media WHERE id =_temp_nid 
        INTO _seq,_id,_origin_id,_file_name,_category,_extension,_mimetype,_geometry,_file_size, _new_parent_id,_is_root;        
     

        IF _category = 'hub' THEN
          
          IF _hub_id = _recipient_id   THEN
          
            SET @st = CONCAT("UPDATE ", _hub_db,
              ".media SET  file_path=?, parent_id=? WHERE id =?"
            );
            PREPARE stmt3 FROM @st;
            EXECUTE stmt3 USING _temp_nid, _new_parent_id, _temp_nid;
            DEALLOCATE PREPARE stmt3;

            SET @st = CONCAT("UPDATE ", _hub_db, 
              ".media SET parent_path=",_hub_db,".parent_path(?) WHERE id =?"
            );
            PREPARE stmt3 FROM @st;
            EXECUTE stmt3 USING _temp_nid, _temp_nid;
            DEALLOCATE PREPARE stmt3;


            SET @st = CONCAT( "UPDATE ",_hub_db, 
              ".media SET status='active', file_path =clean_path(concat(parent_path, '/', user_filename, '.', extension)) 
              WHERE id =?");
            PREPARE stmt3 FROM @st;
            EXECUTE stmt3 USING _temp_nid;
            DEALLOCATE PREPARE stmt3;

          END IF;
        
          IF _hub_id <> _recipient_id AND _is_root = 0  THEN
            SET @st = CONCAT("UPDATE ",_hub_db, 
              ".media m , (SELECT id FROM ",_hub_db,".media WHERE  parent_id = '0') p SET 
              m.parent_id =p.id, status='active',
              m.parent_path ='/',
              m.file_path =  clean_path(CONCAT('/', m.user_filename, '.', m.extension))
              WHERE m.id =?");
            PREPARE stmt3 FROM @st;
            EXECUTE stmt3 USING _temp_nid;
            DEALLOCATE PREPARE stmt3;
          END IF;

        ELSE 
          
          IF _category = 'folder' THEN
            SET @st = CONCAT("
              INSERT INTO _src_media SELECT 
              null,0, id, origin_id, user_filename, category, parent_id, 
              extension, mimetype, filesize, geometry, null, null, 0,
              ?, ?, ?, ?, ?, ?, 0
              FROM ", _hub_db , ".media m WHERE m.parent_id =?"
            );  
            PREPARE stmt FROM @st;
            EXECUTE stmt USING _home_dir, _hub_db, _hub_id, _dest_home_dir, _dest_db, _recipient_id, _temp_nid;
            DEALLOCATE PREPARE stmt; 
          END IF ;

          SET @st = CONCAT( "DELETE FROM ",_hub_db,".media WHERE category <> 'hub' AND id= ",QUOTE(_temp_nid));
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3;
          DEALLOCATE PREPARE stmt3;


          SET @st = CONCAT( "DELETE FROM ",_dest_db,".__register_stack"); 
          PREPARE stmt1 FROM @st;
          EXECUTE stmt1;
          DEALLOCATE PREPARE stmt1;

          SET @st = CONCAT("CALL ", _dest_db, ".mfs_new_node(?,?,?,?,?,?,?,?,?,?)");
          PREPARE stmt2 FROM @st;
          EXECUTE stmt2 USING 
            _origin_id     ,
            _uid           ,
            _file_name     ,
            _new_parent_id ,
            _category      ,
            _extension     ,
            _mimetype      ,
            _geometry      ,
            _file_size     , 
            0;           
          DEALLOCATE PREPARE stmt2;


          SET @st = CONCAT( "SELECT id ,parent_id FROM ",
            _dest_db,".__register_stack INTO @temp_nid, @pid");
          PREPARE stmt3 FROM @st;
          EXECUTE stmt3;
          DEALLOCATE PREPARE stmt3;   
                  
          UPDATE _src_media SET new_id = @temp_nid WHERE seq = _seq ; 
          UPDATE _src_media SET new_parent_id = @temp_nid WHERE parent_id = _temp_nid; 
        END IF;

          
        UPDATE _src_media SET is_checked = 1 WHERE id = _temp_nid ;
        SELECT NULL,NULL,NULL INTO _temp_nid ,@temp_nid,@pid;
        SELECT id FROM _src_media WHERE is_checked =0 AND new_parent_id IS NOT NULL LIMIT 1 INTO _temp_nid ;

     END WHILE;
    
    INSERT INTO _final_media  
    SELECT IFNULL(new_id,id) ,NULL ,NULL, NULL,dest_hub_id ,dest_db_name,'showone' FROM _src_media WHERE seq=1; 
    INSERT INTO _final_media 
    SELECT IFNULL(new_id,id),NULL ,NULL, NULL,dest_hub_id ,dest_db_name,'show' FROM _src_media WHERE is_root=1;

    
    

    INSERT INTO _final_media  
    SELECT id ,  CONCAT(home_dir, "/__storage__/") ,  new_id , CONCAT(dest_home_dir, "/__storage__/")  ,dest_hub_id,dest_db_name , 'copy'  
    FROM _src_media WHERE category NOT IN ("folder","hub") ; 
    INSERT INTO _final_media
    SELECT id , CONCAT(home_dir, "/__storage__/") , NULL ,NULL, dest_hub_id,dest_db_name ,'delete'  FROM _src_media WHERE category NOT IN ("folder","hub") ;  
 

    SELECT _idx + 1 INTO _idx;
  END WHILE;
  SELECT * FROM _final_media;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_root_conflict_files` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_root_conflict_files`(
  IN _src_ids VARCHAR(5000),
  IN _dest_pids VARCHAR(5000),
  IN _des_entity_id VARCHAR(16)
  )
BEGIN
  DECLARE _category VARCHAR(40);
  DECLARE _src_db   VARCHAR(255);
  DECLARE _des_db   VARCHAR(255);
 
  
  SELECT DATABASE()  INTO _src_db;
  SELECT db_name from yp.entity WHERE id=_des_entity_id INTO _des_db;

  
    SELECT ',' INTO @dlm;
    SELECT _src_ids INTO @lst;
    DROP TABLE IF EXISTS _src_lsttbl; 
    CREATE TEMPORARY TABLE _src_lsttbl(`id` varchar(16) DEFAULT NULL); 
    SELECT  LENGTH(@lst) - LENGTH(REPLACE(@lst, @dlm, '')) into @lmt;
    SELECT @lmt+1 into @lmt;
    
    INSERT INTO _src_lsttbl
    SELECT
      SUBSTRING_INDEX(SUBSTRING_INDEX(mytbl.id, @dlm, cnt.n), @dlm, -1) id
    FROM
      (
        SELECT (ons + 10*tns +100*hrds) +1 n FROM 
        (SELECT 0 ons UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) a,
        (SELECT 0 tns UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) b,
            (SELECT 0 hrds UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) c
        WHERE (ons + 10*tns +100*hrds +1)<=@lmt
        ) cnt 
    INNER JOIN (SELECT @lst as id) mytbl ON CHAR_LENGTH(mytbl.id)-CHAR_LENGTH(REPLACE(mytbl.id, @dlm, ''))>=cnt.n-1;
  
  
  
    SELECT ',' INTO @dlm;
    SELECT _dest_pids INTO @lst;
    DROP TABLE IF EXISTS _dest_lsttbl; 
    CREATE TEMPORARY TABLE _dest_lsttbl(`id` varchar(16) DEFAULT NULL); 
    SELECT  LENGTH(@lst) - LENGTH(REPLACE(@lst, @dlm, '')) into @lmt;
    SELECT @lmt+1 into @lmt;
    
    INSERT INTO _dest_lsttbl
    SELECT
      SUBSTRING_INDEX(SUBSTRING_INDEX(mytbl.id, @dlm, cnt.n), @dlm, -1) id
    FROM
      (
        SELECT (ons + 10*tns +100*hrds) +1 n FROM 
        (SELECT 0 ons UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) a,
        (SELECT 0 tns UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) b,
            (SELECT 0 hrds UNION SELECT 1  UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) c
        WHERE (ons + 10*tns +100*hrds +1)<=@lmt
        ) cnt 
    INNER JOIN (SELECT @lst as id) mytbl ON CHAR_LENGTH(mytbl.id)-CHAR_LENGTH(REPLACE(mytbl.id, @dlm, ''))>=cnt.n-1;
  


    SET @sql = CONCAT(
    '   SELECT 
          s.id source_id,
          s.category ,
          s.user_filename name,
          dp.id dest_id,
          dp.user_filename availablein

        FROM ',_src_db,' .media s
            INNER JOIN ',_des_db,'.media d ON d.user_filename= s.user_filename
            AND s.category = d.category
            INNER JOIN _dest_lsttbl dl on d.parent_id = dl.id
            INNER JOIN _src_lsttbl sl on sl.id = s.id
            INNER JOIN ',_des_db,'.media dp on dp.id=dl.id
            ');
        
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_root_is_exist` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_root_is_exist`(
  IN _src_id VARCHAR(16),
  IN _dest_pid VARCHAR(16),
  IN _des_entity_id VARCHAR(16)
  )
BEGIN
  DECLARE _category VARCHAR(40);
  DECLARE _src_db   VARCHAR(255);
  DECLARE _des_db   VARCHAR(255);

  SELECT DATABASE()  INTO _src_db;
  SELECT db_name from yp.entity WHERE id=_des_entity_id INTO _des_db;

    SET @sql = CONCAT(
    ' SELECT 
          CASE 
              WHEN source.category in ("folder") THEN  2 
              ELSE 1 END status, source.id as nid, destination.id as dest_id
        FROM ',_src_db,' .media source
            INNER JOIN ',_des_db,'.media destination ON destination.user_filename= source.user_filename
            AND source.category = destination.category AND destination.status  = "active"
        WHERE 
          (source.id =''',_src_id,''') AND
          destination.parent_id=''',_dest_pid,'''');
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_search`(
  IN _pattern VARCHAR(84),
  IN _cat VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT   
    media.id   as nid,
    origin_id  AS origin_id,
    @entity_id AS oid,
    extension as ext,
    media.category as filetype,
    user_filename as filename,
    firstname,
    lastname,
    caption,
    filesize,
    upload_time as mtime,
    download_count as views,
    MATCH(`caption`,`user_filename`,`file_path`,`metadata`)
      against(_pattern IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION)
    + IF(MATCH(`caption`,`user_filename`,`file_path`,`metadata`)
      against(concat(_pattern, '*') IN BOOLEAN MODE), 30, 0)
    + IF(user_filename = _pattern, 100, 0)
    + IF(user_filename LIKE concat("%", _pattern, "%"), 27, 0) AS score
    FROM media INNER JOIN yp.drumate ON origin_id=drumate.id HAVING  score > 25 
    AND media.category=_cat
    ORDER BY score DESC, mtime ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_set_attr` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_set_attr`(
  IN _id        VARCHAR(16),
  IN _column    VARCHAR(200),
  IN _value     JSON
)
BEGIN
  IF _column='metadata' THEN
    IF NOT JSON_VALID(_value) THEN
      SELECT '{}' INTO _value;
    END IF;
    IF JSON_VALID(_value) THEN 
      UPDATE media SET metadata=_value where id=_id;
    END IF;
  ELSE 
    SET @s = CONCAT("UPDATE media SET `", _column, "`='", _value, "' WHERE id='", _id, "'");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;
  CALL mfs_node_attr(_id);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_set_attributes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_set_attributes`(
  IN _column    VARCHAR(200),
  IN _value     VARCHAR(2000),
  IN _id        VARCHAR(16)
)
BEGIN
  SET @s = CONCAT("UPDATE media SET `", _column, "`='", _value, "' WHERE id='", _id, "'");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  CALL mfs_node_attr(_id);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_set_home_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_set_home_id`(
)
BEGIN
  DECLARE _i INT(4) DEFAULT 0; 
  DECLARE _pid VARCHAR(16);
  DECLARE _status VARCHAR(16);
  DECLARE _path TEXT;
  SELECT id FROM media WHERE parent_id='0' INTO _pid;
  UPDATE yp.entity SET home_id=_pid WHERE db_name=database(); 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_set_metadata` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_set_metadata`(
  IN _id        VARCHAR(16),
  IN _value     JSON,
  IN _show_res BOOLEAN    
)
BEGIN

  DECLARE _idx INTEGER DEFAULT 0;
  DECLARE _key VARCHAR(100);
  DECLARE _val JSON;

  IF JSON_VALID(_value) THEN 
    SELECT JSON_KEYS(_value) INTO @_keys;
    WHILE _idx < JSON_LENGTH(@_keys) DO 
      SELECT get_json_array(@_keys, _idx) INTO _key;
      SELECT get_json_object(_value, _key) INTO _val;
      
      UPDATE media SET metadata=JSON_SET(metadata, CONCAT("$.", _key), _val) WHERE id=_id;
      SELECT _idx + 1 INTO _idx;
    END WHILE;
  END IF;
  IF _show_res THEN 
    CALL mfs_node_attr(_id);
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_share_file` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_share_file`(
  IN _node_id VARCHAR(16),
  IN _dest_id VARCHAR(16),
  IN _dest_hub VARCHAR(100)
)
BEGIN

  DECLARE _id VARCHAR(16);
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _db_name VARCHAR(30);

  SELECT db_name  FROM yp.entity 
    WHERE id=_dest_id OR ident=_dest_id OR utils.vhost(ident)=_dest_id INTO _db_name;

  SELECT yp.uniqueId() INTO _id;
  SELECT UNIX_TIMESTAMP() INTO _ts;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_bin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_show_bin`(
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _id          VARCHAR(16); 



  CALL pageToLimits(_page, _offset, _range);

  
  DROP TABLE IF EXISTS _bin_media;
  CREATE TEMPORARY TABLE _bin_media  AS
  SELECT
    m.id  AS nid,
    m.parent_id AS pid,
    m.parent_id AS parent_id,
    _home_id AS home_id,
    ff.capability,
    me.id AS owner_id,
    me.id AS hub_id,
    m.status AS status,
    m.user_filename AS filename,
    m.filesize AS filesize,
    yp.vhost(me.id) AS vhost,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    m.mimetype,
    m.upload_time AS ctime,
    m.publish_time AS mtime
  FROM  media m
    INNER JOIN yp.entity me  ON me.db_name=database()
    LEFT JOIN yp.filecap ff ON m.extension=ff.extension
  WHERE 
  parent_id NOT IN (SELECT id FROM media WHERE status='deleted')
  AND m.status='deleted';
 

  BEGIN
    DECLARE dbcursor CURSOR FOR 
      SELECT db_name FROM yp.entity WHERE id IN (
        SELECT id FROM media m INNER JOIN permission p 
          ON p.resource_id = m.id AND p.permission=63 AND m.status='active'
      );
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _db_name ;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    
      SET @sql = CONCAT("
        INSERT INTO _bin_media 
        (
        nid, pid, parent_id, home_id, capability,
        owner_id, hub_id, status, filename, filesize,
        vhost, ext, ftype, filetype,
        mimetype, ctime, mtime
        )
        SELECT 
        m.id  AS nid,
        m.parent_id AS pid,
        m.parent_id AS parent_id,
        me.home_id AS home_id,
        ff.capability,
        me.id AS owner_id,
        me.id AS hub_id,
        m.status AS status,
        m.user_filename AS filename,
        m.filesize AS filesize,
        yp.vhost(me.id) AS vhost,
        m.extension AS ext,
        m.category AS ftype,
        m.category AS filetype,
        m.mimetype,
        m.upload_time AS ctime,
        m.publish_time AS mtime
      FROM ", _db_name, ".media m
        INNER JOIN yp.entity me ON me.db_name=", QUOTE(_db_name),"
        LEFT JOIN yp.filecap ff ON m.extension=ff.extension
      WHERE 
        parent_id NOT IN (SELECT id FROM ", _db_name, ".media WHERE status='deleted')
        AND m.status='deleted'
      ");

      PREPARE stmt FROM @sql;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;       
      END LOOP STARTLOOP;   

    CLOSE dbcursor;
  END;  


  SELECT *, _page AS page FROM _bin_media ORDER BY ctime, filename DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_bin_tmp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_show_bin_tmp`(
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _vhost VARCHAR(255);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _area VARCHAR(50);
  DECLARE _home_dir VARCHAR(512);
  DECLARE _home_id VARCHAR(16);
  DECLARE _sb_db_name VARCHAR(255);  
  DECLARE _db_name VARCHAR(50);
  DECLARE _accessibility VARCHAR(16);
  DECLARE _finished       INTEGER DEFAULT 0;
  DECLARE _id          VARCHAR(16); 

  SELECT s.db_name FROM yp.entity e 
    INNER JOIN yp.share_box sb on sb.owner_id=e.id 
    INNER JOIN yp.entity s on s.id=sb.id  
  WHERE e.db_name = DATABASE() INTO _sb_db_name; 

  CALL pageToLimits(_page, _offset, _range);
  CALL mediaEnv(_vhost, _hub_id, _area, _home_dir, _home_id, _db_name, _accessibility);

  DROP TABLE IF EXISTS  _bin_media;  
      CREATE TEMPORARY TABLE `_bin_media` (
      `nid` varchar(16) DEFAULT NULL,
      `pid` varchar(16) NOT NULL DEFAULT '',
      `parent_id` varchar(16) NOT NULL DEFAULT '',
      `hub_id` varchar(16) DEFAULT NULL,
      `home_id` varchar(16) DEFAULT NULL,
      `oid` varchar(16) DEFAULT NULL,
      `caption` varchar(1024) DEFAULT NULL,
      `capability` varchar(8) DEFAULT '---',
      `accessibility` varchar(20),
      `status` varchar(20) DEFAULT NULL,
      `ext` varchar(100) NOT NULL DEFAULT '',
      `ftype` enum('hub', 'web' ,'folder','link','video','image','audio','document','stylesheet','script','vector','other') NOT NULL DEFAULT 'other',
      `filetype` enum('hub', 'web' ,'folder','link','video','image','audio','document','stylesheet','script','vector','other') NOT NULL DEFAULT 'other',
      `mimetype` varchar(100) NOT NULL,
      `view_count` mediumint(8) unsigned NOT NULL DEFAULT '0',
      `geometry` varchar(200) NOT NULL DEFAULT '0x0',
      `ctime` int(11) unsigned NOT NULL DEFAULT '0',
      `ptime` int(11) unsigned NOT NULL DEFAULT '0',
      `parent_path` varchar(1024) NOT NULL,
      `user_path` text NOT NULL,
      `filename` varchar(128) DEFAULT NULL,
      `filesize` double DEFAULT NULL,
      `firstname` char(200) DEFAULT NULL,
      `lastname` char(200) DEFAULT NULL,
      `remit` tinyint(4) DEFAULT '0',
      `vhost` varchar(512) DEFAULT NULL,
      `page` int(4) DEFAULT NULL,
      `area` varchar(100) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;   


  INSERT INTO _bin_media
  SELECT
    media.id  AS nid,
    media.parent_id AS pid,
    media.parent_id AS parent_id,
    _hub_id AS holder_id,
    _home_id AS home_id,
    IF(media.category='hub', 
      (SELECT id FROM yp.entity WHERE entity.id=media.id), _hub_id
    ) AS oid,    
    media.caption,
    capability,
    IF(media.category='hub', (
      SELECT accessibility FROM yp.entity WHERE entity.id=media.id), _accessibility
    ) AS accessibility,
    media.status,
    
    
    
    media.extension AS ext,
    media.category AS ftype,
    media.category AS filetype,
    media.mimetype,
    media.download_count AS view_count,
     media.geometry,
    media.upload_time AS ctime,
    media.publish_time AS ptime,
     media.parent_path,
    IF(media.parent_path='' or media.parent_path is NULL , '/', media.parent_path) AS user_path,
    IF(media.category='hub', (
      SELECT `name` FROM yp.hub WHERE hub.id=media.id), media.user_filename
    ) AS filename,
    IF(media.category='hub', (
      SELECT space FROM yp.entity WHERE entity.id=media.id), media.filesize
    ) AS filesize,
    firstname,
    lastname,
    remit,
    IF(media.category='hub', (
      SELECT utils.vhost(ident) FROM yp.entity WHERE entity.id=media.id), _vhost
    ) AS vhost,    
   
    _page as page,
    IF(media.category='hub', media.extension, _area) AS area
  FROM  media media 
  LEFT JOIN (yp.filecap, yp.drumate) ON  media.extension=filecap.extension AND media.origin_id=yp.drumate.id 
  WHERE 
  parent_id NOT IN (SELECT id FROM media WHERE status='deleted')
  AND media.status='deleted';
 

  SET @sql = CONCAT("
    INSERT INTO _bin_media 
    (
    nid,pid,parent_id,user_path,parent_path,filename,
    status,ext,ftype,filetype,mimetype,
    ctime,ptime, hub_id, home_id,vhost
    )
    SELECT 
    m.id,parent_id,parent_id,IF(parent_path='' or parent_path is NULL , '/', parent_path),parent_path,user_filename,
    m.status,m.extension,m.category,m.category,mimetype,
    upload_time,publish_time,
    me.id,me.id, utils.vhost(me.ident)
    FROM " ,_sb_db_name ,".media m
    INNER JOIN yp.entity me  ON me.db_name=", QUOTE(_sb_db_name),"
    WHERE 
     parent_id NOT IN (SELECT id FROM " ,_sb_db_name , ".media WHERE status='deleted')
    AND m.status='deleted'");

  PREPARE stmt FROM @sql ;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;  


  BEGIN
    DECLARE dbcursor CURSOR FOR  SELECT db_name FROM  yp.entity WHERE id IN(SELECT id FROM media WHERE category = 'hub' AND status='active');
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
    OPEN dbcursor;
     
      STARTLOOP: LOOP
        FETCH dbcursor INTO _db_name ;
         IF _finished = 1 THEN 
            LEAVE STARTLOOP;
         END IF;    

            SET @sql = CONCAT("
            INSERT INTO _bin_media 
            (
            nid,pid,parent_id,user_path,parent_path,filename,
            status,ext,ftype,filetype,mimetype,
            ctime,ptime, hub_id, home_id,vhost
            )
            SELECT 
            m.id,parent_id,parent_id,IF(parent_path='' or parent_path is NULL , '/', parent_path),parent_path,user_filename,
            m.status,m.extension,m.category,m.category,mimetype,
            upload_time,publish_time,
            me.id,me.id, utils.vhost(me.ident)
            FROM " ,_db_name ,".media m
            INNER JOIN yp.entity me  ON me.db_name=", QUOTE(_db_name),"
            LEFT JOIN " ,_db_name ,".permission p on p.entity_id = ",QUOTE(_hub_id)," AND  p.resource_id = m.id
            WHERE 
            ( IFNULL(p.expiry_time,0) = 0 OR   IFNULL(p.expiry_time,0) > UNIX_TIMESTAMP() )
            AND parent_id NOT IN (SELECT id FROM " ,_db_name , ".media WHERE status='deleted')
            AND m.status='deleted'");

            

            PREPARE stmt FROM @sql ;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;       
      END LOOP STARTLOOP;   

    CLOSE dbcursor;
  END;  


  SELECT * FROM _bin_media ORDER BY ctime, filename DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_branch` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_show_branch`(
  IN _nid VARCHAR(16)
)
BEGIN
  DECLARE _file_path TEXT DEFAULT NULL;
  DECLARE _db_name VARCHAR(80) DEFAULT NULL;
  DECLARE _home_dir VARCHAR(2000) DEFAULT NULL;
  DECLARE _eid VARCHAR(16) DEFAULT NULL;
  DECLARE _name VARCHAR(80) DEFAULT NULL;

  DROP TABLE IF EXISTS __tmp_tree;
  SELECT e.home_dir, COALESCE(h.name, d.fullname) FROM yp.entity e
    LEFT JOIN yp.hub h ON e.id = h.id AND e.type='hub'
    LEFT JOIN yp.drumate d ON e.id = d.id AND e.type='drumate'
    WHERE e.db_name=database() INTO _home_dir, _name;

  CREATE TEMPORARY TABLE __tmp_tree AS SELECT 
    id, _home_dir AS home_dir, file_path, status, filesize, 
    user_filename, extension, category
  FROM media where 1=2;
  INSERT INTO __tmp_tree
    WITH RECURSIVE __parent_tree AS
    (
      SELECT
        m.id, 
        _home_dir AS home_dir, 
        m.file_path,
        m.status, 
        m.filesize,
        m.user_filename, 
        m.extension, 
        m.category
      FROM
        media m
        WHERE m.id = _nid 
      UNION ALL
        SELECT
        m.id, 
        _home_dir AS home_dir, 
        m.file_path,
        m.status, 
        m.filesize,
        m.user_filename, 
        m.extension, 
        m.category
      FROM
        media AS m
      INNER JOIN __parent_tree AS t ON m.parent_id = t.id
    )
    SELECT * FROM __parent_tree WHERE status='active' ORDER BY category ASC;
  BEGIN
    DECLARE _finished INTEGER DEFAULT 0;
    DECLARE dbcursor CURSOR FOR SELECT e.id, e.home_dir,
      REPLACE(clean_path(file_path), CONCAT('.', CAST(e.id AS CHAR CHARACTER SET utf8mb4)), ''), 
      db_name FROM __tmp_tree m
      INNER JOIN (yp.entity e, permission p) ON m.id=e.id AND p.resource_id=m.id 
      WHERE m.category='hub' AND permission&32;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
    OPEN dbcursor;
      STARTLOOP: LOOP
        FETCH dbcursor INTO _eid, _home_dir, _file_path, _db_name;
        IF _finished = 1 THEN 
          LEAVE STARTLOOP;
        END IF;    
        SET @s = CONCAT("INSERT INTO __tmp_tree SELECT id, ", 
          QUOTE(_home_dir),
          ", clean_path(CONCAT(", 
          QUOTE(_file_path), 
          ", file_path)), status, filesize, user_filename, extension, category FROM ", 
          _db_name, 
          ".media WHERE extension !='root' 
          AND status='active'");
        
        IF @s IS NOT NULL THEN 
          PREPARE stmt FROM @s;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt;
        END IF;
       END LOOP STARTLOOP;
    CLOSE dbcursor;
  END;

  SELECT 
    id, 
    TRIM(TRAILING '/' FROM home_dir) home_dir, 
    CASE category 
      WHEN 'hub' THEN TRIM(LEADING '/' FROM 
        TRIM(TRAILING CONCAT('.', id) FROM file_path)
      )
      WHEN 'folder' THEN TRIM(LEADING '/' FROM 
        TRIM(TRAILING CONCAT('.', extension) FROM file_path)
      )
      ELSE TRIM(LEADING '/' FROM file_path)
    END file_path,

    status, 
    filesize, 
    user_filename, 
    extension, 
    category
  FROM __tmp_tree WHERE NOT file_path REGEXP '__trash__/';

  SELECT sum(filesize) AS size FROM __tmp_tree;
  SELECT IF(user_filename = '' OR user_filename IS NULL, _name, user_filename) AS filename 
    FROM media WHERE id=_nid;
  SELECT count(*) AS amount, sum(filesize) AS size, category 
    FROM __tmp_tree GROUP BY category;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_folders` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_show_folders`(
  IN _node_id VARCHAR(16),
  IN _uid VARCHAR(16),
  IN _sort_by VARCHAR(20),
  IN _order   VARCHAR(20),
  IN _page    TINYINT(4)
)
BEGIN
 
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _home_id VARCHAR(16);
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _finished       INTEGER DEFAULT 0; 
  DECLARE _nid VARCHAR(16);  
  DECLARE _hub_db_name VARCHAR(255);
  DECLARE _ftype VARCHAR(255);

 

  CALL pageToLimits(_page, _offset, _range);  
  
  SELECT id  from media where parent_id='0' INTO _home_id;
  IF _node_id IS NULL OR _node_id='0' THEN 
    SELECT _home_id INTO _node_id;
  END IF;
    

  DROP TABLE IF EXISTS _show_node;
  CREATE TEMPORARY TABLE _show_node  AS  
  SELECT 
    m.id  AS nid,
    m.parent_id AS pid,
    m.parent_id AS parent_id,
    m.file_path as filepath,
    me.id  AS holder_id,    
    _home_id  AS home_id,   
    ff.capability,
    COALESCE(sbx.db_name, database()) src_db_name,
    he.db_name   hub_db_name,
    COALESCE(he.accessibility,me.accessibility) AS  accessibility,
    COALESCE(he.id,me.id) AS owner_id,
    COALESCE(he.id,me.id) AS hub_id,
    utils.vhost(COALESCE(sbx.ident,he.ident,me.ident)) AS vhost,
    COALESCE(he.status,m.status) AS status,
    COALESCE(hh.name,m.user_filename) AS filename,
    COALESCE(me.space,m.filesize) AS filesize,
    IF(m.category='hub', m.extension, me.area) AS area,
    m.caption,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    m.mimetype,
    m.metadata,
    m.download_count AS view_count,
    m.geometry,
    m.upload_time AS ctime,
    m.publish_time AS ptime,
    d.firstname,
    d.lastname,
    _page as page,
    m.rank,
    CASE 
      WHEN m.file_path REGEXP "^/__Outbound__" THEN 'outbound' 
      WHEN m.file_path REGEXP "^/__Inbound__" THEN 'inbound' 
      ELSE 'nobound' 
    END shared
    
    
    
  FROM media m
    INNER JOIN yp.entity me  ON me.db_name=database()
    LEFT  JOIN yp.filecap ff ON m.extension=ff.extension
    LEFT  JOIN yp.drumate d ON  m.origin_id=d.id 

    LEFT  JOIN yp.entity he ON m.id = he.id AND m.category='hub'
    LEFT  JOIN yp.hub hh ON m.id = hh.id AND m.category='hub'

    LEFT JOIN yp.entity sbx on m.origin_id = sbx.id  AND parent_path(m.id) LIKE CONCAT('/__Inbound__/','%','/') 
  WHERE m.parent_id=_node_id AND m.status='active' AND (m.category='folder' OR m.category='hub');
  

  ALTER table _show_node ADD privilege  tinyint(4) unsigned ;
  ALTER table _show_node ADD  expiry_time int(11) ;
  ALTER table _show_node ADD  actual_home_id VARCHAR(16) ;

  BEGIN
    DECLARE dbcursor CURSOR FOR SELECT  nid, src_db_name ,ftype,hub_db_name FROM _show_node;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1; 
    OPEN dbcursor;
      STARTLOOP: LOOP
        FETCH dbcursor INTO _nid,_src_db_name ,_ftype,_hub_db_name;
        
          IF _finished = 1 THEN 
            LEAVE STARTLOOP;
          END IF;
        
          SET @perm = 0;
          SET @s = CONCAT("SELECT " ,_src_db_name,".user_permission (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @perm");
          PREPARE stmt FROM @s;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt; 
          
          SET @resexpiry = null;    
          SET @s = CONCAT("SELECT " ,_src_db_name,".user_expiry (", QUOTE(_uid),",",QUOTE(_nid), ") INTO @resexpiry");
          PREPARE stmt FROM @s;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt;

          
          SELECT NULL INTO @actual_home_id ;
          IF _ftype = 'hub' AND _hub_db_name IS NOT NULL  THEN 
            SET @s = CONCAT("SELECT id from ", _hub_db_name ," .media where parent_id='0' INTO @actual_home_id");
            PREPARE stmt FROM @s;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;
          END IF ;
                 
          UPDATE _show_node s SET privilege = @perm, expiry_time = @resexpiry, 
            actual_home_id = IFNULL(@actual_home_id , home_id)
          WHERE nid = _nid;

        END LOOP STARTLOOP; 
    CLOSE dbcursor;
  END; 
  
  SELECT 
    nid, 
    pid,
    parent_id, 
    holder_id,    
    home_id, 
    actual_home_id,
    capability,
    privilege,
    accessibility,
    owner_id,
    hub_id,
    vhost,
    status,
    filename,
    filesize,
    area,
    caption,
    ext,
    ftype,
    filetype,
    mimetype,
    metadata,
    view_count,
    geometry,
    ctime,
    ptime,
    firstname,
    lastname,
    page,
    rank,
    shared
    
  FROM 
    _show_node
  WHERE (expiry_time = 0 OR expiry_time > UNIX_TIMESTAMP())
  ORDER BY 
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN ctime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN ctime END DESC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN filename END ASC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN filename END DESC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'asc' THEN rank END ASC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'desc' THEN rank END DESC
      
    
  LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_show_new`(
  IN _node_id VARCHAR(16) CHARACTER SET utf8,
  IN _uid VARCHAR(16),
  IN _page    TINYINT(4)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _tempid VARCHAR(16);
  DECLARE _category VARCHAR(16);
  DECLARE _lvl INT;
  DECLARE _hub_db_name VARCHAR(255);
  DECLARE _hubs MEDIUMTEXT DEFAULT NULL;
  DECLARE _hub_id VARCHAR(16);
  DECLARE _type VARCHAR(255);
    CALL pageToLimits(_page, _offset, _range);
    SELECT type,id FROM yp.entity WHERE db_name = database() INTO  _type,_hub_id;
  
    DROP TABLE IF EXISTS __output_count; 
    CREATE TEMPORARY TABLE `__output_count` (
      seq  int NOT NULL AUTO_INCREMENT,
      id varchar(16),
      owner_id varchar(16) DEFAULT NULL, 
      hub_id varchar(16) DEFAULT NULL, 
      preview varchar(1000),
      category enum('media','chat') DEFAULT 'media',
      PRIMARY KEY `seq`(`seq`),
      UNIQUE KEY `id`(`hub_id`,`id`)
    );


    DROP TABLE IF EXISTS _show_node; 
    CREATE TEMPORARY TABLE _show_node (
     `seq`  int NOT NULL AUTO_INCREMENT,
     `id` varchar(16),
     `parent_id` varchar(16), 
     `category` varchar(16) ,
      PRIMARY KEY `seq`(`seq`) 
    );

    INSERT INTO _show_node 
    (id, parent_id ,category)
    WITH RECURSIVE mytree AS 
    ( 
      SELECT id, parent_id ,category
      FROM media WHERE id = _node_id 
        AND category IN('hub', 'folder')
        UNION ALL
      SELECT m.id,m.parent_id ,m.category
      FROM media AS m JOIN mytree AS t ON m.parent_id = t.id
        AND m.category IN('hub', 'folder')
    )SELECT id, parent_id ,category FROM mytree;
 
     
    SELECT MAX(seq) FROM _show_node  INTO _lvl; 
    SELECT id,category FROM _show_node WHERE seq = _lvl 
      INTO _tempid  ,_category;


    WHILE ( _lvl >= 1 AND  _tempid IS NOT NULL) DO
      IF (_category = 'hub') THEN
        SELECT db_name FROM yp.entity WHERE id = _tempid
        INTO _hub_db_name; 

 
        SET @s = CONCAT(
            "REPLACE INTO __output_count (id, owner_id, hub_id, preview, category) ",
            "SELECT message_id, author_id, ?, SUBSTRING(`message`, 1, 80), 'chat' FROM 
            ", _hub_db_name,".channel where sys_id >(SELECT 
            IFNULL((SELECT ref_sys_id FROM ", _hub_db_name,".read_channel 
            WHERE uid = ?),0))"
          );
        PREPARE stmt FROM @s;
        EXECUTE stmt USING _hub_id,  _uid;
        DEALLOCATE PREPARE stmt;

        SET @s = CONCAT(
            "REPLACE INTO __output_count (id, owner_id, hub_id, preview) ",
            "SELECT id, owner_id, ?, file_path FROM ", _hub_db_name ,
            ".media WHERE file_path not REGEXP '^/__(chat|trash)__' AND ",
            "is_new(metadata, owner_id, ?)"
         );
        PREPARE stmt FROM @s;
        EXECUTE stmt USING _tempid,_uid;
        DEALLOCATE PREPARE stmt;
      END IF;
      SELECT _lvl - 1  INTO _lvl; 
      SELECT NULL, NULL INTO _tempid,_category;
      SELECT id,category FROM _show_node WHERE seq = _lvl 
      INTO _tempid,_category;
    END WHILE;
 
    REPLACE INTO __output_count (id, owner_id, hub_id, preview)
    SELECT  m.id, m.owner_id, _hub_id, file_path FROM _show_node 
    INNER JOIN media m USING(id)  
    WHERE JSON_EXISTS(m.metadata, '$._seen_') AND 
    NOT JSON_EXISTS(metadata, CONCAT('$._seen_.', _uid));

  IF _type='hub' AND _category IN('hub', 'folder') THEN 
    REPLACE INTO __output_count (id, owner_id, hub_id, preview, category) 
    SELECT message_id, author_id, _hub_id, SUBSTRING(`message`, 1, 80), 'chat' FROM 
    channel where sys_id >(SELECT 
    IFNULL((SELECT ref_sys_id FROM read_channel WHERE uid = _uid),0));
  END IF;


  DROP TABLE IF EXISTS __output; 
  CREATE TEMPORARY TABLE __output  AS 
  SELECT o.category, COUNT(DISTINCT o.id) new_media, 0 new_message,
    IF(firstname IS NULL AND lastname IS NULL, email, 
      CONCAT(IFNULL(firstname, ''), ' ', IFNULL(lastname, ''))
    ) fullname, 
    IFNULL(firstname, '') firstname,
    IFNULL(lastname, '') lastname,
    hh.name hubname,
    GROUP_CONCAT(
      JSON_OBJECT(
        "hub_id", o.hub_id, 
        "nid", o.id,
        "type", o.category,
        "preview", o.preview
    )) nodes,
    ',{}' messages,
    o.owner_id `uid` 
    FROM __output_count o 
    INNER JOIN yp.drumate d ON o.owner_id = d.id 
    LEFT JOIN yp.hub hh ON o.hub_id = hh.id 
    WHERE o.owner_id != _uid AND o.category ='media' GROUP BY(d.id)
    
    
  UNION
  SELECT o.category, COUNT(DISTINCT o.id) new_media, 0 new_message,
    d.email fullname, 
    IFNULL(d.email, '') firstname,
    IFNULL(d.email, '') lastname,
    hh.name hubname,
    GROUP_CONCAT(
      JSON_OBJECT(
        "hub_id", o.hub_id, 
        "nid", o.id,
        "type", o.category,
        "preview", o.preview
    )) nodes,
    ',{}' messages,
    o.owner_id `uid` 
    FROM __output_count o 
    INNER JOIN yp.dmz_user d ON o.owner_id = d.id 
    LEFT JOIN yp.hub hh ON o.hub_id = hh.id 
    WHERE o.owner_id != _uid AND o.category ='media' GROUP BY(d.id)
  UNION
  SELECT o.category, 0 new_media, COUNT(DISTINCT o.id) new_message, 
    IF(firstname IS NULL AND lastname IS NULL, email, 
      CONCAT(IFNULL(firstname, ''), ' ', IFNULL(lastname, ''))
    ) fullname, 
    IFNULL(firstname, '') firstname,
    IFNULL(lastname, '') lastname,
    hh.name hubname,
    '{},' nodes,
    GROUP_CONCAT(
      JSON_OBJECT(
        "hub_id", o.hub_id, 
        "nid", o.id,
        "type", o.category,
        "preview", o.preview
    )) messages,
    o.owner_id `uid` 
    FROM __output_count o INNER JOIN yp.drumate d ON o.owner_id = d.id 
    LEFT JOIN yp.hub hh ON o.hub_id = hh.id 
    WHERE o.owner_id != _uid AND o.category ='chat' 
    GROUP BY(d.id);
  
  SELECT GROUP_CONCAT(
      nodes, 
      messages
      SEPARATOR '+++'
    ) notifications, 
    SUM(new_message) new_message, 
    SUM(new_media) new_media,
    SUM(new_message) new_chat, 
    SUM(new_media) new_file,
    `uid`,
    hubname,
    fullname,
    firstname,
    lastname
  FROM __output GROUP BY(uid);
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_nodes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_show_nodes`(
  IN _nodes MEDIUMTEXT,
  IN _uid VARCHAR(16) 
)
BEGIN
  DECLARE _i INTEGER DEFAULT 0;
  DECLARE _pattern VARCHAR(1024);
  DECLARE _nid VARCHAR(16);

  DROP TABLE IF EXISTS __tmp_recursive;
  CREATE TEMPORARY TABLE __tmp_recursive(
    `nid` varchar(16) DEFAULT NULL,
    `parent_path` varchar(1024) DEFAULT NULL,
    `filename` varchar(128) DEFAULT NULL,
    `extension` varchar(128),
    `permission` tinyint(4) unsigned,
    `ttl` int(11),
    `category` enum('hub', 'web' ,'folder','link','video','image','audio','document','stylesheet','script','vector','other'),
    UNIQUE nid (nid)
  ); 
  WHILE _i < JSON_LENGTH(_nodes) DO 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_nodes, CONCAT("$[", _i, "]"))) INTO _nid;
    SELECT replace(clean_path(file_path), concat('.', extension), '/%') 
      FROM media where id=_nid
    INTO _pattern;
    REPLACE INTO __tmp_recursive SELECT 
      m.id, 
      parent_path(m.id) AS parent_path,
      
      m.user_filename, 
      m.extension, 
      user_permission(_uid, m.id),
      media_ttl(_uid, m.id),
      m.category
    FROM media m WHERE file_path LIKE _pattern OR id=_nid;
    SELECT _i + 1 INTO _i;
  END WHILE;
  SELECT * FROM __tmp_recursive;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_show_node_by` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_show_node_by`(
  IN _node_id VARCHAR(16) CHARACTER SET ascii,
  IN _uid VARCHAR(16) CHARACTER SET ascii,
  IN _sort_by VARCHAR(20),
  IN _order   VARCHAR(20),
  IN _page    TINYINT(4)
)
BEGIN
 
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _home_id VARCHAR(16) CHARACTER SET ascii;
  DECLARE _src_db_name VARCHAR(255);
  DECLARE _finished       INTEGER DEFAULT 0; 
  DECLARE _nid VARCHAR(16) CHARACTER SET ascii;  
  DECLARE _parent_id VARCHAR(16) CHARACTER SET ascii;  
  DECLARE _hub_db_name VARCHAR(255);
  DECLARE _ftype VARCHAR(255);

  DECLARE _sys_id INT;
  DECLARE _temp_sys_id INT;
  DECLARE _db VARCHAR(400);


  DECLARE _tempid VARCHAR(16) CHARACTER SET ascii;
  DECLARE _category VARCHAR(16);
  DECLARE _lvl INT;
  
  DECLARE _hubs MEDIUMTEXT DEFAULT NULL;
  DECLARE _hub_id VARCHAR(16);


  CALL pageToLimits(_page, _offset, _range);  
  SELECT database() INTO _src_db_name;
  SELECT id  from media where parent_id='0' INTO _home_id;
  IF _node_id IS NULL OR _node_id='0' THEN 
    SELECT _home_id INTO _node_id;
  END IF;
  
  IF _node_id REGEXP "^/.+" THEN 
    SELECT id FROM media WHERE file_path = CONCAT(
      clean_path(_node_id), '.folder') INTO _node_id;
  END IF;

  DROP TABLE IF EXISTS _temp_show_node;
  CREATE TEMPORARY TABLE _temp_show_node  AS  
  SELECT 
    m.id AS nid,
    m.parent_id AS pid,
    m.parent_id AS parent_id,
    m.file_path as filepath,
    me.id  AS holder_id,    
    _home_id  AS home_id,   
    ff.capability,
    _src_db_name AS src_db_name,
    he.db_name hub_db_name,
    COALESCE(he.accessibility,me.accessibility) AS  accessibility,
    COALESCE(he.id, hh.owner_id) AS owner_id,
    COALESCE(he.id, me.id) AS hub_id,
    
    COALESCE(he.status, m.status) AS status,
    COALESCE(hh.name, m.user_filename) AS filename,
    m.filesize AS filesize,
    COALESCE(vv.fqdn, v.fqdn) AS vhost,
    IF(m.category='hub', m.extension, me.area) AS area,
    m.caption,
    m.extension AS ext,
    m.category AS ftype,
    m.category AS filetype,
    m.mimetype,
    m.metadata,
    m.download_count AS view_count,
    m.geometry,
    m.upload_time AS ctime,
    m.publish_time AS mtime,
    0 new_file,
    0 new_chat,
    0 notify,
    0 chat,
    _page as page,
     m.rank,
    IF(m.category = 'hub' , null, user_permission(_uid, m.id )) privilege,
    IF(m.category = 'hub' , null, user_expiry(_uid, m.id )) expiry_time
  FROM media m
    INNER JOIN yp.entity me  ON me.db_name=database()
    LEFT JOIN yp.vhost v ON  v.id=me.id
    LEFT JOIN yp.vhost vv ON  vv.id=m.id
    LEFT JOIN yp.filecap ff ON m.extension=ff.extension
    LEFT JOIN yp.entity he ON m.id = he.id AND m.category='hub'
    LEFT JOIN yp.hub hh ON m.id = hh.id AND m.category='hub'
  WHERE m.parent_id=_node_id AND 
    m.file_path not REGEXP '^/__(chat|trash)__' AND 
    m.`status` != 'hidden' ;

  ALTER TABLE _temp_show_node ADD sys_id INT PRIMARY KEY AUTO_INCREMENT;


  SELECT sys_id, IF(ftype = 'hub', hub_db_name, src_db_name), nid 
    FROM _temp_show_node WHERE sys_id > 0  AND ftype = 'hub' AND hub_db_name IS NOT NULL ORDER BY sys_id ASC LIMIT 1 
    INTO _sys_id , _db, _nid;
  WHILE _sys_id <> 0 DO
    SET @perm = 0;
    SET @resexpiry = NULL;
    SET @s = CONCAT("SELECT ",
      _db,".user_permission (?, ?) INTO @perm"
    );
    PREPARE stmt FROM @s;
    EXECUTE stmt USING _uid, _nid;
    DEALLOCATE PREPARE stmt; 

    
    SET @resexpiry = null;    
    SET @s = CONCAT("SELECT ",
      _db,".user_expiry (?, ?) INTO @resexpiry"
    );
    PREPARE stmt FROM @s;
    EXECUTE stmt USING _uid, _nid;
    DEALLOCATE PREPARE stmt;

    
    UPDATE _temp_show_node s SET privilege = @perm, expiry_time = @resexpiry  
      WHERE sys_id = _sys_id;
    SELECT _sys_id INTO  _temp_sys_id ;  
    SELECT 0 , NULL INTO  _sys_id, _db ; 
    SELECT IFNULL(sys_id,0), IF(ftype = 'hub', hub_db_name, src_db_name), nid 
      FROM _temp_show_node WHERE sys_id >_temp_sys_id AND ftype = 'hub' AND hub_db_name IS NOT NULL ORDER BY sys_id ASC LIMIT 1 
      INTO _sys_id, _db, _nid;
  END WHILE;


  DROP TABLE IF EXISTS _show_node;
  CREATE TEMPORARY TABLE _show_node  AS 
  SELECT * FROM _temp_show_node WHERE 
    (expiry_time = 0 OR expiry_time > UNIX_TIMESTAMP()) AND 
    privilege > 0 ORDER BY 
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN ctime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN ctime END DESC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN filename END ASC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN filename END DESC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'asc' THEN rank END ASC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'desc' THEN rank END DESC,
    CASE WHEN LCASE(_sort_by) = 'size' and LCASE(_order) = 'asc' THEN filesize END ASC,
    CASE WHEN LCASE(_sort_by) = 'size' and LCASE(_order) = 'desc' THEN filesize END DESC
  LIMIT _offset ,_range;

  ALTER table _show_node ADD hubs MEDIUMTEXT ;
  ALTER table _show_node ADD nodes MEDIUMTEXT ;
  ALTER table _show_node ADD actual_home_id VARCHAR(16) ;

    DROP TABLE IF EXISTS _node_tree; 
    CREATE TEMPORARY TABLE _node_tree (
     `seq`  int NOT NULL AUTO_INCREMENT,
     `heritage_id` varchar(16) CHARACTER SET ascii,
     `id` varchar(16) CHARACTER SET ascii,
     `parent_id` varchar(16) CHARACTER SET ascii, 
     `category` varchar(16) ,
     `new_file` int default 0, 
     `new_chat` int default 0, 
      PRIMARY KEY `seq`(`seq`)
      );



    INSERT INTO _node_tree 
    (heritage_id, id, parent_id ,category)
    WITH RECURSIVE mytree AS 
    ( 
      SELECT id heritage_id , id, parent_id ,category
      FROM media WHERE id in  (select nid from _show_node)
        UNION ALL
      SELECT t.heritage_id,m.id,m.parent_id ,m.category
      FROM media AS m JOIN mytree AS t ON m.parent_id = t.id
    ) SELECT heritage_id, id, parent_id ,category  FROM mytree;



    SELECT MAX(seq) FROM _node_tree  INTO _lvl; 
    SELECT id,category FROM _node_tree WHERE seq = _lvl 
    INTO _tempid  ,_category;

    WHILE ( _lvl >= 1 AND  _tempid IS NOT NULL) DO

      IF (_category = 'hub') THEN
        SET @_temp_read_cnt = 0; 
        SELECT db_name FROM yp.entity WHERE id = _tempid  
        INTO _hub_db_name; 
        IF (_hub_db_name IS NOT NULL) THEN 
          SET @s = CONCAT(
            "SELECT IFNULL(SUM(is_new(metadata, owner_id, ?)), 0) FROM ", _hub_db_name ,
            ".media WHERE file_path not REGEXP '^/__(chat|trash)__' INTO @_temp_file_count"
          );
          PREPARE stmt FROM @s;
          EXECUTE stmt USING _uid;
          DEALLOCATE PREPARE stmt;
          UPDATE  _node_tree   SET new_file = @_temp_file_count WHERE id = _tempid;


          SET @_temp_read_cnt = 0; 
          SET @_temp_result = NULL;
          SET @st = CONCAT('CALL ', _hub_db_name ,'.room_detail(?,?)');
          PREPARE stamt FROM @st;
          EXECUTE stamt USING  JSON_OBJECT('uid',_uid ) , @_temp_result ;
          DEALLOCATE PREPARE stamt; 
        
          SELECT JSON_UNQUOTE(JSON_EXTRACT( @_temp_result, "$.read_cnt")) INTO @_temp_read_cnt;
          UPDATE  _node_tree  SET new_chat =  @_temp_read_cnt WHERE id = _tempid;

          SET @s = CONCAT("SELECT id FROM ", 
              _hub_db_name ,".media WHERE parent_id='0' INTO @actual_home_id"
            );
          PREPARE stmt FROM @s;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt;
          UPDATE _show_node SET actual_home_id =@actual_home_id WHERE nid = _tempid;

        END IF;
      END IF;
      SELECT _lvl - 1  INTO _lvl; 
      SELECT NULL, NULL INTO _tempid,_category;
      SELECT id,category FROM _node_tree WHERE seq = _lvl 
      INTO _tempid,_category;
    END WHILE;

    UPDATE  _node_tree t 
    INNER JOIN media m USING(id) 
    SET t.new_file=is_new(m.metadata, owner_id, _uid)
    WHERE t.category <>  'hub';

    UPDATE _show_node t 
    INNER JOIN ( SELECT  heritage_id , 
      SUM(new_file)  new_file ,
      SUM(new_chat) new_chat,
      GROUP_CONCAT( CASE WHEN id <> heritage_id THEN  id  ELSE NULL END ) nodes,
      GROUP_CONCAT(CASE WHEN category = 'hub' AND id <> heritage_id THEN  id  ELSE NULL END ) hubs
    FROM _node_tree GROUP by heritage_id ) h ON nid = heritage_id
    SET t.new_file =h.new_file , t.new_chat = h.new_chat, 
        t.notify = h.new_chat + h.new_file,
        t.nodes = h.nodes,
        t.hubs = h.hubs;

  SELECT
    nid,
    pid,
    parent_id,
    filepath,
    holder_id,
    home_id,
    capability,
    src_db_name,
    hub_db_name,
    accessibility,
    owner_id,
    hub_id,
    status,
    filename,
    filesize,
    vhost,
    area,
    caption,
    ext,
    ftype,
    filetype,
    mimetype,
    metadata,
    view_count,
    geometry,
    ctime,
    mtime,
    new_file,
    new_chat,
    notify,
    chat,
    page,
    rank,
    privilege,
    expiry_time,
    sys_id,
    hubs,
    nodes,
    IFNULL(actual_home_id, _home_id) actual_home_id
  FROM _show_node  ORDER BY 
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN ctime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN ctime END DESC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN filename END ASC,
    CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN filename END DESC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'asc' THEN rank END ASC,
    CASE WHEN LCASE(_sort_by) = 'rank' and LCASE(_order) = 'desc' THEN rank END DESC,
    CASE WHEN LCASE(_sort_by) = 'size' and LCASE(_order) = 'asc' THEN filesize END ASC,
    CASE WHEN LCASE(_sort_by) = 'size' and LCASE(_order) = 'desc' THEN filesize END DESC;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash`(
  IN _id VARCHAR(16)
)
BEGIN
  DECLARE _node_path VARCHAR(255);
  DECLARE _category VARCHAR(40);
  DECLARE _uid VARCHAR(16);
  DECLARE _owner_id VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _hub_db VARCHAR(40);
  
  SELECT category from media WHERE id=_id into _category;
  
  IF _category='folder' THEN
    SELECT CONCAT(parent_path(id),user_filename) from media WHERE id=_id into _node_path;
    UPDATE media SET status='deleted' WHERE CONCAT(parent_path(id),user_filename ) LIKE concat(_node_path, '/%');
  END IF;
  UPDATE media SET status='deleted' WHERE id=_id;
  
  IF _category='hub' THEN
    
    SELECT id FROM yp.entity WHERE db_name = database() INTO _uid;
    SELECT owner_id FROM yp.hub WHERE id = _id INTO _owner_id;
    SELECT db_name FROM yp.entity WHERE id = _id INTO _hub_db;
   
    IF _uid = _owner_id THEN
      
      SET @sql = CONCAT(
        "CALL  ", _hub_db, ".remove_all_members (", quote(_owner_id), ");"
      );
        
      PREPARE stmt1 FROM @sql;
      EXECUTE stmt1;
      DEALLOCATE PREPARE stmt1;
    END IF;
 
    
  END IF;

  CALL mfs_node_attr(_id);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_child_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_child_hub`(
  IN _nid VARCHAR(16),
  IN _uid VARCHAR(16),
  OUT _output VARCHAR(1000)
)
BEGIN
      DECLARE _tempid VARCHAR(16);

      DECLARE _owner_id VARCHAR(16);
      DECLARE _node_hub_db VARCHAR(40);
      DECLARE _user_hub_db VARCHAR(40);
      DECLARE _cum_output MEDIUMTEXT;
     DROP TABLE IF EXISTS _myhub; 
      CREATE TEMPORARY TABLE `_myhub` (
         id varchar(16) DEFAULT NULL,
        is_checked boolean default 0
      );              



      INSERT INTO _myhub (id ,is_checked ) 
      WITH RECURSIVE myhub AS (
      SELECT id, category  , _nid nid FROM media WHERE id = _nid
      UNION ALL
      SELECT m.id,m.category, t.nid 
      FROM media AS m JOIN myhub AS t ON m.parent_id =t.id
      )
      SELECT id,0 FROM myhub WHERE  category ='hub';

      SELECT `db_name` FROM yp.entity WHERE id = _uid INTO _user_hub_db;                

      SELECT  id FROM _myhub where is_checked =0 LIMIT 1 INTO _tempid ;

    

    WHILE (_tempid IS NOT NULL) do
        SELECT owner_id FROM yp.hub WHERE id = _tempid INTO _owner_id;
        SELECT `db_name` FROM yp.entity WHERE id = _tempid INTO _node_hub_db;
  
         IF _uid = _owner_id THEN

        
            SET @sql = CONCAT(
              "CALL  ", _node_hub_db, ".remove_all_members (", quote(_owner_id), ")" );
            PREPARE hub_stmt FROM @sql;
            EXECUTE hub_stmt;
            DEALLOCATE PREPARE hub_stmt;
          ELSE 
    
            SET @sql = CONCAT(
              "CALL  ", _user_hub_db, ".leave_hub (", quote(_tempid), ")" );
            PREPARE hub_stmt FROM @sql;
            EXECUTE hub_stmt;
            DEALLOCATE PREPARE hub_stmt;

            SET @sql = CONCAT("CALL  " , _node_hub_db ,".hub_add_action_log (?,?,?,?,?,?)");
            PREPARE hub_stmt FROM @sql;
            EXECUTE hub_stmt USING _tempid,'left','member','admin',null,'has been left';
            DEALLOCATE PREPARE hub_stmt;



            SELECT NULL  INTO @huboutput;
            SET @sql = CONCAT(
             " SELECT user_filename FROM ", _user_hub_db, ".media where id= ", quote(_tempid), "INTO @child_hub" );
            PREPARE hub_stmt FROM @sql;
            EXECUTE hub_stmt;
            DEALLOCATE PREPARE hub_stmt;

            SELECT 
             CASE 
              WHEN _cum_output IS NOT NULL  AND @child_hub IS NOT NULL     THEN CONCAT (_cum_output ,',',@child_hub )
              WHEN _cum_output IS NULL      AND @child_hub IS NOT NULL     THEN @child_hub 
              WHEN _cum_output IS NOT NULL  AND @child_hub IS NULL         THEN _cum_output
              WHEN _cum_output IS NULL      AND @child_hub IS NULL         THEN NULL
             END
            INTO _cum_output;


        END IF;
        UPDATE _myhub SET is_checked = 1 WHERE id = _tempid ;
        SELECT NULL INTO _tempid ;
        SELECT id FROM _myhub WHERE is_checked =0 LIMIT 1 INTO _tempid ;

    END WHILE;

    SELECT _cum_output  INTO _output;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_cross_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_cross_node`(
  IN _nid VARCHAR(16),
  IN _uid VARCHAR(16),
  IN _modify_perm TINYINT(4),
  OUT _output VARCHAR(1000)
)
BEGIN
  DECLARE _actual_perm TINYINT(4);
  DECLARE _ts INT(11) DEFAULT 0;
  

  SELECT UNIX_TIMESTAMP() INTO _ts;

  SELECT permission FROM permission WHERE resource_id ='*' AND entity_id = _uid INTO _actual_perm;



  IF CAST(_actual_perm AS UNSIGNED) < CAST(_modify_perm AS UNSIGNED) THEN
    
    INSERT IGNORE INTO permission
    SELECT null, _nid, _uid, null, -1, _ts, _ts, permission,'system' FROM 
    permission WHERE resource_id ='*' AND entity_id = _uid 
    ON DUPLICATE KEY UPDATE expiry_time = -1 ;
    
    SELECT user_filename FROM media where id= _nid INTO _output;
  ELSE 
    INSERT IGNORE INTO permission
    SELECT null, _nid, entity_id, null, -1, _ts, _ts, permission,'system' FROM 
    permission WHERE resource_id ='*' AND entity_id <> _uid 
    ON DUPLICATE KEY UPDATE expiry_time = -1 ;
    CALL mfs_trash_node (_nid);


     SET @st = CONCAT("SELECT  
      user_filename,category, extension 
      FROM  media WHERE id = ?
      INTO  @hub_file_name,@hub_category,@hub_extension" ) ; 
      PREPARE stmt3 FROM @st;
      EXECUTE stmt3 using _nid;
      DEALLOCATE PREPARE stmt3;  


      SET @st = CONCAT("CALL  hub_add_action_log (?,?,?,?,?,?)");
      PREPARE stamt FROM @st;
      EXECUTE stamt USING _uid,'deleted','media','all',null,CONCAT('The ',@hub_file_name, ' ',@hub_category,' has been deleted');
      DEALLOCATE PREPARE stamt;


    
  END IF ;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_hub`(
  IN _nid VARCHAR(16),
  IN _uid VARCHAR(16),
  OUT _output VARCHAR(1000)
)
BEGIN

  DECLARE _owner_id VARCHAR(16);
  DECLARE _node_hub_db VARCHAR(40);
  DECLARE _user_hub_db VARCHAR(40);

  
  SELECT owner_id FROM yp.hub WHERE id = _nid INTO _owner_id;
  SELECT `db_name` FROM yp.entity WHERE id = _nid INTO _node_hub_db;
  SELECT `db_name` FROM yp.entity WHERE id = _uid INTO _user_hub_db;
  
  IF _uid = _owner_id THEN
    SET @sql = CONCAT(
      "CALL  ", _node_hub_db, ".remove_all_members (", quote(_owner_id), ")" );
    PREPARE hub_stmt FROM @sql;
    EXECUTE hub_stmt;
    DEALLOCATE PREPARE hub_stmt;

    SET @sql = CONCAT(
      "CALL  ", _user_hub_db, ".mfs_trash_node (", quote(_nid), ")" );
    PREPARE hub_stmt FROM @sql;
    EXECUTE hub_stmt;
    DEALLOCATE PREPARE hub_stmt;
  ELSE 
    
    SET @sql = CONCAT(
      "CALL  ", _user_hub_db, ".leave_hub (", quote(_nid), ")" );
    PREPARE hub_stmt FROM @sql;
    EXECUTE hub_stmt;
    DEALLOCATE PREPARE hub_stmt;
    
    SET @sql = CONCAT("CALL  " , _node_hub_db ,".hub_add_action_log (?,?,?,?,?,?)");
    PREPARE hub_stmt FROM @sql;
    EXECUTE hub_stmt USING _nid,'left','member','admin',null,'has been left';
    DEALLOCATE PREPARE hub_stmt;

    SELECT NULL  INTO @huboutput;
    SET @sql = CONCAT(
      " SELECT user_filename FROM ", _user_hub_db, ".media where id= ", quote(_nid), "INTO @huboutput" );
    PREPARE hub_stmt FROM @sql;
    EXECUTE hub_stmt;
    DEALLOCATE PREPARE hub_stmt;
    

    SELECT @huboutput  INTO _output;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_init` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_init`(
)
BEGIN
  DECLARE _file_path VARCHAR(400) DEFAULT NULL;
  SELECT file_path from media WHERE file_path='/__trash__.folder' INTO _file_path;
  IF _file_path IS NULL THEN 
    CALL mfs_make_dir('0', JSON_ARRAY('__trash__'), 1);
    UPDATE media SET status='hidden' WHERE file_path='/__trash__.folder';
  END IF;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_node` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_node`(
    IN _nid VARCHAR(16)
  )
BEGIN
    DECLARE _pid VARCHAR(16);
    DECLARE _src_type VARCHAR(100);
    DECLARE _file_name VARCHAR(1024);
    DECLARE _node_path VARCHAR(255);
    
    
    
    DECLARE _root_id VARCHAR(16);
    DECLARE _bound VARCHAR(16);
    DECLARE _lvl INT;
    DECLARE _origin_id VARCHAR(16);
    DECLARE _parent_id VARCHAR(16);
    DECLARE _tempid VARCHAR(16);
    DECLARE _chk_tempid VARCHAR(16);
    DECLARE _temp_file_path VARCHAR(6000);
    DECLARE _temp_parent_id VARCHAR(16);
    DECLARE _temp_user_filename VARCHAR(1024);

    DECLARE t_id VARCHAR(16);

    DROP TABLE IF EXISTS  _folder_media;
    CREATE TEMPORARY TABLE _folder_media (
      `seq`  int NOT NULL AUTO_INCREMENT,  
      `id` varchar(16) DEFAULT NULL,
      `parent_id` varchar(16)  NULL DEFAULT '',
      `user_filename` varchar(128) DEFAULT NULL,
      `is_checked` boolean default 0,
      PRIMARY KEY `seq`(`seq`) 
      );


    DROP TABLE IF EXISTS _compare_media; 
    CREATE TEMPORARY TABLE _compare_media (
      seq  int NOT NULL AUTO_INCREMENT, 
      id varchar(16) DEFAULT NULL,
      parent_id varchar(16) DEFAULT null,
      user_filename varchar(128) DEFAULT NULL, 
      file_path VARCHAR(1024) DEFAULT NULL,
      parent_path VARCHAR(1024) DEFAULT NULL,
      is_checked boolean default 0,
      is_in_trace  boolean default 0,
      t_id varchar(16) DEFAULT NULL,
      t_parent_id varchar(16) DEFAULT null,
      category VARCHAR(50) DEFAULT NULL,
      PRIMARY KEY `seq`(`seq`)  
    );

    SELECT id FROM yp.entity where db_name = DATABASE() INTO _origin_id;
    SELECT id FROM media WHERE  parent_id='0' INTO _root_id;
 
    SELECT  parent_id FROM media where id =_nid INTO _tempid;

    WHILE ( IFNULL(_lvl,0) <=100 AND _root_id  <> _tempid  AND _tempid IS NOT NULL ) DO
      INSERT INTO _folder_media
      SELECT null,id,parent_id, user_filename,0 FROM media where id = _tempid  ;
      SELECT parent_id FROM media where id =_tempid INTO _tempid;
      SELECT IFNULL(_lvl,0) +1  INTO _lvl  ; 
    END WHILE;

    SELECT MAX(seq) FROM _folder_media  INTO _lvl; 
    
    SELECT clean_path(CONCAT( IFNULL(_temp_file_path,''), '/', user_filename )) , user_filename 
    FROM  _folder_media 
    WHERE seq = _lvl
    INTO  _temp_file_path,_temp_user_filename;

    SELECT node_id_from_path('/__trash__') INTO _temp_parent_id; 

    START TRANSACTION;
      WHILE ( _lvl >= 1 AND  _tempid IS NOT NULL) do
        SELECT NULL INTO _chk_tempid ;
        SELECT id FROM media WHERE file_path = clean_path(CONCAT('/__trash__',_temp_file_path, '.folder')) INTO _chk_tempid;
        SELECT _lvl - 1  INTO _lvl  ;  

        IF _chk_tempid IS NULL THEN 
          SET @st = CONCAT("CALL mfs_new_node(
            ?, ?, ?, ?, 'folder', 'folder', 'folder', NULL, NULL, 0)"
          );
          PREPARE stmt2 FROM @st;
          EXECUTE stmt2 USING _origin_id, _origin_id, _temp_user_filename, _temp_parent_id;
          DEALLOCATE PREPARE stmt2;

        END IF;

        SELECT id FROM media WHERE file_path = clean_path(CONCAT('/__trash__',_temp_file_path, '.folder')) INTO _temp_parent_id;
        SELECT clean_path(CONCAT( IFNULL(_temp_file_path,''), '/', user_filename )) , user_filename 
        FROM  _folder_media 
        WHERE seq = _lvl
        INTO  _temp_file_path,_temp_user_filename;
      END WHILE;


      SELECT _temp_parent_id INTO _pid;
      
      INSERT INTO _compare_media (seq,id,parent_id, user_filename,file_path,parent_path,is_checked,is_in_trace,category)
      SELECT null,id,parent_id, user_filename,clean_path(concat(parent_path(id), '/', user_filename, '.', extension)),parent_path(id),0,0,category 
      FROM media where id = _nid;
      
      SELECT id FROM _compare_media WHERE id = _nid AND is_checked =0 LIMIT 1 INTO _tempid ;
      
      WHILE (_tempid IS NOT NULL) do
    
        INSERT INTO _compare_media (seq,id,parent_id, user_filename,file_path,parent_path,is_checked,is_in_trace,category)
        SELECT NULL,id,parent_id, user_filename,clean_path(concat(parent_path(id), '/', user_filename, '.', extension)),parent_path(id),0,0,category 
        FROM media where parent_id = _tempid;
              
        UPDATE _compare_media SET is_checked = 1 WHERE id = _tempid ;
                
        SELECT NULL INTO _tempid ;
        SELECT id FROM _compare_media WHERE is_checked =0 LIMIT 1 INTO _tempid ;
      END WHILE;
    
      
      UPDATE _compare_media c SET t_id = (SELECT id from  media where file_path = clean_path(CONCAT('/__trash__', c.file_path)));
      UPDATE _compare_media c SET t_parent_id = (SELECT parent_id FROM media where id = c.t_id);
      UPDATE _compare_media c SET t_parent_id = _pid WHERE seq=1 AND t_parent_id is null;
      DROP TABLE IF EXISTS _compare_media1; 
      CREATE TEMPORARY TABLE _compare_media1 AS SELECT * FROM _compare_media;

      
      UPDATE _compare_media CM SET t_parent_id = (SELECT CM1.t_id FROM _compare_media1 CM1 where CM1.id = CM.parent_id 
      AND CM1.t_parent_id IS NOT NULL LIMIT 1) WHERE CM.t_parent_id IS NULL ;


      UPDATE media M , _compare_media CM
      SET M.parent_id = CM.t_parent_id,
      status = 'deleted'
      WHERE 
      M.id = CM.id
      AND CM.t_id IS NULL AND CM.t_parent_id IS NOT NULL;

      UPDATE media M, _compare_media CM
      SET M.parent_id = CM.t_parent_id,
      M.user_filename =  unique_filename(CM.t_parent_id, CM.user_filename, M.extension),
      status = 'deleted'
      WHERE 
      M.id = CM.id
      AND CM.t_id IS NOT NULL AND CM.t_parent_id IS NOT NULL AND CM.category <> 'folder' ;

      UPDATE media 
      SET parent_path = parent_path(id),file_path = clean_path(concat(parent_path(id), '/', user_filename, '.', extension)),
      status = 'deleted'
      WHERE id in (SELECT id from _compare_media );


      UPDATE media  SET status = 'deleted' WHERE id in (SELECT C.t_id FROM _compare_media C WHERE C.category = 'folder' 
      AND C.t_id IS NOT NULL AND  C.t_parent_id IS NOT NULL);

      DELETE FROM media  WHERE id IN (SELECT C.id FROM _compare_media C WHERE C.category = 'folder' 
      AND C.t_id IS NOT NULL AND  C.t_parent_id IS NOT NULL );
    IF _root_id <> _nid THEN 
      COMMIT;
    ELSE 
      ROLLBACK;
    END IF;
    

  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_trash_sb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_trash_sb`(
  IN _rid VARCHAR(16),
  IN _oid VARCHAR(16),
  OUT _output VARCHAR(1000)
)
BEGIN
  DECLARE _bound VARCHAR(16);
  DECLARE _finished INTEGER DEFAULT 0;
  DECLARE _db_name VARCHAR(50);
  DECLARE _uid     VARCHAR(16);
  DECLARE _status VARCHAR(50);
  SELECT "" INTO  _status;
  SELECT status FROM media WHERE id =  _rid INTO _status ;  
  SELECT '__Outbound__' FROM media WHERE id=_rid AND parent_path(id) LIKE CONCAT("/__Outbound__","%")  INTO _bound;  
    
  IF _bound IS NOT NULL THEN 
    BEGIN
      DECLARE dbcursor CURSOR FOR  SELECT DISTINCT b.db_name , p.entity_id as uid
      FROM 
      media m
      INNER JOIN permission p ON  p.resource_id=m.id 
      INNER JOIN yp.entity b on b.area='restricted'
      INNER join yp.hub e on e.id = b.id AND e.owner_id = p.entity_id 
      INNER JOIN media ch ON
        CASE WHEN m.category = 'folder' 
            THEN  REPLACE(CONCAT(parent_path(ch.id),ch.user_filename,'/'), '(',')')  regexp REPLACE(CONCAT(parent_path(m.id),m.user_filename,'/'), '(',')') 
            ELSE m.id=ch.id
          END = 1 
      WHERE ch.id = _rid ;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET _finished = 1;
      OPEN dbcursor;
        STARTLOOP: LOOP
          FETCH dbcursor INTO _db_name,_uid ;
          IF _finished = 1 THEN 
            LEAVE STARTLOOP;
          END IF;
          CALL sbx_remove (_oid,  _rid, _uid );
          CALL permission_revoke (_rid, null);
          CALL yp.yp_notification_remove (_rid, null);
        END LOOP STARTLOOP;   
      CLOSE dbcursor;
    END;
    CALL mfs_trash_node (_rid);
    SELECT concat(user_filename,'-out') FROM media where id= _rid INTO _output;
  ELSE 
    SELECT user_filename FROM media where id= _rid INTO _output;
      IF _status <> 'deleted' THEN 
         CALL mfs_delete_node (_rid);
      END IF;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_update_metadata` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `mfs_update_metadata`(
  IN _id    VARBINARY(16),
  IN _data  JSON
)
BEGIN
  DECLARE _value VARCHAR(1024);
  DECLARE _path VARCHAR(100);
  DECLARE _paths VARCHAR(1024);
  DECLARE _i TINYINT(4) DEFAULT 0;

  SELECT JSON_ARRAY(
    "sharebox"
  ) INTO _paths;
  WHILE _i < JSON_LENGTH(_paths) DO 
    SELECT read_json_array(_paths, _i) INTO _path;
    SELECT get_json_object(_data, _path) INTO _value;
    
    IF _value IS NOT NULL THEN 
      UPDATE media SET `metadata` = 
        JSON_SET( IFNULL(metadata, '{}'), CONCAT("$.",_path), _value) WHERE id=_id;
    END IF;
    SELECT _i + 1 INTO _i;
  END WHILE;
  SELECT * FROM media WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_update_rank` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_update_rank`(
  IN _node_id VARBINARY(16),
  IN _rank TINYINT(4)
)
BEGIN
  UPDATE media SET rank=_rank WHERE id=_node_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `mfs_wicket_home` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `mfs_wicket_home`(
  IN _uid VARCHAR(16)
)
BEGIN
  DECLARE _wicket_db_name VARCHAR(255);
  DECLARE _wicket_id VARCHAR(16);

    
    

    SELECT h.id FROM 
      yp.hub h INNER JOIN yp.entity e on e.id=h.id
    WHERE h.owner_id=_uid AND `serial`=0
    INTO _wicket_id;

  
  
  

    SELECT db_name FROM yp.entity WHERE id=_wicket_id INTO _wicket_db_name;
    SET @st = CONCAT('CALL ', _wicket_db_name ,'.mfs_home()');
    PREPARE stamt FROM @st;
    EXECUTE stamt;
    DEALLOCATE PREPARE stamt;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `modify_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `modify_agenda`(
    _agenda_id VARCHAR(16),
    _name VARCHAR(255),
    _place VARCHAR(255),
    _contact_ids TEXT,
    _stime int(11) ,
    _etime int(11) ,  
    _owner_id  VARCHAR(16),
    _calendar_id VARCHAR(16)
    
)
BEGIN
    
    DECLARE _time int(11) unsigned;
    DECLARE _lvl INT(4);
    DECLARE _drumate_id VARCHAR(16);
    DECLARE _drumate_db VARCHAR(255); 
    DECLARE _category  VARCHAR(16);
    DECLARE _i INTEGER DEFAULT 0;
    DECLARE _contact_id VARCHAR(16);
   


    SELECT UNIX_TIMESTAMP() INTO _time;

    DROP TABLE IF EXISTS _map_agenda;
       CREATE TEMPORARY TABLE _map_agenda(
            `drumate_id` varchar(16) NOT NULL,
            `is_checked` boolean default 0
        );
    INSERT INTO _map_agenda (drumate_id)
    SELECT uid FROM map_agenda WHERE  agenda_id = _agenda_id AND uid IS NOT NULL;

       

     WHILE (IFNULL((SELECT 1 FROM _map_agenda  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT NULL,NULL  INTO _drumate_id ,_drumate_db;
        SELECT drumate_id  FROM _map_agenda WHERE is_checked = 0 LIMIT 1  INTO _drumate_id;
       
        SELECT db_name FROM yp.entity WHERE id=_drumate_id INTO _drumate_db;
            SET @st = CONCAT(
             'CALL ', _drumate_db ,'.delete_map_agenda (', QUOTE(_agenda_id) ,')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.delete_agenda(', QUOTE(_agenda_id) ,')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 
 

        UPDATE _map_agenda SET is_checked =  1 WHERE drumate_id =_drumate_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
     END WHILE;

    SELECT id FROM yp.entity WHERE db_name=database() INTO _drumate_id;
    SELECT CASE WHEN _owner_id = _drumate_id THEN 'own' ELSE 'other' END INTO _category;  

    IF _name = '' THEN 
        SELECT NULL INTO _name;
    END IF; 

    IF _place = '' THEN 
        SELECT NULL INTO _place;
    END IF;
    
    IF _etime = '' or _etime = 0 THEN 
        SELECT NULL INTO _etime;
    END IF;

    IF _calendar_id = '' THEN
        SELECT NULL INTO _calendar_id;
    END IF;

    UPDATE agenda
    SET name= _name,place=_place,
    category=_category,owner_id=_owner_id,calendar_id=_calendar_id,stime=_stime,etime=_etime,
    mtime= _time
    WHERE agenda_id= _agenda_id;

    UPDATE calendar SET is_selected=1  WHERE calendar_id=_calendar_id;

    CALL delete_map_agenda(_agenda_id);   
  


    WHILE _i < JSON_LENGTH(_contact_ids) DO 
        SELECT NULL,NULL , NULL INTO _drumate_id ,_drumate_db, _contact_id;
        
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_contact_ids, CONCAT("$[", _i, "]")))  INTO _contact_id ;
        
        
        SELECT  (SELECT id FROM contact WHERE id = _contact_id) INTO _contact_id; 
        SELECT db_name FROM yp.entity WHERE id=_contact_id INTO _drumate_db;
        SELECT *  FROM (SELECT _contact_id ) a WHERE  _drumate_db IS NOT NULL INTO _drumate_id ;     

        IF _contact_id IS NOT NULL THEN
            CALL add_map_agenda (_agenda_id,_contact_id, _drumate_id);
        END IF;



        IF _drumate_id IS NOT NULL THEN


            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.add_map_agenda (', QUOTE(_agenda_id) ,',', QUOTE(_owner_id),',', QUOTE(_owner_id),')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.add_calendar (', QUOTE(_owner_id) ,',null,',  QUOTE(_owner_id),',0,0)' );
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

            SET @st = CONCAT(
            'CALL  ', _drumate_db ,'.insert_agenda(', QUOTE(_agenda_id) ,',', QUOTE(_name),',',
            IFNULL(QUOTE(_place),"NULL"),',"other",',QUOTE(_owner_id),',',QUOTE(_owner_id),',',_stime,',',
            IFNULL(_etime,"NULL"),')'); 
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

     END IF;
        
        SELECT _i + 1 INTO _i;
    END WHILE;
        
    CALL show_detail_agenda(_agenda_id);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `modify_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `modify_calendar`(
    _calendar_id  VARCHAR(16),   
    _name VARCHAR(255),
    _color VARCHAR(10),
    _owner_id  VARCHAR(16),
    _is_selected  BOOLEAN ,
    _is_default  BOOLEAN 
)
BEGIN

    IF IFNULL(_is_default,0) = 1 THEN 
        UPDATE calendar SET  is_default = 0  WHERE is_default = 1  ;
    END IF; 

    UPDATE calendar SET  is_selected = _is_selected, is_default = _is_default , name  =_name ,color= _color WHERE owner_id = _owner_id 
    AND calendar_id = _calendar_id;
    
    

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `move_media` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `move_media`(
  IN _src_id VARCHAR(16),
  IN _dest_pid VARCHAR(16),
  IN _des_entity_id VARCHAR(16),
  IN _option  smallint   
  
  )
BEGIN
  DECLARE _id varchar(16);
  DECLARE _temp_filename varchar(1024);
  DECLARE _lvl int;
  DECLARE _des_db   VARCHAR(255);
  DECLARE _area VARCHAR(25);
  DECLARE _vhost VARCHAR(255);
  DECLARE _home_dir VARCHAR(500);
  DECLARE _hub_id VARCHAR(16);
  
  DECLARE _is_src_folder boolean; 
  SELECT 0 INTO _is_src_folder;
  SELECT 1 FROM media m WHERE category ='folder' AND  m.id =_src_id AND  _is_src_folder; 
  
  SELECT utils.vhost(ident), home_dir, id,db_name FROM yp.entity WHERE id=_des_entity_id
  INTO _vhost, _home_dir, _hub_id,_des_db;

    DROP TABLE IF EXISTS  _src_media;
    CREATE TEMPORARY TABLE _src_media (
    `id` varchar(16) DEFAULT NULL,
    `origin_id` varchar(16) DEFAULT NULL,
    `owner_id` varchar(16) NOT NULL,
    `host_id` varchar(16) NOT NULL,
    `file_path` varchar(512) DEFAULT NULL,
    `user_filename` varchar(128) DEFAULT NULL,
    `parent_id` varchar(16)  NULL DEFAULT '',
    `parent_path` varchar(1024) NOT NULL,
    `extension` varchar(100) NOT NULL DEFAULT '',
    `mimetype` varchar(100) NOT NULL,
    `category`  varchar(16) NOT NULL,
    `isalink` tinyint(2) unsigned NOT NULL DEFAULT '0',
    `filesize` int(20) unsigned NOT NULL DEFAULT '0',
    `geometry` varchar(200) NOT NULL DEFAULT '0x0',
    `publish_time` int(11) unsigned NOT NULL DEFAULT '0',
    `upload_time` int(11) unsigned NOT NULL DEFAULT '0',
    `last_download` int(11) unsigned NOT NULL DEFAULT '0',
    `download_count` mediumint(8) unsigned NOT NULL DEFAULT '0',
    `metadata` varchar(1024) DEFAULT NULL,
    `caption` varchar(1024) DEFAULT NULL,
    `status` varchar(20) NOT NULL DEFAULT 'active',
    `approval` enum('submitted','verified','validated') NOT NULL,
    `rank` tinyint(4) NOT NULL DEFAULT '0',
     
    `relative_path` varchar(1024) NOT NULL,
	  `lvl` int default 0,
    `is_checked` boolean default 0,
    `is_matched` boolean default 0,
    `is_delete` boolean default 0,
    `is_update` boolean default 0,
    `update_file_path`   varchar(1024)  NULL,
    `update_parent_path`   varchar(1024)  NULL
    
    );

    DROP TABLE IF EXISTS  _des_media;
    CREATE TEMPORARY TABLE _des_media AS SELECT  * from _src_media where 1=2;
    
    
    
    
    INSERT INTO _src_media (id,file_path,user_filename,parent_id,parent_path,category,
    origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
    last_download,download_count,metadata,caption,status,approval,rank,
    is_checked,relative_path,lvl)
    SELECT id,file_path,user_filename,parent_id ,parent_path,category,
    origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
    last_download,download_count,metadata,caption,status,approval,rank,
    0, user_filename,0
    FROM media m WHERE m.id =_src_id;
   


    SELECT  id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename  ,_lvl;
    SET  _temp_filename =IFNULL(_temp_filename,'');

    WHILE _id is not null DO
      
        INSERT INTO _src_media (id,file_path,user_filename,parent_id ,parent_path,category,
        origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
        last_download,download_count,metadata,caption,status,approval,rank,
        is_checked,relative_path,lvl)
        SELECT  
          id,file_path,user_filename,parent_id,parent_path,category,
          origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
          last_download,download_count,metadata,caption,status,approval,rank,
          0,CONCAT(_temp_filename,"/",user_filename ) ,_lvl+1
        FROM media WHERE  parent_id =_id;
        
        UPDATE _src_media SET is_checked = 1 WHERE id = _id;
        SELECT NULL INTO _id;
        SELECT id ,relative_path ,lvl FROM _src_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename ,_lvl ;
        SET  _temp_filename =IFNULL(_temp_filename,"");
    END WHILE;




    
    SELECT NULL,NULL INTO _id,_temp_filename;
    SET @sql = CONCAT('
    INSERT INTO _des_media 
      (id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      is_checked,relative_path,lvl)
    SELECT
      m.id,m.file_path,m.user_filename,m.parent_id ,m.parent_path,m.category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank,
      0, m.user_filename,0
    FROM ' ,_des_db ,'.media m
    WHERE 
      parent_id ="', _dest_pid ,'" AND 
      category = ', CASE WHEN _is_src_folder =1 THEN "'folder'" ELSE "category" END ,'     AND 
      user_filename  = ( SELECT  user_filename  FROM _src_media sm WHERE sm.id ="', _src_id,'")');

    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  
    SELECT  id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id ,_temp_filename,_lvl; 
    SET  _temp_filename =IFNULL(_temp_filename,'''');

    WHILE _id is not null DO
         SET @sql = CONCAT('
        INSERT INTO _des_media (id,file_path,user_filename,parent_id ,parent_path,category,
        origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
        last_download,download_count,metadata,caption,status,approval,rank,
        is_checked,relative_path,lvl)
        SELECT  
          id,file_path,user_filename,parent_id,parent_path,category,
          origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
          last_download,download_count,metadata,caption,status,approval,rank,
          0,','CONCAT("',_temp_filename,'","/",user_filename ) ,',_lvl+1,
                ' FROM ' ,_des_db,'.media WHERE  parent_id ="',_id,'"');
        PREPARE stmt FROM @sql ;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        UPDATE _des_media SET is_checked = 1 WHERE id = _id;
        SELECT NULL INTO _id;
        SELECT id ,relative_path,lvl FROM _des_media WHERE is_checked =0 LIMIT 1 INTO _id,_temp_filename,_lvl ;
        SET  _temp_filename =IFNULL(_temp_filename,"");
    END WHILE;
    
    
    UPDATE _des_media dm,_src_media sm SET dm.is_matched = 1 , sm.is_matched =1
	  WHERE  dm.relative_path = sm.relative_path AND dm.category=sm.category;


	  
	  UPDATE _des_media set is_delete=1 WHERE _option =0 ; 
    UPDATE _src_media set is_update=1 WHERE _option =0 ; 
	 
	  
	  UPDATE _des_media SET is_delete=1 WHERE _option =1 and is_matched= 1;  
    UPDATE _des_media SET is_update=1 WHERE _option =1 and is_matched= 0;  
    UPDATE _src_media SET is_update=1 WHERE _option =1;   


	  
	  

    SET @sql = CONCAT('SELECT file_path INTO @temp_parent_path FROM ', _des_db, '.media WHERE id = "', _dest_pid,'"');
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
      
	  UPDATE _src_media SET update_file_path=concat(@temp_parent_path,"/",relative_path);
	  UPDATE _src_media SET update_parent_path= left(update_file_path , LENGTH(update_file_path)- LENGTH(user_filename)-1) ;	
     
     
    
	  
	  UPDATE _des_media SET update_file_path=concat(@temp_parent_path,"/",relative_path);
	  UPDATE _des_media SET update_parent_path= left(update_file_path , LENGTH(update_file_path)- LENGTH(user_filename)-1) ;	

	  
    UPDATE _src_media SET parent_id = _dest_pid WHERE lvl=0;
    
	  
    UPDATE _src_media sm, _des_media dm SET dm.parent_id = sm.id 
    WHERE  dm.is_matched=0 AND dm.is_delete=0 AND dm.update_parent_path = sm.update_file_path AND dm.lvl=sm.lvl+1 AND _option = 1 ;
    


    update _src_media set 
    update_file_path =  CONCAT( update_parent_path,"/", id ,"-orig.",extension)
    WHERE category NOT IN ("folder","hub");

    update _des_media set 
    update_file_path =  CONCAT( update_parent_path,"/", id ,"-orig.",extension)
    WHERE category NOT IN ("folder","hub");


	  
   
      DELETE FROM media WHERE id in (SELECT  id FROM _src_media );
      
      SET @sql = CONCAT('DELETE FROM ', _des_db , '.media WHERE id in (SELECT  id FROM _des_media )');
      PREPARE stmt FROM @sql ;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      
      
      SET @sql = CONCAT( 'INSERT INTO ',_des_db,'.media (id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank)
      SELECT id,update_file_path,user_filename,parent_id ,update_parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),
      last_download,download_count,metadata,caption,status,approval,rank FROM _src_media where is_update =1') ;
      PREPARE stmt FROM @sql ;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;


      SET @sql = CONCAT( 'INSERT INTO ',_des_db,'.media (id,file_path,user_filename,parent_id ,parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,publish_time,upload_time,
      last_download,download_count,metadata,caption,status,approval,rank)
      SELECT id,update_file_path,user_filename,parent_id ,update_parent_path,category,
      origin_id,owner_id,host_id,extension,mimetype,isalink,filesize,geometry,UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),
      last_download,download_count,metadata,caption,status,approval,rank FROM _des_media where is_update =1') ;
      PREPARE stmt FROM @sql ;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      
  
    
    
    SELECT 
      id, 
      id nid,
      parent_id pid,
      concat(_home_dir, "/__storage__/", parent_path) parent_path,
      concat(_home_dir, "/__storage__/", parent_path) sys_parent_path,
      file_path,
      user_filename filename,
      extension ext,
      category filetype,
      category
    FROM _des_media 
    WHERE 
      category NOT IN ("folder","hub")  AND
      is_delete =1  AND
      is_matched= 1 AND
      _option =1;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact`(
  IN _key          VARCHAR(100),
  IN _page         TINYINT(11),
  IN _filter_email  JSON,
  IN _status      VARCHAR(100)
)
BEGIN
  DECLARE _range INT(6);
  DECLARE _offset INT(6);
  DECLARE _uid VARCHAR(16);
  DECLARE _domain VARCHAR(512);
  DECLARE _mail  VARCHAR(500);


  DECLARE _length INTEGER DEFAULT 0;
  DECLARE _idx INTEGER DEFAULT 0;
  
  IF _status IN ('') THEN 
     SELECT NULL INTO  _status;
  END IF;

  SELECT  JSON_LENGTH(_filter_email)  INTO _length;
   
  DROP TABLE IF EXISTS  _temp_mail;
  CREATE TEMPORARY TABLE `_temp_mail` (  `email` varchar(5000) NOT NULL); 
  
  WHILE _idx < _length  DO 
     SELECT JSON_UNQUOTE(JSON_EXTRACT(_filter_email, CONCAT("$[", _idx, "]"))) INTO @_node;
     INSERT INTO _temp_mail SELECT  @_node;
     SELECT _idx + 1 INTO _idx;
  END WHILE;



  SELECT id FROM yp.entity WHERE db_name=database() INTO  _uid;
  SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;


  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    1 as is_mycontact,
    coalesce( du.id,de.id, c.entity) as id,
    coalesce (du.email,de.email,ce.email) email,
    c.firstname,
    c.lastname,
    CONCAT(IFNULL(c.firstname, ''), ' ', IFNULL(c.lastname, '')) as fullname,
    IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
    CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,
    NULL ident,
    CASE WHEN du.id IS NULL THEN 1 ELSE 0 END is_need_email,
    c.status,
    CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
    CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me 
    FROM contact c
    LEFT JOIN contact_email ce on ce.contact_id = c.id AND ce.is_default = 1
    LEFT JOIN yp.drumate de ON de.id = c.entity
    LEFT JOIN yp.drumate du ON du.id = c.uid
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.drumate dm ON dm.email = ce.email
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = dm.id) 
            AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    WHERE 
      (c.firstname LIKE CONCAT(TRIM(_key), '%') OR 
        c.lastname LIKE CONCAT(TRIM(_key), '%') OR 
        c.surname LIKE CONCAT(TRIM(_key), '%') OR 
        c.source LIKE CONCAT(TRIM(_key), '%') ) AND c.status <> 'received'
        AND  _status = CASE WHEN c.status = 'active' THEN 'active' ELSE 'paper' END 
        AND coalesce (du.email,de.email,ce.email)  not in  (SELECT email FROM _temp_mail)
    ORDER BY surname ASC, c.id ASC  LIMIT _offset, _range;



  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `my_contact_add`(
  IN _entity    VARCHAR(1000),
  IN _surname   VARCHAR(255),
  IN _firstname VARCHAR(255),
  IN _lastname  VARCHAR(255),
  IN _category  VARCHAR(255),
  IN _comment  MEDIUMTEXT,
  IN _message  MEDIUMTEXT
)
BEGIN

  DECLARE _id VARCHAR(16);
  SELECT id FROM (SELECT  yp.uniqueId() id ) a  WHERE _id IS NULL INTO _id ; 

  IF _firstname IN ('') THEN 
   SELECT NULL INTO  _firstname;
  END IF;

  IF _lastname IN ('') THEN 
   SELECT NULL INTO  _lastname;
  END IF;

  IF _surname IN ('') THEN 
   SELECT NULL INTO  _surname;
  END IF;

 IF _comment IN ('') THEN 
   SELECT NULL INTO  _comment;
  END IF;

 IF _message IN ('') THEN 
   SELECT NULL INTO  _message;
  END IF;

  INSERT INTO contact 
  (id,surname,firstname,lastname,category,entity,comment,message,status,ctime,mtime) 
  values( _id, _surname,_firstname,_lastname ,_category ,_entity, _comment,_message,'memory', UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
  

  SELECT * FROM contact WHERE id= _id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_address_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_address_add`(
  IN  _contact_id VARCHAR(16),  
  IN _addresses  MEDIUMTEXT
)
BEGIN
 
 DECLARE _idx INTEGER DEFAULT 0;
 DECLARE _category VARCHAR(255);
 DECLARE _street VARCHAR(255);
 DECLARE _city VARCHAR(255);
 DECLARE _country VARCHAR(255);
 DECLARE _address VARCHAR(255);
 DECLARE _id VARCHAR(16);

  
  WHILE _idx < JSON_LENGTH(_addresses) DO 
    
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_addresses, CONCAT("$[", _idx, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.street")) INTO _street;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.city")) INTO _city;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.country")) INTO _country;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.category")) INTO _category;

    SET _address ='{}';
    
    IF _street IS NOT NULL THEN 
      SELECT JSON_insert(_address , '$.street' , _street) INTO _address ;
    END IF ;
    IF _city IS NOT NULL THEN  
      SELECT JSON_insert(_address , '$.city' , _city) INTO  _address ; 
    END IF; 
    IF _country IS NOT NULL THEN  
      SELECT JSON_insert(_address , '$.country' , _country) INTO  _address ;  
    END IF ;
    SELECT  yp.uniqueId() INTO _id ; 

    INSERT INTO contact_address (id,address,category,ctime,mtime ,contact_id )
    SELECT _id,_address,_category, UNIX_TIMESTAMP(), UNIX_TIMESTAMP() ,_contact_id ;
    
    SELECT _idx + 1 INTO _idx;
  END WHILE;

  SELECT id, 
   JSON_UNQUOTE(JSON_EXTRACT(address, '$.street')) AS street,
   JSON_UNQUOTE(JSON_EXTRACT(address, '$.city')) AS city,
   JSON_UNQUOTE(JSON_EXTRACT(address, '$.country')) AS country
  FROM contact_address WHERE id= _contact_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_address_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_address_delete`(
  IN  _contact_id VARCHAR(16), 
  IN  _id VARCHAR(16)  
)
BEGIN

  IF _id IN ('',  '0') THEN 
   SELECT NULL INTO  _id;
  END IF;
 
  IF _id IS NULL THEN
    DELETE FROM contact_address WHERE contact_id = _contact_id;
  ELSE 
    DELETE FROM contact_address WHERE id =_id AND  contact_id = _contact_id;
  END IF; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_address_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_address_get`(
  IN  _contact_id VARCHAR(16)
)
BEGIN

  SELECT 
    id as address_id ,    
    JSON_UNQUOTE(JSON_EXTRACT(address, '$.street')) AS street,
    JSON_UNQUOTE(JSON_EXTRACT(address, '$.city')) AS city,
    JSON_UNQUOTE(JSON_EXTRACT(address, '$.country')) AS country, 
    category  
    FROM  contact_address WHERE contact_id = _contact_id
  ORDER BY sys_id ASC;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_add_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_add_next`(
  IN _entity    VARCHAR(1000),
  IN _surname   VARCHAR(255),
  IN _firstname VARCHAR(255),
  IN _lastname  VARCHAR(255),
  IN _category  VARCHAR(255),
  IN _comment  MEDIUMTEXT,
  IN _message  MEDIUMTEXT,
  IN _metadata JSON 
)
BEGIN

  DECLARE _id VARCHAR(16);
  SELECT id FROM (SELECT  yp.uniqueId() id ) a  WHERE _id IS NULL INTO _id ; 

  IF _firstname IN ('') THEN 
   SELECT NULL INTO  _firstname;
  END IF;

  IF _lastname IN ('') THEN 
   SELECT NULL INTO  _lastname;
  END IF;

  IF _surname IN ('') THEN 
   SELECT NULL INTO  _surname;
  END IF;

 IF _comment IN ('') THEN 
   SELECT NULL INTO  _comment;
  END IF;

 IF _message IN ('') THEN 
   SELECT NULL INTO  _message;
  END IF;

  INSERT INTO contact 
  (id,surname,firstname,lastname,category,entity,comment,message,status,ctime,mtime) 
  values( _id, _surname,_firstname,_lastname ,_category ,_entity, _comment,_message,'memory', UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
  

  UPDATE contact 
    SET metadata =  _metadata
  WHERE id =  _id; 

  SELECT * FROM contact WHERE id= _id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_default_chk` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_default_chk`(
    IN _email_id  VARCHAR(16),
    IN _contact_id VARCHAR(16)  
)
BEGIN

  DECLARE _email VARCHAR(255);

    SELECT email FROM contact_email WHERE id = _email_id INTO _email;

        SELECT email FROM contact 
        WHERE contact_id = _contact_id 
        AND email = _email LIMIT 1;
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_default_exist` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_default_exist`(
    IN _email  VARCHAR(255),
    IN _contact_id VARCHAR(16)  
)
BEGIN

  IF _contact_id IN ('',  '0') THEN 
   SELECT NULL INTO  _contact_id;
  END IF;

    IF _contact_id IS NOT NULL THEN 
        SELECT email FROM contact 
        WHERE id <> _contact_id 
        AND email = _email  AND email IS NOT NULL LIMIT 1;
    ELSE 
        SELECT email FROM contact 
        WHERE  email = _email AND email IS NOT NULL LIMIT 1;         
    END IF;    


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_delete`(
  IN  _contact_id VARCHAR(16)
)
BEGIN
  DECLARE _category VARCHAR(255);
  DECLARE _id VARCHAR(255);
  DECLARE _drumate_db VARCHAR(255);
  DECLARE _email VARCHAR(1000);
  

  SELECT IFNULL(uid,entity) FROM contact WHERE (id = _contact_id OR  uid =_contact_id) INTO _id; 
  SELECT db_name FROM yp.entity WHERE id=_id INTO _drumate_db;
  
  SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _id;  
  SELECT email FROM yp.drumate WHERE id = _id  INTO _email;  
  IF _drumate_db IS NOT NULL THEN

    SET @st = CONCAT('DELETE FROM ', _drumate_db ,'.contact WHERE (uid =? or entity = ? or uid = ? or entity =?) AND status="received"');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _id,_id,_email,_email;
    DEALLOCATE PREPARE stamt; 

    SET @st = CONCAT('UPDATE ', _drumate_db ,'.contact_email SET  is_default = 0 WHERE   is_default = 1 AND contact_id  = (SELECT id FROM ', _drumate_db ,'.contact WHERE uid =? or entity = ? or uid = ? or entity =? )');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _id,_id,_email,_email;
    DEALLOCATE PREPARE stamt;

    SET @st = CONCAT('UPDATE ', _drumate_db ,'.contact_email SET  is_default = 0 WHERE   is_default = 1 AND contact_id  = (SELECT id FROM ', _drumate_db ,'.contact WHERE uid =? or entity = ? or uid = ? or entity =? )');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _id,_id,_email,_email;
    DEALLOCATE PREPARE stamt;

    SET @st = CONCAT('DELETE FROM ', _drumate_db ,'.contact_email WHERE  email =? AND contact_id  = (SELECT id FROM ', _drumate_db ,'.contact WHERE uid =? or entity = ? or uid = ? or entity =? )');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _email,_id,_id,_email,_email;
    DEALLOCATE PREPARE stamt;


    SET @st = CONCAT('INSERT INTO ', _drumate_db ,'.contact_email (id,email,category,ctime,mtime ,contact_id ,is_default )
    SELECT  yp.uniqueId(),?,"priv",UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),id,1 FROM ', _drumate_db ,'.contact WHERE uid =? or entity = ? or uid = ? or entity =? 
    ON DUPLICATE KEY UPDATE is_default =1');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING _email,_id,_id,_email,_email;
    DEALLOCATE PREPARE stamt;


    SET @st = CONCAT('UPDATE ', _drumate_db ,'.contact SET category ="independant", metadata = JSON_OBJECT("source",? ), status="memory", uid = null, entity=? WHERE uid =? or entity =? or uid = ? or entity =?');
    PREPARE stamt FROM @st;
    EXECUTE stamt USING  _email,_id,_id,_id,_id,_email;
    DEALLOCATE PREPARE stamt;


   SELECT NULL INTO  @_contact_id; 
   SET @st = CONCAT('SELECT id FROM ', _drumate_db ,'.contact WHERE (uid =? or entity = ? or uid = ? or entity =?)  INTO @_contact_id');
   PREPARE stamt FROM @st;
   EXECUTE stamt USING _id,_id,_email,_email;
   DEALLOCATE PREPARE stamt; 


   SET @st = CONCAT(' CALL ', _drumate_db ,'.contact_block_update(?)');
   PREPARE stamt FROM @st;
   EXECUTE stamt USING @_contact_id;
   DEALLOCATE PREPARE stamt; 

  END  IF ;
    DELETE FROM map_tag WHERE id = _contact_id;   
    DELETE FROM contact WHERE id = _contact_id; 
    DELETE FROM contact_email WHERE contact_id = _contact_id;
    DELETE FROM contact_phone WHERE contact_id = _contact_id;
    DELETE FROM contact_address WHERE contact_id = _contact_id;
    CALL contact_block_delete(_contact_id);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_exists` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_exists`(
  IN  _key  VARCHAR(255),
  IN  _value1  VARCHAR(255),
  IN  _value2  VARCHAR(255),
  IN _contact_id VARCHAR(16)  
)
BEGIN

  IF _contact_id IN ('',  '0') THEN 
   SELECT NULL INTO  _contact_id;
  END IF;

   IF _value1 IN ('',  '0') THEN 
   SELECT NULL INTO  _value1;
  END IF;
	
   IF _value2 IN ('', '0') THEN 
   SELECT NULL INTO  _value2;
  END IF;


  IF _contact_id IS NULL THEN 
  
    IF (_key = 'name') THEN
     SELECT * FROM contact
     WHERE NULLIF(firstname,-99) = NULLIF(_value1,-99)  AND NULLIF(lastname,-99) = NULLIF(_value2,-99) AND _value1 IS NOT NULL AND 
     _value2 IS NOT     NULL     LIMIT 1;
    END IF ; 

    IF (_key = 'entity') THEN
     SELECT * FROM contact
     WHERE NULLIF(entity,-99) = NULLIF(_value1,-99)  
     LIMIT 1;
    END IF ; 
  
  ELSE 
    IF (_key = 'name') THEN
    SELECT * FROM contact
     WHERE NULLIF(firstname,-99) = NULLIF(_value1,-99)  AND 
     NULLIF(lastname,-99) = NULLIF(_value2,-99) AND 
     _value1 IS NOT NULL AND 
     _value2 IS NOT  NULL AND 
     id <> _contact_id
      LIMIT 1;
    END IF ; 

    IF (_key = 'entity') THEN
     SELECT * FROM contact
     WHERE NULLIF(entity,-99) = NULLIF(_value1,-99)  AND 
     id <> _contact_id
     LIMIT 1;
    END IF ; 

  END IF;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `my_contact_get`(
  IN  _key  VARCHAR(255),
  IN _contact_id VARCHAR(16)  
)
BEGIN
  DECLARE _uid VARCHAR(120);
 
  IF _contact_id IN ('', '0') THEN 
   SELECT NULL INTO  _contact_id;
  END IF; 

  IF _contact_id IS NULL THEN 
    
    SELECT c.id as id,
      c.entity,	 
      c.surname,
      c.firstname,
      c.lastname,
      c.comment, 
      c.ctime, 
      c.mtime, 
      c.category, 
      c.uid, 
      c.status,
      e.ident ,
      CASE WHEN d.id IS NULL THEN 1 ELSE 0 END is_need_email 
    FROM contact c 
    LEFT JOIN yp.entity e on e.id=c.uid
    LEFT JOIN yp.drumate d on d.id=c.entity
    WHERE c.id= _key ; 
  ELSE

    SELECT id as contact_id ,surname,firstname,lastname,comment,ctime,mtime,category,uid, _uid ident FROM contact 
    WHERE id <> _contact_id AND CONCAT(firstname, ' ', lastname)  = _key LIMIT 1;
  
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_get_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_get_next`(
  IN  _key  VARCHAR(255),
  IN _contact_id VARCHAR(16)  
)
BEGIN
  DECLARE _uid VARCHAR(120);
  DECLARE _mail  VARCHAR(500);
  DECLARE _domain_id INT ;
  
    SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _uid;
    SELECT email FROM yp.drumate WHERE id = _uid INTO _mail;
    SELECT 1 INTO _domain_id;
    SELECT domain_id FROM yp.privilege p WHERE  p.domain_id <> 1 AND p.uid = _uid INTO _domain_id; 
 
  IF _contact_id IN ('', '0') THEN 
   SELECT NULL INTO  _contact_id;
  END IF; 

  IF _contact_id IS NULL THEN 
    
    SELECT c.id as id,
      c.entity,	 
      c.firstname,
      c.lastname,
      c.comment, 
      c.ctime, 
      c.invitetime,
      c.mtime, 
      c.category, 
      c.uid, 
      c.status,
      c.source,
      c.metadata,
      IFNULL(du.connected,-1) connected,
      du.username ident, du.username,
      e.dom_id domain_id,
      CASE WHEN  yp.user_exists( c.entity)=1 THEN 1 ELSE 0 END is_drumate ,
      CASE WHEN _domain_id <> 1 AND _domain_id = e.dom_id THEN 1 ELSE 0 END is_same_domain,
      IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
      c.surname given_surname,
      CASE WHEN du.id IS NULL THEN 1 ELSE 0 END is_need_email , 
      CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
      CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me ,
      CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END is_archived  
    FROM contact c 
    LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
    LEFT JOIN yp.entity e on e.id=c.uid
    LEFT JOIN yp.drumate de on de.id=c.entity
    LEFT JOIN yp.drumate du ON du.id = c.uid 
    LEFT JOIN archive_entity ae ON ae.entity_id = c.id
    LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
    LEFT JOIN yp.drumate dm ON dm.email = ce.email
    LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = dm.id) 
      AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
    WHERE c.id= _key ; 
  ELSE

    SELECT id as contact_id ,surname,firstname,lastname,comment,ctime,mtime,category,uid, _uid ident,
    CASE WHEN  yp.user_exists( entity)=1 THEN 1 ELSE 0 END is_drumate 
    FROM contact 
    WHERE id <> _contact_id AND CONCAT(firstname, ' ', lastname)  = _key LIMIT 1;
  
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_mail_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_mail_add`(
  IN  _contact_id VARCHAR(16), 
  IN  _emails  MEDIUMTEXT
)
BEGIN
 
 DECLARE _idx INTEGER DEFAULT 0;
 DECLARE _category VARCHAR(255);
 DECLARE _email VARCHAR(255);
 DECLARE _id VARCHAR(16);
 DECLARE _uid VARCHAR(16);
 DECLARE  _contact_category   VARCHAR(255); 
 DECLARE _is_default INTEGER DEFAULT 0;
 DECLARE _length INTEGER DEFAULT 0;
 

  SELECT category FROM contact WHERE id = _contact_id INTO _contact_category;
  SELECT  JSON_LENGTH(_emails)  INTO _length;

  WHILE _idx < _length  DO 

    SELECT JSON_UNQUOTE(JSON_EXTRACT(_emails, CONCAT("$[", _idx, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.email")) INTO _email;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.category")) INTO _category;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.is_default")) INTO _is_default;
    
    SELECT NULL INTO _uid;
    SELECT  yp.uniqueId() INTO _id ; 

   
    INSERT INTO contact_email (id,email,category,ctime,mtime ,contact_id ,is_default )
    SELECT _id,_email,_category, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(),_contact_id,_is_default;
    


    SELECT _idx + 1 INTO _idx;
  END WHILE;

  SELECT * FROM contact_email WHERE id= _contact_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_mail_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_mail_delete`(
  IN  _contact_id VARCHAR(16), 
  IN  _id VARCHAR(16)  
)
BEGIN
 
  IF _id IN ('',  '0') THEN 
   SELECT NULL INTO  _id;
  END IF;
  
  IF _id IS NULL THEN
    DELETE FROM contact_email WHERE contact_id = _contact_id;
  ELSE 
    DELETE FROM contact_email WHERE id =_id AND  contact_id = _contact_id;
  END IF;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_mail_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_mail_get`(
  IN  _contact_id VARCHAR(16)
)
BEGIN

  DECLARE _contact_category  VARCHAR(255); 
 
  SELECT category FROM contact WHERE id = _contact_id INTO _contact_category;
    SELECT 
      ce.id as email_id, ce.email, ce.category, is_default
    FROM  
    contact_email ce 
    WHERE ce.contact_id = _contact_id
    ORDER BY ce.sys_id ASC;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_online` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `my_contact_online`(
)
BEGIN

  SELECT s.uid, c.firstname, s.id, s.server 
    FROM yp.socket s INNER JOIN contact c ON s.uid=c.uid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_phone_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_phone_add`(
  IN  _contact_id VARCHAR(16),  
  IN _phones  MEDIUMTEXT
)
BEGIN
 
 DECLARE _idx INTEGER DEFAULT 0;
 DECLARE _category VARCHAR(255);
 DECLARE _phone VARCHAR(255);
 DECLARE _id VARCHAR(16);
 DECLARE _areacode VARCHAR(255); 
  
  WHILE _idx < JSON_LENGTH(_phones) DO 
    
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_phones, CONCAT("$[", _idx, "]"))) INTO @_node;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.phone")) INTO _phone;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.areacode")) INTO _areacode;
    SELECT JSON_UNQUOTE(JSON_EXTRACT(@_node, "$.category")) INTO _category;
    SELECT  yp.uniqueId() INTO _id ; 
    
    INSERT INTO contact_phone (id,phone,areacode,category,ctime,mtime,contact_id)
    SELECT _id,_phone,_areacode,_category, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(),_contact_id;
    
    SELECT _idx + 1 INTO _idx;
  END WHILE;

  SELECT * FROM contact_phone WHERE id= _contact_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_phone_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_phone_delete`(
  IN  _contact_id VARCHAR(16), 
  IN  _id VARCHAR(16)
)
BEGIN
 
  IF _id IN ('',  '0') THEN 
   SELECT NULL INTO  _id;
  END IF;

  IF _id IS NULL THEN
    DELETE FROM contact_phone WHERE contact_id = _contact_id;
  ELSE 
    DELETE FROM contact_phone WHERE id =_id AND  contact_id = _contact_id;
  END IF; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_phone_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_phone_get`(
  IN  _contact_id VARCHAR(16)
)
BEGIN

  SELECT id as phone_id ,areacode, phone, category  FROM  contact_phone WHERE contact_id = _contact_id
  ORDER BY sys_id ASC;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_show` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `my_contact_show`(
  IN _tag_id  VARCHAR(16), 
  IN _sort_by VARCHAR(20),
  IN _order   VARCHAR(20),
  IN _page INT(6)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
    DECLARE _lvl INT(4);
    CALL pageToLimits(_page, _offset, _range); 

    DROP TABLE IF EXISTS _tag;
      CREATE TEMPORARY TABLE _tag(
        `tag_id` varchar(16) NOT NULL,
        `is_checked` boolean default 0
      );

    DROP TABLE IF EXISTS _map_tag;
      CREATE TEMPORARY TABLE _map_tag(
        `tag_id` varchar(16) NOT NULL,
        `id`     varchar(16) NOT NULL
      );

   
    IF _tag_id IS  NULL OR (ltrim(_tag_id) = '') THEN
      INSERT INTO _tag (tag_id) SELECT tag_id from  tag ; 
    ELSE 
       
      INSERT INTO _tag (tag_id) SELECT _tag_id;
      WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id;
        INSERT INTO _tag (tag_id) SELECT tag_id FROM tag WHERE  parent_tag_id = _tag_id;
        UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
      END WHILE; 
    END IF;


    INSERT INTO _map_tag (tag_id,id) SELECT tag_id ,id FROM  map_tag WHERE tag_id in (SELECT tag_id FROM _tag); 


    SELECT 
      _page as `page`, 
      c.id, 
      1 as is_mycontact, 
      'my_contact' as type,
      c.firstname,
      c.lastname, 
      c.comment,
      c.ctime,
      c.entity entity,
      IFNULL(c.surname, IFNULL(c.firstname, d.firstname)) surname,
      IF(socket.uid, 1, 0) is_online,
      CASE WHEN c.uid IS NULL THEN 0 ELSE 1 END   is_drumate ,e.ident,c.status,
      CASE WHEN d.id IS NULL THEN 1 ELSE 0 END is_need_email  
    FROM
      contact c
      LEFT JOIN yp.entity e ON e.id = c.uid
      LEFT JOIN yp.drumate d ON d.id = c.entity
      LEFT JOIN yp.socket ON socket.uid = c.uid
    WHERE 
     CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  c.id IN ( SELECT id FROM _map_tag) ELSE c.id =c.id END 
     AND c.status <> 'received' 
    ORDER BY 
      CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN c.ctime END ASC,
      CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN c.ctime END DESC,
      CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN CONCAT(c.firstname, ' ', c.lastname) END ASC,
      CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN CONCAT(c.firstname, ' ', c.lastname) END DESC
  LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_show_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_show_next`(
  IN _tag_id  VARCHAR(16), 
  IN _sort_by VARCHAR(20),
  IN _order   VARCHAR(20),
  IN _option VARCHAR(20),
  IN _page INT(6)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  DECLARE _lvl INT(4);
  DECLARE _online INT(4) DEFAULT 0;
  DECLARE _uid  VARCHAR(16);
  DECLARE _mail  VARCHAR(500);
  CALL pageToLimits(_page, _offset, _range); 

    
    SELECT id, email FROM yp.entity INNER JOIN yp.drumate USING(id)
      WHERE db_name=DATABASE() INTO _uid, _mail;

    

    DROP TABLE IF EXISTS _tag;
      CREATE TEMPORARY TABLE _tag(
        `tag_id` varchar(16) NOT NULL,
        `is_checked` boolean default 0
      );

    DROP TABLE IF EXISTS _map_tag;
      CREATE TEMPORARY TABLE _map_tag(
        `tag_id` varchar(16) NOT NULL,
        `id`     varchar(16) NOT NULL
      );

   
    IF _tag_id IS  NULL OR (ltrim(_tag_id) = '') THEN
      INSERT INTO _tag (tag_id) SELECT tag_id from  tag ; 
    ELSE 
       
      INSERT INTO _tag (tag_id) SELECT _tag_id;
      WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id;
        INSERT INTO _tag (tag_id) SELECT tag_id FROM tag WHERE  parent_tag_id = _tag_id;
        UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
      END WHILE; 
    END IF;


    INSERT INTO _map_tag (tag_id,id) SELECT tag_id ,id FROM  map_tag WHERE tag_id in (SELECT tag_id FROM _tag); 


    SELECT 
      _page as `page`, 
      c.id, 
      1 as is_mycontact, 
      'my_contact' as type,
      c.firstname,
      c.lastname, 
      c.comment,
      c.ctime,
      c.entity entity,
      IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
      c.surname given_surname,
      IF(socket.uid IS NULL, 0, du.connected) online,
      CASE WHEN  yp.user_exists( c.entity)=1 THEN 1 ELSE 0 END is_drumate ,
      du.username ident, du.username,c.status,
      CASE WHEN du.id IS NULL THEN 1 ELSE 0 END is_need_email , 
      CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
      CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me ,
      CASE WHEN ae.entity_id IS NOT NULL THEN 1 ELSE 0 END is_archived
    FROM
      contact c
      LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
      LEFT JOIN yp.drumate de ON de.id = c.entity
      LEFT JOIN yp.drumate du ON du.id = c.uid 
      LEFT JOIN (SELECT distinct uid FROM yp.socket) socket ON socket.uid = c.entity
      LEFT JOIN yp.entity e ON e.id = c.uid 
      LEFT JOIN yp.contact_block mycb ON c.id = mycb.contact_id
      LEFT JOIN yp.drumate dm ON dm.email = ce.email
      LEFT JOIN yp.contact_block hiscb ON (hiscb.owner_id =  c.entity OR hiscb.owner_id = dm.id) 
            AND( hiscb.uid = _uid OR hiscb.entity = _uid OR hiscb.entity = _mail ) 
      LEFT JOIN archive_entity ae ON ae.entity_id = c.id
    WHERE 
     CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  c.id IN ( SELECT id FROM _map_tag) ELSE c.id =c.id END 
     AND c.status <> 'received' 
     AND  CASE WHEN  _option = 'sent' THEN c.status
          ELSE (CASE WHEN  entity_id  IS NOT NULL THEN 'archived' ELSE 'active'  END) END = _option       
    ORDER BY 
      CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'asc' THEN c.ctime END ASC,
      CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_order) = 'desc' THEN c.ctime END DESC,
      CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'asc' THEN
      IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) 
      END ASC,
      CASE WHEN LCASE(_sort_by) = 'name' and LCASE(_order) = 'desc' THEN 
      IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, IFNULL(ce.email,de.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) 
      END DESC ,  c.id ASC
  LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_sync` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_sync`(
  IN _owner_id VARCHAR(16)
)
BEGIN

  DELETE FROM contact_phone WHERE contact_id IN(
  SELECT uid FROM yp.contact_sync WHERE status <>'ok' AND owner_id =_owner_id);
  
  DELETE FROM contact_address WHERE contact_id IN(
  SELECT uid FROM yp.contact_sync WHERE status <>'ok' AND owner_id =_owner_id);

  DELETE FROM contact_email WHERE contact_id IN(
  SELECT uid FROM yp.contact_sync  WHERE status <>'ok' AND owner_id =_owner_id);

  DELETE FROM contact WHERE entity IN(
  SELECT uid FROM yp.contact_sync WHERE status <>'ok' AND owner_id =_owner_id);

  DELETE FROM contact WHERE id IN(
  SELECT uid FROM yp.contact_sync WHERE status ='delete' AND owner_id =_owner_id);
 
  DELETE FROM yp.contact_sync WHERE status ='delete' AND owner_id =_owner_id;

  INSERT INTO contact (id,firstname,lastname,category,entity,uid,status,metadata,ctime,mtime) 
  SELECT id, firstname,lastname,'drumate',id,id,'active',JSON_OBJECT("source",email), UNIX_TIMESTAMP(),UNIX_TIMESTAMP() FROM yp.drumate t
  WHERE id IN (SELECT uid FROM yp.contact_sync WHERE  status <>'ok' AND owner_id =_owner_id)
  ON DUPLICATE KEY UPDATE id = t.id,entity=t.id,uid=t.id,
  firstname =t.firstname ,lastname=t.lastname,  metadata = JSON_OBJECT("source",t.email),
  surname = surname , comment=comment, message =message ,ctime=ctime,mtime =UNIX_TIMESTAMP();

  INSERT INTO contact_email (id,email,category,ctime,mtime ,contact_id ,is_default )
  SELECT id, email,'prof', UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),id,1 FROM yp.drumate t
  WHERE id IN (SELECT uid FROM yp.contact_sync WHERE status <>'ok' AND owner_id =_owner_id)
  ON DUPLICATE KEY UPDATE email=t.email, ctime=ctime,mtime =UNIX_TIMESTAMP();


  INSERT INTO contact_phone (id,areacode,phone,category,ctime,mtime,contact_id)
  SELECT id, read_json_object(profile, "areacode"),read_json_object(profile, "mobile"),'prof', UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),id FROM yp.drumate 
  WHERE id IN (SELECT uid FROM yp.contact_sync WHERE status<>'ok' AND owner_id =_owner_id);
    
  INSERT INTO contact_address (id,address,category,ctime,mtime,contact_id)
  SELECT id, read_json_object(profile, "address"),'prof', UNIX_TIMESTAMP(),UNIX_TIMESTAMP(),id FROM yp.drumate 
  WHERE id IN (SELECT uid FROM yp.contact_sync WHERE status <>'ok' AND owner_id =_owner_id);
      
 
  UPDATE yp.contact_sync SET status='ok' WHERE status<>'ok' AND owner_id =_owner_id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_update` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `my_contact_update`(
  IN  _id VARCHAR(16),  
  IN _surname   VARCHAR(255),
  IN _firstname VARCHAR(255),
  IN _lastname  VARCHAR(255),
  IN _comment  MEDIUMTEXT,
  IN _message  MEDIUMTEXT,
  IN _entity   VARCHAR(1000)   

)
BEGIN

 
  DECLARE _old_status  VARCHAR(255) ; 
  DECLARE _old_entity  VARCHAR(255) ; 
  DECLARE _uid VARCHAR(16);
  DECLARE _entitydb VARCHAR(255);
 
  IF _firstname IN ('') THEN 
   SELECT NULL INTO  _firstname;
  END IF;

  IF _lastname IN ('') THEN 
   SELECT NULL INTO  _lastname;
  END IF;

 IF _surname IN ('') THEN 
   SELECT NULL INTO  _surname;
  END IF;

 IF _comment IN ('') THEN 
   SELECT NULL INTO  _comment;
  END IF;

 IF _message IN ('') THEN 
   SELECT NULL INTO  _message;
  END IF;

 
  SELECT entity,status FROM contact  WHERE id = _id INTO _old_entity, _old_status;

  SELECT id FROM yp.entity WHERE db_name=database() INTO  _uid;

  IF (_old_status NOT IN ('informed','received','active') AND _entity <> _old_entity) THEN
     SELECT _old_entity INTO _old_entity;
     DELETE FROM  yp.token WHERE email = _old_entity AND inviter_id = _uid;
     SELECT db_name FROM yp.entity WHERE id=_old_entity  INTO _entitydb;

    
    IF _entitydb IS NOT NULL THEN
      SET @st = CONCAT("DELETE FROM  " , _entitydb ,".contact WHERE  status ='received' AND entity = ? ");
      PREPARE stamt FROM @st;
      EXECUTE stamt USING _uid;
      DEALLOCATE PREPARE stamt;
    ELSE  
      SELECT NULL INTO _old_entity;
    END IF;  
    UPDATE contact SET status =  'memory'    WHERE id = _id;
  ELSE 
      SELECT NULL INTO _old_entity;
  END IF ; 

  UPDATE contact 
  SET surname=  _surname , firstname = _firstname, lastname=_lastname , comment = _comment ,message= _message ,entity = _entity,mtime =UNIX_TIMESTAMP()
  WHERE id = _id;

  SELECT c.* , _old_entity old_entity  FROM contact c WHERE id= _id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_contact_update_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_contact_update_next`(
  IN  _id VARCHAR(16),  
  IN _surname   VARCHAR(255),
  IN _firstname VARCHAR(255),
  IN _lastname  VARCHAR(255),
  IN _comment  MEDIUMTEXT,
  IN _message  MEDIUMTEXT,
  IN _entity   VARCHAR(1000),
  IN _metadata JSON    

)
BEGIN

 
  DECLARE _old_status  VARCHAR(255) ; 
  DECLARE _old_entity  VARCHAR(255) ; 
  DECLARE _uid VARCHAR(16);
  DECLARE _entitydb VARCHAR(255);
 
  IF _firstname IN ('') THEN 
   SELECT NULL INTO  _firstname;
  END IF;

  IF _lastname IN ('') THEN 
   SELECT NULL INTO  _lastname;
  END IF;

 IF _surname IN ('') THEN 
   SELECT NULL INTO  _surname;
  END IF;

 IF _comment IN ('') THEN 
   SELECT NULL INTO  _comment;
  END IF;

 IF _message IN ('') THEN 
   SELECT NULL INTO  _message;
  END IF;

 
  SELECT entity,status FROM contact  WHERE id = _id INTO _old_entity, _old_status;

  SELECT id FROM yp.entity WHERE db_name=database() INTO  _uid;

  IF (_old_status NOT IN ('informed','received','active') AND _entity <> _old_entity) THEN
     SELECT _old_entity INTO _old_entity;
     DELETE FROM  yp.token WHERE email = _old_entity AND inviter_id = _uid;
     SELECT db_name FROM yp.entity WHERE id=_old_entity  INTO _entitydb;

    
    IF _entitydb IS NOT NULL THEN
      SET @st = CONCAT("DELETE FROM  " , _entitydb ,".contact WHERE  status ='received' AND entity = ? ");
      PREPARE stamt FROM @st;
      EXECUTE stamt USING _uid;
      DEALLOCATE PREPARE stamt;
    ELSE  
      SELECT NULL INTO _old_entity;
    END IF;  
    UPDATE contact SET status =  'memory'    WHERE id = _id;
  ELSE 
      SELECT NULL INTO _old_entity;
  END IF ; 

  UPDATE contact 
  SET  metadata= _metadata, surname=  _surname , firstname = _firstname, lastname=_lastname , comment = _comment ,message= _message ,entity = _entity,mtime =UNIX_TIMESTAMP()
  WHERE id = _id;

  CALL contact_block_update(_id);
  SELECT c.* , _old_entity old_entity  FROM contact c WHERE id= _id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_tag_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_tag_add`(
  IN  _entity_id VARCHAR(16), 
  IN  _tags  MEDIUMTEXT
)
BEGIN
 DECLARE _idx INTEGER DEFAULT 0;
 DECLARE _tag_id VARCHAR(16);
 DECLARE _length INTEGER DEFAULT 0;
 DECLARE _tag_time int(11) unsigned;
 DECLARE _category VARCHAR(50) DEFAULT 'contact';
 
 SELECT 'group' FROM media where id = _entity_id INTO  _category;

 SELECT UNIX_TIMESTAMP() INTO _tag_time; 
 
 SELECT  JSON_LENGTH(_tags)  INTO _length;

 WHILE _idx < _length  DO 
   SELECT JSON_UNQUOTE(JSON_EXTRACT(_tags, CONCAT("$[", _idx, "]"))) INTO _tag_id;
    INSERT INTO map_tag(tag_id,id, category,ctime) 
    SELECT _tag_id,_entity_id,_category ,_tag_time ON DUPLICATE KEY UPDATE ctime =_tag_time , tag_id=_tag_id;
    SELECT _idx + 1 INTO _idx;
  END WHILE;

  CALL my_tag_get (_entity_id);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_tag_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_tag_delete`(
  IN  _entity_id VARCHAR(16), 
  IN  _tag_id VARCHAR(16)  
)
BEGIN
 
  IF _tag_id IN ('',  '0') THEN 
   SELECT NULL INTO  _tag_id;
  END IF;
  
  IF _tag_id IS NULL THEN
    DELETE FROM map_tag WHERE id = _entity_id;
  ELSE 
    DELETE FROM map_tag WHERE tag_id =_tag_id AND  id = _entity_id;
  END IF;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `my_tag_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `my_tag_get`(
  IN  _entity_id VARCHAR(16)
)
BEGIN

  SELECT t.* FROM 
  tag t 
  INNER JOIN map_tag mt ON t.tag_id = mt.tag_id 
  WHERE mt.id =  _entity_id;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `node_from_path` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `node_from_path`(
  IN _path VARCHAR(1024)
)
BEGIN
  DECLARE _r VARCHAR(16);
  DECLARE _id VARCHAR(16);
  DECLARE _count INT(6);
  DECLARE _file_path VARCHAR(1024);

  SELECT id FROM media 
    WHERE TRIM('/' FROM file_path) = TRIM('/' FROM _path) AND category='folder'  LIMIT 1
    INTO _id;
  IF _id IS NOT NULL THEN 
    SELECT _path, _id INTO _file_path, _id;
  ELSE 
    SELECT TRIM('/' FROM _path) INTO @path;
    SET @node = @path;
    WHILE @path regexp  '.+\/.+' AND _id IS NULL DO 
      SELECT SUBSTRING_INDEX(@path, '/', -1) INTO @node;

      SELECT TRIM('/' FROM REPLACE(@path, @nodeh, '')) INTO @path;
      SELECT NULL INTO _id;
      SELECT @path AS parent_path, id FROM media 
        WHERE TRIM('/' FROM file_path) = @path AND category='folder'  LIMIT 1 
        INTO _file_path, _id;
    END WHILE;
    IF _id IS NULL THEN 
      SELECT TRIM('/' FROM REPLACE(_path, @node, '')) INTO @path;
      SELECT CONCAT('/', @path), id FROM media 
        WHERE TRIM('/' FROM file_path) = @path AND category='folder'  LIMIT 1 
        INTO _file_path, _id;
    END IF;
  END IF;
  SELECT _file_path AS file_path, _id AS id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pages_to_read` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `pages_to_read`(
  _entity_id  VARCHAR(16),
  _uid VARCHAR(16)
)
BEGIN
  DECLARE _page int(11);
  DECLARE _entity_id VARCHAR(16);  
  DECLARE _uid VARCHAR(16);
  DECLARE _ref_sys_id int(11) unsigned default 0 ;
  DECLARE _pos_cnt int(11) unsigned default 0 ;
  DECLARE _all_cnt int(11) unsigned default 0 ;

  DECLARE _range bigint;
  DECLARE _offset bigint;

  CALL pageToLimits(_page, _offset, _range);  
  
  SELECT ref_sys_id FROM read_channel WHERE entity_id = _entity_id AND  uid = _uid INTO _ref_sys_id;
  SELECT COUNT(sys_id) FROM channel WHERE  sys_id <=_ref_sys_id  INTO _pos_cnt ;
  SELECT COUNT(sys_id) FROM channel  INTO  _all_cnt ;

  SELECT  FLOOR( (IFNULL(_all_cnt,0)  - IFNULL(_pos_cnt,0))  /_range)+1  page;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pageToLimits` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `pageToLimits`(
  IN _page VARCHAR(32),
  OUT _offset BIGINT,
  OUT _range BIGINT
)
BEGIN
  IF @rows_per_page IS NULL THEN
    SET @rows_per_page=15;
  END IF;
  SELECT (_page - 1)*@rows_per_page, @rows_per_page INTO _offset,_range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_add_history` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_add_history`(
   IN _id        VARCHAR(512),
   IN _hashtag   VARCHAR(512),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _status    VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16)
)
BEGIN
    DECLARE _ts   INT(11) DEFAULT 0;
    SELECT UNIX_TIMESTAMP() INTO _ts;
    INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `status`, `isonline`, `ctime`)
      VALUES(_author_id, _id, _lang, _device, _hashtag, _status, _isonline, _ts);
    SELECT LAST_INSERT_ID() as history_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_copy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_copy`(
   IN _key    VARCHAR(16),
   IN _author  VARCHAR(160)
)
BEGIN
   DECLARE _id VARBINARY(16) DEFAULT '';
   DECLARE _hashtag VARCHAR(512);
   DECLARE _version TINYINT(4);
   DECLARE _tag VARCHAR(512);
   DECLARE _ident VARCHAR(512);

   SELECT id, hashtag FROM page WHERE (id=_key OR hashtag=_key) INTO _id, _hashtag;
   SELECT COUNT(*) FROM page WHERE hashtag LIKE concat(_hashtag, '-v%') INTO _version;
   SET _hashtag = CONCAT(_hashtag, '-v', _version);
   SELECT COUNT(*) FROM page WHERE hashtag = _hashtag INTO _version;
   WHILE _version > 0 DO
      SET _version = _version + 1;
      SET _hashtag = CONCAT(_hashtag, '-v', _version);
      SELECT COUNT(*) FROM page WHERE hashtag = _hashtag INTO _version;
   END WHILE;
   INSERT INTO page
      SELECT null, uniqueId(), serial, active, _author, _hashtag, `type`, editor, status, ctime, mtime, version
      FROM page WHERE id=_id;
   SELECT *, @vhost AS vhost, _id as src_id FROM page WHERE hashtag=_hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_copy_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_copy_new`(
   IN _history_id     VARCHAR(16),
   IN _author         VARCHAR(160),
   IN _to_lang        VARCHAR(20),
   IN _hashtag        VARCHAR(512),
   IN _new_page       VARCHAR(10)
)
BEGIN
   DECLARE _id VARBINARY(16) DEFAULT '';
   DECLARE _new_id VARBINARY(16) DEFAULT '';
   DECLARE _version TINYINT(4);
   DECLARE _tag VARCHAR(512);
   DECLARE _ident VARCHAR(512);
   DECLARE _lang varchar(10);
   DECLARE _device varchar(100);
   DECLARE _ts INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;
   DECLARE _page_exist INT(4) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   START TRANSACTION;
   SELECT master_id, lang, device FROM page_history WHERE serial = _history_id INTO _id, _lang, _device;
   
   SELECT EXISTS (SELECT serial FROM page_history WHERE master_id = _id AND lang = _to_lang AND device = _device) INTO _page_exist;
   IF _lang <> _to_lang AND _page_exist = 1 AND _new_page = "0" THEN
      SELECT 1 AS confirm_copy;
   ELSE
      IF _lang = _to_lang OR (_page_exist = 1 AND _lang <> _to_lang AND _new_page = "1") THEN
        SELECT UNIQUEID() INTO _new_id;
        IF IFNULL(_hashtag, '') = "" THEN
          SELECT hashtag FROM page WHERE id = _id INTO _hashtag;
          
          
          
          
          
          
          
          
          SELECT IFNULL(MAX(SUBSTRING_INDEX(hashtag, '-v', -1)),-1) as d FROM page
            WHERE hashtag REGEXP CONCAT(_hashtag, '-v[0-9]*$') INTO _version;
          SET _hashtag = CONCAT(_hashtag, '-v', _version + 1);

        END IF;
      ELSE
          SELECT _id INTO _new_id;
      END IF;

      UPDATE page_history SET status = 'history' WHERE master_id = _new_id AND lang = _to_lang AND device = _device;
      INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `status`, `isonline`, `meta`, `ctime`)
          VALUES(_author, _new_id, _to_lang, _device, 'draft', 0, _hashtag, _ts);
      SELECT LAST_INSERT_ID() INTO _last;

      IF _lang = _to_lang OR (_page_exist = 1 AND _lang <> _to_lang AND _new_page = "1") THEN
          INSERT INTO page (sys_id, id, serial, active, author_id, hashtag, `type`, editor, status, ctime, mtime, version)
              SELECT null, _new_id, _last, _last, _author, _hashtag, `type`, editor, status, _ts, _ts, version
              FROM page WHERE id=_id;
      END IF;
      COMMIT;
      SELECT *, _hashtag AS hashtag, @vhost AS vhost, _id as src_id, 0 AS confirm_copy FROM page_history WHERE serial=_last;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_delete_by_id_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_delete_by_id_lang`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
  
  DECLARE _eid VARCHAR (16);

  DELETE FROM page_history WHERE master_id = _id AND lang = _locale AND device = _device;
  DELETE page FROM page WHERE id = _id AND id NOT IN (SELECT master_id
    FROM page_history WHERE master_id = _id);
  
  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
  CALL yp.set_homepage(_eid);


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_delete_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_delete_by_lang`(
   IN _locale       VARCHAR(100)
)
BEGIN
  DELETE FROM page_history WHERE lang=_locale;
  DELETE page FROM page WHERE id NOT IN (SELECT master_id FROM page_history);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_exists` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_exists`(
  IN _hashtag        VARCHAR(512)
)
BEGIN
  SELECT id FROM page WHERE hashtag = _hashtag;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get`(
   IN _tag VARCHAR(512),
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16)
)
BEGIN
   DECLARE _existence INT(4);
   SELECT EXISTS (
    SELECT master_id FROM page LEFT JOIN page_history 
      ON master_id = page.id 
      WHERE page.id=_tag OR hashtag=_tag
      AND lang = _lang AND device = _device
   ) INTO _existence;
          
  IF _existence THEN
   SELECT 
    page.id, 
    active, 
    hashtag, 
    `type`, 
    editor, 
    page.status, 
    firstname, 
    lastname,
    ctime, 
    mtime, 
    version
      FROM page LEFT JOIN yp.drumate ON page.author_id=drumate.id
      WHERE (page.id=_tag OR hashtag=_tag);
      
      
      
      
  ELSE
    SELECT id, status FROM page WHERE id=_tag OR hashtag=_tag;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_base_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_base_by_lang`(
   IN _base_lang       VARCHAR(100)
)
BEGIN
  SELECT serial AS history_id, master_id AS page_id, lang, device, status, isonline, meta
    FROM page_history WHERE (lang = _base_lang AND isonline=1)
    OR (lang = _base_lang AND status='draft' AND isonline=0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_by_id` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_by_id`(
   IN _key VARCHAR(512)
)
BEGIN
  SELECT page.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
    FROM page LEFT JOIN yp.drumate ON author_id=drumate.id WHERE page.id = _key OR hashtag= _key;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_by_type` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_by_type`(
   IN _tag VARCHAR(512),
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16),
   IN _type  VARCHAR(16)

)
BEGIN
   SELECT page.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
         FROM page LEFT JOIN yp.drumate ON author_id=drumate.id WHERE `type`=_type;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_draft_publish` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_draft_publish`(
   IN _locale       VARCHAR(100),
   IN _published    INT(4),
   IN _hashtag      VARCHAR(500),
   IN _sort_by      VARCHAR(100),
   IN _sort         VARCHAR(100),
   IN _page         INT(11)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT bh.serial AS history_id, id AS page_id, lang, device, bh.status,
    isonline, hashtag  FROM page b INNER JOIN page_history bh ON b.id = bh.master_id
    WHERE lang = _locale AND hashtag LIKE CONCAT('%', TRIM(IFNULL(_hashtag,'')), '%')
    AND CASE WHEN _published = 1 OR _published = 2 THEN 
      CASE WHEN _published = 2 THEN (bh.status = 'draft' OR isonline=1)
      ELSE isonline = 1 END
    ELSE bh.status = 'draft' END
    ORDER BY
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_sort) = 'asc' THEN b.mtime END ASC,
    CASE WHEN LCASE(_sort_by) = 'date' and LCASE(_sort) = 'desc' THEN b.mtime END DESC,
    CASE WHEN LCASE(_sort) = 'desc' THEN hashtag END DESC,
    CASE WHEN LCASE(_sort) <> 'desc' THEN hashtag END ASC
    LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_thread` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_thread`(
  IN _key VARCHAR(500),
  IN _criteria VARCHAR(16),
  IN _page TINYINT(4)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _head int(6);
  DECLARE _hashtag VARCHAR(500);
  DECLARE _id VARBINARY(16);
  DECLARE _status VARCHAR(16);

  CALL pageToLimits(_page, _offset, _range);

  SELECT id, status, active, hashtag FROM page WHERE id=_key OR hashtag=_key
     INTO _id, _status, _head, _hashtag;

  IF _criteria LIKE "D%" THEN
    SELECT serial, author_id, master_id, lang, device, _hashtag as hashtag,
          master_id as id, firstname, lastname, ctime, _head as head
    FROM page_history LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE master_id=_id ORDER BY ctime DESC LIMIT _offset, _range;
  ELSE
    SELECT serial, author_id, master_id, lang, device, _hashtag as hashtag,
          master_id as id, firstname, lastname, ctime, _head as head
    FROM page_history LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE master_id=_id ORDER BY ctime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_get_used_languages` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_get_used_languages`(
  IN _hashtag  varchar(256)
)
BEGIN
  SELECT lang FROM page LEFT JOIN page_history ON page.id=master_id 
  WHERE hashtag=_hashtag or master_id=_hashtag GROUP BY lang;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_history_check_published` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_history_check_published`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
  SELECT EXISTS (SELECT serial FROM page_history WHERE master_id = _id AND isonline = 1
    AND lang = _locale AND device = _device) AS IS_PUBLISHED;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_history_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_history_log`(
  IN _tag VARCHAR(400),
  IN _device VARCHAR(16),
  IN _lang VARCHAR(16),
  IN _page TINYINT(4),
  IN _month INT(4),
  IN _year INT(4),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _active int(8);
  DECLARE _id   VARBINARY(16) DEFAULT '';
  DECLARE _hashtag   varchar(400);

  SELECT id, hashtag, active FROM page WHERE id=_tag OR hashtag=_tag INTO _id, _hashtag, _active;
  CALL pageToLimits(_page, _offset, _range);

  IF _criteria LIKE "D%" THEN
    SELECT _hashtag AS hashtag, author_id, _id AS id,
       serial, ctime, firstname, lastname,lang, device, IF(serial=_active, 1, 0) AS active,
       FROM_UNIXTIME(ctime) AS created_date, status, isonline
       FROM page_history LEFT JOIN (yp.drumate)
       ON author_id=drumate.id
       WHERE master_id=_id AND lang=_lang AND device=_device
       AND CASE WHEN IFNULL(_month,0) <> 0 AND IFNULL(_year,0) <> 0 THEN
       MONTH(FROM_UNIXTIME(ctime)) = _month ELSE true END
       AND CASE WHEN IFNULL(_year,0) <> 0 THEN
       YEAR(FROM_UNIXTIME(ctime)) = _year ELSE true END
       ORDER BY ctime DESC LIMIT _offset, _range;
  ELSE
    SELECT _hashtag AS hashtag, author_id, _id AS id,
       serial, ctime, firstname, lastname,lang, device, IF(serial=_active, 1, 0) AS active,
       FROM_UNIXTIME(ctime) AS created_date, status, isonline
       FROM page_history LEFT JOIN (yp.drumate)
       ON author_id=drumate.id
       WHERE master_id=_id AND lang=_lang AND device=_device
       AND CASE WHEN IFNULL(_month,0) <> 0 AND IFNULL(_year,0) <> 0 THEN
       MONTH(FROM_UNIXTIME(ctime)) = _month ELSE true END
       AND CASE WHEN IFNULL(_year,0) <> 0 THEN
       YEAR(FROM_UNIXTIME(ctime)) = _year ELSE true END
       ORDER BY ctime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_home` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_home`(
)
BEGIN
  DECLARE _languages VARCHAR(512);
  SELECT
    area, concat(TRIM(TRAILING '/' FROM home_dir), '/page/'), id from yp.entity where db_name=database()
  INTO @area, @root, @entity_id;
  SELECT GROUP_CONCAT(DISTINCT `base` SEPARATOR ':' ) FROM `language` WHERE `state`='active'
    INTO _languages;

  SELECT 
    @area as area, 
    @entity_id as eid, 
    @root AS page_root,
   _languages AS languages;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_id_get_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_id_get_by_lang`(
   IN _locale       VARCHAR(100)
)
BEGIN
  SELECT master_id as page_id FROM page_history WHERE lang=_locale GROUP BY master_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_index` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_index`(
   IN _hashtag  varchar(256),
   IN _lang  VARCHAR(6),
   IN _content  MEDIUMTEXT
)
BEGIN
   DECLARE _key  VARCHAR(25);
   SELECT CONCAT(id, '-', _lang) FROM page WHERE hashtag=_hashtag INTO _key;
   REPLACE INTO seo
     (`key`, `hashtag`, `lang`, `content`)
     VALUES(_key, _hashtag, _lang, _content);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_list`(
  IN _page TINYINT(4),
  IN _editor VARCHAR(10),
  IN _criteria VARCHAR(16)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);

  IF _criteria LIKE "D%" THEN
    SELECT
      page.id, serial, active, hashtag, `type`, `status`, `ctime`, `mtime`, `version`,
      remit, firstname, lastname
    FROM page LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE editor=_editor AND (`type`='page' OR `type`= 'page')
      ORDER BY mtime DESC LIMIT _offset, _range;
  ELSE
    SELECT
      page.id, serial, active, hashtag, `type`, `status`, `ctime`, `mtime`, `version`,
      remit, firstname, lastname
    FROM page LEFT JOIN yp.drumate on author_id=drumate.id
      WHERE editor=_editor AND (`type`='page' OR `type`= 'page')
      ORDER BY mtime ASC LIMIT _offset, _range;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_purge` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_purge`(
   IN _tag      varchar(400)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _hashtag   varchar(400);

   SELECT id, hashtag FROM page WHERE id=_tag OR hashtag=_tag INTO _id, _hashtag;

   DELETE FROM page_history WHERE master_id=_id;
   DELETE FROM page WHERE id=_id;
   SELECT _id as id, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_remove_item` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_remove_item`(
   IN _id      VARBINARY(16)
)
BEGIN
   DELETE FROM page WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_remove_thread` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_remove_thread`(
   IN _id      VARBINARY(16)
)
BEGIN
   DELETE FROM page WHERE id=_id;
   DELETE FROM thread WHERE mester_id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_rename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_rename`(
   IN _key     VARCHAR(512),
   IN _hashtag VARCHAR(512)
)
BEGIN

   UPDATE page SET hashtag=_hashtag WHERE (id=_key OR hashtag=_key);
   SELECT
     *,
     @vhost AS vhost
   FROM page WHERE hashtag=_hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_rename_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_rename_new`(
   IN _id             VARCHAR(16),
   IN _hashtag        VARCHAR(512)
)
BEGIN
   DECLARE _hash_exist INT(4) DEFAULT 0;
   DECLARE _eid VARCHAR (16);

   SELECT EXISTS (SELECT id FROM page WHERE id <> _id AND hashtag = _hashtag) INTO _hash_exist;

   IF _hash_exist = 0 THEN
    UPDATE page SET hashtag=_hashtag WHERE id=_id;
    UPDATE page_history SET meta=_hashtag WHERE master_id=_id;
   END IF;
  
  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
  CALL yp.set_homepage(_eid);   


   SELECT
      *,
      @vhost AS vhost, _hash_exist AS hash_exist
   FROM page WHERE id=_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_save` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_save`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   START TRANSACTION;

   INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
         VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
   SELECT LAST_INSERT_ID() INTO _last;

   INSERT INTO page
     (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
     VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion)
     ON DUPLICATE KEY UPDATE serial=_last, active=_last, mtime=_ts;

   COMMIT;

   SELECT _id as id, _last as active, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_save_int` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_save_int`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;
   DECLARE _hash_exist INT(4) DEFAULT 0;
   DECLARE _eid VARCHAR (16);

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   SELECT EXISTS (SELECT id FROM page WHERE id <> _id AND hashtag = _hashtag) INTO _hash_exist;
   IF _hash_exist = 0 THEN
    START TRANSACTION;

    INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
        VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
    

    SELECT LAST_INSERT_ID() INTO _last;
    UPDATE page_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
    UPDATE page_history SET status = 'draft' WHERE master_id=_id AND lang = _lang AND serial=_last;

    IF _isonline = 1 THEN
        UPDATE page_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
        UPDATE page_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_last;
    END IF;
    INSERT INTO page
      (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
      VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion)
      ON DUPLICATE KEY UPDATE serial=_last, active=_last, mtime=_ts;
    
    SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _eid;
    CALL yp.set_homepage(_eid);
   
    
    COMMIT;

    SELECT _id as id, _last as active, _hashtag as hashtag, _hash_exist AS hash_exist;
   ELSE
    SELECT _id as id, _hashtag as hashtag, _hash_exist AS hash_exist;
   END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_save_int_default_page` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_save_int_default_page`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _isonline  INT(4),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
  DECLARE _id   VARCHAR(16) DEFAULT '';
  DECLARE _ts   INT(11) DEFAULT 0;
  DECLARE _last INT(11) DEFAULT 0;
  DECLARE _hash_exist INT(4) DEFAULT 0;
  DECLARE _src_path VARCHAR(512);

  SELECT UNIX_TIMESTAMP() INTO _ts;

  CALL yp.default_page(_hashtag, _lang, _src_path);

  IF CAST(_inId as CHAR(16))='0' OR _inId='0' THEN
    SELECT yp.uniqueId() INTO _id;
  ELSE
    SELECT _inId INTO _id;
  END IF;

  
  
  
  

  SELECT active FROM `page` LEFT JOIN page_history ON page_history.`serial` = `page`.`serial`  
  WHERE `hashtag` = _hashtag AND page_history.lang = _lang INTO _last;


  
  IF _last IS NULL THEN
    START TRANSACTION;

    INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
        VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
    

    
    SELECT MAX(`serial`)+1 FROM page_history INTO _last;
    UPDATE page_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
    UPDATE page_history SET status = 'draft' 
      WHERE master_id=_id AND lang = _lang AND serial=_last;

    IF _isonline = 1 THEN
      UPDATE page_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
      UPDATE page_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_last;
    END IF;
    
    
    
    

    REPLACE INTO page
      (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, 
      `active`, `status`, `ctime`, `mtime`, `version`)
      VALUES(_id, _hashtag, _author_id, _editor, _type, _last, 
      _last, 'offline', _ts, _ts, _vesrion);

    COMMIT;

    SELECT _id as id, _lang AS lang, _last as active, 
      _hashtag as hashtag, _hash_exist AS hash_exist, _src_path AS src_path;
  ELSE
    SELECT _id as id, _lang AS lang, _hashtag as hashtag, _last AS active,
      _hash_exist AS hash_exist, _src_path AS src_path;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_save_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_save_menu`(
   IN _device  VARCHAR(16),
   IN _lang  VARCHAR(16)
)
BEGIN
   SELECT page.id, active, hashtag, `type`, editor, status, firstname, lastname ctime, mtime, version
         FROM page LEFT JOIN yp.drumate ON author_id=drumate.id WHERE `type`=_type;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_search`(
  IN _pattern VARCHAR(84),
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);

  SELECT
    content as text,
    @vhost AS vhost,
    SUBSTRING(`key`, 1, 16) as id,
    hashtag,
    hashtag as `name`,
    MATCH(content) against(_pattern IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION) as s1,
    MATCH(hashtag) against(concat('*', _pattern, '*') IN BOOLEAN MODE) as s2
  FROM seo HAVING s1 > 0 or s2 > 0 ORDER BY s2 DESC, s1 DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_status` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_status`(
   IN _id      VARBINARY(16),
   IN _status  VARCHAR(16)
)
BEGIN
   UPDATE page SET status=_status WHERE id=_id;
   SELECT *, tag as hashtag FROM page WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_store` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_store`(
   IN _inId      VARCHAR(16),
   IN _hashtag   VARCHAR(512),
   IN _editor    VARCHAR(16),
   IN _type      VARCHAR(20),
   IN _device    VARCHAR(16),
   IN _lang      VARCHAR(20),
   IN _author_id VARBINARY(16),
   IN _vesrion   VARCHAR(16)
)
BEGIN
   DECLARE _id   VARBINARY(16) DEFAULT '';
   DECLARE _ts   INT(11) DEFAULT 0;
   DECLARE _last INT(11) DEFAULT 0;

   SELECT UNIX_TIMESTAMP() INTO _ts;

   IF CAST(_inId as CHAR(16))='0' OR _inId='0' OR _inId='' THEN
     SELECT yp.uniqueId() INTO _id;
   ELSE
     SELECT _inId INTO _id;
   END IF;

   START TRANSACTION;

   INSERT INTO page_history (`author_id`, `master_id`, `lang`, `device`, `meta`, `ctime`)
         VALUES(_author_id, _id, _lang, _device, _hashtag, _ts);
   SELECT LAST_INSERT_ID() INTO _last;

   REPLACE INTO page
     (`id`, `hashtag`, `author_id`, `editor`, `type`, `serial`, `active`, `status`, `ctime`, `mtime`, `version`)
     VALUES(_id, _hashtag, _author_id, _editor, _type, _last, _last, 'offline', _ts, _ts, _vesrion);
     

   COMMIT;

   SELECT _id as id, _last as active, _hashtag as hashtag;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_unpublish` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_unpublish`(
   IN _id           VARCHAR(512),
   IN _locale       VARCHAR(100),
   IN _device       VARCHAR(16)
)
BEGIN
   DECLARE _history_id   INT(11) DEFAULT 0;
   DECLARE _ts INT(11) DEFAULT 0;
   SELECT serial INTO _history_id FROM page_history WHERE master_id = _id AND isonline = 1 AND lang = _locale AND device = _device;
   SELECT UNIX_TIMESTAMP() INTO _ts;
   UPDATE page_history SET status = 'history', isonline = 0 WHERE master_id=_id AND lang = _locale AND device = _device;
   UPDATE page_history SET status = 'draft' WHERE serial=_history_id;
   UPDATE page SET serial=_history_id, active=_history_id,mtime=_ts WHERE id=_id;
   SELECT id, active, hashtag, _history_id AS history_id FROM page WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_update` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_update`(
   IN _id      VARCHAR(16),
   IN _tag     VARCHAR(512),
   IN _author  VARCHAR(160),
   IN _lang    VARCHAR(20),
   IN _device  VARCHAR(20),
   IN _comment TEXT
)
BEGIN
   DECLARE _mtime INT(11) DEFAULT 0;
   DECLARE _url_key   VARCHAR(1000) DEFAULT '';
   SELECT UNIX_TIMESTAMP() INTO _mtime;
   UPDATE page SET hash=page_ident(_tag, _lang, _device),  tag=_tag,
     author=_author, comment=_comment, mtime=_mtime WHERE id=_id;
   SELECT
     *,
     @vhost AS vhost,
     tag as hashtag
   FROM page WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `page_update_new` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `page_update_new`(
   IN _id           VARCHAR(512),
   IN _history_id   INT(11),
   IN _lang         VARCHAR(20),
   IN _isonline     INT(4)
)
BEGIN
   DECLARE _ts INT(11) DEFAULT 0;
   SELECT UNIX_TIMESTAMP() INTO _ts;
   UPDATE page_history SET status = 'history' WHERE master_id=_id AND lang = _lang;
   UPDATE page_history SET status = 'draft' WHERE master_id=_id AND lang = _lang AND serial=_history_id;

   IF _isonline = 1 THEN
      UPDATE page_history SET isonline = 0 WHERE master_id=_id AND lang = _lang;
      UPDATE page_history SET isonline = 1 WHERE master_id=_id AND lang = _lang AND serial=_history_id;
   END IF;
   
   UPDATE page SET serial=_history_id, active=_history_id,mtime=_ts WHERE id=_id;
   SELECT id, active, hashtag FROM page WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `permission_grant` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `permission_grant`(
  IN _rid VARCHAR(16),
  IN _uid VARCHAR(16),
  IN _expiry_time INT(11),
  IN _permission TINYINT(4),
  IN _assign_via VARCHAR(50),
  IN _msg mediumtext
)
BEGIN

  DECLARE _ts INT(11) DEFAULT 0;
  DECLARE _tx INT(11) DEFAULT 0;
  DECLARE _owner_count TINYINT(4) DEFAULT 0;

  SELECT UNIX_TIMESTAMP() INTO _ts;
  SELECT cast(_permission as unsigned) INTO @perm;

  SELECT IF(IFNULL(_expiry_time, 0) = 0, 0,
    UNIX_TIMESTAMP(TIMESTAMPADD(HOUR,_expiry_time, FROM_UNIXTIME(_ts)))) INTO _tx;
  START TRANSACTION;
    INSERT IGNORE INTO permission
      VALUES(null, _rid, _uid, _msg, _tx, _ts, _ts, @perm,_assign_via )
      ON DUPLICATE KEY UPDATE permission=@perm, utime=_ts, 
        expiry_time = _tx , message=_msg, assign_via=_assign_via;

  SELECT count(*) FROM permission WHERE permission=63 AND resource_id='*' INTO _owner_count;
  IF _owner_count < 1 THEN 
    ROLLBACK;
    SELECT 1 failed, "New granting would create orphaned hub" reason;
  ELSE 
    COMMIT;
    SELECT 0 failed, @perm AS permission, sys_id AS id FROM permission 
      WHERE resource_id=_rid AND entity_id=_uid;
  END IF; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `permission_make_owner` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `permission_make_owner`(
  IN _key VARCHAR(80)
)
BEGIN
  DECLARE _uid VARCHAR(16) DEFAULT NULL;

  SELECT id FROM yp.entity WHERE id=_key OR ident=_key INTO _uid;
  IF _uid IS NOT NULL THEN
    DELETE FROM permission WHERE permission=63 AND resource_id='*';
    CALL permission_grant('*', _uid, 0, 63, 'system', 'permission_make_owner');
  ELSE 
    SELECT 1 failed, CONCAT("Invalid user id : ",  _uid, " from key ", _key) reason;
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `permission_revoke` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `permission_revoke`(
  IN _rid VARCHAR(16),
  IN _eid VARCHAR(16)
)
BEGIN
  IF _eid != '' THEN
    DELETE FROM permission WHERE resource_id=_rid AND entity_id=_eid;
    IF _eid = 'nobody' or _eid ='*' THEN
        
         DELETE FROM permission WHERE resource_id=_rid and assign_via= 'link';
    END IF;
  ELSE
    DELETE FROM permission WHERE resource_id=_rid;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `permission_set` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `permission_set`(
  IN _uid VARCHAR(16),
  IN _privilege INT(4)
)
BEGIN
  DECLARE _db_name VARCHAR(30);
  DECLARE _hub_id VARCHAR(16);

  UPDATE permission SET permission=_privilege, utime = UNIX_TIMESTAMP()
    WHERE entity_id=_uid AND resource_id='*';
  SELECT db_name FROM yp.entity WHERE id=_uid INTO _db_name;
  SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _hub_id;
  SET @s = CONCAT(
    "UPDATE `" ,_db_name,"`.permission SET permission=",_privilege, 
    ", utime = UNIX_TIMESTAMP() WHERE resource_id=", QUOTE(_hub_id));
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `post_acknowledge_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `post_acknowledge_message`(
IN _in JSON
)
BEGIN

  DECLARE _entity_id VARCHAR(16);
  DECLARE _message_id VARCHAR(16);
  DECLARE _uid VARCHAR(16);
  DECLARE _ref_sys_id int(11) unsigned default 0 ;
  DECLARE _old_ref_sys_id int(11) unsigned default 0 ;
  DECLARE _entity_db VARCHAR(255); 
 
  
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.message_id")) INTO _message_id;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.uid")) INTO _uid;
  SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.entity_id")) INTO _entity_id;

 
  SELECT sys_id FROM channel c WHERE message_id = _message_id  INTO _ref_sys_id;
  SELECT ref_sys_id FROM read_channel WHERE entity_id =_uid  AND uid = _uid INTO _old_ref_sys_id;


  SELECT CASE WHEN _ref_sys_id < _old_ref_sys_id THEN _old_ref_sys_id ELSE _ref_sys_id END INTO _ref_sys_id;

  
  
  
  
  INSERT INTO read_channel(entity_id,uid,ref_sys_id,ctime) SELECT _uid,_uid,_ref_sys_id,UNIX_TIMESTAMP() 
  ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id , ctime =UNIX_TIMESTAMP();


  SELECT NULL INTO _old_ref_sys_id;
  SELECT ref_sys_id FROM read_channel WHERE entity_id = _uid AND uid = _entity_id INTO _old_ref_sys_id;

  INSERT INTO read_channel(entity_id,uid,ref_sys_id,ctime) SELECT _uid,_entity_id,0,UNIX_TIMESTAMP() 
  WHERE _old_ref_sys_id IS NULL;

  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `post_chat_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `post_chat_message`(
IN _in JSON,
OUT _out JSON
)
BEGIN
 DECLARE _author JSON;
 DECLARE _author_id VARCHAR(16);
 DECLARE _entity_id VARCHAR(16);
 DECLARE _message  TEXT;

 DECLARE _thread_id  VARCHAR(16);
 DECLARE _forward_message_id VARCHAR(16);
 DECLARE _attachment JSON;

 DECLARE _entity_db VARCHAR(255); 
 DECLARE _message_id VARCHAR(16);
 DECLARE _ctime int(11) unsigned;

 DECLARE _ref_sys_id int(11) unsigned;
 DECLARE _temp_result JSON;


  SELECT JSON_VALUE(_in, "$.author_id") INTO _author_id;
  SELECT JSON_VALUE(_in, "$.entity_id") INTO _entity_id;
  SELECT JSON_VALUE(_in, "$.message") INTO _message; 
  SELECT JSON_VALUE(_in, "$.thread_id") INTO _thread_id; 
  SELECT JSON_VALUE(_in, "$.forward_message_id") INTO _forward_message_id; 
  SELECT JSON_VALUE(_in, "$.postattachment") INTO _attachment;
  SELECT JSON_VALUE(_in, "$.message_id") INTO _message_id; 
  SELECT JSON_VALUE(_in, "$.ctime") INTO _ctime;


  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'surname', surname)) FROM contact WHERE uid = _author_id  AND surname IS NOT NULL INTO _author;
  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'firstname', firstname)) FROM contact WHERE uid = _author_id  AND firstname IS NOT NULL INTO _author;
  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'lastname', lastname)) FROM contact WHERE uid = _author_id  AND lastname IS NOT NULL INTO _author;
  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'contact_id', id)) FROM contact WHERE uid = _author_id   INTO _author;
  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'id', uid)) FROM contact WHERE uid = _author_id AND uid IS NOT NULL  INTO _author;

  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'firstname', firstname)) FROM yp.drumate WHERE id = _author_id AND  _author = '{}' INTO _author;
  SELECT JSON_MERGE ( IFNULL(_author,'{}'), JSON_OBJECT( 'lastname', lastname)) FROM yp.drumate WHERE id = _author_id  AND  _author = '{}' INTO _author;

  INSERT INTO channel (message_id,author_id,entity_id,message,thread_id,ctime,attachment)
  SELECT _message_id,_author_id,_author_id,_message,_thread_id,_ctime,_attachment ;


  UPDATE channel SET 
    is_forward =1, 
    metadata=JSON_MERGE(
                        IFNULL(metadata, '{}'), 
                        JSON_OBJECT('forward_message_id',   _forward_message_id),
                        JSON_OBJECT('forward_hub_id',   JSON_UNQUOTE(JSON_EXTRACT(_in, "$.hub_id")))
                       )
  WHERE message_id=_message_id AND _forward_message_id is NOT NULL; 

  SELECT sys_id FROM channel WHERE message_id = _message_id   INTO _ref_sys_id;

  INSERT INTO time_channel(entity_id, ref_sys_id,message,ctime)
  SELECT _author_id, _ref_sys_id,_message, _ctime ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id, ctime =_ctime ,message=_message;
  SELECT  JSON_MERGE(_in,  JSON_OBJECT('author',_author )) INTO _out;


  CALL count_yet_read (JSON_OBJECT('entity_id',_author_id ), _temp_result);
  SELECT JSON_MERGE(_temp_result,  _out ) INTO _out;
  SELECT JSON_REMOVE(_out,"$.entity_id" ) INTO _out;
  SELECT JSON_MERGE(_out, JSON_OBJECT('entity_id',_author_id ) ,JSON_OBJECT('to_id',_entity_id )   )  INTO _out;
  SELECT JSON_MERGE(_out, JSON_OBJECT('entity',_author )) WHERE _author != '{}' INTO _out;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `post_forward_message_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `post_forward_message_get`(IN _in JSON,OUT _out JSON)
BEGIN
  DECLARE _message_id VARCHAR(16);
  DECLARE _message JSON;
  DECLARE _attachment  JSON;
 
    SELECT JSON_UNQUOTE(JSON_EXTRACT(_in, "$.message_id")) INTO _message_id;

    SELECT  attachment FROM channel WHERE message_id = _message_id  AND  attachment  <> '[]' AND  attachment IS NOT NULL INTO  _attachment ;

    SELECT  message FROM channel WHERE message_id = _message_id  AND message IS NOT NULL INTO _message  ;

    SELECT  JSON_OBJECT('forward_message_id', message_id) FROM channel WHERE message_id = _message_id  INTO  _out;

    SELECT JSON_MERGE ( _out, JSON_OBJECT( 'message', _message )) INTO _out WHERE _message IS NOT NULL;
    SELECT JSON_MERGE ( _out, JSON_OBJECT( 'attachment', _attachment )) INTO _out WHERE  _attachment IS NOT NULL;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `remove_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `remove_agenda`(
    _agenda_id VARCHAR(16)
)
BEGIN
    
    DECLARE _lvl INT(4);
    DECLARE _drumate_id VARCHAR(16);
    DECLARE _drumate_db VARCHAR(255); 
    

    DROP TABLE IF EXISTS _map_agenda;
    CREATE TEMPORARY TABLE _map_agenda(
            `drumate_id` varchar(16) NOT NULL,
            `is_checked` boolean default 0
        );
    
    INSERT INTO _map_agenda (drumate_id)
    SELECT uid FROM map_agenda WHERE  agenda_id = _agenda_id AND uid IS NOT NULL;

    WHILE (IFNULL((SELECT 1 FROM _map_agenda  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT NULL,NULL  INTO _drumate_id ,_drumate_db;
        SELECT drumate_id  FROM _map_agenda WHERE is_checked = 0 LIMIT 1  INTO _drumate_id;
        SELECT db_name FROM yp.entity WHERE id=_drumate_id INTO _drumate_db;
        
            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.delete_map_agenda (', QUOTE(_agenda_id) ,')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

            SET @st = CONCAT(
            'CALL ', _drumate_db ,'.delete_agenda (', QUOTE(_agenda_id) ,')');
            PREPARE stamt FROM @st;
            EXECUTE stamt;
            DEALLOCATE PREPARE stamt; 

        UPDATE _map_agenda SET is_checked =  1 WHERE drumate_id =_drumate_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
    END WHILE;


    CALL delete_map_agenda(_agenda_id);
    CALL delete_agenda(_agenda_id);


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `remove_all_members` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `remove_all_members`(
  IN _keep_id  VARCHAR(16)
)
BEGIN
  DECLARE _done INT DEFAULT 0;
  DECLARE _hub_id VARCHAR(16);
  DECLARE _drumate_db VARCHAR(40);
  DECLARE _uid VARCHAR(16);
  DECLARE _perm TINYINT(2);
  DECLARE _members CURSOR FOR SELECT entity_id, permission FROM permission WHERE entity_id != '*';
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET _done = 1; 

  SELECT id  FROM yp.entity WHERE db_name = database() INTO _hub_id;

  OPEN _members;

  WHILE NOT _done DO
    FETCH _members INTO _uid, _perm;
    IF _uid != _keep_id THEN
      
      SELECT db_name  FROM yp.entity WHERE id=_uid INTO  _drumate_db;
      SET @s = CONCAT(
        "DELETE FROM `", _drumate_db, "`.permission WHERE resource_id = ", quote(_hub_id), ";"
      );
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      SET @s = CONCAT(
        "DELETE FROM `", _drumate_db, "`.media WHERE id = ", quote(_hub_id), ";"
      );
      PREPARE stmt FROM @s;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
    END IF;
  END WHILE;
  CLOSE _members;
  DELETE FROM permission WHERE entity_id != _keep_id AND entity_id != '*' ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `remove_from_my_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `remove_from_my_hub`(
  IN _key  VARCHAR(80)
)
BEGIN
  DECLARE _db VARCHAR(30);
  DECLARE _uid VARCHAR(16);
  SELECT db_name, id FROM yp.entity WHERE id=_key INTO _db, _uid;
  DELETE FROM media WHERE id= _uid AND category ='hub';
  DELETE FROM permission WHERE entity_id= _uid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `remove_huber` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `remove_huber`(
  IN _key  VARCHAR(80)
)
BEGIN
  DECLARE _db VARCHAR(30);
  DECLARE _hid VARBINARY(16);
  DECLARE _uid VARBINARY(16);
  SELECT id FROM yp.entity WHERE db_name=database() INTO _hid;
  SELECT db_name, id FROM yp.entity WHERE id=_key OR ident=_key INTO _db, _uid;
  IF IFNULL(_uid, '') <> '' THEN
    SET @s = CONCAT("CALL `", _db, "`.remove_from_my_hub(", quote(_hid), ");");
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    DELETE FROM huber WHERE id = _uid;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `remove_member` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `remove_member`(
  IN _key  VARCHAR(80)
)
BEGIN
  DECLARE _uid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _drumate_db VARCHAR(80);
  SELECT id  FROM yp.entity WHERE db_name = database() INTO _hub_id;
  SELECT id, db_name  FROM yp.entity WHERE id=_key OR ident=_key INTO _uid, _drumate_db;
  
  DELETE FROM permission WHERE entity_id = _uid;
  SET @s1 = CONCAT("DELETE FROM `", _drumate_db, "`.permission ",
    " WHERE resource_id = ", quote(_hub_id), ";");
  SET @s2 = CONCAT("DELETE FROM `", _drumate_db, "`.media ",
    " WHERE id = ", quote(_hub_id), ";");
  PREPARE stmt FROM @s1;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  PREPARE stmt FROM @s2;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  SELECT _uid AS id, 0 AS permission;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `rename_trash` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `rename_trash`(
  IN _src_id VARCHAR(16),
  IN _src_entity_id VARCHAR(16),
  IN _dest_pid VARCHAR(16),
  IN _des_entity_id VARCHAR(16)
  )
BEGIN
  DECLARE _category VARCHAR(40);
  DECLARE _src_db   VARCHAR(255);
  DECLARE _des_db   VARCHAR(255);
 
  
  SELECT db_name from yp.entity WHERE id=_src_entity_id INTO _src_db;
  SELECT db_name from yp.entity WHERE id=_des_entity_id INTO _des_db;
  SELECT NULL,NULL,NULL,NULL INTO @user_filename, @nid, @parent_id,@newfilename;
    
	
    SET @sql = CONCAT(
    " SELECT  destination.user_filename ,destination.id ,destination.parent_id
          
        FROM ",_src_db,".media source
            INNER JOIN ",_des_db,".media destination ON destination.user_filename= source.user_filename
            AND source.category = destination.category AND destination.status  = 'deleted'
        WHERE 
          source.id =",QUOTE(_src_id)," AND
          destination.parent_id=",QUOTE(_dest_pid), " INTO @user_filename, @nid, @parent_id "  );
          
    PREPARE stmt FROM @sql ;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    

   IF @user_filename IS NOT NULL THEN
  
	   SET @sql = CONCAT("SELECT ", _des_db , ".unique_filename( @parent_id,  @user_filename) into @newfilename") ;  
	   PREPARE stmt FROM @sql ;
	   EXECUTE stmt;
	   DEALLOCATE PREPARE stmt;
	   SELECT @user_filename, @nid, @parent_id ,@newfilename ;
	   
	   SET @sql = CONCAT("call ",_des_db ,".mfs_rename(@nid ,@newfilename )" );
	   PREPARE stmt FROM @sql ;
	   EXECUTE stmt;
	   DEALLOCATE PREPARE stmt;
	   SELECT NULL,NULL,NULL,NULL INTO @user_filename, @nid, @parent_id,@newfilename;
   END IF ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `rmdir` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `rmdir`(
  IN mid VARBINARY(16)
)
BEGIN
  DECLARE dirname VARCHAR(255);
  SELECT file_path FROM media  WHERE id=mid INTO dirname;
  DELETE FROM media WHERE file_path LIKE CONCAT(dirname, '/%');
  DELETE FROM media WHERE id=mid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `rmfile` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `rmfile`(
  IN mid VARBINARY(16)
)
BEGIN
  DELETE FROM media WHERE id=mid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `select_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `select_calendar`(
    _calendar_ids MEDIUMTEXT
)
BEGIN
    DECLARE _calendar_id  VARCHAR(16);
    DECLARE _i INTEGER DEFAULT 0;


     UPDATE calendar SET  is_selected = 0;

    WHILE _i < JSON_LENGTH(_calendar_ids) DO 
    
        SELECT JSON_UNQUOTE(JSON_EXTRACT(_calendar_ids, CONCAT("$[", _i, "]")))  INTO _calendar_id ;
        UPDATE calendar SET  is_selected = 1 WHERE calendar_id =_calendar_id;
        SELECT _i + 1 INTO _i;
    END WHILE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `send_chat_message` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `send_chat_message`(
 IN _in JSON
)
BEGIN
 DECLARE _entity JSON;
 DECLARE _out JSON;
 DECLARE _temp_out TEXT;

 DECLARE _author_id VARCHAR(16);
 DECLARE _entity_id VARCHAR(16);
 DECLARE _message  TEXT;

 DECLARE _thread_id  VARCHAR(16);
 DECLARE _forward_message_id VARCHAR(16);
 DECLARE _attachment JSON;
 DECLARE _preattachment JSON;

 DECLARE _entity_db VARCHAR(255); 
 DECLARE _message_id VARCHAR(16);
 DECLARE _ctime int(11) unsigned;

 DECLARE _ref_sys_id int(11) unsigned;
 DECLARE _temp_result JSON;

  SELECT JSON_VALUE(_in, "$.author_id") INTO _author_id;
  SELECT JSON_VALUE(_in, "$.entity_id") INTO _entity_id;
  SELECT JSON_VALUE(_in, "$.message") INTO _message; 
  SELECT JSON_VALUE(_in, "$.thread_id") INTO _thread_id; 
  SELECT JSON_VALUE(_in, "$.forward_message_id") INTO _forward_message_id; 
  SELECT JSON_QUERY(_in, "$.attachment") INTO _attachment; 
  SELECT JSON_VALUE(_in, "$.message_id") INTO _message_id;
  SELECT JSON_VALUE(_in, "$.preattachment") INTO _preattachment; 
  
  SELECT UNIX_TIMESTAMP() INTO _ctime; 
  
  SELECT db_name FROM yp.entity WHERE id=_entity_id INTO _entity_db;

  INSERT INTO channel (message_id,author_id,entity_id,message,thread_id,ctime,attachment)
  SELECT _message_id,_author_id,_entity_id,_message,_thread_id,_ctime,IFNULL(_preattachment,_attachment) ;

  UPDATE channel SET metadata=JSON_MERGE(IFNULL(metadata, '{}'), JSON_OBJECT('_delivered_',   JSON_OBJECT(_entity_id,_ctime)))
  WHERE message_id=_message_id;

  UPDATE channel SET metadata=JSON_MERGE(IFNULL(metadata, '{}'),   JSON_OBJECT('_seen_', JSON_OBJECT(_author_id, 1)), JSON_OBJECT('_delivered_',   JSON_OBJECT(_author_id,_ctime)))
  WHERE message_id=_message_id;

  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'surname', surname)) FROM contact WHERE uid = _entity_id  AND surname IS NOT NULL INTO _entity;
  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'firstname', firstname)) FROM contact WHERE uid = _entity_id  AND firstname IS NOT NULL INTO _entity;
  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'lastname', lastname)) FROM contact WHERE uid = _entity_id  AND lastname IS NOT NULL INTO _entity;
  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'contact_id', id)) FROM contact WHERE uid = _entity_id   INTO _entity;
  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'id', uid)) FROM contact WHERE uid = _entity_id AND uid IS NOT NULL  INTO _entity;

  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'firstname', firstname)) FROM yp.drumate WHERE id = _entity_id AND  _entity = '{}' INTO _entity;
  SELECT JSON_MERGE ( IFNULL(_entity,'{}'), JSON_OBJECT( 'lastname', lastname)) FROM yp.drumate WHERE id = _entity_id  AND  _entity = '{}' INTO _entity;

   UPDATE channel SET 
    is_forward =1, 
    metadata=JSON_MERGE(
                        IFNULL(metadata, '{}'), 
                        JSON_OBJECT('forward_message_id',   _forward_message_id),
                        JSON_OBJECT('forward_hub_id',   JSON_UNQUOTE(JSON_EXTRACT(_in, "$.hub_id")))
                       )
  WHERE message_id=_message_id AND _forward_message_id is NOT NULL; 

  SELECT sys_id FROM channel WHERE message_id = _message_id   INTO _ref_sys_id;

 
  INSERT INTO time_channel(entity_id, ref_sys_id,message,ctime)
  SELECT _entity_id, _ref_sys_id,_message, _ctime ON DUPLICATE KEY UPDATE ref_sys_id= _ref_sys_id, ctime =_ctime ,message=_message;

  SELECT  JSON_MERGE(_in,  JSON_OBJECT('ctime',_ctime )) INTO _in;
  
  
 
  

  SET @st = CONCAT('CALL ', _entity_db ,'.post_chat_message(?,?)');
  PREPARE stamt FROM @st;
  EXECUTE stamt USING _in , _out;
  DEALLOCATE PREPARE stamt; 

  CALL acknowledge_message( JSON_MERGE( JSON_OBJECT('message_id',_message_id ) , JSON_OBJECT('entity_id',_entity_id ) ,JSON_OBJECT('uid',_author_id ))  );
  CALL count_yet_read (JSON_OBJECT('entity_id',_entity_id ),  _temp_result );
  SELECT JSON_MERGE(_temp_result,  _in ) INTO _in;
  SELECT JSON_MERGE(_in, JSON_OBJECT('to_id',_author_id )) INTO _in;
  SELECT JSON_MERGE(_in, JSON_OBJECT('entity',_entity )) WHERE _entity != '{}' INTO _in;
     
  IF _forward_message_id IS NOT NULL THEN 
     SELECT  JSON_MERGE(_in,  JSON_OBJECT('is_forward',1 )) INTO _in;
     SELECT  JSON_MERGE(_out,  JSON_OBJECT('is_forward',1 )) INTO _out;
  ELSE 
    SELECT  JSON_MERGE(_in,  JSON_OBJECT('is_forward',0 )) INTO _in;
    SELECT  JSON_MERGE(_out,  JSON_OBJECT('is_forward',0 )) INTO _out;
  END IF ; 


  SELECT _in  myresult, _out hisresult;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `seo_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `seo_get`(
  IN _hashtag VARCHAR(128),
  IN _lang VARCHAR(128)
)
BEGIN
  DECLARE h VARCHAR(128);
  IF _hashtag is NULL OR _hashtag='' THEN
    SELECT home_layout FROM yp.entity WHERE db_name=database() INTO h;
  ELSE
    SELECT _hashtag INTO h;
  END IF;

  SELECT * FROM `seo` WHERE lang=_lang and hashtag=h;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `session_login_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `session_login_log`(
  IN  _option VARCHAR(64),
  IN  _cookie_id VARCHAR(64),
  IN  _metadata JSON
)
BEGIN
  IF (_option = 'in') THEN
    INSERT INTO login_log ( cookie_id, metadata, intime ) 
    SELECT  _cookie_id, _metadata , UNIX_TIMESTAMP();
  ELSE
    INSERT INTO login_log ( cookie_id, metadata, outtime ) 
    SELECT  _cookie_id, _metadata , UNIX_TIMESTAMP();
  END IF;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `set_member_pemission` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `set_member_pemission`(
  IN _key  VARCHAR(80),
  IN _perm  TINYINT(2)
)
BEGIN
  DECLARE _uid VARCHAR(16);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _drumate_db VARCHAR(80);
  SELECT id  FROM yp.entity WHERE db_name = database() INTO _hub_id;
  SELECT id, db_name  FROM yp.entity WHERE id=_key OR ident=_key INTO _uid, _drumate_db;
  UPDATE permission SET permission=_perm, utime=UNIX_TIMESTAMP() WHERE entity_id = _uid;
  SET @s = CONCAT("UPDATE `", _drumate_db, "`.permission SET permission=", _perm, 
    " WHERE resource_id = ", quote(_hub_id), ";");
  PREPARE stmt FROM @s;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
  SELECT @s;
  SELECT * FROM permission WHERE entity_id = _uid;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `set_page_length` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `set_page_length`(
  IN _start int,
  IN _end int
)
BEGIN
  DECLARE _length INT DEFAULT 20;
  DECLARE _perpage INT DEFAULT 20;

  IF @rows_per_page IS NULL THEN
    SET @rows_per_page=15;
  END IF;

  SELECT (_end - _start)*@rows_per_page INTO _length;
  SET @rows_per_page=_length;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `shareroom_contact_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `shareroom_contact_get`(
  IN _uid     VARCHAR(16)
)
BEGIN
  DECLARE _owner_id VARCHAR(16);
   DECLARE _mail  VARCHAR(500);
    SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _owner_id;
    SELECT email FROM yp.drumate WHERE id = _owner_id INTO _mail;
    
    SELECT
      du.id ,
      c.id contact_id, 
      c.firstname,
      c.lastname, 
      c.entity entity,
      IFNULL(c.surname,  IF(coalesce(c.firstname, c.lastname) IS NULL, coalesce(ce.email,de.email,du.email) , CONCAT( IFNULL(c.firstname, '') ,' ',  IFNULL(c.lastname, '')))) as surname,
      CASE WHEN mycb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked,
      CASE WHEN hiscb.sys_id IS NOT NULL THEN 1 ELSE 0 END is_blocked_me
    FROM
      yp.drumate du 
      LEFT JOIN contact c ON du.id = c.entity
      LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1 
      LEFT JOIN yp.drumate de on de.id=c.entity
      LEFT JOIN yp.contact_block mycb ON  c.id = mycb.contact_id
      LEFT JOIN yp.contact_block hiscb ON 
      (hiscb.owner_id =  c.entity OR hiscb.owner_id =c.uid) 
       AND( hiscb.uid =  _owner_id OR hiscb.entity = _owner_id ) 
     
    WHERE du.id = _uid;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_all_members` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_all_members`(
)
BEGIN
  DECLARE _hub_id VARCHAR(16);
  SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO _hub_id;

  SELECT   
    d.id,
    _hub_id AS nid,
    permission AS privilege,
    read_json_object(d.profile, 'firstname') AS firstname,
    read_json_object(d.profile, 'lastname') AS lastname
    
  FROM permission p 
  INNER JOIN yp.drumate d on p.entity_id=d.id 
  WHERE resource_id='*' ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_calendar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_calendar`(
     _calendar_id  VARCHAR(16)
)
BEGIN

    IF _calendar_id ='' THEN
        SELECT NULL INTO _calendar_id ; 
    END IF ;

    CALL add_intial_calendar();
    

   SELECT * FROM 
    (
        SELECT 
            calendar_id,
            name,
            color,
            category,
            owner_id,
            is_selected,
            is_default,
            ctime
        FROM calendar
        WHERE  calendar_id = IFNULL(_calendar_id, calendar_id)
        AND category = 'own'
    UNION 
        SELECT 
            calendar_id,
            CONCAT(firstname, " ", lastname) name,
            color,
            cl.category,
            owner_id,
            is_selected,
            is_default,
            cl.ctime
        FROM calendar cl
        INNER JOIN contact c on c.uid= cl.owner_id
        WHERE  calendar_id = IFNULL(_calendar_id, calendar_id)
        AND  cl.category = 'other'
    ) A
    ORDER BY 
        category DESC, name  ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_contributors` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_contributors`(
  IN _page         INT(4)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  DECLARE _count int(6);
  DECLARE _hub_id VARCHAR(16);
  DECLARE _p int(4);

  CALL pageToLimits(_page, _offset, _range);
  SELECT COUNT(*) FROM member INTO _count;
  SELECT id FROM yp.entity WHERE db_name = database() INTO _hub_id;

  SELECT drumate.id, 
    permission AS privilege,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.firstname')), ''))AS firstname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.lastname')), '')) AS lastname,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.email')), '')) AS email,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.mobile')), '')) AS mobile,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.address')), '')) AS address,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.city')), ''))) AS city,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.content')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country,
    TRIM(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country.value')), IFNULL(JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')), ''))) AS country_code,
    expiry_time AS expiry,
    permission.ctime, 
    permission.utime, 
    _count as total
    FROM permission LEFT JOIN yp.drumate ON entity_id=drumate.id 
    WHERE entity_id != _hub_id ORDER BY permission DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_detail_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_detail_agenda`(
     _agenda_id  VARCHAR(16)
)
BEGIN
    
    SELECT 
        a.agenda_id,
        a.name agenda_name,
        a.place,
        a.category,
        c.calendar_id,
        a.owner_id,
        a.stime,
        a.etime,
        CASE WHEN c.category ='other' THEN CONCAT(con.firstname, " ", con.lastname) ELSE c.name END  calendar_name
        
    FROM 
    agenda a 
    INNER JOIN calendar c 
    
    ON CASE WHEN c.is_default =1  THEN IFNULL(c.calendar_id,'-99') ELSE c.calendar_id END  = IFNULL(a.calendar_id,'-99')
    LEFT JOIN contact con on con.uid= c.owner_id
    WHERE agenda_id = _agenda_id; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_detail_map_agenda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_detail_map_agenda`(
     _agenda_id  VARCHAR(16)
)
BEGIN
    
    SELECT  
        c.id contact_id,
        CONCAT(c.firstname, " ", c.lastname) fullname, 
        c.email,
        c.uid 
    FROM map_agenda ma 
    INNER JOIN contact c ON c.id = ma.contact_id
    WHERE  ma.agenda_id =_agenda_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_hubers` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `show_hubers`(
  IN _page TINYINT(4)
)
BEGIN

  DECLARE _hid VARBINARY(16);
  DECLARE _range bigint;
  DECLARE _offset bigint;

  SELECT id FROM yp.entity WHERE db_name=database() INTO _hid;

  CALL pageToLimits(_page, _offset, _range);
  SELECT
    _hid as hub_id,
    entity.id,
    entity.ident,
    entity.area,
    entity.vhost,
    drumate.dmail,
    drumate.email,
    drumate.firstname,
    drumate.lastname,
    drumate.gender,
    drumate.remit,
    CONCAT(firstname, ' ', lastname) as `fullname`,
    privilege
  FROM yp.entity INNER JOIN (yp.drumate, huber) ON drumate.id=entity.id AND huber.id=entity.id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_hubs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `show_hubs`( 
)
BEGIN

  SELECT 
    m.id, 
    COALESCE(h.name, m.user_filename) AS `name`,
    e.db_name,
    h.owner_id,
    p.permission AS privilege, 
    home_dir, 
    e.area,
    h.serial
  FROM media m 
  INNER JOIN(permission p, yp.entity e, yp.hub h) 
  ON m.id = p.resource_id AND e.id = m.id AND e.id = h.id
  WHERE m.category='hub' AND e.area <> 'dmz' GROUP BY(m.id);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `show_login_log` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `show_login_log`(
  IN _page INT(6)
)
BEGIN
  DECLARE _uid VARCHAR(16);
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);
  SELECT id FROM yp.entity WHERE db_name = DATABASE() INTO _uid;
 
  SELECT  
    _page as `page`,
    cookie_id ,
    intime,
    outtime,
    read_json_object(l.metadata, "timezone") timezone,
    read_json_object(l.metadata, "city") city,
    read_json_object(l.metadata, "ip") ip,
    metadata,
    CASE WHEN c.id IS NULL THEN 'inactive' ELSE 'active' END  status 
  FROM 
  login_log l
  LEFT JOIN yp.cookie  c ON c.id=l.cookie_id AND c.uid = _uid
  WHERE l.intime IS NOT NULL
  ORDER BY l.sys_id DESC  LIMIT _offset, _range; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_add`(
  IN _selector VARCHAR(255),
  IN _style VARCHAR(12000),
  IN _comment VARCHAR(255)
)
BEGIN
  insert into style(`selector`, `declaration`, `comment`) values(_selector, _style, _comment)
  ON DUPLICATE KEY UPDATE `selector`=_selector, `declaration`=_style, `comment`=_comment;
  SELECT * FROM style WHERE id=LAST_INSERT_ID();
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_create` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_create`(
  IN _name VARCHAR(255),
  IN _sel VARCHAR(255),
  IN _style VARCHAR(12000),
  IN _comment VARCHAR(255)
)
BEGIN

  DECLARE _className  VARCHAR(100) DEFAULT '';
  DECLARE _selector   VARCHAR(200) DEFAULT '';
  SELECT concat('cc-', yp.uniqueId()) INTO _className;
  SELECT IF(_sel IS NULL OR _sel = '', concat('.', _className), concat('.', _className, ' ', _sel))
    INTO _selector;
  INSERT INTO `style`(`name`, `class_name`, `selector`, `declaration`, `comment`)
               VALUES(_name, _className, _selector, _style, _comment)
  ON DUPLICATE KEY UPDATE `name`=_name, `selector`=_selector, `declaration`=_style, `comment`=_comment;
  SELECT * FROM `style` WHERE id=LAST_INSERT_ID();
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_get`(
  IN _id VARCHAR(16)
)
BEGIN
  SELECT * FROM `style` where id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_get_classes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_get_classes`(
)
BEGIN
  SELECT * FROM `style`;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_get_files` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_get_files`(
)
BEGIN
  SELECT id as nid FROM media  WHERE category='stylesheet' AND status='active';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_list`(
  IN _page TINYINT(4)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT * FROM `style` ORDER BY selector ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_remove` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_remove`(
  IN _id VARCHAR(16)
)
BEGIN
  DELETE FROM style WHERE id=_id;
  SELECT _id as id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_rename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_rename`(
  IN _id VARCHAR(16),
  IN _name VARCHAR(255)
)
BEGIN
  UPDATE style SET `name`=_name WHERE id=_id;
  SELECT * FROM style WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_save` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_save`(
  IN _id VARCHAR(16),
  IN _style VARCHAR(12000)
)
BEGIN
  UPDATE style SET declaration=_style WHERE id=_id;
  SELECT * FROM style WHERE id=_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_search` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_search`(
  IN _str VARCHAR(100)
)
BEGIN
  SELECT * FROM `style` where selector like concat("%", _str, "%");
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `style_sheets` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `style_sheets`(
  IN _page TINYINT(4)
)
BEGIN
  DECLARE _range bigint;
  DECLARE _offset bigint;
  CALL pageToLimits(_page, _offset, _range);

  SELECT id AS nid, user_filename AS `filename`,  caption, metadata as outerClass
  FROM media  WHERE category='stylesheet' AND status='active' 
  ORDER BY upload_time DESC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_add` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_add`(
    _name VARCHAR(255),
    _parent_id VARCHAR(16)
)
BEGIN
    
    DECLARE _tag_id VARCHAR(16);
    DECLARE _tag_time int(11) unsigned;
    DECLARE _position int(11) unsigned;
    
    SELECT UNIX_TIMESTAMP() INTO _tag_time; 
    SELECT  yp.uniqueId() INTO _tag_id; 
    SELECT MAX(position) FROM tag INTO _position;

    SELECT IFNULL(_position,0) +1 INTO _position;

    IF _parent_id = '' THEN 
      SELECT NULL INTO _parent_id;
    END IF;  
    
    SELECT unique_tagname(_name,NULL) INTO _name;

    INSERT INTO tag(tag_id,parent_tag_id,name,ctime,position) 
    SELECT _tag_id,_parent_id,_name,_tag_time,_position;

    SELECT * FROM tag WHERE tag_id = _tag_id;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_assign` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_assign`(
    _tag_id VARCHAR(50),
    _parent_id VARCHAR(16)
)
BEGIN
   
     
    UPDATE tag SET parent_tag_id = _parent_id WHERE tag_id = _tag_id;
    
    CALL tag_get_next(_parent_id, '', 'asc');

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_chat_count` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_chat_count`(
  IN _tag_id  VARCHAR(16)
)
BEGIN

  DECLARE _this_hub_id VARCHAR(16);
  DECLARE _nid VARCHAR(16);
  DECLARE _db_name VARCHAR(500);
  DECLARE _temp_result JSON;
  DECLARE _read_cnt INT ;
  DECLARE _ctime INT(11) unsigned;
  DECLARE _message mediumtext;
  DECLARE _temp_nid VARCHAR(16);

   SELECT id FROM yp.entity WHERE db_name=DATABASE() INTO  _this_hub_id ;
    
    DROP TABLE IF EXISTS _show_node;
    CREATE TEMPORARY TABLE _show_node (
      entity_id  VARCHAR(16) NOT NULL,  
      hub_id VARCHAR(16) NOT null,
      room_count INT DEFAULT 0,
      flag VARCHAR(500),
      db_name   VARCHAR(500)  NULL,
      PRIMARY KEY `entity_id`(`entity_id`)
    ); 

    INSERT INTO _show_node
    SELECT
      c.uid  entity_id, 
      _this_hub_id   hub_id,  
      IFNULL(( 
              SELECT 
                COUNT(1)
              FROM 
                channel ch 
              INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
              WHERE
                ch.entity_id = ch.author_id AND 
                rc.entity_id <> rc.uid  AND 
                ch.sys_id > rc.ref_sys_id AND 
                ch.entity_id = c.uid), 0),
       'contact' ,null
    FROM
      contact c
    LEFT JOIN time_channel tc ON tc.entity_id = c.uid
    LEFT JOIN contact_email ce ON ce.contact_id = c.id  AND ce.is_default = 1  
    INNER JOIN yp.drumate du ON du.id = c.uid
    WHERE CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  c.id IN ( SELECT id FROM map_tag mt WHERE mt.tag_id = _tag_id) ELSE c.id =c.id END 
    AND c.uid IS NOT NULL;




    INSERT INTO _show_node(entity_id,hub_id,flag,db_name)
    SELECT 
      m.id ,m.id , 'share', db_name    
    FROM 
    media m
    INNER JOIN yp.hub h on  h.id = m.id 
    INNER  JOIN yp.entity he ON m.id = he.id
    WHERE category = 'hub'
    AND CASE WHEN _tag_id IS NOT NULL AND  _tag_id <> ''  THEN  m.id IN ( SELECT id FROM map_tag mt WHERE mt.tag_id = _tag_id) ELSE m.id =m.id END;
 
    ALTER TABLE _show_node ADD `is_checked` boolean default 0 ;
    UPDATE   _show_node SET is_checked = 1 WHERE flag='contact';

    
    SELECT entity_id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
    WHILE _nid IS NOT NULL DO
 
          SET @st = CONCAT('CALL ', _db_name ,'.room_detail(?,?)');
          PREPARE stamt FROM @st;
          EXECUTE stamt USING  JSON_OBJECT('uid',_this_hub_id ) , _temp_result ;
          DEALLOCATE PREPARE stamt; 
        
          SELECT JSON_UNQUOTE(JSON_EXTRACT(_temp_result, "$.read_cnt")) INTO _read_cnt;  
 
          UPDATE _show_node SET  
            room_count =  _read_cnt
          WHERE entity_id = _nid ;

        UPDATE _show_node SET is_checked = 1 WHERE entity_id = _nid ;
        SELECT NULL , NULL  INTO _read_cnt,_nid;
        SELECT entity_id ,db_name FROM _show_node WHERE is_checked =0  LIMIT 1 INTO _nid, _db_name; 
     END WHILE;


    SELECT  SUM(room_count)  room_count FROM _show_node;

  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_chk_child` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_chk_child`(
    _tag_id  VARCHAR(16),
    _chk_id VARCHAR(16)
)
BEGIN
   
    DECLARE _lvl INT(4);    
    DECLARE _is_any_child int(1) default 0;

     DROP TABLE IF EXISTS _tag;
     CREATE TEMPORARY TABLE _tag(
            `tag_id` varchar(16) NOT NULL,
            `is_checked` boolean default 0
     );
    
     INSERT INTO _tag (tag_id) SELECT _tag_id;
     WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
            SELECT tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id;
            INSERT INTO _tag (tag_id) SELECT tag_id FROM tag WHERE  parent_tag_id = _tag_id;
            UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
            SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
     END WHILE; 


    
        SELECT * FROM tag WHERE tag_id IN (SELECT tag_id FROM _tag WHERE tag_id = _chk_id );
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_delete` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_delete`(
  IN _sys_id        INT(11) UNSIGNED
)
BEGIN
  DELETE FROM content_tag WHERE sys_id = _sys_id;
  SELECT sys_id AS `serial`, id, `language`, `type`, `status`, `name` 
  FROM content_tag ORDER BY sys_id ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_get` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_get`(
    _key  VARCHAR(50),
    _chk_tag_id VARCHAR(50)
)
BEGIN
    DECLARE _tag_id VARCHAR(16);
    DECLARE _lvl INT(4);    
    DECLARE _is_any_child int(1) default 0;
    
        SELECT tag_id FROM tag WHERE tag_id = _key or name = _key INTO _tag_id;
        SELECT  1  FROM tag WHERE parent_tag_id =  _tag_id LIMIT 1 INTO _is_any_child;
        SELECT tag_id,parent_tag_id,_is_any_child as is_any_child,name,position FROM tag WHERE tag_id = _tag_id AND 
        tag_id <> IFNULL(_chk_tag_id,'xxxxxx');
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_get_by_name` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_get_by_name`(
  IN _name         VARCHAR(100),
  IN _page         INT(6)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT 
    `id`,
    `name`, 
    `hashtag`,
    `language`,
    `description` as content,
    _page as `page`
    FROM content_tag c
    INNER JOIN `block` USING(id) 
    WHERE c.`status`='online' AND `name`=_name 
    ORDER BY c.rank ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_get_next` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_get_next`(
    IN _key  VARCHAR(50),
    IN _search VARCHAR(255), 
    IN _order   VARCHAR(20),
    IN  _page INT(6)
)
BEGIN
  DECLARE _tag_id VARCHAR(16);
    
  DECLARE _range bigint;
  DECLARE _offset bigint;
    

  CALL pageToLimits(_page, _offset, _range);

  SELECT 
    _page as `page`,
    tag_id,
    parent_tag_id,
    name,
    IFNULL((SELECT  1  FROM tag c WHERE c.parent_tag_id = p.tag_id LIMIT 1),0) is_any_child,
    position,
    IFNULL(( 
      SELECT 
        COUNT(1)
      FROM 
        channel ch 
      INNER JOIN  read_channel rc ON ch.entity_id= rc.entity_id 
      INNER JOIN  contact c ON c.entity = ch.entity_id
      INNER JOIN  map_tag mt ON  c.id = mt.id
      WHERE
        ch.entity_id = ch.author_id AND 
        rc.entity_id <> rc.uid  AND 
        ch.sys_id > rc.ref_sys_id AND 
        mt.tag_id = p.tag_id), 0) room_count   
  FROM 
    tag p
  WHERE parent_tag_id IS NULL
  ORDER BY 
    CASE WHEN  LCASE(_order) = 'asc' THEN position END ASC,
    CASE WHEN  LCASE(_order) = 'desc' THEN position END DESC LIMIT _offset, _range;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_get_next_old` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_get_next_old`(
    IN _key  VARCHAR(50),
    IN _search VARCHAR(255), 
    IN _order   VARCHAR(20),
    IN  _page INT(6)
)
BEGIN
    DECLARE _tag_id VARCHAR(16);
    DECLARE _root_tag_id VARCHAR(16);
    DECLARE _lvl INT(4);    
    DECLARE _is_any_child int(1) default 0;
    DECLARE _range bigint;
    DECLARE _offset bigint;
    

   CALL pageToLimits(_page, _offset, _range);

    DROP TABLE IF EXISTS _tag;
    CREATE TEMPORARY TABLE _tag(`tag_id` varchar(16) NOT NULL,`root_tag_id` varchar(16)  NULL,
    `is_checked` boolean default 0 ); 

    

    IF (_search IS NULL OR _search = "") THEN

      IF (_key IS NULL OR _key ='' OR _key ='0') THEN
          
        SELECT 
          _page as `page`,
          tag_id,
          parent_tag_id,
          name,
          IFNULL((SELECT  1  FROM tag c WHERE c.parent_tag_id = p.tag_id LIMIT 1),0) is_any_child,
          position
        FROM 
          tag p
        WHERE parent_tag_id IS NULL
        ORDER BY 
          CASE WHEN  LCASE(_order) = 'asc' THEN position END ASC,
          CASE WHEN  LCASE(_order) = 'desc' THEN position END DESC LIMIT _offset, _range;

      ELSE  
        SELECT tag_id FROM tag WHERE tag_id = _key or name = _key INTO _tag_id;
        
        SELECT 
          _page as `page`,
          tag_id,
          parent_tag_id,
          name,
          IFNULL((SELECT  1  FROM tag c WHERE c.parent_tag_id = p.tag_id LIMIT 1),0) is_any_child,
          position
        FROM 
          tag p
        WHERE parent_tag_id = _tag_id
        ORDER BY 
          CASE WHEN  LCASE(_order) = 'asc' THEN position END ASC,
          CASE WHEN  LCASE(_order) = 'desc' THEN position END DESC
          LIMIT _offset, _range;
          
      END IF;
    ELSE

      IF (_key IS NULL OR _key ='' OR _key ='0') THEN
        INSERT INTO _tag (tag_id,root_tag_id) SELECT tag_id,tag_id FROM tag WHERE parent_tag_id IS NULL;
      ELSE 
        SELECT tag_id FROM tag WHERE tag_id = _key or name = _key INTO _tag_id;
        INSERT INTO _tag (tag_id,root_tag_id) SELECT tag_id,tag_id FROM tag WHERE parent_tag_id =_tag_id;
      END IF ;

          
      WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
        SELECT tag_id,root_tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id,_root_tag_id;
        INSERT INTO _tag (tag_id,root_tag_id) SELECT tag_id ,_root_tag_id FROM tag WHERE  parent_tag_id = _tag_id;
        UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
        SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
      END WHILE;
      
      SELECT NULL INTO _tag_id; 
      SELECT tag_id FROM tag WHERE tag_id = _key or name = _key INTO _tag_id;
  
      SELECT 
        _page as `page`,
        t.tag_id , 
        t.parent_tag_id, 
        name,
        IFNULL((SELECT  1  FROM tag c WHERE c.parent_tag_id = t.tag_id LIMIT 1),0) is_any_child,
        position
      FROM 
      tag t        
      WHERE 1=1
      AND EXISTS (
        SELECT 1 FROM _tag at  
        INNER JOIN map_tag mt ON at.tag_id = mt.tag_id 
        WHERE EXISTS (SELECT 1 FROM chat c where c.entity_id =mt.id AND message LIKE CONCAT('%', _search, '%'))
        AND   root_tag_id = t.tag_id
      )
      AND IFNULL(t.parent_tag_id,'-99' ) = IFNULL(_tag_id, '-99') 
      
      ORDER BY 
        CASE WHEN LCASE(_order) = 'asc' THEN name END ASC,
        CASE WHEN LCASE(_order) = 'desc' THEN name END DESC
        LIMIT _offset, _range;
      

    
    END IF;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_list`(
  IN _page         INT(6)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT 
    `name`, 
    GROUP_CONCAT( `hashtag` SEPARATOR ' ' ) as ids,
    `description` as content,
    _page as `page`
    FROM content_tag
    INNER JOIN `block` USING(id) 
    WHERE content_tag.`status`='online' 
    GROUP BY `name`,`description` ASC LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_list_by_lang` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_list_by_lang`(
  IN _lang         VARCHAR(100),
  IN _page         INT(6)
)
BEGIN
  DECLARE _range int(6);
  DECLARE _offset int(6);
  CALL pageToLimits(_page, _offset, _range);
  SELECT 

    `name`, 

    GROUP_CONCAT( `hashtag` SEPARATOR ' ' ) as ids,
    
    
    (
      SELECT content FROM yp.translate 
      WHERE translate.key_code=`name` AND translate.lang=_lang
    ) as content,
    _page as `page`,
    (
      SELECT group_rank FROM content_tag c1
      WHERE c1.name=c2.name limit 1
    ) AS `rank`
    FROM content_tag c2
    INNER JOIN `block` USING(id) 
    WHERE c2.`status`='online' 
    GROUP BY `name`,`description` ASC ORDER by `rank` LIMIT _offset, _range;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_remove` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_remove`(
    _tag_id VARCHAR(50)   
)
BEGIN
    
    DECLARE _lvl INT(4);

        DROP TABLE IF EXISTS _tag;
        CREATE TEMPORARY TABLE _tag(
            `tag_id` varchar(16) NOT NULL,
            `is_checked` boolean default 0
        );
        INSERT INTO _tag (tag_id) SELECT _tag_id;
        WHILE (IFNULL((SELECT 1 FROM _tag  WHERE  is_checked = 0 LIMIT 1 ),0)  = 1 ) AND IFNULL(_lvl,0) < 1000 DO
            SELECT tag_id  FROM _tag WHERE is_checked = 0 LIMIT 1  INTO _tag_id;
            INSERT INTO _tag (tag_id) SELECT tag_id FROM tag WHERE  parent_tag_id = _tag_id;
            UPDATE _tag SET is_checked =  1 WHERE tag_id =_tag_id; 
            SELECT IFNULL(_lvl,0) + 1 INTO _lvl;
        END WHILE; 

        DELETE FROM map_tag WHERE tag_id IN (SELECT tag_id FROM _tag);
        DELETE FROM tag WHERE tag_id IN (SELECT tag_id FROM _tag);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_rename` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_rename`(
    _tag_id VARCHAR(50),
    _name VARCHAR(255)   
)
BEGIN
    
   SELECT unique_tagname(_name,_tag_id) INTO _name;

   UPDATE tag SET name = _name WHERE tag_id = _tag_id;

  CAll tag_get (_tag_id,null);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_reposition` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `tag_reposition`(
  IN _tags MEDIUMTEXT
)
BEGIN
  DECLARE _i INTEGER DEFAULT 0;
  DROP TABLE IF EXISTS __tmp_position;
  CREATE TEMPORARY TABLE __tmp_position(
    `position` INTEGER,
    `id` varchar(16) DEFAULT NULL
  ); 

  WHILE _i < JSON_LENGTH(_tags) DO 
    
    
    INSERT INTO __tmp_position 
      SELECT _i, JSON_UNQUOTE(JSON_EXTRACT(_tags, CONCAT("$[", _i, "]")));
    SELECT _i + 1 INTO _i;
  END WHILE;
  UPDATE tag m INNER JOIN __tmp_position t ON m.tag_id=t.id SET m.position = t.position ;
  SELECT * FROM __tmp_position;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_repostion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_repostion`(
    _tag_id VARCHAR(50),
    _position int(11) unsigned
   
)
BEGIN
    
    UPDATE tag SET position=_position WHERE tag_id = _tag_id;

    CALL tag_get (_tag_id,null);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `tag_save` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `tag_save`(
  IN _sys_id        INT(11) UNSIGNED,
  IN _tag           VARCHAR(500),
  IN _lang          MEDIUMTEXT,
  IN _type          VARCHAR(50),
  IN _name          VARCHAR(500)
)
BEGIN
  DECLARE _row_count INT(11) UNSIGNED;
  DECLARE _id VARBINARY(16);
  DECLARE EXIT HANDLER FOR SQLEXCEPTION, SQLWARNING
  BEGIN
    SELECT "INTERNAL_ERROR" AS error;
  END;
  IF _type = 'block' THEN
    SELECT id FROM block WHERE id=_tag OR hashtag=_tag INTO _id;
  ELSE
    SELECT _tag INTO _id;
  END IF;
  IF IFNULL(_sys_id, 0) = 0 THEN
    SET _sys_id = NULL;
    INSERT INTO content_tag (sys_id, id, `language`, `type`, `status`, `name`, ctime) VALUES
      (_sys_id, _id, _lang, _type, 'online', _name, UNIX_TIMESTAMP())
      ON DUPLICATE KEY UPDATE id = _id, `language`=_lang, `type` = _type, `status` = 'online', `name`=_name;
    SELECT LAST_INSERT_ID() INTO _sys_id;
    SELECT sys_id AS `serial`, id, `language`, `type`, `status`, `name` FROM content_tag WHERE sys_id = _sys_id;
  ELSE
    SELECT COUNT(sys_id) FROM content_tag WHERE sys_id = _sys_id AND id = _id INTO _row_count;
    IF IFNULL(_row_count, 0) = 0 THEN
      SELECT "ID_NOT_FOUND" AS error;
    ELSE
      UPDATE content_tag SET id = _id, `language`=_lang, `type` = _type,
        `status` = 'online', `name`=_name WHERE sys_id = _sys_id;
      SELECT sys_id AS `serial`, id, `language`, `type`, `status`, `name`
        FROM content_tag WHERE sys_id = _sys_id;
    END IF;
  END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `team_create_hub` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `team_create_hub`(
  IN _specs  VARCHAR(150),
  IN _domain VARCHAR(150),
  IN _oid VARCHAR(16)
)
BEGIN

  DECLARE _room_hub_id VARCHAR(16);
  DECLARE _room_hub_db VARCHAR(50);
  DECLARE _room_hub_ident VARCHAR(80); 
  DECLARE _room_hub_fqdn VARCHAR(1024);

  SELECT id, db_name ,ident FROM yp.entity WHERE type='hub' AND area='pool' LIMIT 1 
  INTO _room_hub_id, _room_hub_db, _room_hub_ident;

  SELECT CONCAT(_room_hub_ident, '.', _domain) INTO _room_hub_fqdn;

  UPDATE yp.entity SET area='private', status='active'  WHERE id=_room_hub_id;
  INSERT INTO yp.vhost VALUES (null, _room_hub_fqdn, _room_hub_id, _domain);

  INSERT INTO yp.hub (id, owner_id, origin_id,  name,  keywords, dmail, profile)
  VALUES ( _room_hub_id, _oid, _oid,  _specs, 'Key words', yp.get_dmail(_room_hub_ident), '{}');

  CALL join_hub(_room_hub_id);

  SELECT _room_hub_id id, _room_hub_db db_name;
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `team_create_member_folder` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `team_create_member_folder`(
  IN _mids JSON,  
  IN _oid VARCHAR(16),
  IN _team_hub_id VARCHAR(16)
)
BEGIN
  DECLARE _idx INT(4) DEFAULT 0; 
  DECLARE _mid VARCHAR(16);
  DECLARE _temp_parent_id VARCHAR(16);
  DECLARE _temp_user_filename VARCHAR(1024);
  DECLARE _team_hub_db VARCHAR(50);
  DECLARE _fullname VARCHAR(255) ; 


  DROP TABLE IF EXISTS _final_team; 
  CREATE TEMPORARY TABLE _final_team (
    nid varchar(16) DEFAULT NULL , 
    uid varchar(16) DEFAULT NULL
  );

  SELECT db_name FROM yp.entity WHERE id=_team_hub_id INTO _team_hub_db;


  SET @st = CONCAT( "SELECT id FROM ",_team_hub_db,".media WHERE parent_id='0' INTO  @home_id");
  PREPARE stmt3 FROM @st;
  EXECUTE stmt3;
  DEALLOCATE PREPARE stmt3;  
  
    
  WHILE _idx < JSON_LENGTH(_mids) DO 
    SELECT get_json_array(_mids, _idx) INTO _mid;
    SELECT CONCAT(firstname, " ", lastname) FROM contact WHERE id  = _mid INTO _fullname ;
  
    SELECT 
    CONCAT(get_json_object(d.profile, 'firstname'), ' ', get_json_object(d.profile, 'lastname'))  
    FROM yp.drumate d WHERE  d.id= _mid AND _fullname IS NULL INTO _fullname; 

      
    SET @st = CONCAT( "CREATE TEMPORARY TABLE IF NOT EXISTS  ",_team_hub_db,".__register_stack LIKE template.__register_stack"); 
    PREPARE stmt FROM @st;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;


    SET @st = CONCAT( "DELETE FROM ",_team_hub_db,".__register_stack"); 
    PREPARE stmt1 FROM @st;
    EXECUTE stmt1;
    DEALLOCATE PREPARE stmt1;

    SET @st = CONCAT("CALL ", _team_hub_db ,".mfs_register(",
      QUOTE(_oid),",",
      QUOTE(_fullname),",",
      QUOTE(@home_id), ",'folder','folder','folder',NULL,NULL,0)" 
    );
    PREPARE stmt2 FROM @st;
    EXECUTE stmt2;
    DEALLOCATE PREPARE stmt2;

    SET @st = CONCAT("CALL ", _team_hub_db, ".mfs_new_node(?,?,?,?,?,?,?,?,?,?)");
    PREPARE stmt2 FROM @st;
    EXECUTE stmt2 USING 
      _oid,
      _oid,
      _fullname,
      @home_id,
      'folder',
      'folder',
      'folder',
      NULL,
      NULL, 
      0;           
    DEALLOCATE PREPARE stmt2;

 

    SET @st = CONCAT( "SELECT id FROM ",_team_hub_db,".__register_stack INTO @temp_nid");
    PREPARE stamt FROM @st;
    EXECUTE stamt;
    DEALLOCATE PREPARE stamt; 
    INSERT INTO _final_team SELECT @temp_nid, _mid;

    SET @st = CONCAT(
      "UPDATE ",_team_hub_db,".media SET metadata=",
      QUOTE(JSON_OBJECT('uid', _mid, 'access', 'personal', 'fullname', _fullname)),
    " WHERE id=", QUOTE(@temp_nid));
    PREPARE stamt FROM @st;
    EXECUTE stamt;
    DEALLOCATE PREPARE stamt; 
    
    SELECT _idx + 1 INTO _idx; 
  END WHILE;

  SELECT * from _final_team;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `team_create_owner_folder` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `team_create_owner_folder`(
  IN _name VARCHAR(100),
  IN _oid VARCHAR(16),
  IN _team_hub_id VARCHAR(16)
)
BEGIN

  DECLARE _home_id VARCHAR(16);
  DECLARE _temp_nid VARCHAR(16);
   
    
    
  SELECT id FROM media WHERE parent_id='0' INTO _home_id; 
  CREATE TEMPORARY TABLE IF NOT EXISTS  __register_stack LIKE template.__register_stack;
  DELETE FROM __register_stack;
  CALL mfs_new_node(
    _oid,
    _oid,
    _name,
    _home_id,
    'folder',
    'folder',
    'folder',
    NULL,
    NULL,
  0);
  SELECT id FROM __register_stack INTO _temp_nid;
  UPDATE media SET parent_id= _temp_nid WHERE id = _team_hub_id; 
  
  SELECT * FROM media WHERE id = _temp_nid; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `test_limit` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `test_limit`(
  IN _page int
)
BEGIN
  DECLARE total bigint;
  DECLARE _offset bigint;
  DECLARE perpage INT DEFAULT 20;
  SELECT count(*) FROM media into total;

  SELECT FLOOR(total/perpage)*_page INTO _offset;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `unarchive_entity` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`gopinath`@`%` PROCEDURE `unarchive_entity`(
 _entity_id VARCHAR(16)
)
BEGIN
  DELETE FROM  archive_entity WHERE entity_id= _entity_id;
  SELECT * FROM archive_entity WHERE entity_id = _entity_id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `update_membership` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`somanos`@`localhost` PROCEDURE `update_membership`(
   IN _operation VARCHAR(20)
)
BEGIN

  DECLARE _done INT DEFAULT 0;
  DECLARE _id VARBINARY(16);
  DECLARE _hid VARBINARY(16);
  DECLARE _db_name VARCHAR(20);
  DECLARE _hubers CURSOR FOR SELECT id FROM huber;
  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _done = 1;


  SELECT id FROM yp.entity WHERE db_name=database() INTO _hid;

  OPEN _hubers;

  REPEAT
    FETCH _hubers INTO _id;
    SELECT db_name FROM yp.entity WHERE id=_id INTO _db_name;

    IF _operation = 'add' THEN
      
      SET @s = CONCAT("INSERT IGNORE INTO `",_db_name,"`.media (id, origin_id, file_path, user_filename, parent_id, parent_path,
        extension, mimetype, category, filesize, `geometry`, upload_time, publish_time,
        metadata, caption, `status`, approval) SELECT hub.id, owner_id, vhost, hub.name,
        (SELECT id FROM media WHERE parent_id='0' LIMIT 1), '', entity.area,
        'text/plain', 'hub', entity.space, '', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(),
        '', '', 'active', 'submitted' FROM yp.hub JOIN(yp.entity) ON hub.id=entity.id
        WHERE hub.id=", quote(_hid));
    ELSEIF _operation = 'remove' THEN
      
      SET @s = CONCAT("DELETE FROM `",_db_name,"`.media WHERE id=", quote(_hid) );
    ELSE
      SET @s = "SELECT NULL";
    END IF;

    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

  UNTIL _done END REPEAT;

  CLOSE _hubers;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2021-05-25  6:09:18
